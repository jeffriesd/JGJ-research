% For double-blind review submission, w/o CCS and ACM Reference (max
% submission space)
\documentclass[acmsmall,review,anonymous]{acmart}
\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For double-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true}
%% For single-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For single-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true}
%% For final camera-ready submission, w/ required CCS and ACM Reference
%\documentclass[acmsmall]{acmart}\settopmatter{}


%% Journal information
%% Supplied to authors by publisher for camera-ready submission;
%% use defaults for review submission.
\acmJournal{PACMPL}
\acmVolume{1}
\acmNumber{POPL} % CONF = POPL or ICFP or OOPSLA
\acmArticle{1}
\acmYear{2020}
\acmMonth{1}
\acmDOI{} % \acmDOI{10.1145/nnnnnnn.nnnnnnn}
\startPage{1}

%% Copyright information
%% Supplied to authors (based on authors' rights management selection;
%% see authors.acm.org) by publisher for camera-ready submission;
%% use 'none' for review submission.
\setcopyright{none}
%\setcopyright{acmcopyright}
%\setcopyright{acmlicensed}
%\setcopyright{rightsretained}
%\copyrightyear{2018}           %% If different from \acmYear

%% Bibliography style
\bibliographystyle{ACM-Reference-Format}
%% Citation style
%% Note: author/year citations are required for papers published as an
%% issue of PACMPL.
\citestyle{acmauthoryear}   %% For author/year citations
%\citestyle{acmnumeric}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Note: Authors migrating a paper from PACMPL format to traditional
%% SIGPLAN proceedings format must update the '\documentclass' and
%% topmatter commands above; see 'acmart-sigplanproc-template.tex'.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\usepackage[utf8]{inputenc}
\usepackage{ccicons}
\usepackage{verbatim}

\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amscd}
%\usepackage{MnSymbol}
\usepackage{xcolor}

\usepackage{bbold}
\usepackage{url}
\usepackage{upgreek}
%\usepackage{stmaryrd}

\usepackage{lipsum}
\usepackage{tikz-cd}
\usetikzlibrary{cd}
\usetikzlibrary{calc}
\usetikzlibrary{arrows}

\usepackage{bussproofs}
\EnableBpAbbreviations

\input{macros}
\input{mytheorem}

\theoremstyle{definition}
\newtheorem{exmpl}{Example}

\renewcommand{\greyout}[1]{} %{{\color{gray} {#1}}} -- toggle to remove greyed text

\newcommand{\emptyfun}{{[]}}
\newcommand{\cal}{\mathcal}
%\newcommand{\fold}{\mathit{fold}}
\newcommand{\F}{\mathcal{F}}
\renewcommand{\G}{\mathcal{G}}
\newcommand{\N}{\mathcal{N}}
\newcommand{\E}{\mathcal{E}}
\newcommand{\B}{\mathcal{B}}
\renewcommand{\P}{\mathcal{A}}
\newcommand{\pred}{\mathsf{Fam}}
\newcommand{\env}{\mathsf{Env}}
\newcommand{\set}{\mathsf{Set}}
\renewcommand{\S}{\mathcal S}
\renewcommand{\C}{\mathcal{C}}
\newcommand{\D}{\mathcal{D}}
\newcommand{\A}{\mathcal{A}}
\renewcommand{\id}{\mathit{id}}
\newcommand{\map}{\mathsf{map}}
\newcommand{\pid}{\underline{\mathit{id}}}
\newcommand{\pcirc}{\,\underline{\circ}\,}
\newcommand{\pzero}{\underline{0}}
\newcommand{\pone}{\underline{1}}
\newcommand{\psum}{\,\underline{+}\,}
\newcommand{\pinl}{\underline{\mathit{inL}}\,}
\newcommand{\pinr}{\underline{\mathit{inR}}\,}
\newcommand{\ptimes}{\,\underline{\times}\,}
\newcommand{\ppi}{\underline{\pi_1}}
\newcommand{\pppi}{\underline{\pi_2}}
\newcommand{\pmu}{\underline{\mu}}
\newcommand{\semmap}{\mathit{map}}
\newcommand{\subst}{\mathit{subst}}

\newcommand{\tb}[1]{~~ \mbox{#1} ~~}
\newcommand{\listt}[1]{(\mu \phi. \lambda \beta . \onet + \beta \times
  \phi \beta) #1} 
\newcommand{\filtype}{\Nat^\emptyset 
 (\Nat^\emptyset \, \alpha \, \mathit{Bool})\, (\Nat^\emptyset 
  (List \, \alpha) \, (List \, \alpha))} 
\newcommand{\filtypeGRose}{\Nat^\emptyset 
 (\Nat^\emptyset \, \alpha \, \mathit{Bool})\, (\Nat^\emptyset 
  (\mathit{GRose}\,\psi \, \alpha) \, (\mathit{GRose}\,\psi \, (\alpha
  + \onet)))} 
\newcommand{\maplist}{\mathit{map}_{\lambda A. \setsem{\emptyset; \alpha
      \vdash \mathit{List} \, \alpha} \rho[\alpha := A]}} 
\newcommand{\PLeaves}{\mathsf{PLeaves}}
\newcommand{\swap}{\mathsf{swap}}
\newcommand{\reverse}{\mathsf{reverse}}
\newcommand{\Bcons}{\mathit{Bcons}}
\newcommand{\Bnil}{\mathit{Bnil}}

\title[Free Theorems for Nested Types]{Free Theorems for
  %Primitive
  Nested Types} %% [Short Title] is optional; when present,
                         %% will be used in header instead of Full
                         %% Title.
%\titlenote{with title note}             %% \titlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'
%\subtitle{Subtitle}                     %% \subtitle is optional
%\subtitlenote{with subtitle note}       %% \subtitlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'


%% Author information
%% Contents and number of authors suppressed with 'anonymous'.
%% Each author should be introduced by \author, followed by
%% \authornote (optional), \orcid (optional), \affiliation, and
%% \email.
%% An author may have multiple affiliations and/or emails; repeat the
%% appropriate command.
%% Many elements are not rendered, but should be provided for metadata
%% extraction tools.

%% Author with single affiliation.
\author{Patricia Johann, Enrico Ghiorzi, and Daniel Jeffries}
%\authornote{with author1 note}          %% \authornote is optional;
%                                        %% can be repeated if necessary
%\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
\affiliation{
%  \position{Position1}
%  \department{Department1}              %% \department is recommended
  \institution{Appalachian State University}            %% \institution is required
%  \streetaddress{Street1 Address1}
%  \city{City1}
%  \state{State1}
%  \postcode{Post-Code1}
%  \country{Country1}                    %% \country is recommended
}
\email{johannp@appstate.edu, ghiorzie@appstate.edu, jeffriesd@appstate.edu}          %% \email is recommended


\begin{document}

\begin{abstract}
Abstract goes here
\end{abstract}

%\begin{CCSXML}
%<ccs2012>
%<concept>
%<concept_id>10011007.10011006.10011008</concept_id>
%<concept_desc>Software and its engineering~General programming languages</concept_desc>
%<concept_significance>500</concept_significance>
%</concept>
%<concept>
%<concept_id>10003456.10003457.10003521.10003525</concept_id>
%<concept_desc>Social and professional topics~History of programming languages</concept_desc>
%<concept_significance>300</concept_significance>
%</concept>
%</ccs2012>
%\end{CCSXML}
%
%\ccsdesc[500]{Software and its engineering~General programming languages}
%\ccsdesc[300]{Social and professional topics~History of programming languages}
%% End of generated code


%% Keywords
%% comma separated list
%\keywords{keyword1, keyword2, keyword3}  %% \keywords is optional


\maketitle

\section{Introduction}\label{sec:intro}

Suppose we wanted to prove some property of programs over an algebraic
data type (ADT) such as that of lists, coded in Agda
%\footnote{All code appearing in this paper are written in Agda.}
as
{\small
\[\begin{array}{l}
\mathtt{data\; List \;(A : Set)\;:\;Set\;where}\\
\hspace*{0.4in}\mathtt{nil\;:\; List\;A}\\
\hspace*{0.4in}\mathtt{Cons\;:\;A \rightarrow List\;A \rightarrow List\;A}
\end{array}\]}
A natural approach to the problem uses structural induction on the
input data structure in question. This requires knowing not just the
definition of the ADT of which the input data structure is an
instance, but also the program text for the functions involved in the
properties to be proved. For example, to prove by induction that
mapping a polymorphic function over a list and then reversing the
resulting list is the same as reversing the original list and then
mapping the function over the result, we unwind the (recursive)
definitions of the $\mathtt{reverse}$ and $\mathtt{map}$ functions
over lists to according to the inductive structure of the input
list. Such data-driven induction proofs over ADTs are so routine that
they are often included in, say, undergraduate functional programming
courses.

An alternative technique for proving results like the above
$\mathtt{map}$-$\mathtt{reverse}$ property for lists is to use
parametricity, a formalization of extensional type-uniformity in
polymorphic languages. Parametricity captures the intuition that a
polymorphic program must act uniformly on all of its possible type
instantiations; it is formalized as the requirement that every
polymorphic program preserves all relations between any pair of types
that it is instantiated with.  Parametricity was originally put forth
by Reynolds~\cite{rey83} for System F~\cite{gr89}, the formal calculus
at the core of all polymorphic functional languages. It was later
popularized as Wadler's ``theorems for free''~\cite{wad89} because it
allows the deduction of many properties of programs in such languages
solely from their types, i.e., with no knowledge whatsoever of the
text of the programs involved. To get interesting free theorems,
Wadler's calculus included, implicitly, built-in list types; indeed,
most of the free theorems in~\cite{wad89} are consequences of
naturality for polymorphic list-processing functions. However,
parametricity can also be used to prove naturality properties for
non-list ADTs, as well as results, like correctness of program
optimizations like {\em short cut fusion}~\cite{glp93,joh02,joh03},
that go beyond simple naturality.
%In addition, parametricity in the presence of ADTs
%{\color{blue} check!}  has further been used to prove i) {\em
%  properties of programs}, e.g., that they perform no illegal
%operations, satisfy certain security criteria~\cite{ep03,rp10}, or are
%observationally equivalent to their compiled forms~\cite{bh09,hd11};
%ii) {\em whole-language properties}, e.g., that they support data
%abstraction and modularity via representation independence,
%\cite{bm05,dr04,jac99,kat11,mr92}, enforce information flow
%policies~\cite{ss01,ts04}, or guarantee privacy~\cite{rp10}; and iii)
%{\em properties of implementations}, e.g., compiler
%correctness~\cite{ab08,bh09,hd11,glpj93}. Parametricity is thus an
%important tool for reasoning about programs in polymorphic languages
%that natively support ADTs. {\color{blue} Be clear about what this
%  means. Re-word?}

This paper is about parametricity and free theorems for a polymorphic
calculus with explicit syntax not just for ADTs, but for nested types
as well. An ADT defines a {\em family of inductive data types}, one
for each input type. For example, the $\mathtt{List}$ data type
definition above defines a collection of data types $\mathtt{List\;
  A}$, $\mathtt{List\; B}$, $\mathtt{List\; (A \times B)}$,
$\mathtt{List\; (\List\;A)}$, etc., each independent of all the
others. By contrast, a nested type~\cite{bm98} is an {\em inductive
  family of data types} that is defined over, or is defined mutually
recursively with, (other) such data types. Since the structures of the
data type at one type can depend on those at other types, the entire
family of types must be defined at once. Examples of nested types
include, trivially, ordinary ADTs, such as list and tree types; simple
nested types, such as the data type {\small
\[\begin{array}{l}
\mathtt{data\; PTree\;(A : Set)\;:\;Set\;where}\\
\hspace*{0.4in}\mathtt{pleaf\;:\;A \rightarrow PTree\;A}\\
\hspace*{0.4in}\mathtt{pnode\;:\;PTree\;(A \times A) \rightarrow PTree\;A}
\end{array}\]}
\hspace{-0.04in}of perfect trees, whose recursive occurrences never
appear below other type constructors; ``deep'' nested
types~\cite{jp20}, such as the data type {\small
\[\begin{array}{l}
\mathtt{data\; Forest\;(A : Set)\;:\;Set\;where}\\
\hspace*{0.4in}\mathtt{fempty\;:\;Forest\;A}\\
\hspace*{0.4in}\mathtt{fnode\;:\; A \rightarrow PTree\;(Forest\;A) \to
Forest\;A}
\end{array}\]}
\hspace{-0.04in}of perfect forests, whose recursive occurrences appear
below type constructors for other nested types; and truly nested
types\footnote{Nested types that are defined over themselves are known
  as {\em truly nested types}.}, such as the data type {\small
\[\begin{array}{l}
\mathtt{data\; Bush\;(A : Set)\;:\;Set\;where}\\
\hspace*{0.4in}\mathtt{bnil\;:\; Bush\;A}\\
\hspace*{0.4in}\mathtt{bcons\;:\;A \rightarrow Bush\;(Bush \; A)
  \rightarrow Bush\;A} 
\end{array}\]}
\hspace{-0.04in}of bushes (also called {\em bootstrapped heaps}
in~\cite{oka99}), whose recursive occurrences appear below their own
type constructors.

Suppose we now want to prove properties of functions over nested
types. We might, for example, want to prove a
$\mathtt{map}$-$\mathtt{reverse}$ property for the functions on
perfect trees in Figure~\ref{fig:funs}, or for those on
bushes\footnote{To define the $\mathtt{foldBush}$ and
  $\mathtt{mapBush}$ functions in Figure~\ref{fig:funs2} it is
  necessary to turn off Agda's termination checker.} in
Figure~\ref{fig:funs2}. A few well-chosen examples quickly convince us
that such a property should indeed hold for perfect trees, and,
drawing inspiration from the situation for ADTs, we easily construct a
proof by induction on the input perfect tree. To formally establish
this result, we could even prove it in Coq or Agda: each of these
provers actually generates an induction rule for perfect trees and the
generated rule gives the expected result because proving properties of
perfect trees requires only that we induct over the top-level perfect
tree in the recursive position, leaving any data internal to the input
tree untouched.
\begin{figure*}
\hspace*{-0.5in}
\resizebox{0.35\linewidth}{!}{
\begin{minipage}[t]{0.5\textwidth}
\[\begin{array}{l}
\mathtt{reversePTree : \forall \{A : Set\}  \rightarrow PTree\; A
  \rightarrow PTree \;A}\\  
\mathtt{reversePTree \; \{A\} = foldPTree \; \{A\}\; \{PTree\}}\\
\hspace*{1.3in} \mathtt{pleaf}\\
\hspace*{1.3in} \mathtt{( \lambda p \rightarrow pnode\; (mapPTree\;
  swap\; p) )}\\  
\\
\mathtt{foldPTree : \forall \{A : Set\} \rightarrow \{F : Set \rightarrow Set \}
  \rightarrow}\\
\hspace*{0.8in} \mathtt{( \{B : Set\} \rightarrow B \rightarrow F B) \rightarrow}\\
\hspace*{0.8in} \mathtt{(\{B : Set\} \rightarrow F (B \times B)
  \rightarrow F B) \rightarrow}\\
\hspace*{0.8in}\mathtt{PTree \;A \rightarrow F\;A}\\
\mathtt{foldPTree\; n\; c\; (pleaf\; x) = n \;x}\\
\mathtt{foldPTree\; n\; c \;(pnode\; p) = c\; (foldPTree \;n \;c \;p)}\\
\\
\mathtt{mapPTree : \forall \{A\, B : Set\} \rightarrow (A \rightarrow B)
  \rightarrow PLeaves\; A \rightarrow PLeaves\; B}\\ 
\mathtt{mapPTree \;f\; (pleaf \;x) = pleaf\; (f\; x)}\\
\mathtt{mapPTree\; f \;(pnode\; p) = pnode\; (mapPTree \;(\lambda p
  \rightarrow (f (\pi_1 \,p), f (\pi_2\,p)))\; p)}\\ 
\\
\mathtt{swap : \forall \{A : Set\} \rightarrow (A \times A)
  \rightarrow (A \times A)}\\ 
\mathtt{swap \;(x,y) = (y,x)}
\end{array}\]
\caption{$\mathtt{reversePTree}$ and auxiliary functions in Agda}\label{fig:funs} 
\end{minipage}}
\quad\quad\quad\quad\quad\quad\quad\quad
\resizebox{0.35\linewidth}{!}{
\begin{minipage}[t]{0.5\textwidth}
\[\begin{array}{l}
  \mathtt{reverseBush : \forall \{A : Set\} \rightarrow Bush\; A
  \rightarrow Bush\; A}\\ 
\mathtt{reverseBush \;\{A\} = foldBush\; \{A\}\; \{Bush\}\; bnil \;balg}\\
\\
\mathtt{foldBush : \forall \{A : Set\} \rightarrow \{F : Set \rightarrow
  Set\} \rightarrow}\\
\hspace*{0.5in} \mathtt{(\{B : Set\} \rightarrow F B) \rightarrow}\\
\hspace*{0.5in} \mathtt{(\{B : Set\} \rightarrow B \rightarrow F\;
  (F\; B) \rightarrow F\; B) \rightarrow}\\ 
\hspace*{0.5in} \mathtt{Bush\; A \rightarrow F \;A}\\
\mathtt{foldBush\; bn\; bc\; bnil = bn}\\
\mathtt{foldBush \;bn \;bc \;(bcons\; x \;bb) =}\\
\hspace*{0.5in} \mathtt{bc\; x \;(foldBush \;bn\; bc
  \;(mapBush \;(foldBush\; bn\; bc) \;bb))}\\
\\
\mathtt{mapBush : \forall \{A \,B : Set\} \to (A \to B) \to (Bush\, A) \to
  (Bush\, B)}\\ 
\mathtt{mapBush\; \_ \; bnil = bnil}\\
\mathtt{mapBush\; f\; (bcons\; x \;bb) = bcons \;(f\, x) \; (mapBush\;
  (mapBush\, f) \; bb)}\\ 
\\
\mathtt{balg : \forall \{B : Set\} \rightarrow B \rightarrow Bush
  \;(Bush\; B) \rightarrow Bush\; B}\\
\mathtt{balg \;x \;bnil = bcons\; x \;bnil}\\
\mathtt{balg \;x\; (bcons \;bnil \;bbbx) = bcons\; x \;(bcons \;bnil\; bbbx)}\\
\mathtt{balg\; x \;(bcons \;(bcons\; y \;bx)\; bbbx) =}\\
\hspace*{0.5in} \mathtt{bcons\; y\; (bcons\; (bcons \;x \;bx) \;bbbx)}\\
\end{array}\]
\caption{$\mathtt{reverseBush}$ and auxiliary
  functions in Agda}\label{fig:funs2} 
\end{minipage}}
\end{figure*}
%want to prove that $\mathtt{reversePTree}$ commutes with
%$\mathtt{mapPTree}$ or that $\mathtt{reverseBush}$ commutes with
%$\mathtt{mapBush}$. It is not hard to convince oneself of the former:
%a few well-chosen examples show clearly why mapping a polymorphic
%%function over a perfect tree and then reversing the data at the leaves
%of the resulting perfect tree is indeed the same result as mapping
%that same function over the result of reversing the data at the leaves
%of the original perfect tree.

Unfortunately, it is nowhere near as clear that analogous intuitive or
formal inductive arguments can be made for the
$\mathtt{map}$-$\mathtt{reverse}$ property for bushes. Indeed, a proof
by induction on the input bush must recursively induct over the bushes
that are internal to the top-level bush in the recursive position.
This is sufficiently delicate that no induction rule for bushes or
other truly nested types was known until very recently, when {\em deep
  induction}~\cite{jp20} was developed as a way to induct over {\em
  all} of the structured data present in an input. Deep induction thus
not only gave the first principled and practically useful structural
induction rules for bushes and other truly nested types, and has also
opened the way for incorporating automatic generation of such rules
for (truly) nested data types --- and, eventually, even GADTs --- into
modern proof assistants.

Of course it is great to know that we {\em can}, at last, prove
properties of programs over (truly) nested types by induction.  But
recalling that inductive proofs over ADTs can sometimes be
circumvented in the presence of parametricity, we might naturally ask:
\begin{verse}
{\em Can we derive properties of functions over (truly) nested types
  from parametricity?}
\end{verse}
This paper answers the above question in the affirmative by
constructing a parametric model for a polymorphic calculus providing
primitives for {\em constructing} nested types
%(including ADTs)
directly via
%type-level
recursion --- rather than representing them indirectly by Church
encodings as in most polymorphic calculi.

We introduce our calculus in Section~\ref{sec:calculus}.  At the type
level, it is the level-2-truncation of the higher-kinded calculus
from~\cite{jp19}, augmented with a primitive type of natural
transformations. To construct nested types, it constructs type
expressions not just from standard type variables, but also from type
constructor variables of various arities, and includes an explicit
$\mu$-construct for type-level recursion with respect to these
variables. The class of nested types thus constructed is very robust
and includes all (truly) nested types known from the literature. In
Section~\ref{sec:type-interp} we give set and relational
interpretations for the types From Section~\ref{sec:calculus}. As is
usual when modeling parametricity, types are interpreted as functors
from environments interpreting their type variable contexts to set or
relations, as appropriate. But in order to ensure that these functors
satisfy the cocontinuity properties needed to know that the fixpoints
interpreting $\mu$-types exist, set environments must map each $k$-ary
type constructor variable to an appropriately cocontinuous $k$-ary
functor on sets and relation environments must map each $k$-ary type
constructor variable to an appropriately cocontinuous $k$-ary relation
transformer, and these cocontinuity conditions must be threaded
throughout the type interpretations in such a way that the resulting
model is guaranteed to satisfy an appropriate Identity Extension Lemma
(Theorem~\ref{thm:iel}). Properly progagating the cocontinuity
conditions turns out to be both subtle and challenging, and
Section~\ref{sec:iel}, where it is done, is where the bulk of the work
in constructing our model lies.  At the term level, our calculus
includes primitive constructs for the actions on morphisms of the
functors interpreting types, initial algebras for fixpoints of these
functors, and structured recursion over elements of these initial
algebras (i.e., $\map$, $\tin$, and $\fold$ constructs,
respectively). While our calculus does not support general recursion
at the term level, it is strongly normalizing, so does perhaps edge us
toward the kind of provably total practical programming language
proposed at the end of~\cite{wad89}. In Section~\ref{sec:term-interp},
we give set and relational interpretations for the terms of our
calculus. As usual in parametric models, terms are interpreted as
natural transformations from interpretations of the term contexts in
which they are formed to the interpretations of their types, and these
must cohere in what is essentially a fibrational way. Immediately from
the definitions of our interpretations we prove in
Section~\ref{sec:ft-nat} a scheme deriving free theorems that are
consequences of naturality of functions that are polymorphic over
nested types. This scheme is very general, is parameterized over both
the data type and the polymorphic function at hand, and has each of
the above $\mathtt{map}$-$\mathtt{reverse}$ theorems as instances. The
relationship between naturality and parametricity has long been of
interest, and our inclusion of a primitive type of natural
transformations makes it possible to clearly delineate those free
theorems that are consequences of naturality, and thus would hold even
in non-parametric models of polymorphic calculi, from those that use
the full power of parametricity to go beyond naturality. In
Section~\ref{sec:thms} we prove that our model satisfies an
Abstraction Theorem (Theorem~\ref{thm:abstraction}), and we derive
several of this latter kind of free theorem from it in
Section~\ref{sec:ftnt}. Specifically, we state and prove
(non-)inhabitation results in Sections~\ref{sec:bottom}
and~\ref{sec:identity}, a free theorem for the type of a filter
function on generalized rose trees in Section~\ref{sec:ft-adt}, the
correctness of short cut fusion for lists in
Section~\ref{sec:short-cut}, and its generaliation to nested types in
Section~\ref{sec:short-cut-nested}.

There is a long line of work on categorical models of parametricity
for System F; see, for
example,~\cite{bfss90,bm05,dr04,gjfor15,has94,jac99,mr92,rr94}.
{\color{blue} To our knowledge, all categorical models that treat
  (algebraic) data types do so via their Church encodings}, verifying
in the
%Much of this work does ultimately extend parametricity to data types
%that are modeled as fixpoints of first-order functors, but to our
%knowledge this has never been done by building the data types directly
%into the calculus whose parametricity is to be modeled
%categorically. Indeed, all extensions we know of use the categorical
%equivalent of Atkey's approach. That is, they verify in the
just-constructed parametric model that
%the Church encoding constructed
%from a type constructor is interpreted as the least fixpoint of the
%functor interpreting that type constructor.
the Church encoding of each such type is interpreted as the least
fixpoint of the (first-order) functor interpreting the type
constructor from which its Church encoding was constructed.
%This is the categorical analogue of the approach in~\cite{atk12}
%described above.
The present paper draws on this rich tradition of categorical models
of parametricity for System F, but treats nested types as well as
ADTs, and {\color{blue} is the first to} treat data types by direct
construction via primitives rather than by Church encodings. This
requires that we modify the type calculus to ensure that
%System F's full impredicative polymorphism interacts reasonably with
%functoriality,
functoriality is guaranteed syntactically, and that functoriality is
reflected in the standard model construction so that the existence of
the fixpoints by which nested types are to be interpreted is ensured.
%parametricity to primitive nested types {\em as the model is being
%constructed} by taking care to ensure that System F's full
%impredicative polymorphism does not interfere with the functoriality
%needed to support primitive nested types.

Like us, Pitts~\cite{pit98,pit00} extends parametricity from pure
System F to System F augmented with primitives for constructing data
types directly. Only list types are added in~\cite{pit00}, but other
polynomial ADTs are easily included as in~\cite{pit98}. Part of Pitts'
motivation is to show that ADTs and their Church encodings have the
same operational behavior in his system. We cannot even ask this
question about our system, which cannot express Church encodings of
even simple ADTs such as list, or pair, or sum types, since these are
not functorial; nevertheless, we do prove the correctness of short cut
fusion for nested types, whose operational analogue is the means by
which Pitts proves his equivalence result. It would be particularly
interesting to know what operational analogues of functoriality and
cocontinuity are needed to extend Pitts' parametricity results from a
calculus with primitives for constructing data types modeled as
fixpoints of first-order functors to one that also provides such
primitives for data types modeled as fixpoints of higher-order
functors.

We are not the first to consider parametricity at higher
kinds. Atkey~\cite{atk12} constructs a parametric model for full
System F$\omega$, but within the impredicative Calculus of Inductive
Constructions (iCIC) rather than in a semantic category.  Atkey's
construction is similar to ours in some ways, but he represents data
types using Church encodings rather than constructing them via
primitives. Since his model is entirely syntactic, his syntactic
``functors'', whose associated $\mathit{fmap}$ functions representing
their functorial actions must be {\em given} together with their
underlying type constructors, cannot be interpreted as semantic
functors. The associated Church encodings therefore cannot be
interpreted as their fixpoints, so Atkey need not, and does not,
impose cocontinuity conditions on his model to ensure that these
fixpoints exist. Nevertheless, he does verify the existence of initial
algebras for his ``functors'' in iCIC. Atkey does not indicate which
type constructors support the kinds of $\mathit{fmap}$ functions
needed to turn them into ``functors'', but we suspect spelling this
out would result in a full higher-kinded extension of the calculus we
present here.

\section{The Calculus}\label{sec:calculus}

\subsection{Types}

For each $k \ge 0$, we assume countable sets $\tvars^k$ of \emph{type
  constructor variables of arity $k$} and $\fvars^k$ of
\emph{functorial variables of arity $k$}, all mutually disjoint.
%disjoint for distinct $k$ and disjoint from each other.
The sets of all type constructor variables and functorial variables
are $\tvars = \bigcup_{k \ge 0} \tvars^k$ and $\fvars = \bigcup_{k \ge
  0} \fvars^k$, respectively, and a \emph{type variable} is any
element of $\tvars \cup \fvars$.  We use lower case Greek letters for
type variables, writing $\phi^k$ to indicate that $\phi \in \tvars^k
\cup \fvars^k$, and omitting the arity indicator $k$ when convenient,
unimportant, or clear from context. We reserve letters from the
beginning of the alphabet to denote type variables of arity $0$, i.e.,
elements of $\tvars^0 \cup \fvars^0$. We write $\overline{\zeta}$ for
either a set $\{\zeta_1,...,\zeta_n\}$ of type constructor variables
or a set of functorial variables when the cardinality $n$ of the set
is unimportant or clear from context. If $\Pos\,$ is a set of type
variables we write $\Pos, \overline{\phi}$ for $\Pos\, \cup
\overline{\phi}$ when $\Pos\, \cap \overline{\phi} = \emptyset$.  We
omit the vector notation for a singleton set, thus writing $\phi$,
instead of $\overline{\phi}$, for $\{\phi\}$.

\begin{dfn}
Let $V$ be a finite subset of\, $\tvars$, let $\Pos$ be a finite
subset of\, $\fvars$, let $\overline{\alpha}$ be a finite subset of\,
$\fvars^0$ disjoint from $\Pos$, and let $\phi^k \in \fvars^k
\setminus \Pos$.  The sets $\T(V)$ of {\em type constructor
  expressions} over $V$ and $\mcF^\Pos(V)$ of {\em functorial
  expressions} over $\Pos$ and $V$ are given by
\[\T(V) \; ::= \; V \mid 
   \Nat^{\ol{\alpha}} \, \mcF^{\overline{\alpha}}(V) \;
   \mcF^{\ol{\alpha}}(V) \mid V \ol{\T(V)}
\]
\noindent
and 
\begin{align*}
\mcF^\Pos(V) \; ::= \; \T(V) &\mid
\zerot \mid \onet 
\mid \Pos\; \ol{\mcF^\Pos(V)}  \,
\mid V\, \ol{\mcF^\Pos(V)}  
\mid \mcF^{\Pos}(V) + \mcF^\Pos(V)
\mid \mcF^{\Pos}(V) \times \mcF^\Pos(V)\\
&\mid \left(\mu \phi^{~k}. \lambda \alpha_1...\alpha_k. 
\mcF^{\Pos,\alpha_1,...,\alpha_k,\phi}(V)\right)
  \ol{\mcF^{\Pos}(V)}
\end{align*}
\end{dfn}
\noindent
A \emph{type} over $\Pos$ and $V$ is any element of $\T(V) \cup
\F^\Pos(V)$.

The notation for types entails that an application
$\tau\tau_1...\tau_k$ is allowed only when $\tau$ is a type variable
of arity $k$, or $\tau$ is a subexpression of the form $\mu
\phi^{k}.\lambda \alpha_1...\alpha_k.\tau'$. Moreover, if $\tau$ has
arity $k$ then $\tau$ must be applied to exactly $k$ arguments.
Accordingly, an overbar indicates a sequence of subexpressions whose
length matches the arity of the type applied to it.  The fact that
types are always in \emph{$\eta$-long normal form} avoids having to
consider $\beta$-conversion at the level of types. In a subexpression
$\Nat^{\ol{\alpha}}\sigma\,\tau$, the $\Nat$ operator binds all
occurrences of the variables in $\ol{\alpha}$ in $\sigma$ and
$\tau$. Similarly, in a subexpression $\mu \phi^k.\lambda
\ol{\alpha}.\tau$, the $\mu$ operator binds all occurrences of the
variable $\phi$, and the $\lambda$ operator binds all occurrences of
the variables in $\ol{\alpha}$, in the body $\tau$.

A {\em type constructor context} is a finite set $\Gamma$ of type
constructor variables, and a {\em functorial context} is a finite set
$\Phi$ of functorial variables. In Definition~\ref{def:wftypes}, a
judgment of the form $\Gamma;\Phi \vdash \tau : \T$ or $\Gamma;\Phi
\vdash \tau : \F$ indicates that the type $\tau$ is intended to be
functorial in the variables in $\Phi$ but not necessarily in the
variables in $\Gamma$.

\begin{dfn}\label{def:wftypes}
The formation rules for the set $\T \subseteq \bigcup_{V \subseteq
  \tvars}\T(V)$ of\, {\em well-formed type constructor expressions}
are
\[\begin{array}{cc}
\AXC{$\phantom{\Gamma;\Phi}$}
\UIC{$\Gamma,\alpha^0;\emptyset \vdash \alpha^0 : \T$}
\DisplayProof
\\
\\
\AXC{$\Gamma;\ol{\alpha^0} \vdash \sigma :
  \mcF$}
\AXC{$\Gamma;\ol{\alpha^0}  \vdash \tau : \mcF$}
\BIC{$\Gamma;\emptyset \vdash \Nat^{\ol{\alpha^0}}\sigma \,\tau : \T$}
\DisplayProof
\end{array}\]

\vspace*{0.1in}

\noindent
The formation rules for the set $\F \subseteq \bigcup_{V \subseteq
  \tvars, \Pos \subseteq \fvars}\F^\Pos(V)$ of\, {\em well-formed
  functorial expressions} are
\[\begin{array}{cccc}
\AXC{$\Gamma;\emptyset \vdash \tau : \T$}
\UIC{$\Gamma; \emptyset \vdash \tau : \F$}
\DisplayProof
&
\AXC{$\phantom{\Gamma;\Phi}$}
\UIC{$\Gamma;\Phi, \alpha^0 \vdash \alpha^0 : \F$}
\DisplayProof
&
\AXC{\phantom{$\Gamma,\Phi$}}
\UIC{$\Gamma;\Phi \vdash \zerot : \mcF$}
\DisplayProof
&
\AXC{\phantom{$\Gamma,\Phi$}}
\UIC{$\Gamma;\Phi \vdash \onet : \mcF$}
\DisplayProof
\end{array}\]
\[\begin{array}{c}
\AXC{$\phi^k \in \Gamma \cup \Phi$}
\AXC{$\quad\quad\ol{\Gamma;\Phi \vdash \tau : \mcF}$}
\BIC{$\Gamma;\Phi \vdash \phi^k \ol{\tau} : \mcF $}
\DisplayProof
\\
\AXC{$\Gamma;\Phi,\ol{\alpha},\phi^k \vdash \tau : \mcF$}
\AXC{$\quad\quad\ol{\Gamma;\Phi \vdash \tau : \mcF}$}
\BIC{$\Gamma;\Phi \vdash (\mu \phi^k.\lambda \ol{\alpha}. \,\tau)\ol{\tau} : \mcF$}
\DisplayProof
\end{array}\]
\[\begin{array}{cc}
\AXC{$\Gamma;\Phi \vdash \sigma : \mcF$}
\AXC{$\Gamma;\Phi \vdash \tau : \mcF$}
\BIC{$\Gamma; \Phi \vdash \sigma + \tau : \F$}
\DisplayProof
&
\AXC{$\Gamma;\Phi \vdash \sigma : \mcF$}
\AXC{$\Gamma;\Phi \vdash \tau : \mcF$}
\BIC{$\Gamma; \Phi \vdash \sigma \times \tau : \F$}
\DisplayProof
\end{array}\]

\vspace*{0.1in}

\noindent
A type $\tau$ is {\em well-formed} if it is either a well-formed type
constructor expression or a well-formed functorial expression.
\end{dfn}

If $\tau$ is a closed type we may write $\vdash \tau$, rather than
$\emptyset;\emptyset \vdash \tau$, for the judgment that it is
well-formed.  Definition~\ref{def:wftypes} ensures that the expected
weakening rules for well-formed types hold --- although weakening does
not change the contexts in which $\Nat$-types can be formed. If
$\Gamma;\emptyset \vdash \sigma : \T$ and $\Gamma;\emptyset \vdash
\tau : \T$, then our rules allow formation of the type
$\Gamma;\emptyset \vdash \Nat^\emptyset\sigma \,\tau$. Since a type
$\Gamma; \emptyset \vdash \Nat^{\ol \alpha}\sigma\,\tau$ represents a
natural transformation in $\ol \alpha$ from $\sigma$ to $\tau$, the
type $\Gamma;\emptyset \vdash \Nat^\emptyset\sigma \,\tau$ represents
the standard arrow type $\Gamma \vdash \sigma \to \tau$ in our
calculus. We similarly represent a standard $\forall$-type $\Gamma;
\emptyset \vdash \forall \ol\alpha . \tau$ as $\Gamma; \emptyset
\vdash \Nat^{\ol\alpha} \,\onet \,\tau :\F$ in our calculus.  However,
if $\ol\alpha$ is non-empty then $\tau$ cannot be of the form
$\Nat^{\ol\beta} H \, K$ since $\Gamma; \ol\alpha \vdash
\Nat^{\ol\beta} H \, K$ is not a valid type judgment in our calculus
(except by weakening).

Definition~\ref{def:wftypes} allows the formation of all of the
(closed) nested types from the introduction:
\[\begin{array}{lll}
\mathit{List}\, \alpha & = & \mu \beta. \,\onet + \alpha \times
\beta\; = \; (\mu \phi. \lambda \beta.\,\onet + \beta \times \phi
\beta)\,\alpha\\ 
\mathit{PTree}\,\alpha & = & (\mu \phi. \lambda \beta.\,\beta +
\phi\,(\beta \times \beta))\,\alpha\\
\mathit{Forest}\,\alpha & = & (\mu \phi. \lambda \beta. \,\onet +
\beta \times \mathit{PTree}\,(\phi \beta))\,\alpha\\ 
\mathit{Bush}\,\alpha & = & (\mu \phi.\lambda \beta. \,\onet + \beta
\times \phi\,(\phi\beta))\,\alpha 
\end{array}\]
Each of these types can be considered either functorial in $\alpha$ or
not, according to whether $\alpha \in \Gamma$ or $\alpha \in \Phi$.
%it is well-formed in the context $\emptyset;
%\alpha$ or $\alpha;\emptyset$.
For example, if $\emptyset;\alpha \vdash \mathit{List} \,\alpha$, then
the type $\vdash \Nat^\alpha \onet\, (\mathit{List}\,\alpha) : \T$ is
well-formed; if $\alpha;\emptyset \vdash \List \,\alpha$, then it is
not. If $\mathit{Tree}\,\alpha\,\gamma = \mu \,\beta.\, \alpha + \beta
\times \gamma \times \beta$, then Definition~\ref{def:wftypes} also
allows the derivation of, e.g., the type $\gamma; \emptyset \vdash
\Nat^\alpha (\mathit{List}\, \alpha) \, (\mathit{Tree} \, \alpha\,
\gamma)$ representing a natural transformation from lists to trees
that is natural in $\alpha$ but not necessarily in $\gamma$. We
emphasize that types can be functorial in variables of arity greater
than $0$. For example, the type $\mathit{GRose}\, \phi \, \alpha =
\mu\beta . \alpha \times \phi \beta$ can be functorial in $\phi$ if
$\phi \in \Phi$. As usual, whether $\phi \in \Gamma$ or $\phi \in
\Phi$ determines whether types such as $\Nat^\alpha ( \mathit{GRose}
\, \phi \, \alpha)\, (List\, \alpha)$ are well-formed. But even if
$\mathit{GRose}$ is functorial in $\phi$, it still cannot be the
(co)domain of a $\Nat$ type representing a natural transformation in
$\phi$. This is because our calculus does not allow naturality in
variables of arity greater than $0$.

Definition~\ref{def:wftypes} explicitly considers types in $\T$ to be
types in $\F$ that are functorial in no variables. This allows the
formation of types such as $\mathit{List}\,(\sigma \to \tau)$ and
$\mathit{PTree}\, (\forall \alpha.\tau)$. Functorial variables in a
well-formed type $\tau$ can also be demoted to non-functorial
status. The proof is by induction on
%the structure of
$\tau$.

\begin{lemma}
If\, $\Gamma; \Phi, \phi^k \vdash \tau : \F$, then $\Gamma, \psi^k;
\Phi \vdash \tau[\phi^k :== \psi^k] : \F$ is also derivable. Here,
$\tau[\phi :== \psi]$ is the textual replacement of $\phi$ in $\tau$,
meaning that all occurences of $\phi\ol\sigma$ in $\tau$ become
$\psi\ol\sigma$.
\end{lemma}

In addition to textual replacement, we also have a proper substitution
operation on types. If $\tau$ is a type over $P$ and $V$, if $\Pos$
and $V$ contain only type variables of arity $0$, and if $k=0$ for
every occurrence of $\phi^k$ bound by $\mu$ in $\tau$, then we say
that $\tau$ is {\em first-order}; otherwise we say that $\tau$ is {\em
  second-order}.  Substitution for first-order types is the usual
capture-avoiding textual substitution. We write $\tau[\alpha :=
  \sigma]$ for the result of substituting $\sigma$ for $\alpha$ in
$\tau$, and $\tau[\alpha_1 := \tau_1,...,\alpha_k := \tau_k]$, or
$\tau[\ol{\alpha := \tau}]$ when convenient, for $\tau[\alpha_1 :=
  \tau_1][\alpha_2 := \tau_2,...,\alpha_k := \tau_k]$. Substitution
for second-order types is defined below, where we adopt a similar
notational convention for vectors of types.


\begin{dfn}\label{def:second-order-subst}
{\color{blue} Def 4 changed again; not correct to substitute along
  non-functorial variables.}
  If $\phi^k \in \Gamma \cup \Phi$ with $k \geq 1$, if \,$\Gamma; \Phi
  \vdash F : \F$, and if\, $\Gamma;\Phi, \ol{\alpha} \vdash
  H : \F$ with $|\ol\alpha| = k$, then $\Gamma \setminus
  \phi^k;\Phi \setminus \phi^k\vdash F[\phi :=_{\ol{\alpha}}
    H] : \F$, where the operation $(\cdot)[\phi := H]$ of {\em
    second-order type substitution} is defined by:
%  If $\phi^k \in \Gamma \cup \Phi$ with $k \geq 1$, if \,$\Gamma; \Phi
%  \vdash F : \F$, and if\, $\Gamma, \ol \beta;\Phi, \ol{\alpha} \vdash
%  H : \F$ with $|\ol\alpha| + |\ol\beta| = k$, then $\Gamma \setminus
%  \phi^k;\Phi \setminus \phi^k\vdash F[\phi :=_{\ol\beta,\ol{\alpha}}
%    H] : \F$, where the operation $(\cdot)[\phi := H]$ of {\em
%    second-order type substitution} is defined by:
\[\begin{array}{lll}
(\Nat^{\ol\gamma} G \,K)[\phi :=_{\ol{\alpha}} H]
& = & \Nat^{\ol\gamma}\, (G[\phi :=_{\ol{\alpha}} H]) \,(K[\phi
  :=_{\ol{\alpha}} H]) \\
\onet[\phi :=_{\ol{\alpha}} H] & = & \onet\\[0.5ex]
\zerot[\phi :=_{\ol{\alpha}} H] & = & \zerot\\[0.25ex]
(\psi\ol{\tau})[\phi :=_{\ol{\alpha}} H] & = &
\left\{\begin{array}{ll}
\psi \,\ol{\tau[\phi :=_{\ol{\alpha}} H]} & \mbox{if } \psi \not = \phi\\
  H[\ol{\alpha  := \tau[\phi :=_{\ol{\alpha}} H]}] 
%  [\ol{\beta := \sigma[\phi :=_{\ol\beta,\ol{\alpha}} H]}]
  & \mbox{if } \psi = \phi
\end{array}\right.\\
\\[-0.25ex]
(\sigma + \tau)[\phi :=_{\ol{\alpha}} H] & = & \sigma[\phi
  :=_{\ol{\alpha}} H] + \tau[\phi :=_{\ol{\alpha}} H]\\[0.5ex] 
(\sigma \times \tau)[\phi :=_{\ol{\alpha}} H] & = &
\sigma[\phi :=_{\ol{\alpha}} H] \times \tau[\phi
  :=_{\ol{\alpha}} H]\\[0.5ex]   
((\mu \psi. \lambda \ol{\gamma}.\, G)\ol{\tau})[\phi :=_{\ol{\alpha}}
  H] & = & (\mu \psi. \lambda \ol{\gamma}. \,G[\phi :=_{\ol{\alpha}}
  H])\, \ol{\tau[\phi :=_{\ol{\alpha}} H]}
\end{array}\]
\end{dfn}
\noindent
We omit the variable subscripts in second-order type constructor
substitution when convenient.

\subsection{Terms}
We assume an infinite set $\cal V$ of term variables disjoint from
$\tvars$ and $\fvars$. If $\Gamma$ be a type constructor context and
$\Phi$ is a functorial context, then a {\em term context for $\Gamma$
  and $\Phi$} is a finite set of bindings of the form $x : \tau$,
where $x \in {\cal V}$ and $\Gamma; \Phi \vdash \tau : \F$. We adopt
the same conventions for denoting disjoint unions and for vectors in
term contexts as for type constructor contexts and functorial
contexts.

\begin{dfn}\label{def:well-formed-terms}
Let $\Delta$ be a term context for $\Gamma$ and $\Phi$.  The formation
rules for the set of\, {\em well-formed terms over $\Delta$} are
\[\begin{array}{cc}
\AXC{$\Gamma;\emptyset \vdash \tau : \T$}
\UIC{$\Gamma;\emptyset\,|\, \Delta,x :\tau \vdash x : \tau$}
\DisplayProof
&
\AXC{$\Gamma;\Phi \vdash \tau : \mcF$}
\UIC{$\Gamma;\Phi \,|\, \Delta,x :\tau \vdash x : \tau$}
\DisplayProof\\\\
\AXC{$\phantom{\Gamma;\Phi}$}
\UIC{$\Gamma;\Phi \,|\, \Delta \vdash \top : \onet$}
\DisplayProof
&
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : \zerot$}
\AXC{$\Gamma;\Phi \vdash \tau: \F$}
\BIC{$\Gamma;\Phi \,|\, \Delta \vdash \bot_\tau t  : \tau$}
\DisplayProof
\\\\
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash s: \sigma$}
\UIC{$\Gamma;\Phi \,|\, \Delta \vdash \inl \,s: \sigma + \tau$}
\DisplayProof
&
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : \tau$}
\UIC{$\Gamma;\Phi \,|\, \Delta \vdash \inr \,t: \sigma + \tau$}
\DisplayProof\\\\
\end{array}\]
\[\begin{array}{c}
\AXC{$\Gamma; \Phi \vdash \tau,\sigma : \F$}
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : \sigma + \tau$}
\AXC{$\Gamma;\Phi \,|\, \Delta, x : \sigma \vdash l : \gamma \hspace{0.3in} \Gamma;\Phi \,|\, \Delta, y : \tau \vdash r : \gamma$}
\TIC{$\Gamma;\Phi~|~\Delta \vdash \case{t}{{\color{blue} \mathsf{inl
        \,}} x \mapsto l}{{\color{blue} \mathsf{inr \,}} y \mapsto r} : \gamma$}
\DisplayProof
\end{array}\]

\vspace*{0.05in}

\[\begin{array}{lll}
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash s: \sigma$}
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : \tau$}
\BIC{$\Gamma;\Phi \,|\, \Delta \vdash (s,t) : \sigma \times \tau$}
\DisplayProof
&
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : \sigma \times \tau$}
\UIC{$\Gamma;\Phi \,|\, \Delta \vdash \pi_1 t : \sigma$}
\DisplayProof
&
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : \sigma \times \tau$}
\UIC{$\Gamma;\Phi \,|\, \Delta \vdash \pi_2 t : \tau$}
\DisplayProof
\end{array}\]

\vspace*{0.05in}

\[\begin{array}{c}
%\AXC{$\Gamma; \emptyset \vdash \Nat^{\ol{\alpha}} \,F\,G : \T$}
\AXC{$\Gamma; \ol{\alpha} \vdash F : \F$}
\AXC{$\Gamma; \ol{\alpha} \vdash G : \F$}
\AXC{$\Gamma; \ol{\alpha} \,|\, \Delta, x : F
  \vdash t: G  $} 
\TIC{$\Gamma;\emptyset \,|\, \Delta \vdash L_{\ol{\alpha}} x.t : \Nat^{\ol{\alpha}} \,F \,G$}
\DisplayProof
\\\\
\AXC{$\Gamma;\emptyset \,|\, \Delta \vdash t : \Nat^{\ol{\alpha}} \,F \,G$}
\AXC{$\ol{\Gamma;\Phi \vdash \tau : \F}$}
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash s: F[\overline{\alpha := \tau}]$}
\TIC{$\Gamma;\Phi \,|\, \Delta \vdash t_{\ol{\tau}} s:
  G[\overline{\alpha := \tau}]$}
\DisplayProof
\\\\
\AXC{$\Gamma; \ol{\phi},\ol{\gamma} \vdash H : \F$}
\AXC{$\ol{\Gamma; \ol{\beta},\ol{\gamma} \vdash F : \F}$}
\AXC{$\ol{\Gamma; \ol{\beta},\ol{\gamma} \vdash G : \F}$}
\TIC{$\Gamma;\emptyset~|~\emptyset \vdash \map^{\ol{F},\ol{G}}_H :
  \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
      :=_{\ol{\beta}} G}])$} 
\DisplayProof
\\\\
%\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : H[\phi := (\mu \phi.\lambda 
%  \ol{\alpha}.H)\ol{\beta}][\ol{\alpha := \tau}]$}
%\AXC{$\ol{\Gamma;\Phi \vdash \tau : \F}$}
\AXC{$\Gamma; \phi, \ol{\alpha},\ol{\gamma} \vdash H : \F$}
\UIC{$\Gamma;\emptyset \,|\, \emptyset \vdash \tin_H :
  \Nat^{\ol{\beta},\ol{\gamma}} H[\phi :=_{\ol{\beta}} (\mu
    \phi.\lambda \ol{\alpha}.H)\ol{\beta}][\ol{\alpha := \beta}]\,(\mu
  \phi.\lambda \ol{\alpha}.H)\ol{\beta}$}
\DisplayProof
\\\\
\AXC{$\Gamma; \phi,\ol{\alpha}, \ol{\gamma} \vdash H : \mcF$}
\AXC{$\Gamma; \ol{\beta}, \ol{\gamma} \vdash F : \F$}
%\AXC{$\Gamma;\emptyset \,|\, \Delta \vdash t :
%  \Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi :=_{\ol{\beta}} F][\ol{\alpha
%      := \beta}]\,F$} 
%\TIC{$\Gamma;\emptyset \,|\, \Delta \vdash
%  \fold_{H,F}\, t : \Nat^{\ol{\beta}, \ol{\gamma}}\,((\mu
%  \phi.\lambda \ol{\alpha}.H)\ol{\beta})\,F$} 
\BIC{$\Gamma;\emptyset \,|\, \emptyset \vdash \fold^F_H :
  \Nat^\emptyset\; (\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\; (\Nat^{\ol{\beta},
    \ol{\gamma}}\,(\mu \phi.\lambda \ol{\alpha}.H)\ol{\beta})\,F)$}
\DisplayProof
\end{array}\]
\end{dfn}

In the rule for $L_{\ol{\alpha}}x.t$, the $L$ operator binds all
occurrences of the type variables in $\ol{\alpha}$ in the type of the
term variable $x$ and in the body $t$, as well as all occurrences of
$x$ in $t$. In the rule for $t_{\ol\tau} s$ there is one functorial
expression $\tau$ for every functorial variable $\alpha$. In the rule
for $\map^{\ol{F},\ol{G}}_H$ there is one functorial expression $F$
and one functorial expression $G$ for each functorial variable in
$\ol\phi$. Moreover, for each $\phi^k \in \ol\phi$ the number of
functorial variables $\beta$ in the judgments for its corresponding
functorial expresssions $F$ and $G$ is $k$. In the rules for $\tin_H$
and $\fold^F_H$, the functorial variables in $\ol{\beta}$ are fresh
with respect to $H$, and there is one $\beta$ for every
$\alpha$. (Recall from above that, in order for the types of $\tin_H$
and $\fold^F_H$ to be well-formed, the length of $\alpha$ must equal
the arity of $\phi$.) Substitution for terms is the obvious extension
of the usual capture-avoiding textual substitution, and
Definition~\ref{def:well-formed-terms} ensures that the expected
weakening rules for well-formed terms hold.

Using Definition~\ref{def:well-formed-terms} we can represent the
$\mathtt{reversePTree}$ function from Figure~\ref{fig:funs} in our
calculus as
\[\vdash \fold_{\beta + \phi(\beta \times \beta)}^{\mathit{PTree}\,
  \alpha} \, (\tin_{\beta + \phi(\beta \times \beta)} \circ s) :
\Nat^{\alpha} (\mathit{PTree}\,\alpha)\,(\mathit{PTree}\,\alpha)\] 
where
\[\begin{array}{lll}
\vdash \fold_{\beta + \phi(\beta \times \beta)}^{\mathit{PTree}\,\alpha} &
: & \Nat^{\emptyset} (\Nat^{\alpha} (\alpha + \mathit{PTree}\,(\alpha \times
\alpha)) \; (\mathit{PTree}\,\alpha))\; (\Nat^{\alpha}
(\mathit{PTree}\,\alpha) \; (\mathit{PTree}\,\alpha))\\
\vdash \tin_{\beta + \phi(\beta \times \beta)} & : & \Nat^{\alpha}
(\alpha + \mathit{PTree}\,(\alpha \times \alpha)) \; (\mathit{PTree}\,
\alpha)\\ 
\vdash \map_{\mathit{PTree}\,\alpha}^{\alpha \times \alpha, \alpha \times
  \alpha} & : & \Nat^{\emptyset} (\Nat^{\alpha} (\alpha \times \alpha)\,
(\alpha \times \alpha))\; (\Nat^{\alpha} (\mathit{PTree}\,(\alpha \times
\alpha))\, (\mathit{PTree}\,(\alpha \times \alpha)))
\end{array}\]
and 
$\mathit{swap}$ and $s$ are the terms
\[ \vdash L_{\alpha} p.\, (\pi_2 p, \pi_1 p) :
\Nat^{\alpha} (\alpha \times \alpha)\, (\alpha \times \alpha)\]
and
\[\begin{array}{l}
\vdash L_{\alpha} t. \,\case{t}{b \mapsto \inl\, b}{t' \mapsto \inr\,(
  \map_{\mathit{PTree}\,\alpha}^{\alpha \times \alpha, \alpha \times \alpha}\,
  \mathit{swap}\, t' )} : \Nat^{\alpha} (\alpha + \mathit{PTree}\,(\alpha \times
\alpha))\; (\alpha + \mathit{PTree}\,(\alpha \times \alpha))
\end{array}\]
respectively. We can similarly represent the $\mathtt{reverseBush}$
function from Figure~\ref{fig:funs2} as
\[\vdash \fold_{\onet + \beta \times
\phi (\phi\beta)}^{\mathit{Bush}\,\alpha}\, ( \tin_{\onet + \beta \times
  \phi (\phi\beta)} \circ (\onet + t \circ i \circ i') ) :
\Nat^{\alpha} (\mathit{Bush}\,\alpha)\,(\mathit{Bush}\,\alpha)\] 
where
\[\begin{array}{lll}
\vdash \fold_{\onet + \beta \times \phi
  (\phi\beta)}^{\mathit{Bush}\,\alpha} : \Nat^{\emptyset}\, (\Nat^{\alpha}\, 
(\onet + \alpha \times \mathit{Bush}\, (\mathit{Bush}\, \alpha))) \;
(\mathit{Bush}\,\alpha))\; (\Nat^{\alpha} \,(\mathit{Bush}\,\alpha) \;
(\mathit{Bush}\,\alpha))\\ 
\vdash \tin_{\onet + \beta \times \phi (\phi\beta)} : \Nat^{\alpha}\,
(\onet + \alpha \times \mathit{Bush}\, (\mathit{Bush} \, \alpha))
\;(\mathit{Bush}\, \alpha)\\
\end{array}\]
and $\mathit{bnil}$, $\mathit{bcons}$, $\tin^{-1}_{\onet + \beta
  \times \phi (\phi\beta)}$, $t$, $i$, and 
$i'$ are the terms
\[\begin{array}{l}
\vdash \tin_{\onet + \beta \times \phi (\phi\beta)} \circ (
L_{\alpha}\, x.\, \inl\, x) \; : \; \Nat^{\alpha}\, \onet\;
(\mathit{Bush}\,\alpha)\\ 
\vdash \tin_{\onet + \beta \times \phi (\phi\beta)} \circ (
L_{\alpha}\, x.\, \inr\, x ) \; : \; \Nat^{\alpha}\, (\alpha \times
\mathit{Bush}\,(\mathit{Bush}\,\alpha))\; (\mathit{Bush}\,\alpha)\\
\vdash \fold_{\onet + \beta \times \phi (\phi\beta)}^{(\onet + \beta
  \times \phi (\phi\beta))[\phi := \mathit{Bush}\,\alpha]}\,
(\map_{\onet + \beta \times \phi (\phi\beta)}^{(\onet + \beta \times
  \phi (\phi\beta))[\phi := \mathit{Bush}\,\alpha][\beta := \alpha],
  \mathit{Bush}\,\alpha}\, \tin_{\onet + \beta \times \phi
  (\phi\beta)})\\
\hspace*{0.2in} : \Nat^{\alpha}\, (\mathit{Bush}\,\alpha)\; (\onet +
\alpha \times \mathit{Bush}\,(\mathit{Bush}\,\alpha))\\ 
\vdash L_{\alpha}\, (b, s). \,\mathsf{case}\;s\, \{ \hspace*{0.21in}\ast \mapsto
\mathit{bcons}_{\alpha}\, b\, (\mathit{bnil}_{\alpha}\, \ast); \\
\hspace*{1in}(s', u) \mapsto \mathsf{case}\;s' \{\hspace*{0.35in}\ast
\mapsto \mathit{bcons}_{\alpha}\, b \,(\mathit{bcons}_{\mathit{Bush}\,
  \alpha}\, (\mathit{bnil}_{\alpha}\, \ast)\, u); \\
\hspace*{2in} (b', u') \mapsto \mathit{bcons}_{\alpha}\, b'
(\mathit{bcons}_{\mathit{Bush}\, \alpha}\, (\mathit{bcons}_{\alpha}\,
b\, u )\, u')\}\}\\
\hspace{0.2in} : \Nat^{\alpha} (\alpha \times (\onet + (\onet + \alpha
\times \mathit{Bush}\, (\mathit{Bush} \, \alpha))) \times
\mathit{Bush}\, (\mathit{Bush} \, (\mathit{Bush}\, \alpha))) \;
(\alpha \times \mathit{Bush}\, (\mathit{Bush} \, \alpha))\\
\vdash \alpha \times (\onet + \tin^{-1}_{\onet + \beta \times \phi
  (\phi\beta)} \times \mathit{Bush}\, (\mathit{Bush} \,
(\mathit{Bush}\, \alpha)))\\
\hspace{0.2in} : \Nat^{\alpha} (\alpha \times (\onet + \mathit{Bush}
\, \alpha \times \mathit{Bush}\,( \mathit{Bush} \, (\mathit{Bush}\,
\alpha))))\\
\hspace*{0.57in}(\alpha \times (\onet + (\onet + \alpha \times
\mathit{Bush}\, (\mathit{Bush} \, \alpha)) \times \mathit{Bush}\,
(\mathit{Bush} \, (\mathit{Bush}\, \alpha))))\\
\vdash \alpha \times (L_{\alpha}\,x.\, (\tin^{-1}_{\onet +
  \beta \times \phi (\phi\beta)})_{\mathit{Bush}\,\alpha}\, x)\\
\hspace{0.2in} : \Nat^{\alpha} (\alpha
\times \mathit{Bush} \, (\mathit{Bush}\, \alpha)) \; (\alpha \times (\onet
+ \mathit{Bush} \, (\alpha \times \mathit{Bush}\, (\mathit{Bush} \,
(\mathit{Bush}\, \alpha)))))
\end{array}\]
respectively. Here, $\Gamma; \emptyset \,|\, \Delta \vdash \sigma +
\eta : \Nat^{\ol{\alpha}} (\sigma + F)\; (\sigma + G)$ and $\Gamma;
\emptyset \,|\, \Delta \vdash \sigma \times \eta : \Nat^{\ol{\alpha}}
(\sigma \times F)\; (\sigma \times G)$ for $\sigma + \eta :=
L_{\ol{\alpha}}\, x.\, \case{x}{s \mapsto \inl\, s}{t \mapsto \inr\,
  (\eta_{\ol{\alpha}} t)}$ and $\sigma \times \eta := L_{\ol{\alpha}}\,
x.\, (\pi_1 x, \eta_{\ol{\alpha}} (\pi_2 x))$ for $\Gamma; \emptyset
\,|\, \Delta \vdash \eta : \Nat^{\ol{\alpha}} F\; G$ and $\Gamma;
\ol{\alpha} \vdash \sigma : \F$.

Because our system is designed to ensure functoriality, and ensuring
functoriality does not interact with polymorphism as well as might be
hoped, our system cannot express nontrivial recursive functions, such
as a concatenation function for perfect trees,
%$\mathtt{combine} : \mathtt{PTree}\, \alpha \to \mathtt{PTree}
%\,\alpha \to \mathtt{PTree}\, \alpha$
that take not just one nested type functorial in a variable $\alpha$
as input, but other inputs functorial in $\alpha$ as well. The
fundamental issue is that recursion is expressible only via folds. A
fold over a nested type must take a natural transformation as an
argument and return a natural transformation, but the polymorphism
natural transformations entail leaves no nontrivial way to incorporate
data from the second argument to a function with a type like that
above into a fold over its first argument. Currying the type also does
not help, because the codomain of a fold applied to an algebra
%--- and thus of the function so expressed ---
must be a functor, and this clearly is not the case for a function
that takes more than one input involving the same type variable.  Even
some recursive functions of a single non-algebraic nested type ---
e.g., a $\mathtt{reverseBush}$ function that is a true involution ---
cannot be expressed as folds because the algebra arguments needed to
define them are themselves recursive functions
%  cannot be defined. This happens, for
%  example, when the algebra argument to a fold must be a recursive
%  function
%, and thus must itself be defined as a fold
whose type signatures have the same problematic form discussed above.
More sophisticated combinators for stylized recursion (e.g.,
generalized folds)
%  ~\cite{bp99})
don't mitigate these difficulties, either. Indeed, they appear to be a
fundamental consequence of the interaction of functoriality and
polymorphism, not just some peculiarity of our particular calculus.

The presence of the ``extra'' functorial variables in $\ol{\gamma}$ in
the rules for $\map^{\ol{F},\ol{G}}_H$, $\tin_H$, and $\fold^F_H$ also
merit special mention. They allows us to map or fold polymorphic
functions over nested types. Consider, for example, the function
$\mathit{flatten} : \Nat^\beta
(\mathit{PTree}\,\beta)\,(\mathit{List}\,\beta)$ that maps perfect
trees to lists. Even in the absence of extra variables the instance of
$\map$ required to map each non-functorial monomorphic instantiation
of $\mathit{flatten}$ over a list of perfect trees is well-typed:
\[\begin{array}{l}
\AXC{$\Gamma;\alpha \vdash \mathit{List} \, \alpha$}
\AXC{$\Gamma;\emptyset \vdash \sigma \hspace*{0.3in} \Gamma;\emptyset
  \vdash \tau$}
\AXC{$\Gamma;\emptyset \vdash \mathit{PTree}\,\sigma \hspace*{0.3in}
  \Gamma;\emptyset \vdash \mathit{List}\,\tau$}
\TIC{$\Gamma;\emptyset \,|\, \emptyset \vdash
  \map^{\mathit{PTree}\,\sigma, \,\mathit{List}\,\tau}_{\mathit{List}\,\alpha} :
  \Nat^\emptyset\;(\Nat^\emptyset\,(\mathit{PTree}\,
  \sigma)\,(\mathit{List}\, \tau))\; (\Nat^\emptyset\,(\mathit{List}\,
  (\mathit{PTree}\, \sigma))\,(\mathit{List}\, (\mathit{List}\,
  \tau)))$}
\DisplayProof
\end{array}\]
But in the absence of $\ol \gamma$, the instance
\[\Gamma;\emptyset \,|\, \emptyset \vdash
\map^{\mathit{PTree}\,\beta,\mathit{List}\,\beta}_{\mathit{List}\,\alpha}
: \Nat^\emptyset\;(\Nat^\beta(\mathit{PTree}\,
\beta)\,(\mathit{List}\, \beta))\; (\Nat^\beta\,(\mathit{List}\,
(\mathit{PTree}\, \beta))\,(\mathit{List}\, (\mathit{List}\,
\beta)))\] of $\mathtt{map}$ required to map the {\em polymorphic}
$\mathit{flatten}$ function over a list of perfect trees is not: in
that setting the functorial contexts for $F$ and $G$ in the rule for
$\map^{F,G}_H$ would have to be empty, but the fact that the
polymorphic $\mathit{flatten}$ function is functorial in some
variable, say $\delta$, means that it cannot possibly have a type of
the form $\Nat^\emptyset F\, G$ that would be required for it to be
the function input to $\map$. Since untypeability of this instance of
$\map$ is unsatisfactory in a polymorphic calculus, where we naturally
expect to be able to manipulate entire polymorphic functions rather
than just their monomorphic instances, we use the ``extra'' variables
in $\ol \gamma$ to remedy the situation. Specifrically, the rules from
Definition~\ref{def:well-formed-terms} ensure that the instance of
$\map$ needed to map the polymorphic $\mathit{flatten}$ function is
typeable as follows:
\[\begin{array}{l}
\AXC{$\Gamma;\alpha,\beta \vdash \mathit{List} \, \alpha$}
\AXC{$\Gamma;\beta \vdash \mathit{PTree}\,\beta \hspace*{0.3in}
  \Gamma;\beta \vdash \mathit{List}\,\beta$}
\BIC{$\Gamma;\emptyset \,|\, \emptyset \vdash
  \map^{F,G}_{\mathit{List}} :
  \Nat^\emptyset\;(\Nat^\beta(\mathit{PTree}\,
  \beta)\,(\mathit{List}\, \beta))\; (\Nat^\beta\,(\mathit{List}\,
  (\mathit{PTree}\, \beta))\,(\mathit{List}\, (\mathit{List}\,
  \beta)))$}
\DisplayProof
\end{array}\]
Similar remarks explain the appearance of $\ol \gamma$ in the typing
rules for $\tin$ and $\fold$.


\vspace*{0.05in}

\section{Interpreting Types}\label{sec:type-interp}

We denote the category of sets and functions by $\set$. The category
$\rel$ has as its objects triples $(A,B,R)$ where $R$ is a relation
between the objects $A$ and $B$ in $\set$, i.e., a subset of $A \times
B$, and has as its morphisms from $(A,B,R)$ to $(A',B',R')$ pairs $(f
: A \to A',g : B \to B')$ of morphisms in $\set$ such that $(f a,g\,b)
\in R'$ whenever $(a,b) \in R$. We write $R : \rel(A,B)$ in place of
$(A,B,R)$ when convenient.  If $R : \rel(A,B)$ we write $\pi_1 R$ and
$\pi_2 R$ for the {\em domain} $A$ of $R$ and the {\em codomain} $B$
of $R$, respectively.  If $A : \set$, then we write $\Eq_A =
(A,A,\{(x,x)~|~ x \in A\})$ for the {\em equality relation} on $A$.

The key idea underlying Reynolds' parametricity is to give each type
$\tau(\alpha)$ with one free variable $\alpha$ both an {\em object
  interpretation} $\tau_0$ taking sets to sets and a \emph{relational
  interpretation} $\tau_1$ taking relations $R : \rel(A,B)$ to
relations $\tau_1 (R) : \rel(\tau_0 (A), \tau_0 (B))$, and to
interpret each term $t(\alpha,x) : \tau(\alpha)$ with one free term
variable $x : \sigma(\alpha)$ as a map $t_0$ associating to each set
$A$ a function $t_0(A) : \sigma_0(A) \to \tau_0(A)$. These
interpretations are to be given inductively on the structures of
$\tau$ and $t$ in such a way that they imply two fundamental
theorems. The first is an \emph{Identity Extension Lemma}, which
states that $\tau_1(\Eq_A) = \Eq_{\tau_0(A)}$, and is the essential
property that makes a model relationally parametric rather than just
induced by a logical relation. The second is an \emph{Abstraction
  Theorem}, which states that, for any $R :\rel(A, B)$,
$(t_0(A),t_0(B))$ is a morphism in $\rel$ from
$(\sigma_0(A),\sigma_0(B),\sigma_1(R))$ to
$(\tau_0(A),\tau_0(B),\tau_1(R))$. The Identity Extension Lemma is
similar to the Abstraction Theorem except that it holds for {\em all}
elements of a type's interpretation, not just those that are
interpretations of terms.
%i.e., $t_0(A)$ and $t_0(B)$ map related arguments to
%related results.
Similar results are expected to hold for types and terms with any
number of free variables.

The key to proving the Identity Extension Lemma
(Theorem~\ref{thm:iel}) in our setting is a familiar ``cutting down''
of the interpretations of universally quantified types, such as our
$\Nat$-types, to include only the ``parametric'' elements.
%(See, e.g.,~\cite{atk12,bfss90,gjfor15,rey83}).
This requires that set interpretations of types are defined
simultaneously with their relational interpretations. We give set
interpretations for our types in Section~\ref{sec:set-interp} and give
their relational interpretations in Section~\ref{sec:rel-interp}.
While the set interpretations are relatively straightforward, their
relation interpretations are less so, mainly because of the
cocontinuity conditions we must impose to ensure that they are
well-defined. We take some effort to develop conditions in
Section~\ref{sec:rel-interp}, which separates
Definitions~\ref{def:set-sem} and~\ref{def:rel-sem} in space, but
otherwise has no impact on the fact that they are given by mutual
induction.

\subsection{Interpreting Types as Sets}\label{sec:set-interp}

%A poset $\mcD = (D,\leq)$ is \emph{$\omega$-directed} if every finite
%subset of $D$ has an upper bound. When $\mcD$ is considered as a
%category, we write $d \in \mcD$ to indicate that $d$ is an object of
%$\mcD$ (i.e., $d \in D$). An {\em $\omega$-directed colimit} in a
%category $\mcC$ is a colimit of a diagram $F : {\mathcal D} \to \mcC$,
%where $\mathcal D$ is an $\omega$-directed poset. A category $\mcC$ is
%{\em $\omega$-cocomplete} if it has all $\omega$-directed colimits. A
%cocomplete category is one that has all colimits.
%
%If $\mcA$ and $\mcC$ are $\omega$-cocomplete, then the functor $F :
%\mcA \to \mcC$ is {\em $\omega$-cocontinuous} if it preserves
%$\omega$-directed colimits.  If $\mcA$ is locally small, then an
%object $A$ of $\mcA$ is {\em finitely presentable} if the functor
%$\mathsf{Hom}_\mcA(A, -) : \mcA \to \Set$ preserves $\omega$-directed
%colimits, i.e., if for every $\omega$-directed poset $\mathcal D$ and
%every functor $F : {\mathcal D} \to \mcC$, there is a canonical
%isomorphism $\colim{d \in \mcD}{\mathsf{Hom}_\mcA(A,Fd)} \simeq
%\mathsf{Hom}_{\mcA}(A, \colim{d \in \mcD}{Fd})$. A category $\mcA$ is
%       {\em finitely accessible} if it is $\omega$-cocomplete and has
%       a set $\mcA_0$ of finitely presentable objects such that every
%%       object is an $omega$-directed colimit of objects in $\mcA_0$;
%       it is {\em locally finitely presentable} if it is finitely
%       accessible and cocomplete.
We will interpret the types in our calculus as $\omega$-cocontinuous
functors on locally finitely presentable categories~\cite{ar94}. Since
functor categories of locally finitely presentable categories are
again locally finitely presentable, this will ensure, in particular,
that the fixed points interpreting $\mu$-types in $\set$ and $\rel$
exist, and thus that both the set and relational interpretations of
all of the types in Definition~\ref{def:wftypes} are
well-defined~\cite{jp19}. To bootstrap this process, we interpret type
variables themselves as $\omega$-cocontinuous functors in
Definitions~\ref{def:set-env} and~\ref{def:reln-env}. If $\C$ and $\D$
are locally finitely presentable categories, we write $[\C,\D]$ for
the set of $\omega$-cocontinuous functors from $\C$ to $\D$.
%Note that the categories $\set$ and $\rel$ are both locally finitely
%presentable.

\begin{dfn}\label{def:set-env}
A {\em set environment} maps each type variable in $\tvars^k \cup
\fvars^k$ to an element of $[\set^k,\set]$.  A morphism $f : \rho \to
\rho'$ for set environments $\rho$ and $\rho'$ with $\rho|_\tvars =
\rho'|_\tvars$ maps each type constructor variable $\psi^k \in \tvars$
to the identity natural transformation on $\rho \psi^k = \rho'\psi^k$
and each functorial variable $\phi^k \in \fvars$ to a natural
transformation from the $k$-ary functor $\rho \phi^k$ on $\set$ to the
$k$-ary functor $\rho' \phi^k$ on $\set$.  Composition of morphisms on
set environments is given componentwise, with the identity morphism
mapping each set environment to itself. This gives a category of set
environments and morphisms between them, which we denote $\setenv$.
\end{dfn}
When convenient we identify a functor $F : [\set^0, \set]$ with the
set that is its codomain and consider a set environment to map
a type variable of arity $0$ to
%an $\omega$-cocontinuous functor from $\set^0$ to $\set$, i.e., to
a set.  If $\ol{\alpha} = \{\alpha_1,...,\alpha_k\}$ and $\ol{A} =
\{A_1,...,A_k\}$, then we write $\rho[\ol{\alpha := A}]$ for the set
environment $\rho'$ such that $\rho' \alpha_i = A_i$ for $i = 1,...,k$
and $\rho' \alpha = \rho \alpha$ if $\alpha \not \in
\{\alpha_1,...,\alpha_k\}$.  If $\rho$ is a set environment we write
$\Eq_\rho$ for the relation environment (see
Definition~\ref{def:reln-env}) such that $\Eq_\rho v = \Eq_{\rho v}$
for every type variable $v$.
%; see Definition~\ref{def:reln-env} for the complete definition of a
%relation environment.
The relational interpretations appearing in the second clause of
Definition~\ref{def:set-sem} are given in full in
Definition~\ref{def:rel-sem}.

\begin{dfn}\label{def:set-sem}
%Let $\rho$ be a set environment.
The {\em set interpretation} $\setsem{\cdot} : \F \to [\setenv, \set]$
is defined by
\begin{align*}
  \setsem{\Gamma;\emptyset \vdash v} \rho &= \rho v \mbox{
    if } v \in \tvars^0 \\ 
  \setsem{\Gamma;\emptyset \vdash \Nat^{\ol{\alpha}}
    \,F\,G}\rho &= \{\eta : \lambda \ol{A}. \,\setsem{\Gamma; \ol{\alpha} \vdash
    F}\rho[\ol{\alpha := A}] 
      \Rightarrow \lambda \ol{A}.\,\setsem{\Gamma;\ol{\alpha} \vdash
        G}\rho[\ol{\alpha := A}] \\ 
      &\hspace{0.3in}|~\forall \overline{A}, \overline{B} :
      \set. \forall \overline{R : \rel(A, B)}.\\ 
      &\hspace{0.4in}(\eta_{\overline{A}}, \eta_{\overline{B}})
      : \relsem{\Gamma; \ol{\alpha} \vdash F}\Eq_{\rho}[\ol{\alpha := R}]
      \rightarrow \relsem{\Gamma;\ol{\alpha} \vdash
        G}\Eq_{\rho}[\ol{\alpha := R}] \} \\
  \setsem{\Gamma;\Phi \vdash \zerot}\rho &= 0\\
  \setsem{\Gamma;\Phi \vdash \onet}\rho &= 1\\
  \setsem{\Gamma;\Phi \vdash \phi\ol{\tau}}\rho &=
  (\rho\phi)\,\ol{\setsem{\Gamma;\Phi \vdash
    \tau}\rho}\\
  \setsem{\Gamma;\Phi \vdash \sigma+\tau}\rho &=
  \setsem{\Gamma;\Phi \vdash \sigma}\rho +
  \setsem{\Gamma;\Phi \vdash \tau}\rho\\
  \setsem{\Gamma;\Phi \vdash \sigma\times \tau}\rho &=
  \setsem{\Gamma;\Phi \vdash \sigma}\rho \times
  \setsem{\Gamma;\Phi \vdash \tau}\rho\\ 
  \setsem{\Gamma;\Phi \vdash (\mu \phi.\lambda
    \ol{\alpha}. H)\ol{\tau}}\rho &= (\mu
    T^\set_{H,\rho})\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho}\\
    \text{where } T^\set_{H,\rho}\,F & = \lambda
  \ol{A}. \setsem{\Gamma;\Phi,\phi, \ol{\alpha} \vdash
    H}\rho[\phi :=  F][\ol{\alpha := A}]\\
  \text{and } T^\set_{H,\rho}\,\eta &= \lambda
  \ol{A}. \setsem{\Gamma;\Phi,\phi, \ol{\alpha} \vdash
    H}\id_\rho[\phi := \eta][\ol{\alpha := \id_{A}}]
\end{align*}
\end{dfn}
The interpretations in Definition~\ref{def:set-sem} respect weakening,
i.e., a type and its weakenings have the same set interpretations.
The same holds for the actions of these interpretations on morphisms
in Definition~\ref{def:set-sem-funcs} below.
%= \setsem{\Gamma \vdash \sigma} \rho \to
%\setsem{\Gamma \vdash \tau} \rho$, as expected {\color{blue} by IEL}.
If $\rho$ is a set environment and $\vdash \tau : \F$ then we may
write $\setsem{\vdash \tau}$ instead of $\setsem{\vdash \tau}\rho$
since the environment is immaterial. We note that the second clause of
Definition~\ref{def:set-sem} does indeed define a set: local finite
presentability of $\set$ and $\omega$-cocontinuity of
$\setsem{\Gamma;\ol{\alpha} \vdash F}\rho$ ensure that $\{\eta :
\setsem{\Gamma;\ol{\alpha} \vdash F}\rho \Rightarrow
\setsem{\Gamma;\ol{\alpha} \vdash G}\rho\}$ (which contains
$\setsem{\Gamma;\emptyset \vdash \Nat^{\ol{\alpha}}\,F\,G}\rho$) is a
subset of $\big\{({\setsem{\Gamma;\ol{\alpha} \vdash G}\rho[\ol{\alpha
      := S}]})^{(\setsem{\Gamma;\ol{\alpha} \vdash F}\rho[\ol{\alpha
      := S}])}~\big|~ \ol{S} = (S_1,...,S_{|\ol{\alpha}|}), \mbox{ and
}$ $S_i \mbox{ is a finite set for } i =
1,...,|\ol{\alpha}|\big\}$. There are countably many choices for
tuples $\ol{S}$, and each of these gives rise to a morphism from
${\setsem{\Gamma;\ol{\alpha} \vdash F}\rho[ \ol{\alpha := S}]}$ to
${\setsem{\Gamma;\ol{\alpha} \vdash G}\rho[\ol{\alpha := S}]}$. But
there are only $\set$-many choices of morphisms between any
%these (or any)
two objects since $\set$ is locally small. Finally, interpretations of $\Nat$
types in Definitions~\ref{def:set-sem} and~\ref{def:rel-sem} ensure
$\setsem{\Gamma \vdash \sigma \to \tau}$ and $\setsem{\Gamma \vdash
  \forall \alpha. \tau}$ are as expected in any parametric model.

In order to make sense of the last clause in
Definition~\ref{def:set-sem}, we need to know that, for each $\rho \in
\setenv$, $T^\set_{H,\rho}$ is an $\omega$-cocontinuous endofunctor on
$[\set^k, \set]$, and thus admits a fixed point.  Since
$T_{H,\rho}^\set$ is defined in terms of $\setsem{\Gamma;\Phi,\phi,
  \ol{\alpha} \vdash H}$, this means that interpretations of types
must be such functors, which in turn means that the actions of set
interpretations of types on objects and on morphisms in $\setenv$ are
intertwined. Fortunately, we know from~\cite{jp19} that, for every
$\Gamma; \ol{\alpha} \vdash \tau : \F$, $\setsem{\Gamma; \ol{\alpha}
  \vdash \tau}$ is actually in $[\set^k,\set]$ where $k = |\ol
\alpha|$. This means that for each $\setsem{\Gamma; \Phi, \phi^k,
  \ol{\alpha} \vdash H}$, the corresponding operator $T^\set_{H}$ can
be extended to a {\em functor} from $\setenv$ to
$[[\set^k,\set],[\set^k,\set]]$. The action of $T^\set_H$ on an object
$\rho \in \setenv$ is given by the higher-order functor
$T_{H,\rho}^\set$, whose actions on objects (functors in $[\set^k,
  \set]$) and morphisms (natural transformations between such
functors) are given in Definition~\ref{def:set-sem}. Its action on a
morphism $f : \rho \to \rho'$ is the higher-order natural
transformation $T^\set_{H,f} : T^\set_{H,\rho} \to T^\set_{H,\rho'}$
whose action on $F : [\set^k,\set]$ is the natural transformation
$T^\set_{H,f}\, F : T^\set_{H,\rho}\,F \to T^\set_{H,\rho'}\,F$ whose
component at $\ol{A}$ is $(T^\set_{H,f}\, F)_{\ol{A}} =
\setsem{\Gamma; \Phi,\phi,\ol{\alpha} \vdash H}f[\phi :=
  \id_F][\ol{\alpha := \id_A}]$. The next definition uses the functor
$T^\set_H$ to define the actions of functors interpreting types on
morphisms between set environments.

\begin{dfn}\label{def:set-sem-funcs}
Let $f: \rho \to \rho'$ for set environments $\rho$ and $\rho'$ (so
that $\rho|_\tvars = \rho'|_\tvars$). The action $\setsem{\Gamma;\Phi
  \vdash \tau}f$ of\, $\setsem{\Gamma;\Phi \vdash \tau}$ on the
morphism $f$ is given as follows:
\begin{itemize}
\item If \,$\Gamma,v;\emptyset \vdash v$ then
  $\setsem{\Gamma,v;\emptyset \vdash v}f = \id_{\rho v}$
\item If \,$\Gamma; \emptyset \vdash \Nat^{\ol{\alpha}}\,F\,G$ then
  $\setsem{\Gamma;\emptyset \vdash \Nat^{\ol{\alpha}}\,F\,G} f =
  \id_{\setsem{\Gamma;\emptyset \vdash \Nat^{\ol{\alpha}}\,F\,G}\rho}$
\item If \,$\Gamma;\Phi \vdash \zerot$ then $\setsem{\Gamma;\Phi \vdash
  \zerot}f = \id_0$
\item If \,$\Gamma;\Phi \vdash \onet$ then $\setsem{\Gamma;\Phi \vdash
  \onet}f = \id_1$
\item If \,$\Gamma;\Phi \vdash \phi \ol{\tau}$ then
  $\setsem{\Gamma;\Phi \vdash \phi \ol{\tau}} f : \setsem{\Gamma;\Phi
  \vdash \phi \ol{\tau}}\rho \to \setsem{\Gamma;\Phi \vdash
  \phi\ol{\tau}}\rho' = (\rho\phi) \ol{\setsem{\Gamma;\Phi \vdash
    \tau}\rho} \to (\rho'\phi) \ol{\setsem{\Gamma;\Phi \vdash
    \tau}\rho'}$ is defined by $\setsem{\Gamma;\Phi \vdash \phi
  \ol{\tau}} f = (f\phi)_{\ol{\setsem{\Gamma;\Phi \vdash
      \tau}\rho'}}\, \circ\, (\rho\phi) {\ol{\setsem{\Gamma;\Phi
      \vdash \tau}f}} = (\rho'\phi) {\ol{\setsem{\Gamma;\Phi \vdash
      \tau}f}}\, \circ\, (f \phi)_{\ol{\setsem{\Gamma;\Phi \vdash
      \tau}\rho}}$.  The latter equality holds because $\rho\phi$ and
  $\rho'\phi$ are functors and $f\phi : \rho\phi \to \rho'\phi$ is a
  natural transformation, so the following naturality square commutes:
{\footnotesize\begin{equation}\label{eq:cd2}
\begin{CD}
  (\rho\phi) \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho} @> (f\phi)_{
    \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho}} >> (\rho'\phi)
  \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho} \\ @V(\rho\phi)
  \ol{\setsem{\Gamma;\Phi \vdash \tau}f}VV @V (\rho'\phi)
  \ol{\setsem{\Gamma;\Phi \vdash \tau}f} VV \\ (\rho\phi)
  \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho'} @>(f\phi)_{
    \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho'}}>> (\rho'\phi)
  \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho'}
\end{CD}
\end{equation}}
\item If\, $\Gamma;\Phi \vdash \sigma + \tau$ then $\setsem{\Gamma;\Phi
  \vdash \sigma + \tau}f$ is defined by $\setsem{\Gamma;\Phi \vdash
  \sigma + \tau}f(\inl\,x) = \inl\,(\setsem{\Gamma;\Phi \vdash
  \sigma}f x)$ and $\setsem{\Gamma;\Phi \vdash \sigma +
  \tau}f(\inr\,y) = \inr\,(\setsem{\Gamma;\Phi \vdash \tau}f y)$.
\item If \,$\Gamma;\Phi\vdash \sigma \times \tau$ then
  $\setsem{\Gamma;\Phi \vdash \sigma \times \tau}f = 
  \setsem{\Gamma;\Phi \vdash \sigma}f \times \setsem{\Gamma;\Phi \vdash
    \tau}f$.
\item If \,$\Gamma;\Phi \vdash (\mu \phi.\lambda
  \ol{\alpha}. H)\ol{\tau}$ then $ \setsem{\Gamma;\Phi \vdash (\mu
    \phi.\lambda \ol{\alpha}. H)\ol{\tau}} f : \setsem{\Gamma;\Phi
    \vdash (\mu \phi.\lambda \ol{\alpha}. H)\ol{\tau}} \rho \to
  \setsem{\Gamma;\Phi \vdash (\mu
    \phi.\lambda\ol{\alpha}. H)\ol{\tau}} \rho'$ $ = (\mu
  T^\set_{H,\rho})\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho} \to (\mu
  T^\set_{H,\rho'})\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho'}$ is
  defined by $ (\mu T^\set_{H,f})\ol{\setsem{\Gamma;\Phi \vdash
      \tau}\rho'} \circ (\mu T^\set_{H,\rho})\ol{\setsem{\Gamma;\Phi
      \vdash \tau}f}$ $= (\mu T^\set_{H,\rho'})\ol{\setsem{\Gamma;\Phi
      \vdash \tau}f} \circ (\mu T^\set_{H,f})\ol{\setsem{\Gamma;\Phi
      \vdash \tau}\rho}$.  The latter equality holds because $\mu
  T^\set_{H,\rho}$ and $\mu T^\set_{H,\rho'}$ are functors and $\mu
  T_{H,f}^\set : \mu T_{H,\rho}^\set \to \mu T_{H,\rho'}^\set$ is a
  natural transformation, so the following naturality square commutes:
{\footnotesize\begin{equation}\label{eq:cd3}
\begin{CD}
 (\mu T^\set_{H,\rho}) \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho} @> (\mu
  T^\set_{H,f})_{\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho}} >> (\mu
  T^\set_{H,\rho'}) \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho} \\ 
 @V(\mu T^\set_{H,\rho}) \ol{\setsem{\Gamma;\Phi \vdash \tau}f}VV @V  (\mu
 T^\set_{H,\rho'}) \ol{\setsem{\Gamma;\Phi \vdash \tau}f} VV \\ 
(\mu T^\set_{H,\rho}) \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho'} @>(\mu
 T^\set_{H,f})_{\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho'}}>> (\mu
 T^\set_{H,\rho'}) \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho'}
\end{CD}
\end{equation}}
\end{itemize}
\end{dfn}

\subsection{Interpreting Types as Relations}\label{sec:rel-interp}

\begin{dfn}\label{def:rel-transf}
A {\em $k$-ary relation transformer} $F$ is a triple $(F^1, F^2,F^*)$,
where $F^1,F^2 : [\set^k,\set]$ are functors, $F^* : [\rel^k, \rel]$
is a functor, if $R_1:\rel(A_1,B_1),...,R_k:\rel(A_k,B_k)$, then $F^*
\ol{R} : \rel(F^1 \ol{A}, F^2 \ol{B})$, and if $(\alpha_1, \beta_1)
\in \Homrel(R_1,S_1),..., (\alpha_k, \beta_k) \in \Homrel(R_k,S_k)$
then $F^* \ol{(\alpha, \beta)} = (F^1 \ol{\alpha}, F^2 \ol{\beta})$.
We define $F\ol{R}$ to be $F^*\overline{R}$ and
$F\overline{(\alpha,\beta)}$ to be $F^*\overline{(\alpha,\beta)}$.
\end{dfn}
The last clause of Definition~\ref{def:rel-transf} expands to: if
$\ol{(a,b) \in R}$ implies $\ol{(\alpha\,a,\beta\,b) \in S}$ then
$(c,d) \in F^*\ol{R}$ implies $(F^1 \ol{\alpha}\,c,F^2 \ol{\beta}\,d)
\in F^*\ol{S}$. When convenient we identify a $0$-ary relation
transformer $(A,B,R)$ with $R : \rel(A,B)$. We may also write $\pi_1
F$ for $F^1$ and $\pi_2 F$ for $F^2$. We extend these conventions to
relation environments, introduced in Definition~\ref{def:reln-env}
below, in the obvious way.

\begin{dfn}
The category $RT_k$ of $k$-ary relation transformers is given by the
following data:
\begin{itemize}
\item An object of $RT_k$ is a relation transformer.
\item A morphism $\delta : (G^1,G^2,G^*) \to (H^1,H^2,H^*)$ in $RT_k$
  is a pair of natural transformations $(\delta^1, \delta^2)$ where
  $\delta^1 : G^1 \to H^1$, $\delta^2 : G^2 \to H^2$ such that, for
  all $\ol{R : \rel(A, B)}$, if $(x, y) \in G^*\ol{R}$ then
  $(\delta^1_{\ol{A}}x, \delta^2_{\ol{B}}y) \in H^*\ol{R}$.
%  {\color{blue} Comment that this is basically a fibred natural
%    transformation, but for heterogeneous relations.}
\item Identity morphisms and composition are inherited from the
  category of functors on $\set$.
\end{itemize}
\end{dfn}

\begin{dfn}\label{def:RT-functor}
An endofunctor $H$ on $RT_k$ is a triple $H = (H^1,H^2,H^*)$, where
\begin{itemize}
\item $H^1$ and $H^2$ are functors from $[\set^k,\set]$ to $[\set^k,\set]$
\item $H^*$ is a functor from $RT_k$ to $[\rel^k,\rel]$
\item for all $\overline{R : \rel(A,B)}$,
  $\pi_1((H^*(\delta^1,\delta^2))_{\overline{R}}) = (H^1
  \delta^1)_{\overline{A}}$ and
  $\pi_2((H^*(\delta^1,\delta^2))_{\overline{R}}) = (H^2
  \delta^2)_{\overline{B}}$
\item The action of $H$ on objects is given by $H\,(F^1,F^2,F^*) =
  (H^1F^1,\,H^2F^2,\,H^*(F^1,F^2,F^*))$
\item The action of $H$ on morphisms is given by
  $H\,(\delta^1,\delta^2) = (H^1\delta^1,H^2\delta^2)$ for
  $(\delta^1,\delta^2) : (F^1,F^2,F^*)\to (G^1,G^2,G^*)$
\end{itemize}
\end{dfn}
Since the results of applying an endofunctor $H$ to $k$-ary relation
transformers and morphisms between them must again be $k$-ary relation
transformers and morphisms between them, respectively,
Definition~\ref{def:RT-functor} implicitly requires that the following
three conditions hold:\,{\em i})
if $R_1:\rel(A_1,B_1),...,R_k:\rel(A_k,B_k)$, then
  $H^*(F^1,F^2,F^*) \ol{R} : \rel(H^1F^1 \ol{A}, H^2F^2 
  \ol{B})$;
  %In other words, $\pi_1 (H^*(F^1,F^2,F^*) \ol{R}) = H^1F^1
  %\ol{A}$ and $\pi_2 (H^*(F^1,F^2,F^*) \ol{R}) = H^2F^2 \ol{B}$.
{\em ii}) if $(\alpha_1, \beta_1) \in \Homrel(R_1,S_1),..., (\alpha_k,
  \beta_k) \in \Homrel(R_k,S_k)$, then
  $H^*(F^1,F^2,F^*)\, \ol{(\alpha, \beta)} = (H^1F^1\ol{\alpha}, H^2F^2
  \ol{\beta})$; and
  %In other words, $\pi_1 (H^*(F^1,F^2,F^*) \ol{(\alpha,
  %  \beta)}) = H^1F^1 \ol{\alpha}$ and $\pi_2 (H^*(F^1,F^2,F^*) 
  % \ol{(\alpha, \beta)}) = H^2F^2 \ol{\beta}$.  {\em iii}) if
  $(\delta^1,\delta^2) : (F^1,F^2,F^*)\to (G^1,G^2,G^*)$ and
  $R_1:\rel(A_1,B_1),...,R_k:\rel(A_k,B_k)$, then
  $((H^1\delta^1)_{\ol{A}}x, (H^2\delta^2)_{\ol{B}}y) \in
  H^*(G^1,G^2,G^*)\ol{R}$ whenever $(x, y) \in
  H^*(F^1,F^2,F^*)\ol{R}$. Note, however, that this last condition is
  automatically satisfied because it is implied by the third bullet
  point of Definition~\ref{def:RT-functor}.

\begin{dfn}\label{def:RT-nat-trans}
If $H$ and $K$ are endofunctors on $RT_k$, then a {\em natural
  transformation} $\sigma : H \to K$ is a pair $\sigma = (\sigma^1,
\sigma^2)$, where $\sigma^1 : H^1 \to K^1$ and $\sigma^2 : H^2 \to
K^2$ are natural transformations between endofunctors on
$[\set^k,\set]$ and the component of $\sigma$ at $F
%= (F^1,F^2,F^*)
\in RT_k$ is given by $\sigma_F = (\sigma^1_{F^1}, \sigma^2_{F^2})$.
\end{dfn}
Definition~\ref{def:RT-nat-trans} entails that $\sigma^i_{F^i}$ must
be natural in $F^i : [\set^k,\set]$, and, for every $F$, both
$(\sigma^1_{F^1})_{\overline{A}}$ and
$(\sigma^2_{F^2})_{\overline{A}}$ must be natural in $\overline{A}$.
Moreover, since the results of applying $\sigma$ to $k$-ary relation
transformers must be morphisms of $k$-ary relation transformers,
Definition~\ref{def:RT-nat-trans} implicitly requires that
$(\sigma_F)_{\overline{R}} = ( (\sigma^1_{F^1})_{\overline{A}},
(\sigma^2_{F^2})_{\overline{B}})$ is a morphism in $\rel$ for any
$k$-tuple of relations $\overline{R : \rel(A, B)}$, i.e., that if $(x,
y) \in H^*F\overline{R}$, then $((\sigma^1_{F^1})_{\overline{A}} x,
(\sigma^2_{F^2})_{\overline{B}} y) \in K^*F\overline{R}$.

\vspace*{0.1in}

%{\color{blue} More context? Weave cocontinuity requirement for fixed
%  points through text better.}
Critically, we can compute $\omega$-directed colimits in $RT_k$: it is
not hard to see that if $\cal D$ is an $\omega$-directed set then
$\colim{d \in {\cal D}}{(F^1_d, F^2_d,F^*_d)} = (\colim{d \in {\cal
    D}}{F^1_d}, \colim{d \in {\cal D}}{F^2_d}, \colim{d \in {\cal
    D}}{F^*_d})$.  We define an endofunctor $T = (T^1,T^2,T^*)$ on
$RT_k$ to be {\em $\omega$-cocontinuous} if $T^1$ and $T^2$ are
$\omega$-cocontinuous endofunctors on $[\set^k,\set]$ and $T^*$ is an
$\omega$-cocontinuous functor from $RT_k$ to $[\rel^k,\rel]$, i.e., is
in $[RT_k,[\rel^k,\rel]]$.
%\begin{lemma}\label{lem:colimits}
%$\colim{d \in {\cal D}}{(F^1_d, F^2_d,F^*_d)} = (\colim{d \in {\cal
%      D}}{F^1_d}, \colim{d \in {\cal D}}{F^2_d}, \colim{d \in {\cal
%      D}}{F^*_d})$
%\end{lemma}
%\begin{proof}
%We first observe that $(\colim{d \in {\cal D}}{F^1_d}, \colim{d \in
%  {\cal D}}{F^2_d}, \colim{d \in {\cal D}}{F^*_d})$ is in $RT_k$.  If
%$R_1:\rel(A_1,B_1),...,R_k:\rel(A_k,B_k)$, then $\colim{d \in \cal
%  D}{F^*_d\ol{R}} : \rel(\colim{d \in {\cal D}}{F^1_d\ol{A}},
%\,\colim{d \in {\cal D}}{F^2_d\ol{B}})$ because of how colimits are
%computed in $\rel$. Moreover, if $(\alpha_1, \beta_1) \in
%\Homrel(R_1,S_1),..., (\alpha_k, \beta_k) \in \Homrel(R_k,S_k)$, then
%\[\begin{array}{ll}
%  & (\colim{d \in \cal D}{F_d^*})\ol{(\alpha,\beta)}\\
%= & \colim{d \in \cal D}{F_d^*\ol{(\alpha,\beta)}}\\
%= & \colim{d \in \cal D}{(F_d^1\ol{\alpha},\, F_d^2\ol{\beta})}\\
%= & (\colim{d \in \cal D}{F^1_d \ol{\alpha}}, \,\colim{d \in \cal D}{
%  F^2_d \ol{\beta}})
%\end{array}\]
%so $(\colim{d \in {\cal D}}{F^1_d}, \colim{d \in {\cal D}}{F^2_d},
%\colim{d \in {\cal D}}{F^*_d})$ actually is in $RT_k$.
%
%Now to see that $\colim{d \in {\cal D}}{(F^1_d, F^2_d,F^*_d)} =
%(\colim{d \in {\cal D}}{F^1_d}, \colim{d \in {\cal D}}{F^2_d},
%\colim{d \in {\cal D}}{F^*_d})$, let $\gamma^1_d : F^1_d \to \colim{d
%  \in {\cal D}}{F^1_d}$ and $\gamma^2_d : F^2_d \to \colim{d \in {\cal
%    D}}{F^2_d}$ be the injections for the colimits $\colim{d \in {\cal
%    D}}{F^1_d}$ and $\colim{d \in {\cal D}}{F^2_d}$,
%respectively. Then $(\gamma^1_d, \gamma^2_d) : (F^1_d, F^2_d,F^*_d)
%\to \colim{d \in {\cal D}}{(F^1_d, F^2_d,F^*_d)}$ is a morphism in
%$RT_k$ because, for all $\ol{R : \rel(A, B)}$,
%$((\gamma^1_d)_{\ol{A}}, (\gamma^2_d)_{\ol{B}}) : F^*_d \ol{R} \to
%\colim{d \in {\cal D}}{F^*_d \ol{R}}$ is a morphism in $\rel$. So
%$\{(\gamma^1_d, \gamma^2_d)\}_{d \in {\cal D}}$ are the mediating
%morphisms of a cocone in $RT_k$ with vertex $\colim{d \in {\cal
%    D}}{(F^1_d, F^2_d,F^*_d)}$. To see that this cocone is a
%colimiting cocone, let $C = (C^1,C^2,C^*)$ be the vertex of a cocone
%for $\{(F^1_d,F^2_d,F^*_d)\}_{d \in {\cal D}}$ with injections
%$(\delta^1_d,\delta^2_d) : (F^1_d,F^2_d,F^*_d) \to C$. If $\eta^1 :
%\colim{d \in {\cal D}}{F^1_d} \to C^1$ and $\eta^2 : \colim{d \in
%  {\cal D}}{F^2_d} \to C^2$ are the mediating morphisms in
%$[\set^k,\set]$, then $\eta^1$ and $\eta^2$ are unique such that
%$\delta^1_d = \eta^1 \circ \gamma^1_d$ and $\delta^2_d = \eta^2 \circ
%\gamma^2_d$.  We therefore have that $(\eta^1,\eta^2) : \colim{d \in
%  {\cal D}}{(F^1_d, F^2_d,F^*_d)} \to C$ is the mediating morphism in
%$RT_k$. Indeed, for all $\ol{R : \rel(A,B)}$ and $(x,y) \in \colim{d
%  \in {\cal D}}{F^*_d \ol{R}}$, there exist $d$ and $(x',y') \in
%F^*_d\ol{R}$ such that $(\gamma^1_d)_{\ol{A}}x' = x$ and
%$(\gamma^2_d)_{\ol{B}}y' = y$. But then $(\eta^1_{\ol{A}}x,
%\eta^2_{\ol{B}}y) = (\eta^1_{\ol{A}}((\gamma^1_d)_{\ol{A}}x'),
%\eta^2_{\ol{B}}((\gamma^2_d)_{\ol{B}}y')) = ((\delta^1_d)_{\ol{A}}x',
%(\delta^2_d)_{\ol{B}}y')$, and this pair is in $C^*\ol{R}$ because
%$(\delta^1_d, \delta^2_d)$ is a morphism from $(F^1_d,F^2_d,F^*_d)$ to
%$C$ in $RT_k$.
%\end{proof}
\begin{comment}
\begin{dfn}\label{def:omega-cocont}
An endofunctor $T = (T^1,T^2,T^*)$ on $RT_k$ is {\em
$\omega$-cocontinuous} if $T^1$ and $T^2$ are $\omega$-cocontinuous
endofunctors on $[\set^k,\set]$ and $T^*$ is an $\omega$-cocontinuous
functor from $RT_k$ to $[\rel^k,\rel]$, i.e., is in
$[RT_k,[\rel^k,\rel]]$.
\end{dfn}
\end{comment}
Now, for any $k$, any $A : \set$, and any $R : \rel(A, B)$, let
$K^\set_A$ be the constantly $A$-valued functor from $\set^k$ to
$\set$ and $K^\rel_R$ be the constantly $R$-valued functor from
$\rel^k$ to $\rel$.  Also let $0$ denote either the initial object of
$\set$ or the initial object of $\rel$, as appropriate.  Observing
that, for every $k$, $K^\set_0$ is initial in $[\set^k,\set]$, and
$K^\rel_0$ is initial in $[\rel^k,\rel]$, we have that, for each $k$,
$K_0 = (K^\set_0,K^\set_0,K^\rel_0)$ is initial in $RT_k$. Thus, if $T
= (T^1,T^2,T^*) : RT_k \to RT_k$ is an endofunctor on $RT_k$ then we
can define the relation transformer $\mu T$ to be $\colim{n \in
  \nat}{T^n K_0}$.
%Then Lemma~\ref{lem:colimits} shows $\mu T$ is indeed a relation
%transformer, and that it is given explicitly by
It is not hard to see that $\mu T$ is given explicitly as 
\begin{equation}\label{eq:mu}
  %\colim{n \in \nat}{T^n K_0}
  \mu T = (\mu T^1,\mu T^2,
\colim{n \in \nat}{(T^nK_0)^*})
\end{equation}
and that, as our notation suggests, it really is a fixpoint for $T$ if
$T$ is $\omega$-cocontinuous:
\begin{lemma}\label{lem:fp}
For any $T : [RT_k,RT_k]$, $\mu T \cong T(\mu T)$.
\end{lemma}
\noindent
The isomorphism is given by the morphisms $(in_1, in_2) : T(\mu T)
\to \mu T$ and $(in_1^{-1}, in_2^{-1}) : \mu T \to T(\mu T)$ in
$RT_k$. The latter is always a morphism in $RT_k$, but the
former need not be if $T$ is not $\omega$-cocontinuous.

\begin{comment}
\begin{proof}
We have $T(\mu T) = T(\colim{n \in \nat}{(T^nK_0)}) \cong \colim{n \in
\nat}{T(T^nK_0)} =
\mu T$.
\end{proof}
In fact, the isomorphism in Lemma~\ref{lem:fp} is given by the
morphisms $(in_1, in_2) : T(\mu T) \to \mu T$ and $(in_1^{-1},
in_2^{-1}) : \mu T \to T(\mu T)$ in $RT_k$. It is worth noting that the
latter is always a morphism in $RT_k$, but the former isn't necessarily
a morphism in $RT_k$ unless $T$ is $\omega$-cocontinuous.
\end{comment}

{\color{blue} It is worth noting that the third component in
  Equation~(\ref{eq:mu}) is the colimit in $[\rel^k,\rel]$ of third
  components of relation transformers, rather than a fixpoint of an
  endofunctor on $[\rel^k,\rel]$. That there is an asymmetry between
  the first two components of $\mu T$ and its third is an important
  conceptual observation, and reflects the fact that the third
  component of an endofunctor on $RT_k$ need not be a functor on all
  of $[\rel^k,\rel]$. In particular, although we can define
  $T_{H,\rho}\, F$ for a relation transformer $F$ in
  Definition~\ref{def:rel-sem} below, it is not clear how we could
  define it for $F : [\rel^k,\rel]$.}

\begin{dfn}\label{def:reln-env}
A {\em relation environment} maps each each type variable in $\tvars^k
\cup \fvars^k$ to a $k$-ary relation transformer.  A morphism $f :
\rho \to \rho'$ for relation environments $\rho$ and $\rho'$ with
$\rho|_\tvars = \rho'|_\tvars$ maps each type constructor variable
$\psi^k \in \tvars$ to the identity morphism on $\rho \psi^k = \rho'
\psi^k$ and each functorial variable $\phi^k \in \fvars$ to a morphism
from the $k$-ary relation transformer $\rho \phi$ to the $k$-ary
relation transformer $\rho' \phi$. Composition of morphisms on
relation environments is given componentwise, with the identity
morphism mapping each relation environment to itself. This gives a
category of relation environments and morphisms between them, which we
denote $\relenv$.
\end{dfn}
When convenient we identify a $0$-ary relation transformer with the
relation (transformer) that is its codomain and consider
% With this convention,
a relation environment to map a type variable of arity $0$
%to a $0$-ary relation transformer, i.e.,
to a relation.  We write $\rho[\ol{\alpha := R}]$ for the relation
environment $\rho'$ such that $\rho' \alpha_i \, = R_i$ for $i =
1,...,k$ and $\rho' \alpha = \rho\alpha$ if $\alpha \not \in
\{\alpha_1,...,\alpha_k\}$.  If $\rho$ is a relation environment, we
write $\pi_1 \rho$ and $\pi_2 \rho$ for the set environments mapping
each type variable $\phi$ to the functors $(\rho\phi)^1$ and
$(\rho\phi)^2$, respectively.

We define, for each $k$, the notion of an $\omega$-cocontinuous
functor from $\relenv$ to $RT_k$:
\begin{dfn}\label{def:relenv-functor}
A functor $H : [\relenv, RT_k]$ is a triple $H = (H^1,H^2,H^*)$,
where
\begin{itemize}
\item $H^1$ and $H^2$ are objects in $[\setenv,[\set^k,\set]]$
\item $H^*$ is a an object in $[\relenv,[\rel^k,\rel]]$
\item for all $\overline{R : \rel(A,B)}$ and morphisms $f$ in
  $\relenv$, $\pi_1(H^*f \,{\overline{R}}) = H^1 (\pi_1
  f)\,{\overline{A}}$ and $\pi_2(H^*f \,{\overline{R}}) = H^2 (\pi_2
  f)\,{\overline{B}}$
\item The action of $H$ on $\rho$ in $\relenv$ is given by $H \rho = (H^1
  (\pi_1 \rho),\,H^2 (\pi_2 \rho),\,H^*\rho)$
\item The action of $H$ on morphisms $f : \rho \to \rho'$ in $\relenv$
  is given by $Hf = (H^1 (\pi_1 f),H^2 (\pi_2 f))$
\end{itemize}
\end{dfn}
\noindent Spelling out the last two bullet points above gives the
following analogues of the three conditions immediately following
Definition~\ref{def:RT-functor}: {\em i}) if $R_1 :
\rel(A_1,B_1),...,R_k : \rel(A_k,B_k)$, then $H^*\rho\, \ol{R} :
\rel(H^1(\pi_1 \rho)\, \ol{A}, H^2(\pi_2 \rho)\, \ol{B})$;
%In other words, $\pi_1 (H^*\rho \ol{R}) = H^1(\pi_1 \rho)
%  \,\ol{A}$ and $\pi_2 (H^*\rho \ol{R}) = H^2 (\pi_2 \rho) \,\ol{B}$;
{\em ii}) if $(\alpha_1, \beta_1) \in \Homrel(R_1,S_1),..., (\alpha_k,
\beta_k) \in \Homrel(R_k,S_k)$, then $H^*\rho\, \ol{(\alpha, \beta)} =
(H^1(\pi_1 \rho)\,\ol{\alpha}, H^2(\pi_2 \rho)\, \ol{\beta})$;
%  In other words, $\pi_1 (H^*\rho\, \ol{(\alpha, \beta)}) = H^1(\pi_1
%  \rho)\,\ol{\alpha}$ and $\pi_2 (H^*\rho\, \ol{(\alpha, \beta)}) =
%  H^2(\pi_2 \rho)\,\ol{\beta}$;
and {\em iii}) if $f : \rho \to \rho'$ and
$R_1:\rel(A_1,B_1),...,R_k:\rel(A_k,B_k)$, then $(H^1(\pi_1
f)\,{\ol{A}}\,x, H^2(\pi_2 f)\,{\ol{B}}\,y) \in H^*\rho'\,\ol{R}$
whenever $(x, y) \in H^*\rho\,\ol{R}$. As before, the last
condition is automatically satisfied because it is implied by the
third bullet point of Definition~\ref{def:relenv-functor}.

Considering $\relenv$ as a product $\Pi_{\phi^k \in \tvars \cup
  \fvars} RT_k$, we extend the computation of $\omega$-directed
colimits in $RT_k$ to compute colimits in $\relenv$ componentwise. We
similarly extend the notion of an $\omega$-cocontinuous endofunctor on
$RT_k$ componentwise to give a notion of $\omega$-cocontinuity for
functors from $\relenv$ to $RT_k$.  Recalling from the start of this
subsection that Definition~\ref{def:rel-sem} is given mutually
inductively with Definition~\ref{def:set-sem} we can, at last, define:

\begin{dfn}\label{def:rel-sem}
%Let $\rho$ be a relation environment.
The {\em relational interpretation} $\relsem{\cdot} : \F \to [\relenv,
  \rel]$ is defined by
\begin{align*}
  \relsem{\Gamma;\emptyset \vdash v}\rho &= \rho v \mbox{ if
  } v \in \tvars^0 \\ 
  \relsem{\Gamma;\emptyset \vdash \Nat^{\ol{\alpha}}
    \,F\,G}\rho &= \{\eta : \lambda \ol{R}.\,\relsem{\Gamma;
      \ol{\alpha} \vdash F}\rho[\ol{\alpha := R}] \Rightarrow \lambda
  \ol{R}. \,\relsem{
      \Gamma;\ol{\alpha} \vdash G}\rho[\ol{\alpha := R}]\}\\
  &=
  \{(t,t') \in \setsem{\Gamma;\emptyset \vdash \Nat^{\ol{\alpha}}
    \,F\,G} (\pi_1 \rho) \times \setsem{ 
      \Gamma;\emptyset \vdash \Nat^{\ol{\alpha}} \,F\,G} (\pi_2
  \rho)~|~\\ 
  & \hspace{0.3in} \forall {R_1 : \rel(A_1,B_1)}\,...\,{R_k : \rel(A_k,B_k)}.\\
  & \hspace{0.4in} (t_{\ol{A}},t'_{\ol{B}}) \in
  (\relsem{\Gamma;\ol{\alpha} \vdash G}\rho[\ol{\alpha :=
      R}])^{\relsem{\Gamma;\ol{\alpha}\vdash F}\rho[\ol{\alpha := R}]} \}\\  
  % exponential in $\rel$
%  &= \{(t,t') \in \setsem{\Gamma;\emptyset \vdash \Nat^{
%      \ol{\alpha}} \,F\,G} (\pi_1 \rho) \times 
%  \setsem{\Gamma;\emptyset \vdash \Nat^{\ol{\alpha}} \,F\,G}
%  (\pi_2 \rho)~|~\\ 
%  & \hspace{0.3in} \forall {R_1 : \rel(A_1,B_1)}\,...\,{R_k : \rel(A_k,B_k)}.\\
%  & \hspace{0.4in} \forall (a,b) \in \relsem{\Gamma;
%      \ol{\alpha} \vdash F}\rho[\ol{\alpha := R}].\\
%  & \hspace*{0.5in}  (t_{\ol{A}}a,t'_{\ol{B}}b) \in \relsem{
%      \Gamma; \ol{\alpha} \vdash G}\rho[\ol{\alpha := R}] \}\\
  \relsem{\Gamma;\Phi \vdash \zerot}\rho &= 0\\
  \relsem{\Gamma;\Phi \vdash \onet}\rho &= 1\\
  \relsem{\Gamma;\Phi \vdash \phi \ol{\tau}}\rho &=
  (\rho\phi)\ol{\relsem{\Gamma;\Phi \vdash 
    \tau}\rho}\\
  \relsem{\Gamma;\Phi \vdash \sigma+\tau}\rho &=
  \relsem{\Gamma;\Phi \vdash \sigma}\rho +
  \relsem{\Gamma;\Phi \vdash \tau}\rho\\
  \relsem{\Gamma;\Phi \vdash \sigma\times \tau}\rho &=
  \relsem{\Gamma;\Phi \vdash \sigma}\rho \times
  \relsem{\Gamma;\Phi \vdash \tau}\rho\\  
   \relsem{\Gamma;\Phi \vdash (\mu \phi.\lambda
    \ol{\alpha}. H)\ol{\tau}}\rho
  &= (\mu T_{H,\rho})\ol{\relsem{\Gamma;\Phi \vdash
     \tau}\rho}\\
  \text{where }	T_{H,\rho}
    &= (T^\set_{H,\pi_1\rho}, T^\set_{H,\pi_2\rho}, T^\rel_{H,\rho}) \\
  \text{and } T^\rel_{H,\rho}\,F
    &= \lambda \ol{R}. \relsem{
      \Gamma;\Phi,\phi,\ol{\alpha} \vdash H}\rho[\phi :=
    F][\ol{\alpha := R}]\\
  \text{and } T^\rel_{H,\rho}\,\delta
    &= \lambda \ol{R}. \relsem{
      \Gamma;\Phi,\phi,\ol{\alpha} \vdash H}\id_\rho[\phi :=
    \delta][\ol{\alpha := \id_{\ol{R}}}]
\end{align*}
\end{dfn}

The interpretations in Definition~\ref{def:rel-sem}, as well as in
Definition~\ref{def:rel-sem-funcs} below, respect weakening, and also
ensure that $\relsem{\Gamma \vdash \forall \alpha. \tau}$ are as
expected in any parametric model.
%$\relsem{\Gamma \vdash
%  \sigma \to \tau}\rho = \relsem{\Gamma \vdash \sigma} \rho \to
%\relsem{\Gamma \vdash \tau} \rho$.
If $\rho$ is a relational environment and $\vdash \tau : \F$, then we
write $\relsem{\vdash \tau }$ instead of $\relsem{\vdash \tau }\rho$
as for set interpretations.  For the last clause in
Definition~\ref{def:rel-sem} to be well-defined we need $T_{\rho}$ to
be an $\omega$-cocontinuous endofunctor on $RT$ so that, by
Lemma~\ref{lem:fp}, it admits a fixed point. Since $T_\rho$ is defined
in terms of $\relsem{\Gamma;\Phi,\phi^k, \ol{\alpha} \vdash H}$, this
means that relational interpretations of types must be
$\omega$-cocontinuous functors from $\relenv$ to $RT_0$, which in turn
entails that the actions of relational interpretations of types on
objects and on morphisms in $\relenv$ are intertwined. As for set
interpretations, we know from~\cite{jp19} that, for every $\Gamma;
\ol{\alpha} \vdash \tau : \F$, $\setsem{\Gamma; \ol{\alpha} \vdash
  \tau}$ is actually in $[\rel^k,\rel]$ where $k = |\ol \alpha|$.
%In fact, we already know from~\cite{jp19} that, for every $\Gamma;
%\ol{\alpha} \vdash \tau : \F$, $\relsem{\Gamma; \ol{\alpha} \vdash
%  \tau}$ is actually functorial in $\ol{\alpha}$ and
%$\omega$-cocontinuous.
We first define the actions of each of these functors on morphisms
between environments in Definition~\ref{def:rel-sem-funcs}, and then
argue that the functors given by Definitions~\ref{def:rel-sem}
and~\ref{def:rel-sem-funcs} are well-defined and have the required
properties. To do this, we extend $T_H$ to a {\em functor} from
$\relenv$ to $[[\rel^k,\rel],[\rel^k,\rel]]$. Its action on an object
$\rho \in \relenv$ is given by the higher-order functor
$T^\rel_{H,\rho}$ whose actions on objects and morphisms are given in
Definition~\ref{def:rel-sem-funcs}. Its action on a morphism $f : \rho
\to \rho'$ is the higher-order natural transformation $T_{H,f} :
T_{H,\rho} \to T_{H,\rho'}$ whose action on any $F : [\rel^k,\rel]$ is
the natural transformation $T_{H,f}\, F : T_{H,\rho}\, F \to
T_{H,\rho'}\, F$ whose component at $\ol{R}$ is $(T_{H,f}\,
F)_{\ol{R}} = \relsem{\Gamma; \Phi,\phi,\ol{\alpha} \vdash H}f[\phi :=
  \id_F][\ol{\alpha := \id_R}]$.  The next definition uses the functor
$T_H$ to define the actions of functors interpreting types on
morphisms between relation environments.
    
\begin{dfn}\label{def:rel-sem-funcs}
Let $f: \rho \to \rho'$ for relation environments $\rho$ and $\rho'$
(so that $\rho|_\tvars = \rho'|_\tvars$). The action
$\relsem{\Gamma;\Phi \vdash \tau}f$ of $\relsem{\Gamma;\Phi \vdash
  \tau}$ on the morphism $f$ is given as follows:
\begin{itemize}
\item If $\Gamma,v;\emptyset \vdash v$ then
  $\relsem{\Gamma,v;\emptyset \vdash v}f = \id_{\rho v}$
\item If $\Gamma; \emptyset \vdash \Nat^{\ol{\alpha}}\,F\,G$, then
  $\relsem{\Gamma;\emptyset \vdash \Nat^{\ol{\alpha}}\,F\,G} f =
  \id_{\relsem{\Gamma;\emptyset \vdash \Nat^{\ol{\alpha}}\,F\,G}\rho}$
\item If $\Gamma;\Phi \vdash \zerot$ then $\relsem{\Gamma;\Phi \vdash
  \zerot}f = \id_0$
\item If $\Gamma;\Phi \vdash \onet$ then $\relsem{\Gamma;\Phi \vdash
  \onet}f = \id_1$
\item If $\Gamma;\Phi \vdash \phi \ol{\tau}$, then
  $\relsem{\Gamma;\Phi \vdash \phi \ol{\tau}} f : \relsem{\Gamma;\Phi
  \vdash \phi \ol{\tau}}\rho \to \relsem{\Gamma;\Phi \vdash \phi
  \ol{\tau}}\rho' = (\rho\phi) \ol{\relsem{\Gamma;\Phi \vdash
    \tau}\rho} \to (\rho'\phi) \ol{\relsem{\Gamma;\Phi \vdash
    \tau}\rho'}$ is defined by $\relsem{\Gamma;\Phi \vdash \phi
  \tau{A}} f = (f\phi)_{\ol{\relsem{\Gamma;\Phi \vdash \tau}\rho'}}
  \,\circ\, (\rho\phi) \ol{\relsem{\Gamma;\Phi \vdash \tau}f} =
  (\rho'\phi) \ol{\relsem{\Gamma;\Phi \vdash \tau}f} \,\circ\, (f
  \phi)_{\ol{\relsem{\Gamma;\Phi \vdash \tau}\rho}}$
\item If $\Gamma;\Phi\vdash \sigma + \tau$ then $\relsem{\Gamma;\Phi
  \vdash \sigma + \tau}f$ is defined by $\relsem{\Gamma;\Phi \vdash
  \sigma + \tau}f(\inl\,x) = \inl\,(\relsem{\Gamma;\Phi \vdash
  \sigma}f x)$ and $\relsem{\Gamma;\Phi \vdash \sigma +
  \tau}f(\inr\,y) = \inr\,(\relsem{\Gamma;\Phi \vdash \tau}f y)$
\item If $\Gamma;\Phi\vdash \sigma \times \tau$ then
  $\relsem{\Gamma;\Phi \vdash \sigma \times \tau}f =
  \relsem{\Gamma;\Phi \vdash \sigma}f \times \relsem{\Gamma;\Phi
    \vdash \tau}f$
\item If $\Gamma;\Phi \vdash (\mu \phi^k.\lambda
  \ol{\alpha}. H)\ol{\tau}$ then $\relsem{\Gamma;\Phi \vdash (\mu
    \phi.\lambda \ol{\alpha}. H)\ol{\tau}} f = (\mu
  T_{H,f})\ol{\relsem{\Gamma;\Phi \vdash \tau}\rho'} \circ (\mu
  T_{H,\rho})\ol{\relsem{\Gamma;\Phi \vdash \tau}f} = (\mu
  T_{H,\rho'})\ol{\relsem{\Gamma;\Phi \vdash \tau}f} \circ (\mu
  T_{H,f})\ol{\relsem{\Gamma;\Phi \vdash \tau}\rho}$
\end{itemize}
\end{dfn}

To see that the functors given by Definitions~\ref{def:rel-sem}
and~\ref{def:rel-sem-funcs} are well-defined we must show that, for
every $H$, $T_{H,\rho}\,F$ is a relation transformer for any relation
transformer $F$, and that $T_{H,f}\, F : T_{H,\rho}\, F \to
T_{H,\rho'}\, F$ is a morphism of relation transformers for every
relation transformer $F$ and every morphism $f : \rho \to \rho'$ in
$\relenv$. This is an immediate consequence of 
\begin{lemma}\label{lem:rel-transf-morph}
%The interpretations in Definitions~\ref{def:rel-sem}
%and~\ref{def:rel-sem-funcs} are well-defined and,
For every $\Gamma;\Phi \vdash \tau$, $\sem{\Gamma;\Phi \vdash \tau} =
(\setsem{\Gamma;\Phi \vdash \tau}, \setsem{\Gamma;\Phi \vdash
  \tau},\relsem{\Gamma;\Phi \vdash \tau}) \in
%is an $\omega$-cocontinuous functor from $\relenv$ to $RT_0$, i.e., is an
%element of
[\relenv,RT_0]$.
\end{lemma}
\noindent
The proof is a straightforward induction on the structure of $\tau$,
%%each case of which first shows that $(\setsem{\Gamma;\Phi \vdash
%  \tau}, \setsem{\Gamma;\Phi \vdash \tau},\relsem{\Gamma;\Phi \vdash
%  \tau})$ is indeed a functor from $\relenv$ to $RT_0$, and then uses
using an appropriate result from~\cite{jp19} to deduce
$\omega$-cocontinuity of $\sem{\Gamma;\Phi \vdash \tau}$ in each case,
together with Lemma~\ref{lem:fp} and Equation~\ref{eq:mu} in the
$\mu$-case.

\begin{comment}
\begin{proof}
By induction on the structure of $\tau$. The only interesting cases
are when $\tau = \phi\ol{\tau}$ and when $\tau = (\mu \phi^k. \lambda
\overline{\alpha}. H)\overline{\tau}$. We consider each in turn.

\begin{itemize}
\item When $\tau = \Gamma; \Phi \vdash \phi\ol{\tau}$, we have    
\[\begin{array}{ll}
  & \pi_i (\relsem{\Gamma; \Phi \vdash \phi\ol{\tau}}\rho)\\
= & \pi_i ((\rho \phi)\overline{\relsem{\Gamma; \Phi \vdash \tau}\rho})\\
= & (\pi_i (\rho \phi)) (\pi_i(\overline{\relsem{\Gamma; \Phi \vdash \tau}\rho}))\\
= & ((\pi_i \rho) \phi) (\overline{\setsem{\Gamma; \Phi \vdash
    \tau}(\pi_i \rho)})\\
= & \setsem{\Gamma; \Phi \vdash \phi\ol{\tau}}(\pi_i \rho)
\end{array}\]
and, for $f : \rho \to \rho'$ in $\relenv$,
\[\begin{array}{ll}
  & \pi_i (\relsem{\Gamma; \Phi \vdash \phi\ol{\tau}}f)\\
= & \pi_i ((f\phi)_{\overline{\relsem{\Gamma; \Phi \vdash \tau}\rho'}})
\circ \pi_i((\rho\phi)({\overline{\relsem{\Gamma; \Phi \vdash \tau}f}}))\\
= & (\pi_i (f\phi))_{\overline{\pi_i (\relsem{\Gamma; \Phi \vdash \tau}\rho')}}
\circ (\pi_i(\rho\phi))({\overline{\pi_i (\relsem{\Gamma; \Phi \vdash \tau}f}}))\\
= & ((\pi_i f)\phi)_{\overline{\setsem{\Gamma; \Phi \vdash \tau}(\pi_i\rho')}}
\circ ((\pi_i\rho)\phi)({\overline{\setsem{\Gamma; \Phi \vdash \tau}(\pi_i f)}})\\
= & \setsem{\Gamma; \Phi \vdash \phi\ol{\tau}}(\pi_i f)
\end{array}\]
The third equalities of each of the above derivations are by the
induction hypothesis. That $\sem{\Gamma; \Phi \vdash
  \phi\ol{\tau}}$ is $\omega$-cocontinuous is an immediate
consequence of the facts that $\set$ and $\rel$ are locally finitely
presentable, together with Corollary~12 of~\cite{jp19}.
\item When $\tau = (\mu \phi. \lambda
  \overline{\alpha}. H)\overline{\tau}$ we first show that $\sem{ (\mu
    \phi. \lambda \overline{\alpha}. H)\overline{\tau}}$ is
  well-defined.
\begin{itemize}
\item \underline{$T_\rho : [RT_k,RT_k]$}:\/ We must show that, for any
  relation transformer $F = 
  (F^1, F^2, F^*)$, the triple $T_{\rho} F = (T^\set_{\pi_1 \rho}F^1,
  T^\set_{\pi_2 \rho}F^2, T^\rel_{\rho}F)$ is also a relation
  transformer.  Let $\overline{R : \rel(A, B)}$. Then for
  $i = 1, 2$, we have
\[\begin{split}
\pi_i(T^\rel_{\rho}\,F\,\overline{R})
&= \pi_i(\relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\rho[\phi := F]\overline{[\alpha := R]}) \\
&= \setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H} (\pi_i (\rho[\phi := F]\overline{[\alpha := R]})) \\
&= \setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H} (\pi_i \rho)[\phi := \pi_i F]\overline{[\alpha := \pi_i R]}) \\
&= T^\set_{\pi_i \rho} (\pi_i F) (\overline{\pi_i R})
\end{split}\]
and 
\[\begin{split}
\pi_i(T^\rel_{\rho}\,F\,\overline{\gamma})
&= \pi_i(\relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\id_\rho[\phi
  := \id_F]\overline{[\alpha := \gamma]}) \\
&= \setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H} (\pi_i (\id_\rho[\phi := \id_F]\overline{[\alpha := \gamma]})) \\
&= \setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H} \id_{\pi_i \rho}[\phi := \id_{\pi_i F}]\overline{[\alpha := \pi_i \gamma]} \\
&= T^\set_{\pi_i \rho} (\pi_i F) (\overline{\pi_i \gamma})
\end{split}\]
Here, the second equality in each of the above chains of equalities is
by the induction hypothesis.

We also have that, for every morphism $\delta = (\delta^1, \delta^2) :
F \to G$ in $RT_k$ and all $\overline{R : \rel(A, B)}$,
\[\begin{array}{ll}
  & \pi_i((T^\rel_\rho \delta)_{\overline{R}})\\
= & \pi_i(\relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\id_\rho[\phi :=
  \delta]\overline{[\alpha := \id_R]})\\
= & \setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\id_{\pi_i\rho}[\phi :=
  \pi_i \delta]\overline{[\alpha := \id_{\pi_i R}]}\\
= & (T^\set_{\pi_i \rho} (\pi_i \delta))_{\overline{\pi_i R}}
\end{array}\]

Here, the second equality is by the induction hypothesis.  That
$T_\rho$ is $\omega$-cocontinuous follows immediately from the
induction hypothesis on $\sem{\Gamma;\Phi,\phi,\ol{\alpha} \vdash H}$
and the fact that colimts are computed componentwise in $RT$.
\item \underline{$\sigma_f = (\sigma^\set_{\pi_1 f},
  \sigma^\set_{\pi_2 f})$ is a natural transformation from $T_{\rho}$
  to $T_{\rho'}$}:\/ We must show that $(\sigma_f)_F =
  ((\sigma^\set_{\pi_1 f})_{F^1}, (\sigma^\set_{\pi_2 f})_{F^2})$ is a
  morphism in $RT_k$ for all relation transformers $F = (F^1, F^2,
  F^*)$, i.e., that $((\sigma_f)_F)_{\overline{R}}
  =(((\sigma^\set_{\pi_1 f})_{F^1})_{\overline{A}},
  ((\sigma^\set_{\pi_2 f})_{F_2})_{\overline{B}})$ is a morphism in
  $\rel$ for all relations $\overline{R : \rel(A, B)}$. Indeed, we
  have that
\[
((\sigma_f)_F)_{\overline{R}} =
\relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}f[\phi :=
  \id_F]\overline{[\alpha := \id_R]}
\]
is a morphism in $RT_0$ (and thus in $\rel$) by the induction hypothesis.
\end{itemize}

\vspace*{0.05in}

The relation transformer $\mu T_\rho$ is therefore a fixed point of
$T_\rho$ by Lemma~\ref{lem:fp}, and $\mu \sigma_f$ is a morphism in
$RT_k$ from $\mu T_\rho$ to $\mu T_{\rho'}$. ($\mu$ is shown to be a
functor in~\cite{jp19}.)  So $\relsem{\Gamma; \Phi \vdash (\mu
  \phi. \lambda \overline{\alpha}. H)\overline{\tau}}$, and thus
$\sem{\Gamma; \Phi \vdash (\mu \phi. \lambda
  \overline{\alpha}. H)\overline{\tau}}$, is well-defined.

\vspace*{0.1in}

To see that $\sem{\Gamma; \Phi \vdash (\mu \phi. \lambda
  \overline{\alpha}. H)\overline{\tau}} : [\relenv,RT_0]$, we must
verify three conditions:
\begin{itemize}
\item Condition (1) after Definition~\ref{def:relenv-functor} is
  satisfied since
\[\begin{split}
\pi_i(\relsem{\Gamma;\Phi \vdash (\mu \phi. \lambda
  \overline{\alpha}. H) \overline{\tau}}\rho) 
&= \pi_i( (\mu T_\rho) (\overline{\relsem{\Gamma;\Phi \vdash
    \tau}\rho})) \\ 
&= \pi_i(\mu T_{\rho}) (\overline{\pi_i(\relsem{\Gamma;\Phi \vdash
    \tau}\rho})) \\ 
&= \mu T^\set_{\pi_i\rho} (\overline{\setsem{\Gamma;\Phi \vdash
    \tau}(\pi_i\rho)}) \\ 
&= \setsem{\Gamma;\Phi \vdash (\mu \phi. \lambda \overline\alpha. H)
  \overline{\tau}}(\pi_i\rho) 
\end{split}\]
The third equality is by Equation ~\ref{eq:mu} and the induction
hypothesis.
\item Condition (2) after Definition~\ref{def:relenv-functor} is
  satisfied since it is subsumed by the previous condition because $k
  = 0$.
\item The third bullet point of Definition~\ref{def:relenv-functor} is
  satisfied because
\[\begin{split}
& \pi_i(\relsem{\Gamma;\Phi \vdash (\mu \phi. \lambda
  \overline\alpha. H)\overline{\tau}}f)\\
&= \pi_i((\mu T_{\rho'})(\overline{\relsem{\Gamma;\Phi \vdash
    \tau}f}) \circ (\mu \sigma_f)_{\overline{\relsem{\Gamma;\Phi
      \vdash \tau}\rho}}) \\ 
&= \pi_i((\mu T_{\rho'})(\overline{\relsem{\Gamma;\Phi \vdash
    \tau}f})) \circ \pi_i((\mu
\sigma_f)_{\overline{\relsem{\Gamma;\Phi \vdash \tau}\rho}}) \\  
&= \pi_i(\mu T_{\rho'})(\overline{\pi_i(\relsem{\Gamma;\Phi
    \vdash \tau}f})) \circ \pi_i(\mu
\sigma_f)_{\overline{\pi_i(\relsem{\Gamma;\Phi \vdash 
      \tau}\rho})} \\ 
&= (\mu T^\set_{\pi_i \rho'})(\overline{\setsem{\Gamma;\Phi \vdash
    \tau}(\pi_i f)}) \circ (\mu \sigma^\set_{\pi_i
  f})_{\overline{\setsem{\Gamma;\Phi \vdash \tau}(\pi_i\rho)}} \\ 
&= \setsem{\Gamma;\Phi \vdash (\mu \phi. \lambda
  \overline\alpha. H)\overline{\tau}}(\pi_i f). 
\end{split}\]
The fourth equality is by~\ref{eq:mu} and the induction hypothesis.
\end{itemize}
As before, that $\sem{\Gamma; \Phi \vdash (\mu \phi. \lambda
  \overline{\alpha}. H)\overline{\tau}}$ is $\omega$-concontinuous
follows from the facts that $\set$ and $\rel$ are locally finitely
presentable, and that colimits in $\relenv$ are computed
componentwise, together with Corollary~12 of~\cite{jp19}.
\end{itemize}
\end{proof}
\end{comment}

%We need
%$\relsem{\Gamma; \Phi, \phi \vdash \tau}\rho$ $=
%\relsem{\Gamma, \psi; \Phi \vdash \tau[\phi :==
%    \psi]}\rho[\psi:=\rho\phi]$, and that $\relsem{\Gamma \vdash
%  \sigma \to \tau}$ and
%$\setsem{\Gamma; \Phi, \phi \vdash \tau}\rho$ $=
%\setsem{\Gamma, \psi; \Phi \vdash \tau[\phi :==
%    \psi]}\rho[\psi:=\rho\phi]$. 
We can also prove by simultaneous induction that our interpretations
of types interact well with demotion of functorial variables. Indeed,
we have that, for any $\rho,\rho'$ and $f: \rho \to \rho'$ in
$\setenv$, 
\begin{gather}
\label{thm:demotion-objects}
\setsem{\Gamma; \Phi, \phi \vdash F} \rho = \setsem{\Gamma, \psi; \Phi
  \vdash F[\phi :== \psi] } \rho[\psi := \rho \phi]\\
\label{thm:demotion-morphisms}
\setsem{\Gamma; \Phi, \phi \vdash F} f = \setsem{\Gamma, \psi; \Phi
  \vdash F[\phi :== \psi]} f[\psi \mapsto f\phi]
\end{gather}
Moreover,
%\begin{lemma}\label{lem:demotion-objects}
if $\rho, \rho' : \setenv$ are such that $\rho \phi = \rho \psi =
\rho' \phi = \rho' \psi$, \,$f : \rho \to \rho'$ in $\setenv$ is such
that $f \phi = f \psi = \id_{\rho \phi}$,\, \, $\Gamma; \Phi, \phi^k
\vdash F : \F$, $\Gamma;\Phi,\ol{\alpha} \vdash G$
$\Gamma;\Phi,\alpha_1...\alpha_k \vdash H$, and $\Gamma;\Phi \vdash
\tau$, then
\begin{gather}
%\label{thm:demotion-objects}
%\setsem{\Gamma; \Phi, \phi \vdash F} \rho = \setsem{\Gamma, \psi; \Phi
%  \vdash F[\phi :== \psi] } \rho{\color{blue}[\psi := \rho \phi]}\\
%\label{thm:demotion-morphisms}
%\setsem{\Gamma; \Phi, \phi \vdash F} f = \setsem{\Gamma, \psi; \Phi
%  \vdash F[\phi :== \psi]} f{\color{blue}[\psi \mapsto f\phi]}\\
\label{eq:subs-var}
\setsem{\Gamma;\Phi \vdash G[\ol{\alpha := \tau}]}\rho =
\setsem{\Gamma;\Phi,\ol{\alpha} \vdash G}\rho[\ol{\alpha :=
\setsem{\Gamma;\Phi \vdash \tau}\rho}]\\
\label{eq:subs-var-morph}
\setsem{\Gamma;\Phi \vdash G[\ol{\alpha := \tau}]}f =
\setsem{\Gamma;\Phi,\ol{\alpha} \vdash G}f[\ol{\alpha :=
\setsem{\Gamma;\Phi \vdash \tau}f}]\\
\label{eq:subs-const}
\setsem{\Gamma; \Phi \vdash F[\phi := H]}\rho
= \setsem{\Gamma; \Phi, \phi \vdash F}\rho
[\phi := \lambda \ol{A}.\, \setsem{\Gamma;\Phi,\overline{\alpha}\vdash
    H}\rho[\overline{\alpha := A}]] \\ 
\label{eq:subs-const-morph}
\setsem{\Gamma; \Phi \vdash F[\phi := H]}f
= \setsem{\Gamma; \Phi, \phi \vdash F}f
[\phi := \lambda \ol{A}.\,\setsem{\Gamma;\Phi,\overline{\alpha}\vdash
    H}f[\overline{\alpha := \id_{\ol{A}}}]] 
\end{gather}
Identities analogous to (\ref{thm:demotion-objects}) through
(\ref{eq:subs-const-morph}) hold for relational interpretations as well.
%\end{lemma}


\begin{comment}
\begin{lemma}\label{lem:substitution}
Let $\rho$ and $\rho'$ be set environments and let $f : \rho \to \rho'$ be a
morphism of set environments. 
\begin{itemize}
\item If $\Gamma;\Phi,\ol{\alpha} \vdash F$ and $\Gamma;\Phi \vdash \tau$,
  then  
\begin{gather}\label{eq:subs-var}
\setsem{\Gamma;\Phi \vdash F[\ol{\alpha := \tau}]}\rho =
\setsem{\Gamma;\Phi,\ol{\alpha} \vdash F}\rho[\ol{\alpha :=
\setsem{\Gamma;\Phi \vdash \tau}\rho}]\\
\intertext{and}\label{eq:subs-var-morph}
\setsem{\Gamma;\Phi \vdash F[\ol{\alpha := \tau}]}f =
\setsem{\Gamma;\Phi,\ol{\alpha} \vdash F}f[\ol{\alpha :=
\setsem{\Gamma;\Phi \vdash \tau}f}]
\end{gather}
\item If $\Gamma;\Phi,\phi^k\vdash F$ and
  $\Gamma;\Phi,\alpha_1...\alpha_k \vdash H$, then 
\begin{gather}\label{eq:subs-const}
\setsem{\Gamma; \Phi \vdash F[\phi := H]}\rho
= \setsem{\Gamma; \Phi, \phi \vdash F}\rho
[\phi := \lambda \ol{A}.\, \setsem{\Gamma;\Phi,\overline{\alpha}\vdash
    H}\rho[\overline{\alpha := A}]] \\ 
\intertext{and}\label{eq:subs-const-morph}
\setsem{\Gamma; \Phi \vdash F[\phi := H]}f
= \setsem{\Gamma; \Phi, \phi \vdash F}f
[\phi := \lambda \ol{A}.\,\setsem{\Gamma;\Phi,\overline{\alpha}\vdash
    H}f[\overline{\alpha := \id_{\ol{A}}}]] 
\end{gather}
\end{itemize}
Analogous identities hold for relation environments and morphisms
between them.
\end{lemma}

\end{comment}






\begin{comment}

\begin{thm}\label{thm:demotion-objects}
Let \, $\Gamma; \Phi, \phi \vdash \tau : \F$. If $\rho, \rho' : \setenv$
are such that $\rho \phi = \rho \psi = \rho' \phi = \rho' \psi$, and
if $f : \rho \to \rho'$ is a morphism of set environments such that $f
\phi = f \psi = \id_{\rho \phi}$, then
\[\setsem{\Gamma; \Phi, \phi \vdash \tau} \rho = \setsem{\Gamma, \psi;
  \Phi \vdash \tau[\phi :== \psi] } \rho\]
and
\[\setsem{\Gamma; \Phi, \phi \vdash \tau} f = \setsem{\Gamma, \psi;
  \Phi \vdash \tau[\phi :== \psi]} f\]

\vspace*{0.1in}

\noindent
Analogously, if $\rho, \rho' : \relenv$ are such that $\rho \phi =
\rho \psi = \rho' \phi = \rho' \psi$, and if $f : \rho \to \rho'$ is a
morphism of relation environments such that $f \phi = f \psi =
\id_{\rho \phi}$, then
\[\relsem{\Gamma; \Phi, \phi \vdash \tau} \rho = \relsem{\Gamma, \psi;
  \Phi \vdash \tau[\phi :== \psi] } \rho\]
and
\[\relsem{\Gamma; \Phi, \phi \vdash \tau} f = \relsem{\Gamma, \psi;
  \Phi \vdash \tau[\phi :== \psi]} f\]
\end{thm}

\end{comment}

  
\begin{comment}
---
The next two theorems are proven by simultaneous induction. We are
actually only interested in using Theorem~\ref{thm:demotion-objects},
but in order to prove the $\mu$ case for this theorem, we need
Theorem~\ref{thm:demotion-morph} to show that two functors have equal
actions on morphisms.

\begin{thm}\label{thm:demotion-objects}
Let $\Gamma; \Phi, \phi \vdash \tau : \F$. If $\rho, \rho' : \setenv$
are such that $\rho \phi = \rho \psi = \rho' \phi = \rho' \psi$, and
if $f : \rho \to \rho'$ is a morphism of set environments such that $f
\phi = f \psi = \id_{\rho \phi}$, then
\[\setsem{\Gamma; \Phi, \phi \vdash \tau} \rho = \setsem{\Gamma, \psi;
  \Phi \vdash \tau[\phi :== \psi] } \rho\]
and
\[\setsem{\Gamma; \Phi, \phi \vdash \tau} f = \setsem{\Gamma, \psi;
  \Phi \vdash \tau[\phi :== \psi]} f\]

\vspace*{0.1in}

\noindent
Analogously, if $\rho, \rho' : \relenv$ are such that $\rho \phi =
\rho \psi = \rho' \phi = \rho' \psi$, and if $f : \rho \to \rho'$ is a
morphism of relation environments such that $f \phi = f \psi =
\id_{\rho \phi}$, then
\[\relsem{\Gamma; \Phi, \phi \vdash \tau} \rho = \relsem{\Gamma, \psi;
  \Phi \vdash \tau[\phi :== \psi] } \rho\]
and
\[\relsem{\Gamma; \Phi, \phi \vdash \tau} f = \relsem{\Gamma, \psi;
  \Phi \vdash \tau[\phi :== \psi]} f\]
\end{thm}
\begin{proof}
We prove the result for set interpretations by induction on the
structure of $\tau$.  The case for relational interpretations proceeds
analogously. Since the only interesting cases are the application case
and the $\mu$-case, we elide the others.
\begin{itemize}
\item If $\Gamma; \Phi, \phi \vdash \phi \ol\tau : \F$, then the
  induction hypothesis gives that  
\[\setsem{\Gamma; \Phi, \phi \vdash \tau } \rho = \setsem{\Gamma,
  \psi; \Phi \vdash \tau[\phi :== \psi] } \rho\] 
and
\[\setsem{\Gamma; \Phi, \phi \vdash \tau} f = \setsem{\Gamma, \psi;
  \Phi \vdash \tau[\phi :== \psi]} f\]
for each $\tau$. Then
\begin{align*}
 & \setsem{\Gamma; \Phi, \phi \vdash \phi \ol\tau } \rho \\
= \; & (\rho \phi) \ol{\setsem{\Gamma; \Phi, \phi \vdash \tau } \rho} \\
= \; & (\rho \phi) \ol{\setsem{\Gamma, \psi; \Phi \vdash \tau[\phi :==
      \psi] } \rho} \\ 
= \; & (\rho \psi) \ol{\setsem{\Gamma, \psi; \Phi \vdash \tau[\phi :==
      \psi] } \rho} \\ 
= \; & \setsem{\Gamma, \psi; \Phi \vdash \psi \ol{\tau[\phi :== \psi]}
} \rho \\ 
= \; & \setsem{\Gamma, \psi; \Phi \vdash (\phi \ol\tau)[\phi :== \psi]
} \rho 
\end{align*}
Here, the first and fifth equalities are by
Definition~\ref{def:set-sem}, and the fourth equality is by equality
of the functors $\rho \phi$ and $\rho \psi$. We also have that
\begin{align*}
& \setsem{\Gamma; \Phi, \phi \vdash \phi \ol\tau} f \\
= \; & (f \phi)_{\ol{\setsem{\Gamma; \Phi, \phi \vdash \tau} \rho'}} 
    \circ (\rho \phi) \ol{\setsem{\Gamma; \Phi, \phi \vdash \tau} f} \\
= \; & (\id_{\rho \phi})_{\ol{\setsem{\Gamma; \Phi, \phi \vdash \tau} \rho'}} 
    \circ (\rho \phi) \ol{\setsem{\Gamma; \Phi, \phi \vdash \tau} f} \\
= \; & (\rho \phi) \ol{\setsem{\Gamma; \Phi, \phi \vdash \tau} f} \\
= \; & (\rho \psi) \ol{\setsem{\Gamma, \psi; \Phi \vdash \tau[\phi :==
      \psi]} f} \\ 
= \; & (\id_{\rho \psi})_{\ol{\setsem{\Gamma, \psi; \Phi \vdash
      \tau[\phi :== \psi]} \rho'}} \circ (\rho \psi)
\ol{\setsem{\Gamma, \psi; \Phi \vdash \tau[\phi :== \psi]} f} \\ 
= \; & (f \psi)_{\ol{\setsem{\Gamma, \psi; \Phi \vdash \tau[\phi :==
        \psi]} \rho'}} \circ (\rho \psi) \ol{\setsem{\Gamma, \psi;
    \Phi \vdash \tau[\phi :== \psi]} f} \\ 
= \; & \setsem{\Gamma, \psi; \Phi \vdash \psi \ol{\tau[\phi :== \psi]}} f \\
= \; & \setsem{\Gamma, \psi; \Phi \vdash (\phi \ol\tau) [\phi :== \psi]} f
\end{align*}
\item If $\Gamma; \Phi, \phi \vdash (\mu \phi'. \lambda
  \ol\alpha. H)\ol\tau : \F$, then the induction hypothesis gives that
\[\setsem{\Gamma; \Phi, \phi', \ol{\alpha}, \phi \vdash H } \rho =
\setsem{\Gamma, \psi; \Phi, \phi', \ol{\alpha} \vdash H[\phi :== \psi]
} \rho\]
and 
\[\setsem{\Gamma; \Phi, \phi \vdash \tau } \rho = \setsem{\Gamma,
  \psi; \Phi \vdash \tau[\phi :== \psi] } \rho\]
as well as that
\[\setsem{\Gamma; \Phi, \phi', \ol{\alpha}, \phi \vdash H } f =
\setsem{\Gamma, \psi; \Phi, \phi', \ol{\alpha} \vdash H[\phi :== \psi]
} f\]
and 
\[\setsem{\Gamma; \Phi, \phi \vdash \tau } f = \setsem{\Gamma, \psi;
  \Phi \vdash \tau[\phi :== \psi] } f\]
for each $\tau$. Then
\begin{align*}
& \setsem{\Gamma; \Phi, \phi \vdash (\mu \phi'. \lambda
    \ol\alpha. H)\ol\tau } \rho \\ 
= \; & (\mu (\lambda F. \lambda \ol{A}. \setsem{\Gamma; \Phi, \phi',
  \ol{\alpha}, \phi \vdash H} \rho[\phi' := F][\ol{\alpha := A}]))
\ol{\setsem{ \Gamma; \Phi, \phi \vdash \tau} \rho} \\ 
= \; & (\mu (\lambda F. \lambda \ol{A}. \setsem{\Gamma, \psi; \Phi,
  \phi', \ol{\alpha} \vdash H[\phi :== \psi]} \rho[\phi' :=
  F][\ol{\alpha := A}])) \ol{\setsem{ \Gamma; \Phi, \phi \vdash \tau}
  \rho} \\ 
= \; &  (\mu (\lambda F. \lambda \ol{A}. \setsem{\Gamma, \psi; \Phi,
  \phi', \ol{\alpha} \vdash H[\phi :== \psi]} \rho[\phi' :=
  F][\ol{\alpha := A}])\ol{\setsem{ \Gamma, \psi; \Phi \vdash
    \tau[\phi :== \psi]} \rho} \\ 
= \; & \setsem{\Gamma, \psi; \Phi \vdash (\mu \phi'. \lambda
  \ol\alpha. H[\phi :== \psi]) \ol{\tau[\phi :== \psi]} } \rho \\ 
= \; & \setsem{\Gamma, \psi; \Phi \vdash ((\mu \phi'. \lambda
  \ol\alpha. H) \ol\tau)[\phi :== \psi] } \rho   
\end{align*} 
The first and fifth equalities are by Definition~\ref{def:set-sem}.
The second equality follows from the following equality:
\begin{align*}
&\lambda F. \lambda \ol{A}. \setsem{\Gamma; \Phi, \phi', \ol{\alpha},
    \phi \vdash H} \rho[\phi' := F][\ol{\alpha := A}] \\ 
& = \lambda F. \lambda \ol{A}. \setsem{\Gamma, \psi; \Phi, \phi',
    \ol{\alpha} \vdash H[\phi :== \psi]} \rho[\phi' := F][\ol{\alpha
      := A}] 
\end{align*}
These two maps have the same actions on objects and morphisms by the
induction hypothesis on $H$, and the fact that the extended
environment $\rho[\phi' := F][\ol{\alpha := A}]$ satisfies the
required hypothesis. They are thus equal as functors and so have the
same fixed point. We also have that 
\begin{align*}
& \setsem{\Gamma; \Phi, \phi \vdash (\mu \phi'. \lambda
    \ol\alpha. H)\ol\tau } f \\ 
= \; & (\mu (\lambda F. \lambda \ol{A}. \setsem{\Gamma; \Phi, \phi',
  \ol{\alpha}, \phi \vdash H} f [\phi' := \id_F][\ol{\alpha :=
    \id_A}]))_{\ol{\setsem{\Gamma; \Phi, \phi \vdash \tau} \rho'}} \\ 
\; & \circ (\mu (\lambda F. \lambda \ol{A}. \setsem{\Gamma; \Phi,
  \phi', \ol{\alpha}, \phi \vdash H} \rho[\phi' := F][\ol{\alpha :=
    A}])) \ol{\setsem{ \Gamma; \Phi, \phi \vdash \tau} f} \\ 
= \; & (\mu (\lambda F. \lambda \ol{A}. \setsem{\Gamma; \Phi, \phi',
  \ol{\alpha}, \phi \vdash H} f [\phi' := \id_F][\ol{\alpha :=
    \id_A}]))_{\ol{\setsem{\Gamma, \psi; \Phi \vdash \tau[\phi :==
        \psi]} \rho'}} \\ 
\; & \circ (\mu (\lambda F. \lambda \ol{A}. \setsem{\Gamma; \Phi,
  \phi', \ol{\alpha}, \phi \vdash H} \rho[\phi' := F][\ol{\alpha :=
    A}])) \ol{\setsem{ \Gamma, \psi; \Phi \vdash \tau[\phi :== \psi]}
  f} \\ 
= \; & (\mu (\lambda F. \lambda \ol{A}. \setsem{\Gamma, \psi; \Phi,
  \phi', \ol{\alpha} \vdash H[\phi :== \psi]} f [\phi' :=
  \id_F][\ol{\alpha := \id_A}]))_{\ol{\setsem{\Gamma, \psi; \Phi
      \vdash \tau[\phi :== \psi]} \rho'}} \\ 
\; & \circ (\mu (\lambda F. \lambda \ol{A}. \setsem{\Gamma; \Phi,
  \phi', \ol{\alpha}, \phi \vdash H} \rho[\phi' := F][\ol{\alpha :=
    A}])) \ol{\setsem{ \Gamma, \psi; \Phi \vdash \tau[\phi :== \psi]}
  f} \\ 
= \; & (\mu (\lambda F. \lambda \ol{A}. \setsem{\Gamma, \psi; \Phi,
  \phi', \ol{\alpha} \vdash H[\phi :== \psi]} f [\phi' :=
  \id_F][\ol{\alpha := \id_A}]))_{\ol{\setsem{\Gamma, \psi; \Phi
      \vdash \tau[\phi :== \psi]} \rho'}} \\ 
\; & \circ (\mu (\lambda F. \lambda \ol{A}. \setsem{\Gamma, \psi;
  \Phi, \phi', \ol{\alpha} \vdash H[\phi :== \psi]} \rho[\phi' :=
  F][\ol{\alpha := A}])) \ol{\setsem{ \Gamma, \psi; \Phi \vdash
    \tau[\phi :== \psi]} f} \\ 
= \; & \setsem{\Gamma, \psi; \Phi \vdash (\mu \phi'. \lambda
  \ol\alpha. H[\phi :== \psi]) \ol{\tau[\phi :== \psi]} } f \\ 
= \; & \setsem{\Gamma, \psi; \Phi \vdash ((\mu \phi'. \lambda
  \ol\alpha. H) \ol\tau)[\phi :== \psi] } f 
\end{align*} 
The first and fifth equalities are by Definition~\ref{def:set-sem}.
The third equality is by the equality of the arguments to the first
$\mu$ operator:
\begin{align*}
& \lambda F. \lambda \ol{A}. \setsem{\Gamma; \Phi, \phi', \ol{\alpha},
    \phi \vdash H} f [\phi' := \id_F][\ol{\alpha := \id_A}] \\ 
& = \lambda F. \lambda \ol{A}. \setsem{\Gamma, \psi; \Phi, \phi',
    \ol{\alpha} \vdash H[\phi :== \psi]} f [\phi' := \id_F][\ol{\alpha
      := \id_A}] 
\end{align*}
By the induction hypothesis on $H$ and the fact that the morphism
$f[\phi' := \id_F][\ol{\alpha := \id_A}] : \rho[\phi' := F][\ol{\alpha
    := A}] \to \rho'[\phi' := F][\ol{\alpha := A}]$ still satisfies
the required hypotheses.  The fourth equality is by the equality of
the arguments to the second $\mu$ operator:
\begin{align*}
& \lambda F. \lambda \ol{A}. \setsem{\Gamma; \Phi, \phi', \ol{\alpha},
    \phi \vdash H} \rho[\phi' := F][\ol{\alpha := A}] \\ 
& = \lambda F. \lambda \ol{A}. \setsem{\Gamma, \psi; \Phi, \phi',
    \ol{\alpha} \vdash H[\phi :== \psi]} \rho[\phi' := F][\ol{\alpha
      := A}] 
\end{align*}
By the same reasoning as above, these two maps are equal as functors,
and thus have the same fixed point.
\end{itemize}
\end{proof}

---


The following lemma ensures that substitution interacts well with type
interpretations.  It is a consequence of
Definitions~\ref{def:second-order-subst},~\ref{def:set-interp},
and~\ref{def:rel-interp}.

\begin{lemma}\label{lem:substitution}
Let $\rho$ and $\rho'$ be set environments and let $f : \rho \to \rho'$ be a
morphism of set environments. 
\begin{itemize}
\item If $\Gamma;\Phi,\ol{\alpha} \vdash F$ and $\Gamma;\Phi \vdash \tau$,
  then  
\begin{gather}\label{eq:subs-var}
\setsem{\Gamma;\Phi \vdash F[\ol{\alpha := \tau}]}\rho =
\setsem{\Gamma;\Phi,\ol{\alpha} \vdash F}\rho[\ol{\alpha :=
\setsem{\Gamma;\Phi \vdash \tau}\rho}]\\
\intertext{and}\label{eq:subs-var-morph}
\setsem{\Gamma;\Phi \vdash F[\ol{\alpha := \tau}]}f =
\setsem{\Gamma;\Phi,\ol{\alpha} \vdash F}f[\ol{\alpha :=
\setsem{\Gamma;\Phi \vdash \tau}f}]
\end{gather}
\item If $\Gamma;\Phi,\phi^k\vdash F$ and
  $\Gamma;\Phi,\alpha_1...\alpha_k \vdash H$, then 
\begin{gather}\label{eq:subs-const}
\setsem{\Gamma; \Phi \vdash F[\phi := H]}\rho
= \setsem{\Gamma; \Phi, \phi \vdash F}\rho
[\phi := \lambda \ol{A}.\, \setsem{\Gamma;\Phi,\overline{\alpha}\vdash
    H}\rho[\overline{\alpha := A}]] \\ 
\intertext{and}\label{eq:subs-const-morph}
\setsem{\Gamma; \Phi \vdash F[\phi := H]}f
= \setsem{\Gamma; \Phi, \phi \vdash F}f
[\phi := \lambda \ol{A}.\,\setsem{\Gamma;\Phi,\overline{\alpha}\vdash
    H}f[\overline{\alpha := \id_{\ol{A}}}]] 
\end{gather}
\end{itemize}
Analogous identities hold for relation environments and morphisms
between them.
\end{lemma}
\end{comment}

\begin{comment}
\begin{proof}
The proofs for the set and relational interpretations are completely
analogous, so we just prove the former. Likewise, we only prove
Equations~\ref{eq:subs-var} and~\ref{eq:subs-const}, since the proofs
for Equations~\ref{eq:subs-var-morph} and~\ref{eq:subs-const-morph}
are again analogous. Finally, we prove Equation~\ref{eq:subs-var} for
substitution for just a single type variable since the proof for
multiple simultaneous substitutions proceeds similarly.

Although Equation~\ref{eq:subs-var} is a special case of
Equation~\ref{eq:subs-const}, it is convenient to prove
Equation~\ref{eq:subs-var} first, and then use it to prove
Equation~\ref{eq:subs-const}. We prove Equation~\ref{eq:subs-var} by
induction on the structure of $F$ as follows:
\begin{itemize}
\item If $\Gamma; \emptyset \vdash F : \T$, or if $F$ is $\onet$ or
  $\zerot$, then $F$ does not contain any functorial variables to
  replace, so there is nothing to prove.
\item If $F$ is $F_1 \times F_2$ or $F_1 + F_2$, then the substitution
  distributes over the product or coproduct as appropriate, so the
  result follows immediately from the induction hypothesis.
\item If $F = \beta$ with $\beta \neq \alpha$, then there is nothing to
  prove.
\item If $F = \alpha$, then
\[\setsem{\Gamma;\Phi\vdash\alpha[\alpha := \tau]}\rho \, = \,
\setsem{\Gamma;\Phi\vdash\tau}\rho \, = \,
\setsem{\Gamma;\Phi,\alpha\vdash\alpha}\rho[\alpha :=
  \setsem{\Gamma;\Phi\vdash\tau}\rho]\]
\item If $F = \phi \overline{\sigma}$ with $\phi \neq \alpha$, then
\[\begin{array}{ll}
 &\setsem{\Gamma; \Phi \vdash (\phi \overline{\sigma})[\alpha := \tau]}\rho\\
=&\setsem{\Gamma; \Phi \vdash \phi (\overline{\sigma[\alpha := \tau]})}\rho \\
=&(\rho\phi)\overline{\setsem{\Gamma;\Phi\vdash\sigma[\alpha := \tau]}\rho} \\
=&(\rho\phi)\overline{\setsem{\Gamma;\Phi,\alpha\vdash\sigma}
      \rho [\alpha := \setsem{\Gamma;\Phi\vdash\tau}] } \\
=&\setsem{\Gamma; \Phi, \alpha \vdash \phi \overline{\sigma}}
      \rho [\alpha := \setsem{\Gamma;\Phi\vdash\tau}]
\end{array}\]
Here, the third equality is by the induction hypothesis.
\item If $F = (\mu \phi. \lambda \overline{\beta}. G)
  \overline{\sigma}$, then
\[\begin{array}{ll}
  & \setsem{\Gamma; \Phi \vdash ((\mu \phi. \lambda
  \overline{\beta}. G) \overline{\sigma}) [\alpha := \tau]}\rho \\
=&\setsem{\Gamma; \Phi \vdash (\mu \phi. \lambda
  \overline{\beta}. G[\alpha := \tau]) (\overline{\sigma [\alpha :=
      \tau]})}\rho \\ 
=&\mu(\setsem{\Gamma; \Phi, \phi, \overline{\beta} \vdash G[\alpha := \tau]}
      \rho[\phi := \text{--}][\overline{\beta := \text{--}}])
      (\overline{\setsem{\Gamma;\Phi \vdash \sigma [\alpha := \tau]}\rho}) \\
=&\mu(\setsem{\Gamma; \Phi, \phi, \overline{\beta}, \alpha \vdash G}
\rho [\alpha := \setsem{\Gamma;\Phi \vdash \tau}\rho] [\phi := \text{--}]
[\overline{\beta := \text{--}}]) \\
 &\hspace{0.5in} (\overline{\setsem{\Gamma;\Phi,\alpha \vdash \sigma}
   \rho [\alpha := \setsem{\Gamma;\Phi\vdash \tau}\rho]}) \\
=&\setsem{\Gamma;\Phi,\alpha\vdash(\mu\phi.\lambda\overline{\beta}.G)
  \overline{\sigma}}\rho  [\alpha := \setsem{\Gamma;\Phi \vdash
   \tau}\rho] 
\end{array}  \]
Here, the third equality is by the induction hypothesis and weakening.
\end{itemize}

We now prove Equation~\ref{eq:subs-const}, again by induction on the
structure of $F$.
\begin{itemize}
\item If $\Gamma; \emptyset \vdash F : \T$, or if $F$ is $\onet$ or
  $\zerot$, then $F$ does not contain any functorial variables to
  replace, so there is nothing to prove.
\item If $F$ is $F_1 \times F_2$ or $F_1 + F_2$, then the substitution
  distributes over the product or coproduct as appropriate, so the
  result follows immediately from the induction hypothesis.
\item If $F = \phi \overline{\tau}$, then
\[\begin{array}{ll}
 &\setsem{\Gamma; \Phi \vdash (\phi \overline{\tau})[\phi := H]}\rho \\
=&\setsem{\Gamma; \Phi \vdash H[\overline{\alpha:= \tau[\phi := H]}]}\rho \\
=&\setsem{\Gamma; \Phi \vdash H}\rho [\overline{\alpha:=
    \setsem{\Gamma;\Phi\vdash\tau[\phi := H]}\rho}] \\ 
=&\setsem{\Gamma; \Phi \vdash H}\rho [\overline{\alpha:=
    \setsem{\Gamma;\Phi,\phi\vdash\tau} \rho [\phi :=
      \setsem{\Gamma;\Phi,\overline{\alpha}\vdash
        H}\rho[\overline{\alpha := \text{--}}]]}] \\
=&\setsem{\Gamma; \Phi, \phi \vdash \phi \overline{\tau}}\rho [\phi :=
  \setsem{\Gamma;\Phi,\overline{\alpha}\vdash H}\rho[\overline{\alpha
      := \text{--}}]] 
  \end{array}\]
Here, the first equality is by
Definition~\ref{def:second-order-subst}, the second is by
Equation~\ref{eq:subs-var}, the third is by the induction hypothesis,
and the fourth is by Definition~\ref{def:set-sem}.
\item If $F = \psi \overline{\tau}$ with $\psi \neq \phi$, then the
  proof is similar to that for the previous case, but simpler, because
  $\phi$ only needs to be substituted in the arguments $\ol{\tau}$ of
  $\psi$.
\item If $F = (\mu \psi. \lambda \overline{\beta}. G)
  \overline{\tau}$, then
\[\begin{array}{ll}
 &\setsem{\Gamma; \Phi \vdash ((\mu \psi. \lambda \overline{\beta}. G)
 \overline{\tau})[\phi := H]}\rho \\ 
=&\setsem{\Gamma; \Phi \vdash (\mu \psi. \lambda
  \overline{\beta}. G[\phi := H]) (\overline{\tau[\phi := H]})}\rho \\
=&\mu(\setsem{\Gamma; \Phi, \psi, \overline{\beta} \vdash G[\phi := H]}
    \rho[\psi := \text{--}][\overline{\beta := \text{--}}])
    (\overline{\setsem{\Gamma;\Phi \vdash \tau[\phi := H]}\rho}) \\
=&\mu(\setsem{\Gamma; \Phi, \psi, \overline{\beta}, \phi \vdash G}
\rho [\phi := \setsem{\Gamma;\Phi,\overline{\alpha}\vdash
    H}\rho[\overline{\alpha := \text{--}}]][\psi := \text{--}]
     [\overline{\beta := \text{--}}]) \\
&\hspace{0.5in} (\overline{\setsem{\Gamma;\Phi,\phi \vdash \tau} \rho
       [\phi := \setsem{\Gamma;\Phi,\overline{\alpha}\vdash H}
         \rho[\overline{\alpha := \text{--}}]]}) \\
=&\setsem{\Gamma;\Phi,\phi\vdash(\mu\psi.\lambda\overline{\beta}.G)
  \overline{\tau}}\rho [\phi :=
  \setsem{\Gamma;\Phi,\overline{\alpha}\vdash H}\rho[\overline{\alpha
      := \text{--}}]] 
\end{array}\]
Here, the first equality is by
Definition~\ref{def:second-order-subst}, the second and fourth are by
Definition~\ref{def:set-sem}, and the third is by the induction
hypothesis and weakening.
\end{itemize}
\end{proof}
\end{comment}

\section{The Identity Extension Lemma}\label{sec:iel}

In most treatments of parametricity, equality relations on sets are
given --- either directly as diagonal relations, or perhaps via
reflexive graphs if kinds are also being tracked --- and the graph
relations used to validate existence of initial algebras are defined
in terms of them. We take a different approach here, giving a
categorical definition of graph relations for morphisms (i.e., natural
transformations) between functors and define equality relations as
particular graph relations. Our definitions specialize to the usual
ones for the graph relation for a morphism between sets and the
equality relation for a set. In light of its novelty, we spell out our
construction in detail.

The standard definition of the graph for a morphism $f : A \to B$ in
$\set$ is the relation $\graph{f} : \rel(A,B)$ defined by $(x,y) \in
\graph{f}$ iff $fx = y$. This definition naturally generalizes to
associate to each natural transformation between $k$-ary functors on
$\set$ a $k$-ary relation transformer as follows:

\begin{dfn}\label{dfn:graph-nat-transf}
If $F, G: \Set^k \to \Set$
%are $k$-ary functors
and $\alpha : F \to G$ is a natural transformation, then the functor
$\graph{\alpha}^*: \rel^k \to \rel$ is defined as follows. Given $R_1
: \rel(A_1, B_1),...,R_k : \rel(A_k,B_k)$, let $\iota_{R_i} : R_i
\hookrightarrow A_i \times B_i$, for $i = 1,...,k$, be the inclusion
of $R_i$ as a subset of $A_i \times B_i$,
%. By the universal property of the product, there exists a
let $h_{\overline{A \times B}}$ be the unique morphism making the diagram
{\footnotesize\[\begin{tikzcd}[row sep = large]
        F\overline{A}
        &F(\overline{A \times B})
        \ar[l, "{F\overline{\pi_1}}"']
        \ar[r, "{F\overline{\pi_2}}"]
        \ar[d, dashed, "{h_{\overline{A \times B}}}"]
        &F\overline{B}
        \ar[r, "{\alpha_{\ol{B}}}"]
        &G\overline{B} \\
        &F\overline{A} \times G\overline{B}
        \ar[ul, "{\pi_1}"] \ar[urr, "{\pi_2}"']
\end{tikzcd}\]}
commute, and let $h_{\overline{R}} : F\overline{R} \to F\overline{A}
\times G\overline{B}$ be $h_{\overline{A \times B}} \circ
F\overline{\iota_R}$. Further, let $\alpha^\wedge\overline{R}$ be the
subobject through which $h_{\overline{R}}$ is factorized by the
mono-epi factorization system in $\set$, as shown in the
following diagram:
{\footnotesize\[\begin{tikzcd}
        F\overline{R}
        \ar[rr, "{h_{\overline{R}}}"]
        \ar[dr, twoheadrightarrow, "{q_{\alpha^\wedge\overline{R}}}"']
        &&F\overline{A} \times G\overline{B} \\
        &\alpha^\wedge\overline{R}
        \ar[ur, hookrightarrow, "{\iota_{\alpha^\wedge\overline{R}}}"']
\end{tikzcd}\]}
Then $\alpha^\wedge\overline{R} : \rel(F\overline{A}, G\overline{B})$
by construction, so the action of $\langle \alpha \rangle^*$ on
objects can be given by $\langle \alpha \rangle^* \overline{(A,B,R)} =
(F\overline{A}, G\overline{B}, \iota_{\alpha^\wedge
  \overline{R}}\alpha^\wedge\overline{R})$. Its action on morphisms is
given by $\graph{\alpha}^*\overline{(\beta, \beta')} =
(F\overline\beta, G\overline\beta')$.
\end{dfn}

The data in Definition~\ref{dfn:graph-nat-transf} yield the {\em graph relation
transformer for $\alpha$}, denoted $\graph{\alpha} = (F, G,
\graph{\alpha}^*)$.
% yield a relation transformer $\graph{\alpha} = (F, G,
%\graph{\alpha}^*)$, called the {\em graph relation transformer for
%$\alpha$}.

\begin{lemma}\label{lem:graph-reln-functors}
If $F,G : [\set^k,\set]$, and if $\alpha : F \to G$ is a natural
transformation, then $\graph{\alpha}$ is in $RT_k$.
\end{lemma}
\begin{proof}
Clearly, $\graph{\alpha}^*$ is $\omega$-cocontinuous, so
$\graph{\alpha}^* : [\rel^k,\rel]$. Now, suppose $\overline{R :
  \rel(A, B)}$, $\overline{S : \rel(C, D)}$, and $\overline{(\beta,
  \beta') : R \to S}$. We want to show that there exists a morphism
$\epsilon : \alpha^\wedge\overline{R} \to \alpha^\wedge\overline{S}$
such that
{\footnotesize    \[
    \begin{tikzcd}
        \alpha^\wedge\overline{R}
        \ar[r, hookrightarrow, "{\iota_{\alpha^\wedge\overline{R}}}"]
        \ar[d, "{\epsilon}"']
        & F\overline{A} \times G\overline{B}
        \ar[d, "{F\overline{\beta} \times G\overline{\beta'}}"] \\
        \alpha^\wedge\overline{S}
        \ar[r, hookrightarrow, "{\iota_{\alpha^\wedge\overline{S}}}"']
        & F\overline{C} \times G\overline{D}
    \end{tikzcd}
    \]}
    commutes.
    Since $\ol{(\beta,\beta') : R \to S}$, there exist $\overline{\gamma : R \to S}$
    such that each diagram
{\footnotesize    \[
    \begin{tikzcd}
        R_i
        \ar[d, "{\gamma_i}"']
        \ar[r, hookrightarrow, "{\iota_{R_i}}"]
        &A_i \times B_i
        \ar[d, "{\beta_i \times \beta'_i}"] \\
        S_i
        \ar[r, hookrightarrow, "{\iota_{S_i}}"]
        &C_i \times D_i
    \end{tikzcd}
    \]}
    commutes. Moreover, since both
    $h_{\overline{C \times D}} \circ F(\overline{\beta \times \beta'})$
    and
    $(F\overline{\beta} \times G\overline{\beta'}) \circ h_{\overline{A \times B}}$
    make
{\footnotesize      \[
      \begin{tikzcd}[row sep = large]
          F\overline{C}
          &F\overline{C} \times F\overline{D}
          \ar[l, "{\pi_1}"'] \ar[r, "{\pi_2}"]
          &F\overline{D}
          \ar[r, "{\alpha_{\ol{D}}}"]
          &G\overline{D}\\
          &F(\overline{A \times B})
          \ar[u, dashed, "{\exists !}"]
          \ar[ul, "{F\ol{\pi_1} \circ F(\overline{\beta \times \beta'})}"]
          \ar[urr, "{\alpha_{\ol{D}} \circ F\ol{\pi_2} \circ F(\overline{\beta \times \beta'})}"']
      \end{tikzcd}
      \]}
      commute, they must be equal. We therefore get that the
      right-hand square below commutes, and thus that the entire
      following diagram does as well:
{\footnotesize      \[
      \begin{tikzcd}
          F\overline{R}
          \ar[d, "{F\overline{\gamma}}"']
          \ar[r, hookrightarrow, "{F\overline{\iota_R}}"]
          \ar[rr, bend left, "{h_{\overline{R}}}"]
          &F(\overline{A \times B})
          \ar[d, "{F(\overline{\beta \times \beta'})}"]
          \ar[r, "{h_{\overline{A \times B}}}"]
          &F\overline{A} \times G\overline{B}
          \ar[d, "{F\overline{\beta} \times F\overline{\beta'}}"] \\
          F\overline{S}
          \ar[r, hookrightarrow, "{F\overline{\iota_S}}"']
          \ar[rr, bend right, "{h_{\overline{S}}}"']
          &F(\overline{C \times D})
          \ar[r, "{h_{\overline{C \times D}}}"']
          &F\overline{C} \times G\overline{D}
      \end{tikzcd}
      \]}
      Finally, by the left-lifting property of $q_{F^\wedge\overline{R}}$
      with respect to $\iota_{F^\wedge\overline{S}}$ given by the epi-mono
      factorization system, there exists an $\epsilon$ such that the
      following diagram commutes:
      {\footnotesize
        \[
      \begin{tikzcd}
          F\overline{R}
          \ar[d, "{F\overline{\gamma}}"']
          \ar[r, twoheadrightarrow, "{q_{\alpha^\wedge\overline{R}}}"]
          &\alpha^\wedge\overline{R}
          \ar[d, dashed, "{\epsilon}"]
          \ar[r, hookrightarrow, "{\iota_{\alpha^\wedge\overline{R}}}"]
          &F\overline{A} \times G\overline{B}
          \ar[d, "{F\overline{\beta} \times G\overline{\beta'}}"] \\
          F\overline{S}
          \ar[r, twoheadrightarrow, "{q_{\alpha^\wedge\overline{S}}}"']
          &\alpha^\wedge\overline{S}
          \ar[r, hookrightarrow, "{\iota_{\alpha^\wedge\overline{S}}}"']
          &F\overline{C} \times G\overline{D}
      \end{tikzcd}
      \]}
\end{proof}

If $f : A \to B$ is a morphism in $\set$ then the definition of the
graph relation transformer $\langle f \rangle$ for $f$ as a natural
transformation between $0$-ary functors $A$ and $B$ coincides with its
standard definition.  Graph relation transformers are thus a
reasonable extension of graph relations to functors.
\begin{comment}

If $f : A \to B$ is a function with graph relation $\graph{f} = (A, B,
\graph{f}^*)$, then $\langle \id_{A}, f \rangle : A \to A \times B$
and $\langle \id_{A}, f \rangle\, A = \graph{f}^*$.  Moreover, if
$\iota_{\graph{f}} : \graph{f}^* \hookrightarrow A \times B$ is the
inclusion of $\graph{f}^*$ into $A \times B$ then there is an
isomorphism of subobjects
\[\begin{tikzcd}
A \ar[rr, "{\cong}"] \ar[dr, "{\langle \id_{A}, f \rangle}"']
&&{\graph{f}^*} \ar[dl, "{\iota_{\graph{f}}}"]\\
&A \times B
\end{tikzcd}\]

We also note that if $f : A \to B$ is a function seen as a natural
transformation between 0-ary functors, then $\graph{f}$ is (the 0-ary
relation transformer associated with) the graph relation of $f$.
Indeed, we need to apply Definition~\ref{dfn:graph-nat-transf} with $k
= 0$, i.e., to the degenerate relation $\ast : \rel(\ast, \ast)$.  As
degenerate $0$-ary functors, $A$ and $B$ are constant functors, i.e.,
$A\, \ast = A$ and $B\, \ast = B$.  By the universal property of the
product, there exists a unique $h$ making the diagram
\[ \begin{tikzcd}[row sep = large]
        A
        &A
        \ar[l, equal]
        \ar[r, equal]
        \ar[d, dashed, "{h}"]
        &A
        \ar[r, "{f}"]
        &B \\
        &A \times B
        \ar[ul, "{\pi_1}"] \ar[urr, "{\pi_2}"']
\end{tikzcd}\]
commute. Since $\iota_\ast : \ast \to \ast$ is the identity on $\ast$,
and $A\, \id_{\ast} = \id_{A}$, we have $h_{\ast} = h$.  Moreover,
$h_{\overline{A \times B}} = \langle \id_{A}, f \rangle$ is a
monomorphism in $\set$ because $\id_{A}$ is.  Then,
$\iota_{f^\wedge\ast} = \langle \id_{A}, f \rangle$ and $f^\wedge\ast
= A$, from which we deduce that $\iota_{f^\wedge\ast} f^\wedge\ast =
\langle \id_{A}, f \rangle\, A = \graph{f}^*$. This ensures that the
graph of $f$ as a 0-ary natural transformation coincides with the
graph of $f$ as a morphism in $\set$, and so that
Definition~\ref{dfn:graph-nat-transf} is a reasonable generalization
of Definition~\ref{def:graph}.

Just as the equality relation $\Eq_B$ on a set $B$ coincides with
$\graph{\id_B}$, the graph of the identity on the set, so we can
define the equality relation transformer to be the graph of the
identity natural transformation. This gives

\begin{dfn}
Let $F : [\set^k, \set]$.  The equality relation transformer on $F$ is
defined to be $\Eq_F = \graph{\id_{F}}$. This entails that $Eq_F = (F,
F, \Eq_F^*)$ with $\Eq_F^* = \graph{\id_{F}}^*$.
\end{dfn}
\end{comment}

To prove the IEL, we will need to know that the equality relation
transformer preserves equality relations; see
Equation~\ref{eq:eq-pres-eq} below. This will follow from the next
lemma, which shows how to compute the action of a graph relation
transformer on any graph relation.

\begin{lemma}\label{lem:eq-reln-equalities}
If $\alpha : F \to G$ is a morphism in $[\Set^k, \Set]$
and $f_1: A_1 \to B_1, ..., f_k : A_k \to B_k$,
then $\graph{\alpha}^* \graph{\overline{f}}
= \langle G \ol{f} \circ \alpha_{\ol{A}} \rangle
= \langle \alpha_{\ol{B}} \circ F \ol{f} \rangle$.
\end{lemma}
\begin{proof}
Since $h_{\overline{A \times B}}$ is the unique morphism making the
bottom triangle of this diagram commute
{\footnotesize
\[\begin{tikzcd}[row sep = large]
        &F\overline{A}
        \ar[d, "{F \overline{\langle \id_A, f \rangle}}" description]
        \ar[dl, equal]
        \ar[dr, "{F\ol{f}}"]\\
        F\overline{A}
        &F(\overline{A \times B})
        \ar[l, "{F\overline{\pi_1}}"']
        \ar[r, "{F\overline{\pi_2}}"]
        \ar[d, "{h_{\overline{A \times B}}}"]
        &F\overline{B}
        \ar[r, "{\alpha_{\ol{B}}}"]
        &G\overline{B}\\
        &F\overline{A} \times G\overline{B}
        \ar[ul, "{\pi_1}"] \ar[urr, "{\pi_2}"']
\end{tikzcd}\]}
and since $h_{\graph{\overline{f}}} = h_{\overline{A \times B}} \circ
F \,\ol{\iota_{\graph{f}}} = h_{\overline{A \times B}} \circ F
\overline{\langle \id_A, f \rangle}$,
%(the last equality being by the observation after
%Remark~\ref{rmk:graph-fn}),
the universal property of the product
{\footnotesize
\[
      \begin{tikzcd}[row sep = large]
          F\overline{A}
          &F\overline{A} \times G\overline{B}
          \ar[l, "{\pi_1}"'] \ar[r, "{\pi_2}"]
          &G\overline{B}\\
          &F\overline{A}
          \ar[u, dashed, "{\exists !}"]
          \ar[ul, equal]
          \ar[r, "{F\ol{f}}"']
          &F{\ol{B}}
          \ar[u, "{\alpha_{\ol{B}}}"']
      \end{tikzcd}
      \]}
gives $h_{\graph{\overline{f}}} = \langle \id_{F \ol{A}},
\alpha_{\ol{B}} \circ F\ol{f} \rangle : F \ol{A} \to F \ol{A} \times G
\ol{B}$.  Moreover, $\langle \id_{F \ol{A}}, \alpha_{\ol{B}} \circ
F\ol{f} \rangle$ is a monomorphism in $\set$ because $\id_{F \ol{A}}$
is, so its epi-mono factorization gives $\iota_{\alpha^\wedge
  \graph{\overline{f}}} = \langle \id_{F \ol{A}}, \alpha_{\ol{B}}
\circ F\ol{f} \rangle$, and thus $\alpha^\wedge \graph{\overline{f}} =
%the domain of $\iota_{\alpha^\wedge \graph{\overline{f}}}$, is equal
%to
F\overline{A}$.  Then $\iota_{\alpha^\wedge
  \graph{\overline{f}}} \alpha^\wedge \graph{\overline{f}} = \langle
\id_{F \ol{A}}, \alpha_{\ol{B}} \circ F\ol{f} \rangle (F \ol{A}) =
\graph{ \alpha_{\ol{B}} \circ F\ol{f} }^*$,
%(where the last equality is by Remark~\ref{rmk:graph-fn}).
%We therefore conclude that
so that $\graph{ \alpha }^* \graph{ \overline{f} } = (F\overline{A},
G\overline{B}, \iota_{\alpha^\wedge \graph{\overline{f}}}\,
\alpha^\wedge \graph{\overline{f}}) = (F\overline{A}, G\overline{B},
\graph{ \alpha_{\ol{B}} \circ F\ol{f} }^*) = \graph{ \alpha_{\ol{B}}
  \circ F\ol{f} }$.  Finally, $\alpha_{\ol{B}} \circ F\ol{f} = G\ol{f}
\circ \alpha_{\ol{A}}$ by naturality of $\alpha$.
\end{proof}

The {\em equality relation transformer} on $F : [\set^k,\set]$ is
defined to be $\Eq_F = \graph{\id_{F}}$. Specifically, $Eq_F = (F, F,
\Eq_F^*)$ with $\Eq_F^* = \graph{\id_{F}}^*$, and
Lemma~\ref{lem:eq-reln-equalities} indeed ensures that
\begin{equation}\label{eq:eq-pres-eq}
\Eq^*_F \ol{\Eq_A}
= \graph{\id_F}^* \graph{\id_{\ol{A}}}
= \graph{F \id_{\ol{A}} \circ (\id_F)_{\ol{A}}}
= \graph{\id_{F\ol{A}} \circ \id_{F\ol{A}}}
= \graph{\id_{F\ol{A}}}
= \Eq_{F\ol{A}}
\end{equation}
%$\Eq^*_F \,\ol{\Eq_A} = \Eq_{F\ol{A}}$
for all $\ol{A : \set}$.
\begin{comment}
  \begin{lemma}
$\Eq^*_F \,\ol{\Eq_A}
= \Eq_{F\ol{A}}$ for all $\ol{A : \set}$.
  \end{lemma}
\begin{proof}
We have that\
\begin{equation}\label{eq:eq-pres-eq}
\Eq^*_F \ol{\Eq_A}
= \graph{\id_F}^* \graph{\id_{\ol{A}}}
= \graph{F \id_{\ol{A}} \circ (\id_F)_{\ol{A}}}  %by your Lemma 5
= \graph{\id_{F\ol{A}} \circ \id_{F\ol{A}}}
%= \graph{\id_F \ol{A} \circ \id_{\ol{A}}}
= \graph{\id_{F\ol{A}}}
= \Eq_{F\ol{A}}
\end{equation}
The second identity here is by Lemma~\ref{lem:eq-reln-equalities}.
\end{proof}
\end{comment}
Graph relation transformers in general, and equality relation
transformers in particular, extend to relation environments in the
obvious ways.
%\begin{definition}
Indeed, if $\rho, \rho' : \setenv$ and $f : \rho \to \rho'$, then the
{\em graph relation environment} $\graph{f}$ is defined pointwise by
$\graph{f} \phi = \graph{f \phi}$ for every $\phi$. This entails that
$\pi_1 \graph{f} = \rho$ and $\pi_2 \graph{f} = \rho'$. In particular,
the {\em equality relation environment} $\Eq_\rho$ is defined to be
$\graph{\id_{\rho}}$. This entails that $\Eq_\rho \phi = \Eq_{\rho
  \phi}$ for every $\phi$.
%\end{definition}
With these definitions in hand, we can state and prove both an
Identity Extension Lemma and a Graph Lemma for our calculus.
\begin{thm}[IEL]\label{thm:iel}
  If $\rho : \setenv$ and $\Gamma; \Phi \vdash \tau : \F$ then
  $\relsem{\Gamma; \Phi \vdash \tau} \Eq_\rho = \Eq_{\setsem{\Gamma;
      \Phi \vdash \tau}\rho}$.
\end{thm}
The proof is by induction on the structure of $\tau$. Only the
application and fixpoint cases are non-routine. Both use
Lemma~\ref{lem:eq-reln-equalities}. The latter also uses the
observation that, for every $n \in \nat$, the following intermediate
results can be proved {\color{blue} by simultaneous induction with
  Theorem~\ref{thm:iel}}:
%\begin{equation}\label{eq:iel-fix-point-intermediate1}
$T^n_{\Eq_{\rho}} K_0\, \ol{\Eq_{\setsem{\Gamma; \Phi \vdash
      \tau}\rho}} = (\Eq_{(T^\set_\rho)^n K_0})^*
\ol{\Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}}$\;
%\end{equation}
and\;
%\begin{equation}\label{eq:iel-fix-point-intermediate2}
%\begin{split}
$ \relsem{\Gamma; \Phi, \phi, \ol{\alpha} \vdash H} \Eq_{\rho} [\phi
  := T^{n}_{\Eq_{\rho}} K_0] \overline{[\alpha := \Eq_{\setsem{\Gamma;
        \Phi \vdash \tau}\rho}]} =$\\
$\relsem{\Gamma; \Phi, \phi,
  \ol{\alpha} \vdash H} \Eq_{\rho} [\phi := \Eq_{(T^\set_\rho)^n K_0}]
\overline{[\alpha := \Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}]}$.
%\end{split}
%\end{equation}

\begin{comment}
\begin{proof}
By induction on the structure of $\tau$.
\begin{itemize}
\item $\relsem{\Gamma; \emptyset \vdash v}\Eq_{\rho} = \Eq_{\rho} v =
  \Eq_{\rho v} = \Eq_{\setsem{\Gamma; \emptyset \vdash v}\rho}$ where
  $v \in \Gamma$.
\item By definition, $\relsem{\Gamma; \emptyset \vdash
  \Nat^{\overline\alpha} \,F\,G} \Eq_{\rho}$ is the relation on
  $\setsem{\Gamma; \emptyset \vdash \Nat^{\overline\alpha} \,F\,G}
  \rho$ relating $t$ and $t'$ if, for all ${R_1 :
    \rel(A_1,B_1)},...,{R_k : \rel(A_k,B_k)}$, $(t_{\overline{A}},
  t'_{\overline{B}})$ is a morphism from $\relsem{\Gamma;
    \overline\alpha \vdash F} \Eq_{\rho}\overline{[\alpha := R]}$ to
  $\relsem{\Gamma ; \overline\alpha \vdash G}
  \Eq_{\rho}\overline{[\alpha := R]}$ in $\rel$.  To prove that this
  is equal to $\Eq_{\setsem{\Gamma; \emptyset \vdash
      \Nat^{\overline\alpha} \,F\,G} \rho}$ we need to show that
  $(t_{\overline{A}}, t'_{\overline{B}})$ is a morphism from
  $\relsem{\Gamma; \overline\alpha \vdash F}
  \Eq_{\rho}\overline{[\alpha := R]}$ to $\relsem{\Gamma ;
    \overline\alpha \vdash G} \Eq_{\rho}\overline{[\alpha := R]}$ in
  $\rel$ for all ${R_1 : \rel(A_1,B_1)},...,{R_k : \rel(A_k,B_k)}$ if
  and only if $t = t'$ and $(t_{\overline{A}}, t_{\overline{B}})$ is a
  morphism from $\relsem{\Gamma; \overline\alpha \vdash F}
  \Eq_{\rho}\overline{[\alpha := R]}$ to $\relsem{\Gamma ; \overline
    \alpha \vdash G} \Eq_{\rho}\overline{[\alpha := R]}$ in $\rel$ for
  all ${R_1 : \rel(A_1,B_1)}, ...,$ ${R_k : \rel(A_k,B_k)}$. The only
  interesting part of this equivalence is to show that if
  $(t_{\overline{A}}, t'_{\overline{B}})$ is a morphism from
  $\relsem{\Gamma; \overline\alpha \vdash F}
  \Eq_{\rho}\overline{[\alpha := R]}$ to $\relsem{\Gamma ;
    \overline\alpha \vdash G} \Eq_{\rho}\overline{[\alpha := R]}$ in
  $\rel$ for all ${R_1 : \rel(A_1,B_1),}$ $...,{R_k : \rel(A_k,B_k)}$,
  then $t = t'$.  By hypothesis, $(t_{\overline{A}},
  t'_{\overline{A}})$ is a morphism from $\relsem{\Gamma;
    \overline\alpha \vdash F} \Eq_{\rho}\overline{[\alpha :=
      \Eq_{A}]}$ to $\relsem{\Gamma ; \overline\alpha \vdash G}
  \Eq_{\rho}\overline{[\alpha := \Eq_{A}]}$ in $\rel$ for all
  $A_1\,...\,A_k : \set$. By the induction hypothesis, it is therefore
  a morphism from $\Eq_{\setsem{\Gamma; \overline\alpha \vdash F}
    \rho\overline{[\alpha := A]}}$ to $\Eq_{\setsem{\Gamma ;
      \overline\alpha \vdash G} \rho\overline{[\alpha := A]}}$ in
  $\rel$. This means that, for every $x : \Eq_{\setsem{\Gamma;
      \overline\alpha \vdash F} \rho\overline{[\alpha := A]}}$,
  $t_{\overline{A}}x = t'_{\overline{A}}x$.  Then, by extensionality,
  $t = t'$.
\item $\relsem{\Gamma; \Phi \vdash \zerot} \Eq_{\rho} = 0_\rel =
  \Eq_{0_\set} = \Eq_{\setsem{\Gamma; \Phi \vdash \zerot}\rho}$
\item $\relsem{\Gamma; \Phi \vdash \onet} \Eq_{\rho} = 1_\rel =
  \Eq_{1_\set} = \Eq_{\setsem{\Gamma; \Phi \vdash \onet}\rho}$
\item The application case is proved by the following sequence of
  equalities, where the second equality is by the induction hypothesis
  and the definition of the relation environment $\Eq_\rho$, the third
  is by the definition of application of relation transformers, and
  the fourth is by Lemma~\ref{lem:eq-reln-equalities}:
\[
\begin{split}
\relsem{\Gamma; \Phi \vdash \phi\ol{\tau}}\Eq_{\rho} &=
(\Eq_{\rho}\phi)\ol{\relsem{\Gamma; \Phi \vdash \tau}
\Eq_{\rho}}\\
&= \Eq_{\rho \phi}\, \ol{\Eq_{\setsem{\Gamma; \Phi \vdash \tau}
  \rho}}\\
&= (\Eq_{\rho \phi})^* \,\ol{\Eq_{\setsem{\Gamma; \Phi \vdash \tau}
  \rho}}\\
&= \Eq_{(\rho \phi) \,\ol{\setsem{\Gamma; \Phi \vdash \tau} \rho}}\\
&= \Eq_{\setsem{\Gamma; \Phi \vdash \phi\ol{\tau}}\rho}
\end{split}
\]
\item The fixed point case is proven by the sequence of equalities
\[
\begin{split}
\relsem{\Gamma; \Phi \vdash (\mu \phi.\lambda
  \ol{\alpha}. H)\ol{\tau}}\Eq_{\rho} 
&=(\mu {T_{\Eq_{\rho}}}) \,\ol{\relsem{\Gamma; \Phi \vdash \tau}\Eq_{\rho}}\\ 
&= \colim{n \in \nat}{T^n_{\Eq_{\rho}} K_0}\, \ol{\relsem{\Gamma; \Phi
  \vdash \tau}\Eq_{\rho}}\\
&= \colim{n \in \nat}{ T^n_{\Eq_{\rho}} K_0 \,\ol{\Eq_{\setsem{\Gamma;
    \Phi \vdash \tau}\rho}}}\\
&= \colim{n \in \nat}{(\Eq_{(T^\set_\rho)^n K_0})^*
  \ol{\Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}}}\\
&= \colim{n \in \nat}{\Eq_{(T^\set_\rho)^n K_0 \,\ol{\setsem{\Gamma;
        \Phi \vdash \tau}\rho}}}\\ 
&= \Eq_{\colim{n \in \nat}{ (T^\set_{\rho})^n K_0\,
    \ol{\setsem{\Gamma; \Phi \vdash \tau}\rho}}}\\
&= \Eq_{\setsem{\Gamma; \Phi \vdash (\mu \phi.\lambda
      \ol{\alpha}. H)\ol{\tau}}\rho}
\end{split}
\]
Here, the third equality is by induction hypothesis, the fifth is by
Lemma~\ref{lem:eq-reln-equalities} and the fourth equality is because,
for every $n \in \nat$, the following two statements can be proved by
simultaneous induction:
\begin{equation}\label{eq:iel-fix-point-intermediate1}
T^n_{\Eq_{\rho}} K_0\, \ol{\Eq_{\setsem{\Gamma; \Phi \vdash
      \tau}\rho}} = (\Eq_{(T^\set_\rho)^n K_0})^*
\ol{\Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}}
\end{equation}
and
\begin{equation}\label{eq:iel-fix-point-intermediate2}
\begin{split}
  \relsem{\Gamma; \Phi, \phi, \ol{\alpha} \vdash H}
\Eq_{\rho} [\phi := 
 & T^{n}_{\Eq_{\rho}} K_0] \overline{[\alpha :=
    \Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}]} \\
=\;\; & \relsem{\Gamma; \Phi, \phi, \ol{\alpha} \vdash H} \Eq_{\rho} [\phi
  := \Eq_{(T^\set_\rho)^n K_0}] \overline{[\alpha :=
    \Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}]}
\end{split}
\end{equation}
We prove~\eqref{eq:iel-fix-point-intermediate1}.  The case $n=0$ is
trivial, because $T^0_{\Eq_{\rho}} K_0 = K_0$ and
$(T^\set_\rho)^0 K_0 = K_0$; the inductive step is
proved by the following sequence of equalities:
\[
\begin{split}
T^{n+1}_{\Eq_{\rho}} K_0\, \overline{\Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}}
&= T^\rel_{\Eq_{\rho}} (T^{n}_{\Eq_{\rho}} K_0)
\overline{\Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}} \\ 
&= \relsem{\Gamma; \Phi, \phi, \ol{\alpha} \vdash H} \Eq_{\rho} [\phi
  := T^{n}_{\Eq_{\rho}} K_0] \overline{[\alpha :=
    \Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}]} \\ 
&= \relsem{\Gamma; \Phi, \phi, \ol{\alpha} \vdash H} \Eq_{\rho} [\phi
  := \Eq_{(T^\set_\rho)^n K_0}] \overline{[\alpha :=
    \Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}]} \\ 
&= \relsem{\Gamma; \Phi, \phi, \ol{\alpha} \vdash H} \Eq_{\rho [\phi
    := (T^\set_\rho)^n K_0] \overline{[\alpha :=
      \setsem{\Gamma; \Phi \vdash \tau}\rho]}} \\ 
&= \Eq_{\setsem{\Gamma; \Phi, \phi, \ol{\alpha} \vdash H} \rho [\phi
    := (T^\set_\rho)^n K_0] \overline{[\alpha :=
      \setsem{\Gamma; \Phi \vdash \tau}\rho]}} \\ 
&= \Eq_{(T^\set_\rho)^{n+1} K_0 \overline{\setsem{\Gamma; \Phi
      \vdash \tau}\rho}} \\ 
&= (\Eq_{(T^\set_\rho)^{n+1} K_0})^*\, \overline{\Eq_{\setsem{\Gamma;
      \Phi \vdash \tau}\rho}} 
\end{split}
\]
Here, the third equality is by~\eqref{eq:iel-fix-point-intermediate2},
the fifth by the induction hypothesis on $H$, and the last by
Lemma~\ref{lem:eq-reln-equalities}.  We prove the induction step
of~\eqref{eq:iel-fix-point-intermediate2} by structural induction on
$H$: the only interesting case, though, is when $\phi$ is applied,
i.e., for $H = \phi \ol{\sigma}$, which is proved by the sequence of
equalities:
\[
\begin{split}
& \relsem{\Gamma; \Phi, \phi, \ol{\alpha} \vdash \phi
    \ol{\sigma}} \Eq_{\rho} [\phi := T^{n}_{\Eq_{\rho}} K_0]
  \overline{[\alpha := \Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}]}
  \\
&= T^{n}_{\Eq_{\rho}} K_0\, \overline{\relsem{\Gamma; \Phi,
      \phi, \ol{\alpha} \vdash \sigma} \Eq_{\rho} [\phi :=
      T^{n}_{\Eq_{\rho}} K_0] \overline{[\alpha :=
        \Eq_{\setsem{\Gamma; \Phi \vdash \tau} \rho}]}} \\ 
&= T^{n}_{\Eq_{\rho}} K_0\, \overline{\relsem{\Gamma; \Phi,
      \phi, \ol{\alpha} \vdash \sigma} \Eq_{\rho} [\phi :=
      \Eq_{(T^\set_\rho)^{n} K_0}] \overline{[\alpha :=
        \Eq_{\setsem{\Gamma; \Phi \vdash \tau} \rho}]}} \\ 
&= T^{n}_{\Eq_{\rho}} K_0\, \overline{\relsem{\Gamma; \Phi,
      \phi, \ol{\alpha} \vdash \sigma} \Eq_{\rho [\phi := (T^\set_\rho)^{n}
        K_0] \overline{[\alpha := \setsem{\Gamma; \Phi \vdash
            \tau} \rho]}}} \\ 
&= T^{n}_{\Eq_{\rho}} K_0\, \overline{\Eq_{\setsem{\Gamma;
        \Phi, \phi, \ol{\alpha} \vdash \sigma} \rho [\phi :=
        (T^\set_\rho)^{n} K_0] \overline{[\alpha :=
          \setsem{\Gamma; \Phi \vdash \tau} \rho]}}} \\ 
&= (\Eq_{(T^\set_\rho)^{n} K_0})^* \,\overline{\Eq_{\setsem{\Gamma;
        \Phi, \phi, \ol{\alpha} \vdash \sigma} \rho [\phi :=
        (T^\set_\rho)^{n} K_0] \overline{[\alpha :=
          \setsem{\Gamma; \Phi \vdash \tau} \rho]}}} \\ 
&= (\Eq_{(T^\set_{\rho})^{n} K_0})^* \overline{\relsem{\Gamma;
      \Phi, \phi, \ol{\alpha} \vdash \sigma} \Eq_{\rho} [\phi :=
      \Eq_{(T^\set_{\rho})^{n} K_0}] \overline{[\alpha :=
        \Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}]}} \\ 
&= \relsem{\Gamma; \Phi, \phi, \ol{\alpha} \vdash \phi \ol{\sigma}}
  \Eq_{\rho} [\phi := \Eq_{(T^\set_{\rho})^{n} K_0}]
  \overline{[\alpha := \Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}]} 
\end{split}
\]
Here, the second equality is by the induction hypothesis
for~\eqref{eq:iel-fix-point-intermediate2} on the $\sigma$s, the
fourth is by the induction hypothesis for Theorem~\ref{thm:iel} on the
$\sigma$s, and the fifth is by the induction hypothesis on $n$
for~\eqref{eq:iel-fix-point-intermediate1}.
\item $\relsem{\Gamma; \Phi \vdash \sigma + \tau} \Eq_{\rho} =
  \relsem{\Gamma; \Phi \vdash \sigma} \Eq_{\rho} + \relsem{\Gamma;
    \Phi \vdash \tau} \Eq_{\rho} = \Eq_{\setsem{\Gamma; \Phi \vdash
      \sigma}\rho} + \Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho} =
  \Eq_{\setsem{\Gamma; \Phi \vdash \sigma}\rho + \setsem{\Gamma; \Phi
      \vdash \tau}\rho} = \Eq_{\setsem{\Gamma; \Phi \vdash \sigma +
      \tau}\rho}$
\item $\relsem{\Gamma; \Phi \vdash \sigma \times \tau} \Eq_{\rho} =
  \relsem{\Gamma; \Phi \vdash \sigma}\Eq_{\rho} \times \relsem{\Gamma;
    \Phi \vdash \tau}\Eq_{\rho} = \Eq_{\setsem{\Gamma; \Phi \vdash
      \sigma}\rho} \times \Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}
  = \Eq_{\setsem{\Gamma; \Phi \vdash \sigma}\rho \times
    \setsem{\Gamma; \Phi \vdash \tau}\rho} = \Eq_{\setsem{\Gamma;
      \Phi \vdash \sigma \times \tau}\rho}$
\end{itemize}
\end{proof}
\end{comment}

%It follows from Theorem~\ref{thm:iel} that $\relsem{\Gamma \vdash
%  \sigma \to \tau} \Eq_{\rho} = \Eq_{\setsem{\Gamma \vdash \sigma \to
%    \tau}\rho}$, as expected.  Moreover,

%\vspace*{0.05in}
%
%The Graph Lemma appropriate to our setting is now easily obtained:
\begin{lemma}[Graph Lemma]\label{lem:graph}
If $\rho, \rho' : \setenv$, $f : \rho \to \rho'$, and $\Gamma; \Phi
\vdash F : \F$, then $\graph{\setsem{\Gamma; \Phi \vdash F} f} =
\relsem{\Gamma; \Phi \vdash F}\graph{f}$.
\end{lemma}
\begin{proof}
Applying Lemma~\ref{lem:rel-transf-morph} to the morphisms $(f,
\id_{\rho'}) : \graph{f} \to \Eq_{\rho'}$ and $(\id_{\rho}, f) :
\Eq_{\rho} \to \graph{f}$ of relation environments gives that
$(\setsem{\Gamma; \Phi \vdash F}f, \setsem{\Gamma; \Phi \vdash
  F}\id_{\rho'}) = \relsem{\Gamma; \Phi \vdash F} (f, \id_{\rho'}) :
\relsem{\Gamma; \Phi \vdash F}\graph{f} \to \relsem{\Gamma; \Phi
  \vdash F}\Eq_{\rho'}$ and $(\setsem{\Gamma; \Phi \vdash
  F}\id_{\rho}, \setsem{\Gamma; \Phi \vdash F}f) = \relsem{\Gamma;
  \Phi \vdash F} (\id_{\rho}, f) : \relsem{\Gamma; \Phi \vdash
  F}\Eq_{\rho} \to \relsem{\Gamma; \Phi \vdash F}\graph{f}$.
Expanding the first equation gives that if $(x,y) \in \relsem{\Gamma;
  \Phi \vdash F}\graph{f}$ then $(\setsem{\Gamma; \Phi \vdash F} f\,
x, \setsem{\Gamma; \Phi \vdash F}\id_{\rho'}\, y) \in \relsem{\Gamma;
  \Phi \vdash F}\Eq_{\rho'}$.  Then $\setsem{\Gamma; \Phi \vdash
  F}\id_{\rho'}\, y = \id_{\setsem{\Gamma; \Phi \vdash F}\rho'}\, y =
y$ and $\relsem{\Gamma; \Phi \vdash F}\Eq_{\rho'} =
\Eq_{\setsem{\Gamma; \Phi \vdash F}\rho'}$, so if $(x,y) \in
\relsem{\Gamma; \Phi \vdash F}\graph{f}$ then $(\setsem{\Gamma; \Phi
  \vdash F} f\, x, y) \in \Eq_{\setsem{\Gamma; \Phi \vdash F}\rho'}$,
i.e., $\setsem{\Gamma; \Phi \vdash F} f\, x = y$, i.e., $(x, y) \in
\graph{\setsem{\Gamma; \Phi \vdash F} f}$.  So, we have that
$\relsem{\Gamma; \Phi \vdash F}\graph{f} \subseteq
\graph{\setsem{\Gamma; \Phi \vdash F}f}$.  Expanding the second
equation gives that if $x \in \setsem{\Gamma; \Phi \vdash F}\rho$ then
$(\setsem{\Gamma; \Phi \vdash F}\id_{\rho}\, x, \setsem{\Gamma; \Phi
  \vdash F} f\, x) \in \relsem{\Gamma; \Phi \vdash F}\graph{f}$.  Then
$\setsem{\Gamma; \Phi \vdash F}\id_{\rho}\, x = \id_{\setsem{\Gamma;
    \Phi \vdash F}\rho} x = x$, so for any $x \in \setsem{\Gamma; \Phi
  \vdash F}\rho$ we have that $(x, \setsem{\Gamma; \Phi \vdash F}f\,
x) \in \relsem{\Gamma; \Phi \vdash F}\graph{f}$.  Moreover, $x \in
\setsem{\Gamma; \Phi \vdash F}\rho$ if and only if $(x,
\setsem{\Gamma; \Phi \vdash F} f\, x) \in \graph{\setsem{\Gamma; \Phi
    \vdash F}f}$ and, if $x \in \setsem{\Gamma; \Phi \vdash F}\rho$
then $(x, \setsem{\Gamma; \Phi \vdash F} f\, x) \in \relsem{\Gamma;
  \Phi \vdash F} \graph{f}$, so if $(x, \setsem{\Gamma; \Phi \vdash F}
f\, x) \in \graph{\setsem{\Gamma; \Phi \vdash F}f}$ then $(x,
\setsem{\Gamma; \Phi \vdash F} f\, x) \in \relsem{\Gamma; \Phi \vdash
  F} \graph{f}$, i.e., $\graph{\setsem{\Gamma; \Phi \vdash F}f}
\subseteq \relsem{\Gamma; \Phi \vdash F} \graph{f}$.


\end{proof}



\begin{comment}

\begin{proof}
First observe that $(f, \id_{\rho'}) : \graph{f} \to \Eq_{\rho'}$ and
$(\id_{\rho}, f) : \Eq_{\rho} \to \graph{f}$ are morphisms of relation
environments.  Applying Lemma~\ref{lem:rel-transf-morph} to each of
these observations gives that
\begin{equation}\label{eq:graph-one}
(\setsem{\Gamma; \Phi \vdash F}f, \setsem{\Gamma; \Phi \vdash
    F}\id_{\rho'}) = \relsem{\Gamma; \Phi \vdash F} (f, \id_{\rho'}) :
  \relsem{\Gamma; \Phi \vdash F}\graph{f} \to \relsem{\Gamma; \Phi
    \vdash F}\Eq_{\rho'}
\end{equation}
and
\begin{equation}\label{eq:graph-two}
(\setsem{\Gamma; \Phi \vdash F}\id_{\rho}, \setsem{\Gamma; \Phi \vdash F}f)
= \relsem{\Gamma; \Phi \vdash F} (\id_{\rho}, f)
: \relsem{\Gamma; \Phi \vdash F}\Eq_{\rho} \to \relsem{\Gamma; \Phi \vdash F}\graph{f}
\end{equation}
Expanding Equation~\ref{eq:graph-one} gives that if
$(x,y) \in \relsem{\Gamma; \Phi \vdash F}\graph{f}$
then
\[(\setsem{\Gamma; \Phi \vdash F} f\, x, \setsem{\Gamma; \Phi \vdash
  F}\id_{\rho'}\, y) \in \relsem{\Gamma; \Phi \vdash F}\Eq_{\rho'}\]
Observe that $\setsem{\Gamma; \Phi \vdash F}\id_{\rho'}\, y =
\id_{\setsem{\Gamma; \Phi \vdash F}\rho'}\, y = y$ and
$\relsem{\Gamma; \Phi \vdash F}\Eq_{\rho'} = \Eq_{\setsem{\Gamma; \Phi
    \vdash F}\rho'}$. So, if $(x,y) \in \relsem{\Gamma; \Phi \vdash
  F}\graph{f}$ then $(\setsem{\Gamma; \Phi \vdash F} f\, x, y) \in
\Eq_{\setsem{\Gamma; \Phi \vdash F}\rho'}$, i.e., $\setsem{\Gamma;
  \Phi \vdash F} f\, x = y$, i.e., $(x, y) \in \graph{\setsem{\Gamma;
    \Phi \vdash F} f}$.  So, we have that $\relsem{\Gamma; \Phi \vdash
  F}\graph{f} \subseteq \graph{\setsem{\Gamma; \Phi \vdash F}f}$

Expanding Equation~\ref{eq:graph-two} gives that, for any
$x \in \setsem{\Gamma; \Phi \vdash F}\rho$,
then
\[
(\setsem{\Gamma; \Phi \vdash F}\id_{\rho}\, x, \setsem{\Gamma; \Phi
  \vdash F} f\, x) \in \relsem{\Gamma; \Phi \vdash F}\graph{f} 
\]
Observe that $\setsem{\Gamma; \Phi \vdash F}\id_{\rho}\, x =
\id_{\setsem{\Gamma; \Phi \vdash F}\rho} x = x$ so, for any $x \in
\setsem{\Gamma; \Phi \vdash F}\rho$, we have that $(x, \setsem{\Gamma;
  \Phi \vdash F}f\, x) \in \relsem{\Gamma; \Phi \vdash F}\graph{f}$.
Moreover, $x \in \setsem{\Gamma; \Phi \vdash F}\rho$ if and only if
$(x, \setsem{\Gamma; \Phi \vdash F} f\, x) \in \graph{\setsem{\Gamma;
    \Phi \vdash F}f}$ and, if $x \in \setsem{\Gamma; \Phi \vdash
  F}\rho$ then $(x, \setsem{\Gamma; \Phi \vdash F} f\, x) \in
\relsem{\Gamma; \Phi \vdash F} \graph{f}$, so if $(x, \setsem{\Gamma;
  \Phi \vdash F} f\, x) \in \graph{\setsem{\Gamma; \Phi \vdash F}f}$
then $(x, \setsem{\Gamma; \Phi \vdash F} f\, x) \in \relsem{\Gamma;
  \Phi \vdash F} \graph{f}$, i.e., $\graph{\setsem{\Gamma; \Phi \vdash
    F}f} \subseteq \relsem{\Gamma; \Phi \vdash F} \graph{f}$. We
conclude that $\relsem{\Gamma; \Phi \vdash F}\graph{f} =
\graph{\setsem{\Gamma; \Phi \vdash F}f}$ as desired.
\end{proof}
\end{comment}

\section{Interpreting Terms}\label{sec:term-interp}

{\color{blue} Double use of brackets confusing? (Graphs and pairing
  morphisms)} 
%  Here, we are using angle bracket notation for both the
%  graph relation of a function and for the pairing of functions with
%  the same domain. This is justified by the relationship between the
%  two notions observed immediately after
%  Lemma~\ref{lem:graph-reln-functors}.}

If $\Delta = x_1 : \tau_1,...,x_n : \tau_n$ is a term context for $\Gamma$
and $\Phi$, then the interpretations $\setsem{\Gamma;\Phi \vdash \Delta}$ and
$\relsem{\Gamma;\Phi \vdash \Delta}$ are defined by
\[\begin{array}{lll}
\setsem{\Gamma;\Phi \vdash \Delta} & = & \setsem{\Gamma;\Phi \vdash
  \tau_1} \times ... \times \setsem{\Gamma;\Phi \vdash \tau_n}\\ 
\relsem{\Gamma;\Phi \vdash \Delta} & = & \relsem{\Gamma;\Phi \vdash
  \tau_1} \times ... \times \relsem{\Gamma;\Phi \vdash \tau_n}\\ 
\end{array}\]
Every well-formed term $\Gamma;\Phi~|~\Delta \vdash t : \tau$ then
has, for every $\rho \in \setenv$, set interpretations
$\setsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}\rho$ as natural
transformations from $\setsem{\Gamma; \Phi \vdash \Delta}\rho$ to
$\setsem{\Gamma; \Phi \vdash \tau}\rho$, and, for every $\rho \in
\relenv$, relational interpretations $\relsem{\Gamma;\Phi~|~\Delta
  \vdash t : \tau}\rho$ as natural transformations from
$\relsem{\Gamma; \Phi \vdash \Delta}\rho$ to $\relsem{\Gamma; \Phi
  \vdash \tau}\rho$. These are given in the next (two) definitions.

\begin{dfn}\label{def:set-interp}
If $\rho$ is a set (resp., relation) environment and
$\Gamma;\Phi~|~\Delta \vdash t : \tau$ then
$\setsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}\rho$ (resp.,
$\relsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}\rho$) is defined as
follows, where $\mathsf D$ is either $\set$ or $\rel$ as appropriate:
\[\begin{array}{lll}
\dsem{\Gamma;\emptyset \,|\, \Delta,x :\tau \vdash x : \tau} \rho& = &
\pi_{|\Delta|+1}\\
%\dsem{\Gamma;\emptyset \,|\, \Delta \vdash \lambda x.t : \sigma \to \tau}\rho &
%= & \curry (\dsem{\Gamma;\emptyset \,|\, \Delta, x : \sigma \vdash t :
%  \tau}\rho)\\ 
%\dsem{\Gamma;\emptyset \,|\, \Delta \vdash st: \tau} \rho & = &
%\eval \circ
% \langle \dsem{\Gamma;\emptyset \,|\, \Delta \vdash s: \sigma \to
%  \tau}\rho, \dsem{\Gamma;\emptyset \,|\, \Delta \vdash t: \sigma}\rho
%\rangle\\
\dsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline \alpha} x.t : \Nat^{\overline
    \alpha} \,F \,G}\rho & = &  \curry (\dsem{\Gamma;\overline \alpha
  \,|\, \Delta, x : F \vdash t: G}\rho[\overline{\alpha := \_}])\\
\dsem{\Gamma;\Phi \,|\, \Delta \vdash t_{\overline \tau} s:
  G [\overline{\alpha := \tau}]}\rho & = & \eval \circ \langle
  \lambda d.\,(\dsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
  \Nat^{\overline{\alpha}} \,F \,G}\rho\; d)_{\overline{\dsem{\Gamma;\Phi
      \vdash \tau}\rho}},\\ 
 & & \hspace*{0.5in} \dsem{\Gamma;\Phi \,|\,
    \Delta \vdash s: F [\overline{\alpha := \tau}]}\rho \rangle\\ 
& & \\
%% \color{red} \mbox{Add rules for } \forall \mbox{ if we include it} & & \\
\dsem{\Gamma;\Phi \,|\, \Delta,x :\tau \vdash x : \tau} \rho& = &
\pi_{|\Delta|+1}\\
\dsem{\Gamma;\Phi \,|\, \Delta \vdash \bot_\tau t : \tau} \rho& = &
!^0_{\dsem{\Gamma;\Phi \vdash \tau}\rho} \circ
  \dsem{\Gamma;\Phi~|~\Delta \vdash t : \zerot}\rho, \mbox{ where } \\
 & & \hspace*{0.1in} !^0_{\dsem{\Gamma;\Phi \vdash \tau}\rho}
\mbox{ is the unique morphism from } 0\\
 & & \hspace*{0.1in} \mbox{ to } \dsem{\Gamma;\Phi \vdash \tau}\rho\\
\dsem{\Gamma;\Phi \,|\, \Delta \vdash \top : \onet}\rho & = &
!^{\dsem{\Gamma;\Phi\vdash \Delta}\rho}_1, \mbox{ where }
!^{\dsem{\Gamma;\Phi\vdash \Delta}\rho}_1\\ 
& & \hspace*{0.1in} \mbox{ is the unique morphism from }
\dsem{\Gamma;\Phi\vdash \Delta}\rho \mbox{ to } 1\\ 
\dsem{\Gamma;\Phi \,|\, \Delta \vdash (s,t) : \sigma \times \tau} \rho& = &
\dsem{\Gamma;\Phi \,|\, \Delta \vdash s: \sigma} \rho\times
\dsem{\Gamma;\Phi \,|\, \Delta \vdash t : \tau} \rho\\
\dsem{\Gamma;\Phi \,|\, \Delta \vdash \pi_1 t : \sigma} \rho& = &
\pi_1 \circ \dsem{\Gamma;\Phi \,|\, \Delta \vdash t : \sigma \times \tau}\rho\\
\dsem{\Gamma;\Phi \,|\, \Delta \vdash \pi_2 t : \sigma}\rho & = &
\pi_2 \circ \dsem{\Gamma;\Phi \,|\, \Delta \vdash t : \sigma \times
  \tau} \rho\\
\dsem{\Gamma;\Phi~|~\Delta \vdash \case{t}{x \mapsto l}{y \mapsto r} :
  \gamma}\rho & = & \eval \circ \langle \curry \,[\dsem{\Gamma;\Phi
    \,|\, \Delta, x : \sigma \vdash l : \gamma}\rho,\\
   & & \hspace*{0.79in} \dsem{\Gamma;\Phi \,|\, \Delta, y
    : \tau \vdash r : \gamma}\rho],\\
   & &  \hspace*{0.5in} \dsem{\Gamma;\Phi \,|\, \Delta \vdash t :
  \sigma + \tau} \rho\rangle\\   
\dsem{\Gamma;\Phi \,|\, \Delta \vdash \inl \,s: \sigma + \tau} \rho& = &
\inl \circ \dsem{\Gamma;\Phi \,|\, \Delta \vdash s: \sigma}\rho\\
\dsem{\Gamma;\Phi \,|\, \Delta \vdash \inr \,t: \sigma + \tau}\rho & = & 
\inr \circ \dsem{\Gamma;\Phi \,|\, \Delta \vdash t : \tau}\rho\\
\llbracket \Gamma;\emptyset \,|\, \emptyset \vdash \map^{\ol{F},\ol{G}}_H :
\Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;&
= & \lambda d\, \ol{\eta}\,\ol{B}.\,
\dsem{\Gamma; \ol{\phi},\ol{\gamma}\vdash H}\id_{\rho[\ol{\gamma :=
      B}]}[\ol{\phi := \lambda \ol{A}.\eta_{\ol{A}\,\ol{B}}}]\\
\hspace*{0.79in} (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
      :=_{\ol{\beta}} G}]) \rrbracket^\set \rho & & \\
\llbracket \Gamma;\emptyset \,|\, \emptyset \vdash \tin_H :
Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda {\overline
    \alpha}.H){\overline \beta}][\ol{\alpha := \beta}] & = &
\lambda d\,\ol{B}\, \ol{C}.\,(\mathit{in}_{{T}^\set_{H,\rho[\ol{\gamma := C}]}})_{\ol{B}}\\
\hspace*{0.79in}(\mu \phi.\lambda {\overline \alpha}.H){\overline
  \beta} \rrbracket^\set \rho & & \\
\llbracket \Gamma;\emptyset \,|\, \emptyset \vdash
  \fold^F_H : \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F) & = &  
\lambda d\,\eta\,\ol{B}\,\ol{C}.\,
(\mathit{fold}_{T^\set_{H,\rho[\ol{\gamma := C}]}} \, (\lambda
\ol{A}.\,\eta_{\ol{A}\,\ol{C}}))_{\ol{B}}\\ 
\hspace*{0.79in}(\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu
  \phi.\lambda \overline \alpha.H)\overline \beta\;F)
\rrbracket^\set \rho & & 
\end{array}\]
\end{dfn}
\noindent
The return type for the semantic fold in the last clause is
$\dsem{\Gamma;\ol\beta,\ol\gamma \vdash F}\rho[\ol{\gamma := C}]$.
This interpretation gives that $\dsem{\Gamma;\emptyset \,|\, \Delta
  \vdash \lambda x.t : \sigma \to \tau}\rho = \curry
(\dsem{\Gamma;\emptyset \,|\, \Delta, x : \sigma \vdash t :
  \tau}\rho)$ and $\dsem{\Gamma;\emptyset \,|\, \Delta \vdash st:
  \tau} \rho = \eval \circ \langle \dsem{\Gamma;\emptyset \,|\,
  \Delta \vdash s: \sigma \to \tau}\rho, \dsem{\Gamma;\emptyset
  \,|\, \Delta \vdash t: \sigma}\rho \rangle$, {\color{blue} so it
  specializes to the standard interpretations for System F terms}.  If
$t$ is closed, i.e., if $\emptyset; \emptyset~|~\emptyset \vdash t :
\tau$, then we write $\dsem{\vdash t : \tau}$ instead of
$\dsem{\emptyset; \emptyset~|~\emptyset \vdash t : \tau}$.
%, and similarly for $\relsem{\emptyset; \emptyset~|~\emptyset \vdash
%t : \tau}$.

\begin{comment}

\begin{dfn}\label{def:rel-interp}
If $\rho$ is a relation environment and $\Gamma;\Phi~|~\Delta \vdash t :
\tau$ then $\relsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}\rho$ is
defined as follows:
\[\begin{array}{lll}
\relsem{\Gamma;\emptyset \,|\, \Delta,x :\tau \vdash x : \tau} \rho& = &
\pi_{|\Delta|+1}\\
%\relsem{\Gamma;\emptyset \,|\, \Delta \vdash \lambda x.t : \sigma \to \tau}\rho &
%= & \curry (\relsem{\Gamma;\emptyset \,|\, \Delta, x : \sigma \vdash t :
%  \tau}\rho)\\ 
%\relsem{\Gamma;\emptyset \,|\, \Delta \vdash st: \tau} \rho & = & \eval
%\circ \langle \relsem{\Gamma;\emptyset \,|\, \Delta \vdash s: \sigma \to
%  \tau}\rho, \relsem{\Gamma;\emptyset \,|\, \Delta \vdash t: \sigma}\rho
%\rangle\\
\relsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline \alpha} x.t : \Nat^{\overline
    \alpha} \,F \,G}\rho & = &  \curry (\relsem{\Gamma;\overline \alpha
  \,|\, \Delta, x : F \vdash t: G}\rho[\overline{\alpha := \_}])\\
\relsem{\Gamma;\Phi \,|\, \Delta \vdash t_{\overline{\tau}} s:
  G [\overline{\alpha := \tau}]}\rho & = & \eval \circ \langle
  \lambda e. \,(\relsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
  \Nat^{\overline{\alpha}} \,F \,G}\rho\; e)_{\overline{\relsem{\Gamma;\Phi
      \vdash \tau}\rho}},\\ 
 & & \hspace*{0.5in} \relsem{\Gamma;\Phi \,|\,
    \Delta \vdash s: F [\overline{\alpha := \tau}]}\rho \rangle\\ 
& & \\
%% \color{red} \mbox{Add rules for } \forall \mbox{ if we include it} & & \\
\relsem{\Gamma;\Phi \,|\, \Delta,x :\tau \vdash x : \tau} \rho& = &
\pi_{|\Delta|+1}\\
\relsem{\Gamma;\Phi \,|\, \Delta \vdash \bot_\tau t : \tau} \rho& = &
!^0_{\relsem{\Gamma;\Phi \vdash \tau}\rho} \circ
  \relsem{\Gamma;\Phi~|~\Delta \vdash t : \zerot}\rho, \mbox{ where } \\
 & & \hspace*{0.1in} !^0_{\relsem{\Gamma;\Phi \vdash \tau}\rho}
\mbox{ is the unique morphism from } 0\\
 & & \hspace*{0.1in} \mbox{ to } \relsem{\Gamma;\Phi \vdash \tau}\rho\\
\relsem{\Gamma;\Phi \,|\, \Delta \vdash \top : \onet}\rho & = &
!^{\relsem{\Gamma;\Phi\vdash \Delta}\rho}_1, \mbox{ where }
!^{\relsem{\Gamma;\Phi\vdash \Delta}\rho}_1\\ 
& & \hspace*{0.1in} \mbox{ is the unique morphism from }
\relsem{\Gamma;\Phi\vdash \Delta}\rho \mbox{ to } 1\\ 
\relsem{\Gamma;\Phi \,|\, \Delta \vdash (s,t) : \sigma \times \tau} \rho& = &
\relsem{\Gamma;\Phi \,|\, \Delta \vdash s: \sigma} \rho\times
\relsem{\Gamma;\Phi \,|\, \Delta \vdash t: \tau} \rho\\
\relsem{\Gamma;\Phi \,|\, \Delta \vdash \pi_1 t : \sigma} \rho& = &
\pi_1 \circ \relsem{\Gamma;\Phi \,|\, \Delta \vdash t : \sigma \times \tau}\rho\\
\relsem{\Gamma;\Phi \,|\, \Delta \vdash \pi_2 t : \sigma}\rho & = &
\pi_2 \circ \relsem{\Gamma;\Phi \,|\, \Delta \vdash t : \sigma \times
  \tau} \rho\\
\relsem{\Gamma;\Phi~|~\Delta \vdash \case{t}{x \mapsto l}{y \mapsto r} :
  \gamma}\rho & = & \eval \circ \langle \curry \,[\relsem{\Gamma;\Phi
    \,|\, \Delta, x : \sigma \vdash l : \gamma}\rho,\\
   & & \hspace*{0.79in} \relsem{\Gamma;\Phi \,|\, \Delta, y
    : \tau \vdash r : \gamma}\rho],\\
   & &  \hspace*{0.5in} \relsem{\Gamma;\Phi \,|\, \Delta \vdash t :
  \sigma + \tau} \rho\rangle \\
\relsem{\Gamma;\Phi \,|\, \Delta \vdash \inl \,s: \sigma + \tau} \rho& = &
\inl \circ \relsem{\Gamma;\Phi \,|\, \Delta \vdash s: \sigma}\rho\\
\relsem{\Gamma;\Phi \,|\, \Delta \vdash \inr \,t: \sigma + \tau}\rho & = & 
\inr \circ \relsem{\Gamma;\Phi \,|\, \Delta \vdash t : \tau}\rho\\
\llbracket \Gamma;\emptyset \,|\, \emptyset \vdash \map^{\ol{F},\ol{G}}_H :
\Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;&
= & \lambda d\, \ol{\eta}\,\ol{R}.\,
\relsem{\Gamma; \ol{\phi},\ol{\gamma}\vdash H}\id_{\rho[\ol{\gamma :=
      R}]}[\ol{\phi := \lambda \ol{S}.\eta_{\ol{S}\,\ol{R}}}]\\
\hspace*{0.79in} (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
      :=_{\ol{\beta}} G}]) \rrbracket^\rel \rho & & \\
\llbracket \Gamma;\emptyset \,|\, \emptyset \vdash \tin_H :
Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda {\overline
    \alpha}.H){\overline \beta}][\ol{\alpha := \beta}] & = &
\lambda d\,\ol{R}\, \ol{S}.\,(\mathit{in}_{T_{\rho[\ol{\gamma := S}]}})_{\ol{R}}\\
\hspace*{0.79in}(\mu \phi.\lambda {\overline \alpha}.H){\overline
  \beta} \rrbracket^\rel \rho & & \\
\llbracket \Gamma;\emptyset \,|\, \emptyset \vdash
  \fold^F_H : \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F) & = &  
\lambda d\,\eta\,\ol{R}\,\ol{S}.\, (\mathit{fold}_{T_{\rho[\ol{\gamma
        := S}]}} \, (\lambda
\ol{Z}.\,\eta_{\ol{Z}\,\ol{S}}))_{\ol{R}}\\
\hspace*{0.79in}(\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu
  \phi.\lambda \overline \alpha.H)\overline \beta\;F)
\rrbracket^\rel \rho & & 
\end{array}\]
\end{dfn}
{\color{blue} Add return type for fold in last clause? Should be
  $\relsem{\Gamma;\ol\beta,\ol\gamma \vdash F}\rho[\ol{\gamma :=
  C}]$.}

This interpretation gives that $\relsem{\Gamma;\emptyset \,|\, \Delta
  \vdash \lambda x.t : \sigma \to \tau}\rho = \curry
(\relsem{\Gamma;\emptyset \,|\, \Delta, x : \sigma \vdash t :
  \tau}\rho)$ and $\relsem{\Gamma;\emptyset \,|\, \Delta \vdash st:
  \tau} \rho = \eval \circ \langle \relsem{\Gamma;\emptyset \,|\,
  \Delta \vdash s: \sigma \to \tau}\rho, \relsem{\Gamma;\emptyset
  \,|\, \Delta \vdash t: \sigma}\rho \rangle$, as expected.

If $t$ is closed, i.e., if $\emptyset; \emptyset~|~\emptyset \vdash t
: \tau$, then we write $\setsem{\vdash t : \tau}$ instead of
$\setsem{\emptyset; \emptyset~|~\emptyset \vdash t : \tau}$.
\end{comment}

\subsection{Basic Properties of Term Interpretations}

The interpretations in Definition~\ref{def:set-interp} respect
weakening, i.e., a term and its weakenings all have the same set and
relational interpretations. In particular, for any $\rho \in \setenv$,
\[ \setsem{\Gamma;\Phi \,|\, \Delta, x : \sigma \vdash t : \tau}\rho
  = (\setsem{\Gamma;\Phi \,|\, \Delta \vdash t : \tau}\rho) \circ
  \pi_{\Delta}\] where $\pi_{\Delta}$ is the projection
  $\setsem{\Gamma;\Phi \vdash \Delta, x : \sigma} \to
  \setsem{\Gamma;\Phi \vdash \Delta}$, and similarly for relational
  interpretations. 
\begin{comment}
  , and for any $\rho \in \relenv$, 
\[ \relsem{\Gamma;\Phi \,|\, \Delta, x : \sigma \vdash t : \tau}\rho
  = (\relsem{\Gamma;\Phi \,|\, \Delta \vdash t : \tau}\rho) \circ
  \pi_{\Delta}\] where $\pi_{\Delta}$ is the projection
  $\relsem{\Gamma;\Phi \vdash \Delta, x : \sigma} \to
  \relsem{\Gamma;\Phi \vdash \Delta}$.
\end{comment}
  Moreover, if
  $\Gamma,\alpha;\Phi \,|\, \Delta \vdash t : \tau$ and
  $\Gamma;\Phi,\alpha \,|\, \Delta \vdash t' : \tau$ and $\Gamma;\Phi
  \vdash \sigma : \F$ then
\begin{itemize}
\item $\setsem{\Gamma;\Phi \,|\, \Delta[\alpha := \sigma] \vdash
  t[\alpha := \sigma] : \tau[\alpha := \sigma]}\rho =
  \setsem{\Gamma,\alpha;\Phi \,|\, \Delta \vdash t : \tau }\rho [
    \alpha := \setsem{\Gamma;\Phi\vdash\sigma}\rho ]$
%\item $\relsem{\Gamma;\Phi \,|\, \Delta[\alpha := \sigma] \vdash
%  t[\alpha := \sigma] : \tau[\alpha := \sigma]}\rho =
%  \relsem{\Gamma,\alpha;\Phi \,|\, \Delta \vdash t : \tau }\rho [
%    \alpha := \relsem{\Gamma;\Phi\vdash\sigma}\rho ]$
\item $\setsem{\Gamma;\Phi \,|\, \Delta[\alpha := \sigma] \vdash
  t'[\alpha := \sigma] : \tau[\alpha := \sigma]}\rho =
  \setsem{\Gamma;\Phi,\alpha \,|\, \Delta \vdash t' : \tau }\rho [
    \alpha := \setsem{\Gamma;\Phi\vdash\sigma}\rho ]$
%\item $\relsem{\Gamma;\Phi \,|\, \Delta[\alpha := \sigma] \vdash
%  t'[\alpha := \sigma] : \tau[\alpha := \sigma]}\rho =
%  \relsem{\Gamma;\Phi,\alpha \,|\, \Delta \vdash t' : \tau }\rho [
%    \alpha := \relsem{\Gamma;\Phi\vdash\sigma}\rho ]$
\end{itemize}
and if $\Gamma;\Phi \,|\, \Delta, x: \sigma \vdash t : \tau$ and
$\Gamma;\Phi \,|\, \Delta \vdash s : \sigma$ then
\begin{itemize}
\item $\lambda A.\, \setsem{\Gamma;\Phi \,|\, \Delta \vdash t[x := s]
  : \tau }\rho \, A = \lambda A.\,\setsem{\Gamma;\Phi \,|\, \Delta, x:
  \sigma \vdash t : \tau}\rho \,(A, \setsem{\Gamma;\Phi \,|\,
  \Delta\vdash s: \sigma}\rho\, A)$
%\item $\lambda R.\,\relsem{\Gamma;\Phi \,|\, \Delta \vdash t[x := s] :
%  \tau }\rho\,R = \lambda R.\,\relsem{\Gamma;\Phi \,|\, \Delta, x:
%  \sigma \vdash t : \tau}\rho \,(R, \relsem{\Gamma;\Phi \,|\,
%  \Delta\vdash s: \sigma}\rho\,R)$
\end{itemize}
Direct calculation reveals that the set interpretations of terms also
satisfy
\begin{itemize}
\item $\setsem{\Gamma; \Phi~|~\Delta \vdash
  (L_{\ol{\alpha}}x.t)_{\ol{\tau}}s} = \setsem{\Gamma; \Phi~|~\Delta
  \vdash t [\ol{\alpha := \tau}][x := s]}$
\end{itemize}
{\color{blue} Term extensionality with respect to types and terms ---
  i.e., $\setsem{\Gamma;\Phi\vdash (L_\alpha x.t)_\alpha \top} =
  \setsem{\Gamma;\Phi \vdash t}$ and $\setsem{\Gamma;\Phi\vdash
    (L_\alpha x.t)_\alpha x} = \setsem{\Gamma;\Phi \vdash t}$}
%$\relsem{\Gamma;\Phi\vdash (L_\alpha x.t)_\alpha t} =
%\relsem{\Gamma;\Phi \vdash t}$, as well as
%term extensionality
%and $\relsem{\Gamma;\Phi\vdash
%  (L_\alpha x.t)_\alpha \top} = \relsem{\Gamma;\Phi \vdash t}$
--- follow. Similar properties hold for relational interpretations.

\subsection{Properties of Terms of $\Nat$-Type}

Define, for $\Gamma; \ol{\alpha} \vdash F$, the term {\color{blue}
  $\id_F$} to be $\Gamma;\emptyset~|~\emptyset \vdash
L_{\ol{\alpha}}x.x : \Nat^{\ol{\alpha}} F\,F$ and, for terms $\Gamma;
\emptyset \,|\, \Delta \vdash t: \Nat^{\overline{\alpha}} F\,G$ and
$\Gamma; \emptyset \,|\, \Delta \vdash s: \Nat^{\overline{\alpha}}
G\,H$, the {\em composition} $s \circ t$ of $t$ and $s$ to be $\Gamma;
\emptyset \,|\, \Delta \vdash L_{\overline{\alpha}}
x. s_{\overline{\alpha}}(t_{\overline{\alpha}}x):
\Nat^{\overline{\alpha}} F\,H$. Then $\setsem{\Gamma; \emptyset \,|\,
  \emptyset \vdash \id_{F} : \Nat^{\ol{\alpha}} F\,F} \rho\, \ast =
\id_{\lambda \ol{A}. \setsem{\Gamma; \ol{\alpha} \vdash F} \rho
  [\ol{\alpha := A}]}$ for any set environment $\rho$, and
$\setsem{\Gamma; \emptyset \,|\, \Delta \vdash s \circ t:
  \Nat^{\overline{\alpha}} F\,H} = \setsem{\Gamma; \emptyset \,|\,
  \Delta \vdash s: \Nat^{\overline{\alpha}} G\,H} \circ
\setsem{\Gamma; \emptyset \,|\, \Delta \vdash t:
  \Nat^{\overline{\alpha}} F\,G}$.  Straightforward calculation using
these equalities shows that terms of $\Nat$ type behave as
natural transformations with respect to their source and target
functorial types, i.e.,
\begin{thm}\label{eq:ft-from-nat}
\[\begin{array}{l}
\hspace*{0.135in}\setsem{\Gamma; \emptyset \,|\, x :
  \Nat^{\overline{\alpha}, 
    \overline{\gamma}} F\,G, \overline{y : \Nat^{\overline{\gamma}}
    \sigma\, \tau} \vdash ((\map_G^{\overline{\sigma},
    \overline{\tau}})_{\emptyset} \overline{y}) \circ
  (L_{\overline{\gamma}} z. x_{\overline{\sigma}, \overline{\gamma}}
  z) : \Nat^{\overline{\gamma}} F[\overline{\alpha := \sigma}]\,
  G[\overline{\alpha := \tau}]}\\
= \setsem{ \Gamma; \emptyset \,|\, x
  : \Nat^{\overline{\alpha}, \overline{\gamma}} F\, G, \overline{y :
    \Nat^{\overline{\gamma}} \sigma\, \tau} \vdash
  (L_{\overline{\gamma}} z. x_{\overline{\tau}, \overline{\gamma}} z)
  \circ ((\map_F^{\overline{\sigma}, \overline{\tau}})_{\emptyset}
  \overline{y}) : \Nat^{\overline{\gamma}} F[\overline{\alpha :=
      \sigma}]\, G[\overline{\alpha := \tau}]}
\end{array}\]
\end{thm}
When $x = in_H$ and $\xi = \Nat^{\overline{\gamma}} H[\phi := (\mu
  \phi. \lambda \overline{\alpha}. H)
  \overline{\beta}][\overline{\alpha := \sigma}]\, (\mu \phi. \lambda
\overline{\alpha}. H)\overline{\tau}$ Theorem~\ref{eq:ft-from-nat}
specializes to
\begin{equation}\label{thm:subst}
\begin{array}{l}
\hspace*{0.135in}\setsem{\Gamma; \emptyset \,|\, \overline{y :
    \Nat^{\overline{\gamma}} 
    \sigma\, \tau} \vdash ((\map_{(\mu \phi. \lambda
    \overline{\alpha}. H) \overline{\beta}}^{\overline{\sigma},
    \overline{\tau}})_{\emptyset} \overline{y}) \circ
  (L_{\overline{\gamma}} z. (\tin_{H})_{\overline{\sigma},
    \overline{\gamma}} z) : \xi}\\
= \setsem{\Gamma; \emptyset \,|\, \overline{y :
  \Nat^{\overline{\gamma}} \sigma\, \tau} 
  \vdash (L_{\overline{\gamma}} z. (\tin_H)_{\overline{\tau}, \overline{\gamma}} z)
  \circ ((\map_{H[\phi := (\mu \phi. \lambda \overline{\alpha}. H)
      \overline{\beta}]}^{\overline{\sigma},
    \overline{\tau}})_{\emptyset} \overline{y}) 
  : \xi}
\end{array}
\end{equation}
\noindent
Theorem~\ref{eq:ft-from-nat} gives a family of free theorems that are
consequences of naturality, and thus do not require the full power of
parametricity. Other specific instances include the three
$\mathtt{map}$/$\mathtt{reverse}$ theorems from
Section~\ref{sec:intro}. In our setting, the
$\mathtt{map}$/$\mathtt{reverse}$ theorem for bushes, e.g., becomes
\begin{align*}
  &\setsem{\emptyset; \alpha~|~ y : \Nat^\emptyset \sigma \, \tau
    \vdash ((\map_{\mathit{Bush}\,\alpha}^{{\sigma},
      {\tau}})_{\emptyset} {y}) \circ (L_{{\emptyset}}
    z. \mathit{reverseBush}_{\sigma} z) : \Nat^{{\emptyset}}
    (\mathit{Bush} \, \sigma) \, (\mathit{Bush} \, \tau) }\\ =\;
  &\setsem{\emptyset; \alpha~|~ y : \Nat^\emptyset \sigma \, \tau
    \vdash (L_{\emptyset} z. \mathit{reverseBush}_{\tau} z) \circ
    ((\map_{\mathit{Bush} \, \alpha}^{{\sigma}, {\tau}})_{\emptyset}
           {y}) : \Nat^{\emptyset} (\mathit{Bush} \, \sigma ) \,
           (\mathit{Bush} \, \tau)}
\end{align*}
for any term $\vdash \mathit{reverseBush} : \Nat^\alpha (\mathit{Bush}
\,\alpha) \, (\mathit{Bush} \, \alpha)$. We can also prove a theorem
for the data type $\emptyset;\alpha,\gamma \vdash
\mathit{Tree}\,\alpha\,\gamma$ from Section~\ref{sec:calculus} that is
similar but only maps along some of its functorial variables:
%  \begin{align*}
%  &\setsem{\emptyset; \alpha~|~ y : \Nat^\emptyset \sigma \, \tau
%    \vdash ((\map_{\mathit{PTree}\,\alpha}^{{\sigma},
%      {\tau}})_{\emptyset} {y}) \circ (L_{{\emptyset}}
%    z. \mathit{reverse}_{\sigma} z) : \Nat^{{\emptyset}}
%    (\mathit{PTree} \, \sigma) \, (\mathit{PTree} \, \tau) }\\ =\;
%  &\setsem{\emptyset; \alpha~|~ y : \Nat^\emptyset \sigma \, \tau
%    \vdash (L_{\emptyset} z. \mathit{reverse}_{\tau} z) \circ
%    ((\map_{\mathit{PTree} \, \alpha}^{{\sigma}, {\tau}})_{\emptyset} {y}) :
%    \Nat^{\emptyset} (\mathit{PTree} \, \sigma ) \, (\mathit{PTree} \,
%    \tau)}
%\end{align*}
%for any term $\vdash \mathit{reverse} : \Nat^\alpha (\mathit{PTree}
%\,\alpha) \, (\mathit{PTree} \, \alpha)$,
if $\vdash \mathit{reverseTree} : \Nat^{\alpha, \gamma} (\mathit{Tree}
\,\alpha \, \gamma) \, (\mathit{Tree} \, \alpha \, \gamma)$ then
\begin{align*}
  &\setsem{\emptyset; \alpha,\gamma~|~y : \Nat^\emptyset \sigma \,
    \tau \vdash ((\map_{\mathit{Tree}\,\alpha \, \gamma}^{{\sigma},
      {\tau}})_{\emptyset} {y}) \circ (L_{{\gamma}}
    z. \mathit{reverseTree}_{\sigma, \gamma} z) : \Nat^{{\gamma}}
    (\mathit{Tree} \, \sigma \, \gamma) \, (\mathit{Tree} \, \tau \,
    \gamma) }\\ = &\setsem{\emptyset; \alpha,\gamma~|~y :
    \Nat^\emptyset \sigma \, \tau \vdash (L_{\gamma}
    z. \mathit{reverseTree}_{\tau, \gamma} z) \circ
    ((\map_{\mathit{Tree} \, \alpha\, \gamma}^{{\sigma},
      {\tau}})_{\emptyset} {y}) : \Nat^{\gamma} (\mathit{Tree} \,
    \sigma \, \gamma) \, (\mathit{Tree} \, \tau\, \gamma)}
\end{align*}
\noindent
%Note this instance uses the following version of map:
%$$\map_{\mathit{Tree} \,\alpha \, \gamma}^{\sigma, \tau} : 
%\Nat^{\emptyset} (\Nat^\gamma \, \sigma \,\tau)\,
%(\Nat^\gamma(\mathit{Tree}\,\sigma\,\gamma)\,(\mathit{Tree}\,\tau\,\gamma))$$
%as opposed to 
%$$\map_{\mathit{Tree} \,\alpha \, \gamma}^{\sigma, \sigma', \tau, \tau'} : 
%\Nat^{\emptyset} ((\Nat^\emptyset \, \sigma \,\tau) \times
%(\Nat^\emptyset\,\sigma'\,\tau')) \,
%(\Nat^\emptyset\,(\mathit{Tree}\,\sigma\,\sigma')\,(\mathit{Tree}\,\tau\,\tau'))$$
Finally,
in Section~\ref{sec:calculus} we observed that $\emptyset; \phi,
\alpha \vdash \mathit{GRose}\,\phi\,\alpha$ cannot appear as the
(co)domain in a $\Nat$ type. As a result, there are no instances of,
say, a $\mathtt{map}$/$\mathtt{reverse}$ free theorem for this data
type. But $\phi; \alpha \vdash \mathit{GRose}\,\phi\,\alpha$ does
support a $\mathtt{map}$/$\mathtt{reverse}$ theorem similar to those
from Section~\ref{sec:intro}.

As usual, analogous reuslts hold for relation environments and
relational interpretations.

\subsection{Properties of Initial Algebraic Constructs}\label{sec:iaps}

Our semantics interprets $\map$ terms as semantic $\mathit{map}$
functions. Indeed, if \(\Gamma; \ol{\phi}, \ol{\gamma} \vdash H :
\F\), \(\ol{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F : \F}\) and
\(\ol{\Gamma; \ol{\beta}, \ol{\gamma} \vdash G : \F}\), then
Definition~\ref{def:set-interp} gives that
\begin{multline}\label{eq:map-sem-def}
\setsem{
\Gamma;\emptyset \,|\, \emptyset
\vdash \map^{\ol{F},\ol{G}}_H
: \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\; {}
(\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi :=_{\ol{\beta}} G}])
} \rho \\
= \lambda d\, \ol{\eta}\,\ol{B}.\,
\setsem{\Gamma; \ol{\phi},\ol{\gamma}\vdash H}
\id_{\rho[\ol{\gamma := B}]}[\ol{\phi := \lambda \ol{A}.\eta_{\ol{A}\,\ol{B}}}]
\end{multline}
In particular, if $\Gamma; \ol{\alpha} \vdash H : \F$, $\ol{\Gamma;
  \emptyset \vdash \sigma : \F}$, $\ol{\Gamma; \emptyset \vdash
  \tau : \F}$, and $\ast$ is the unique element of $\setsem{\Gamma;
  \emptyset \vdash \emptyset} \rho$, then
%as a special case of the above definition we get that
\[\begin{array}{rl}
&\setsem{
\Gamma;\emptyset \,|\, \emptyset
\vdash \map^{\ol{\sigma},\ol{\tau}}_H
: \Nat^\emptyset\;(\ol{\Nat^{\emptyset}\,\sigma\,\tau})\; {}
(\Nat^{\emptyset}\,H[\ol{\alpha := \sigma}]\,H[\ol{\alpha := \tau}])
} \rho\, \ast \\
=& \lambda \ol{f : \setsem{\Gamma; \emptyset \vdash \sigma}\rho \to \setsem{\Gamma; \emptyset \vdash \tau}\rho}.\,
\setsem{\Gamma; \ol{\alpha}\vdash H}
\id_{\rho}[\ol{\alpha := f}] \\
=& \lambda \ol{f : \setsem{\Gamma; \emptyset \vdash \sigma}\rho \to \setsem{\Gamma; \emptyset \vdash \tau}\rho}.\,
\textit{map}_{\lambda \ol{A}.\,\setsem{\Gamma; \ol{\alpha}\vdash H} \rho [\ol{\alpha := A}]} \ol{f} \\
=& \textit{map}_{\lambda \ol{A}.\,\setsem{\Gamma; \ol{\alpha}\vdash H} \rho [\ol{\alpha := A}]}
\end{array}
\]
Here, the first equality is by Equation~\ref{eq:map-sem-def}, the
second is obtained by noting that $\lambda \ol{A}.\,\setsem{\Gamma;
  \ol{\alpha}\vdash H} \rho [\ol{\alpha := A}]$ is a functor in
$\alpha$, and $\textit{map}_G$ denotes the action of the semantic
functor $G$ on morphisms.

\vspace*{0.1in}

We also have the expected relationships between the interpetations of
$\map$, $\tin$, and $\fold$:

\noindent
$\bullet$\;  If
$\Gamma; \ol{\psi}, \ol{\gamma} \vdash H$,\;
$\ol{\Gamma; \ol{\alpha}, \ol{\gamma}, \ol{\phi} \vdash K}$,\;
$\ol{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F}$,\; and
$\ol{\Gamma; \ol{\beta}, \ol{\gamma} \vdash G}$,
then
\[\setsem{\Gamma; \emptyset \,|\, \emptyset \vdash
\map_{H[\ol{\psi := K}]}^{\ol{F}, \ol{G}} : \xi} = \setsem{\Gamma;
  \emptyset \,|\, \emptyset \vdash \map_H^{\ol{K[\ol{\phi := F}]},
    \ol{K[\ol{\phi := G}]}} \circ \ol{\map_K^{\ol{F}, \ol{G}}} :
  \xi}\]
for $\xi = \Nat^{\emptyset} (\ol{\Nat^{\ol{\alpha}, \ol{\beta},
    \ol{\gamma}} F\, G}) (\Nat^{\ol{\gamma}} H[\ol{\psi :=
    K}][\ol{\phi := F}] H[\ol{\psi := K}][\ol{\phi := G}])$

\vspace*{0.05in}

\noindent
$\bullet$\; If $\Gamma; \overline{\beta}, \overline{\gamma} \vdash H$,\;
  $\Gamma; \overline{\beta}, \overline{\gamma} \vdash K$,\;
  $\overline{\Gamma; \overline{\alpha}, \overline{\gamma} \vdash
  F}$,\; $\overline{\Gamma; \overline{\alpha}, \overline{\gamma}
  \vdash G}$,\; $\overline{\Gamma; \phi, \overline{\psi},
  \overline{\gamma} \vdash \tau}$,\; $\overline{I}$ is the sequence
  $\overline{F}, H$ and $\overline{J}$ is the sequence $\overline{G},
  K$ then
\[\hspace*{0.13in}\setsem{\Gamma; \emptyset \,|\, \emptyset
    \vdash L_{\emptyset} (x, \overline{y}). L_{\overline{\gamma}} z.
    x_{\overline{\tau [\overline{\psi := G}] [\phi := K]},
      \overline{\gamma}} \Big(\big( (\map_{H}^{\overline{\tau
        [\overline{\psi := F}] [\phi := H]}, \overline{\tau
        [\overline{\psi := G}] [\phi := K]}})_{\emptyset}
    (\overline{(\map_{\tau}^{\overline{I}, \overline{J}})_{\emptyset}
      (x, \overline{y})}) \big)_{\overline{\gamma}} z \Big) : \xi}\]
\[= \setsem{\Gamma; \emptyset \,|\, \emptyset
    \vdash L_{\emptyset} (x, \overline{y}). L_{\overline{\gamma}} z.
    \big( (\map_{K}^{\overline{\tau [\overline{\psi := F}] [\phi :=
          H]}, \overline{\tau [\overline{\psi := G}] [\phi :=
          K]}})_{\emptyset} (\overline{(\map_{\tau}^{\overline{I},
        \overline{J}})_{\emptyset} (x, \overline{y})})
    \big)_{\overline{\gamma}} \Big( x_{\overline{\tau [\overline{\psi
            := F}] [\phi := H]}, \overline{\gamma}} z \Big) : \xi}\]
for $\xi = \Nat^{\emptyset} (\Nat^{\overline{\beta},
  \overline{\gamma}} H\, K \times \overline{\Nat^{\overline{\alpha},
    \overline{\gamma}} F\, G})\, (\Nat^{\overline{\gamma}}
H[\overline{\beta:= \tau}] [\overline{\psi := F}] [\phi := H]\,
K[\overline{\beta := \tau}] [\overline{\psi := G}] [\phi := K])$.

\vspace*{0.05in}

\noindent
$\bullet$\; If $\xi = \Nat^{\overline{\beta}, \overline{\gamma}}
H[\phi := (\mu \phi. \lambda
  \overline{\alpha}. H)\overline{\beta}][\overline{\alpha := \beta}]\,
F$, then
\[\hspace*{-0.88in}\setsem{\Gamma; \emptyset \,|\, x:
  \Nat^{\overline{\beta}, \overline{\gamma}} H[\phi :=
    F][\overline{\alpha := \beta}]\, F \vdash ((\fold_{H,
    F})_{\emptyset} x) \circ \tin_{H} : \xi}\]
\[= \setsem{ \Gamma; \emptyset \,|\, x: \Nat^{\overline{\beta},
    \overline{\gamma}} H[\phi := F][\overline{\alpha := \beta}]\, F
  \vdash x \circ \big( (\map_{H [\ol{\alpha := \beta}]}^{(\mu
    \phi. \lambda \overline{\alpha} H) \overline{\beta},
    F})_{\emptyset} ((\fold_{H, F})_{\emptyset} x) \big) : \xi}\]

\vspace*{0.05in}

\noindent
$\bullet$\; If $\xi = \Nat^{\overline{\beta}, \overline{\gamma}} (\mu
\phi. \lambda \overline{\alpha}. H)\overline{\beta}\, (\mu
\phi. \lambda \overline{\alpha}. H)\overline{\beta}$, then
\[\setsem{\Gamma; \emptyset \,|\, \emptyset
  \vdash \tin_H \circ (\fold_{H, H[\phi := (\mu \phi. \lambda
      \overline{\alpha}. H)\overline{\beta}]})_{\emptyset}
  ((\map_{H}^{H[\phi := (\mu \phi. \lambda
      \overline{\alpha}. H)\overline{\beta}][\overline{\alpha :=
        \beta}], (\mu \phi. \lambda
    \overline{\alpha}. H)\overline{\beta}})_{\emptyset} \tin_H) :
  \xi}\]
\[\hspace*{-3.6in} = \setsem{\Gamma; \emptyset \,|\, \emptyset \vdash \Id_{(\mu
    \phi. \lambda \overline{\alpha}. H)\overline{\beta}} : \xi}\]

\vspace*{0.05in}

\noindent
$\bullet$\; If $\xi = \Nat^{\overline{\beta}, \overline{\gamma}}
H[\phi := (\mu \phi. \lambda \overline{\alpha}. H)\overline{\beta}]\,
H[\phi := (\mu \phi. \lambda \overline{\alpha}. H)\overline{\beta}]$,
then
\[\setsem{\Gamma; \emptyset \,|\, \emptyset \vdash
(\fold_{H, H[\phi := (\mu \phi. \lambda
      \overline{\alpha}. H)\overline{\beta}]})_{\emptyset}
  ((\map_{H}^{H[\phi := (\mu \phi. \lambda
      \overline{\alpha}. H)\overline{\beta}][\overline{\alpha :=
        \beta}], (\mu \phi. \lambda
    \overline{\alpha}. H)\overline{\beta}})_{\emptyset} \tin_H) \circ
  \tin_H : \xi}\]
\[\hspace*{-3.32in} =\setsem{ \Gamma; \emptyset \,|\, \emptyset \vdash
  \Id_{H[\phi := (\mu \phi. \lambda
      \overline{\alpha}. H)\overline{\beta}]} : \xi}\]
Analogous results hold for relational interpretations of terms and
relational environments.

\begin{comment}
\subsection{Free Theorems Derived from Naturality}\label{sec:ft-nat}

In our setting, free theorems of a certain familiar form are derivable
directly from the semantic properties of $\Nat$-types. Indeed, the
following theorem is immediate from Equation~\ref{thm:subst}, by taking
$\gamma$ to be empty, expanding the interpretations on the left- and
right-hand sides, and using the fact from Section~\ref{sec:iaps} that
$\map$ terms are interpreted as semantic $\mathit{map}$ functions:
\begin{thm}\label{thm:ft-nat}
If\, $\Gamma; \ol\alpha \vdash F : \F$,\, $\Gamma; \ol\alpha \vdash G :
\F$, $\rho : \setenv$, $x \in \setsem{\Gamma; \emptyset \vdash
  \Nat^{\ol\alpha} F\, G } \rho$, and, for vectors of length
$|\ol\alpha|$, \, $\ol{\Gamma; \emptyset \vdash \sigma : \F}$,\,
$\ol{\Gamma; \emptyset \vdash \tau: \F}$, and $\ol{y \in
  \setsem{\Gamma; \emptyset \vdash \Nat^{\emptyset} \sigma\, \tau }
  \rho}$, then
\[\mathit{map}_{\setsem{\Gamma; \ol\alpha \vdash G} \rho[\ol{\alpha := \_}]} \ol{y}
  \circ x_{\ol{{\setsem{\Gamma; \emptyset \vdash \sigma} \rho}}} =
  x_{\ol{\setsem{\Gamma; \emptyset \vdash \tau} \rho} } \circ
  \mathit{map}_{\setsem{\Gamma; \ol\alpha \vdash F} \rho[\ol{\alpha :=
        \_}]} \, \ol{y}\]
\end{thm}
\noindent
%INCORRECT
%In particular, for $\ol{A, B: \set}$, variables $\ol{v}$ and $\ol{w}$
%with $\ol{\rho v = A}$ and $\ol{\rho w = B}$, and functions $\ol{f : A
%  \to B}$, the following holds: $\mathit{map}_{\setsem{\Gamma; \ol\alpha \vdash G}
%  \rho[\ol{\alpha := \_}]} \ol{f} \circ x_{\ol{A}} = x_{\ol{B}} \circ
%\mathit{map}_{\setsem{\Gamma; \ol\alpha \vdash F} \rho[\ol{\alpha :=
%      \_}]} \, \ol{f}$.
A similar result holds for relational interpretations.

Specific instances of Theorem~\ref{thm:ft-nat} include {\color{blue}
  Wadler free theorems, map-reverse theorems from intro, ???}
\end{comment}

\begin{comment}
We already know from Equation~\ref{thm:subst} that 
\begin{multline}
\setsem{\Gamma; \emptyset \,|\, x :
  \Nat^{\overline{\alpha}, 
    \overline{\gamma}} F\,G, \overline{y : \Nat^{\overline{\gamma}}
    \sigma\, \tau} \vdash ((\map_G^{\overline{\sigma},
    \overline{\tau}})_{\emptyset} \overline{y}) \circ
  (L_{\overline{\gamma}} z. x_{\overline{\sigma}, \overline{\gamma}}
  z) : \Nat^{\overline{\gamma}} F[\overline{\alpha := \sigma}]\,
  G[\overline{\alpha := \tau}]} \\
= \setsem{ \Gamma; \emptyset \,|\, x
  : \Nat^{\overline{\alpha}, \overline{\gamma}} F\, G, \overline{y :
    \Nat^{\overline{\gamma}} \sigma\, \tau} \vdash
  (L_{\overline{\gamma}} z. x_{\overline{\tau}, \overline{\gamma}} z)
  \circ ((\map_F^{\overline{\sigma}, \overline{\tau}})_{\emptyset}
  \overline{y}) : \Nat^{\overline{\gamma}} F[\overline{\alpha :=
      \sigma}]\, G[\overline{\alpha := \tau}]}
\end{multline}

In particular, for any set environment $\rho$, natural transformation 
$x \in \setsem{\Gamma; \emptyset \vdash \Nat^{\ol\alpha} F\, G } \rho$, and functions
$\ol{y \in \setsem{\Gamma; \emptyset \vdash \Nat^{\emptyset} \sigma\, \tau } \rho}$
(thus specializing to the case where there are no $\gamma$s), we have
\begin{multline}
\setsem{\Gamma; \emptyset \,|\, x :
  \Nat^{\overline{\alpha}} F\,G, \overline{y : \Nat^{\emptyset}
    \sigma\, \tau} \vdash ((\map_G^{\overline{\sigma},
    \overline{\tau}})_{\emptyset} \overline{y}) \circ
  (L_{\emptyset} z. x_{\overline{\sigma}}
  z) : \Nat^{\emptyset} F[\overline{\alpha := \sigma}]\,
  G[\overline{\alpha := \tau}]} \rho (x, \ol{y}) \\
= \setsem{ \Gamma; \emptyset \,|\, x
  : \Nat^{\overline{\alpha}} F\, G, \overline{y :
    \Nat^{\emptyset} \sigma\, \tau} \vdash
  (L_{\emptyset} z. x_{\overline{\tau}} z)
  \circ ((\map_F^{\overline{\sigma}, \overline{\tau}})_{\emptyset}
  \overline{y}) : \Nat^{\emptyset} F[\overline{\alpha :=
      \sigma}]\, G[\overline{\alpha := \tau}]} \rho (x, \ol{y})
\end{multline}

Unwinding these interpretations yields
\begin{multline}
\setsem{\Gamma; \emptyset \,|\, x :
  \Nat^{\overline{\alpha}} F\,G, \overline{y : \Nat^{\emptyset}
    \sigma\, \tau} \vdash ((\map_G^{\overline{\sigma},
    \overline{\tau}})_{\emptyset} \overline{y}) \circ
  (L_\emptyset z. x_{\overline{\sigma}}
  z) : \Nat^{\emptyset} F[\overline{\alpha := \sigma}]\,
  G[\overline{\alpha := \tau}]} \rho \, (x , \ol{y}) \\
= 
\setsem{\Gamma; \emptyset \,|\, x : \Nat^{\overline{\alpha}} F\,G, 
  \overline{y : \Nat^{\emptyset}
    \sigma\, \tau} \vdash (\map_G^{\overline{\sigma},
    \overline{\tau}})_{\emptyset} \overline{y} } \rho \, (x, \ol{y})
   \circ
  \setsem{\Gamma; \emptyset \,|\, x : \Nat^{\overline{\alpha}} F\,G 
   , \overline{y : \Nat^{\emptyset}
      \sigma\, \tau} \vdash
   L_{\emptyset} z. x_{\overline{\sigma}}
  z } \rho \, (x, \ol{y}) \\
= 
\setsem{\Gamma; \emptyset \,|\, \overline{y : \Nat^{\emptyset}
    \sigma\, \tau} \vdash (\map_G^{\overline{\sigma},
    \overline{\tau}})_{\emptyset} \overline{y} } \rho \, \ol{y}
   \circ
  \setsem{\Gamma; \emptyset \,|\, x : \Nat^{\overline{\alpha}} F\,G \vdash
    L_{\emptyset} z. x_{\overline{\sigma}}
  z } \rho \, x \\
= \map_{\setsem{\Gamma; \ol\alpha \vdash G} \rho[\ol{\alpha := \_}]} \ol{y}
  \circ 
  x_{\ol{{\setsem{\Gamma; \emptyset \vdash \sigma} \rho}}}
\end{multline}


and 
\begin{multline}
\setsem{ \Gamma; \emptyset \,|\, x
  : \Nat^{\overline{\alpha}} F\, G, \overline{y :
    \Nat^{\emptyset} \sigma\, \tau} \vdash
  (L_{\emptyset} z. x_{\overline{\tau}} z)
  \circ ((\map_F^{\overline{\sigma}, \overline{\tau}})_{\emptyset}
  \overline{y}) : \Nat^{\emptyset} F[\overline{\alpha :=
      \sigma}]\, G[\overline{\alpha := \tau}]} \rho (x, \ol{y}) \\
=
\setsem{ \Gamma; \emptyset \,|\, x
  : \Nat^{\overline{\alpha}} F\, G, \overline{y :
    \Nat^{\emptyset} \sigma\, \tau} \vdash
  L_{\emptyset} z. x_{\overline{\tau}} z)} \rho (x, \ol{y})
  \circ 
  \setsem{\Gamma; \emptyset
  \,|\, x : \Nat^{\overline{\alpha}} F\, G, \overline{y :
    \Nat^{\emptyset} \sigma\, \tau} \vdash 
  (\map_F^{\overline{\sigma}, \overline{\tau}})_{\emptyset}
  \overline{y} } \rho (x, \ol{y}) \\
= \setsem{\Gamma; \emptyset \,|\, x
  : \Nat^{\overline{\alpha}} F\, G \vdash 
  L_{\emptyset} z. x_{\overline{\tau}} z} \rho \, x
  \circ 
  \setsem{\Gamma;\emptyset \,|\, \overline{y :
    \Nat^{\emptyset} \sigma\, \tau} \vdash
    (\map_F^{\overline{\sigma}, \overline{\tau}})_{\emptyset}
  \overline{y} } \rho \, \ol{y}  \\
  = x_{\ol{\setsem{\Gamma; \emptyset \vdash \tau} \rho} }
  \circ \map_{\setsem{\Gamma; \ol\alpha \vdash F} 
    \rho[\ol{\alpha := \_}]} \, \ol{y}
\end{multline}


So, we can conclude that
\begin{equation}
\map_{\setsem{\Gamma; \ol\alpha \vdash G} \rho[\ol{\alpha := \_}]} \ol{y}
  \circ 
  x_{\ol{{\setsem{\Gamma; \emptyset \vdash \sigma} \rho}}}
= x_{\ol{\setsem{\Gamma; \emptyset \vdash \tau} \rho} }
\circ \map_{\setsem{\Gamma; \ol\alpha \vdash F} 
  \rho[\ol{\alpha := \_}]} \, \ol{y}
\end{equation}

Moreover, for any $\ol{A, B: \set}$,
we can choose $\ol{\sigma = v}$ and $\ol{\tau = w}$ to be variables such that
$\ol{\rho v = A}$ and $\ol{\rho w = B}$.
Then for any functions $\ol{f : A \to B}$ we have that
\begin{equation}
\map_{\setsem{\Gamma; \ol\alpha \vdash G} \rho[\ol{\alpha := \_}]} \ol{f}
  \circ 
  x_{\ol{A}}
  = x_{\ol{B}}
\circ \map_{\setsem{\Gamma; \ol\alpha \vdash F} 
  \rho[\ol{\alpha := \_}]} \, \ol{f}
\end{equation}
\end{proof}
\end{comment}

\subsection{The Abstraction Theorem}\label{sec:thms} 

To go beyond naturality and get {\em all} consequences of
parametricity, we prove an Abstraction Theorem for our calculus. As
usual for such theorems, we prove a more general result in
Theorem~\ref{thm:at-gen} that handles possibly open terms. We then
recover the Abstraction Theorem (Theorem~\ref{thm:abstraction}) as the
special case Theorem~\ref{thm:at-gen} for closed terms of closed type.

\begin{thm}\label{thm:at-gen}
Every well-formed term $\Gamma;\Phi~|~\Delta \vdash t : \tau$ induces
a natural transformation from $\sem{\Gamma; \Phi \vdash \Delta}$ to
$\sem{\Gamma; \Phi \vdash \tau}$, i.e., a triple of natural
transformations 
\[(\setsem{\Gamma;\Phi~|~\Delta \vdash t : \tau},\,
\setsem{\Gamma;\Phi~|~\Delta \vdash t : \tau},\,
\relsem{\Gamma;\Phi~|~\Delta \vdash t : \tau})\]
where
\[\begin{array}{lll}
\setsem{\Gamma;\Phi~|~\Delta \vdash t : \tau} & : & \setsem{\Gamma;
  \Phi \vdash \Delta} \to \setsem{\Gamma; \Phi \vdash \tau}
\end{array}\]
has as its component at $\rho : \setenv$ a morphism
\[\begin{array}{lll}
\setsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}\rho & : & \setsem{\Gamma;
  \Phi \vdash \Delta}\rho \to \setsem{\Gamma; \Phi \vdash \tau}\rho
\end{array}\]
in $\set$,
\[\begin{array}{lll}
\relsem{\Gamma;\Phi~|~\Delta \vdash t : \tau} & : & \relsem{\Gamma;
  \Phi \vdash \Delta} \to \relsem{\Gamma; \Phi \vdash \tau}
\end{array}\]
has as its component at $\rho : \relenv$ a morphism
\[\begin{array}{lll}
\relsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}\rho & : & \relsem{\Gamma;
  \Phi \vdash \Delta}\rho \to \relsem{\Gamma; \Phi \vdash \tau}\rho
\end{array}\]
in $\rel$,
and, for all $\rho : \relenv$,
\begin{equation}\label{eq:projs}
\relsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}\rho =
(\setsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}(\pi_1 \rho),\,
\setsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}(\pi_2 \rho))
\end{equation}
\end{thm}

\begin{proof}
By structural induction on the type judgment for $t$. The only
interesting cases are the cases for abstraction, application, $\map$,
$\tin$, and $\fold$ so we omit the others. The challenging lies in
showing that the set and relational interpretations of each type
judgment are natural transformations (also satisfying the appropriate
{\color{blue} equality preservation} condition in the case of the set
interpretations). We give proofs for the set interpretations only;
those for the relational interpretations are similar.  The proof that
Equation~\ref{eq:projs} holds in each case is by direct calculation,
using the facts that projections are surjective and that the set and
relational interpretations are defined ``in parallel'', i.e., are
fibred.
\begin{itemize}
\item $\underline{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline{\alpha}}
  x.t : \Nat^{\overline{\alpha}} \,F \,G}$ \; Since
  %the functorial part of its context
  $\Phi$ is empty, to see that $\setsem{\Gamma;\emptyset
    \,|\, \Delta \vdash L_{\overline{\alpha}} x.t :
    \Nat^{\overline{\alpha}} \,F \,G}$ is a natural transformation
  from $\setsem{\Gamma;\emptyset \vdash \Delta}$ to
  $\setsem{\Gamma;\emptyset \vdash \Nat^{\overline{\alpha}} \,F \,G}$
  we need only show that, for every $\rho : \setenv$,
  $\setsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline{\alpha}}
    x.t : \Nat^{\overline{\alpha}} \,F \,G}\rho$ is a morphism in
  $\set$ from $\setsem{\Gamma; \emptyset \vdash \Delta}\rho$ to
  $\setsem{\Gamma; \emptyset \vdash \Nat^{\overline{\alpha}} \,F
    \,G}\rho$, i.e., that, for each $\ol{A : \set}$ and each $d :
  \setsem{\Gamma;\emptyset \vdash \Delta}\rho = \setsem{\Gamma;
    \ol{\alpha} \vdash \Delta}\rho[\overline{\alpha := A}]$, we have
  $(\setsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline{\alpha}}
    x.t : \Nat^{\overline{\alpha}} \,F \,G}\rho\,d)_{\ol{A}}$ $:
  \setsem{\Gamma; \ol{\alpha} \vdash F}\rho[\overline{\alpha := A}]$
  $\to \setsem{\Gamma; \ol{\alpha} \vdash G}\rho[\overline{\alpha :=
      A}]$. But this follows easily from the induction hypothesis.
  \begin{comment}
To see that $\setsem{\Gamma;\emptyset \,|\, \Delta \vdash
  L_{\overline{\alpha}} x.t : \Nat^{\overline{\alpha}} \,F \,G}$ is a
  natural transformation from $\setsem{\Gamma;\emptyset \vdash
    \Delta}$ to $\setsem{\Gamma;\emptyset \vdash
    \Nat^{\overline{\alpha}} \,F \,G}$, since the functorial part
  $\Phi$ of the context is empty, we need only show that, for
  every $\rho : \setenv$, $\setsem{\Gamma;\emptyset \,|\, \Delta
    \vdash L_{\overline{\alpha}} x.t : \Nat^{\overline{\alpha}} \,F
    \,G}\rho$ is a morphism in $\set$ from $\setsem{\Gamma; \emptyset
    \vdash \Delta}\rho$ to $\setsem{\Gamma; \emptyset \vdash
    \Nat^{\overline{\alpha}} \,F \,G}\rho$. For this, recall that
\[\setsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline{\alpha}}
  x.t : \Nat^{\overline{\alpha}} \,F \,G}\rho = \curry\,
(\setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t:
  G}\rho[\overline{\alpha := \_}])\]
By the induction hypothesis, $\sem{\Gamma;\overline{\alpha} \,|\,
  \Delta, x : F \vdash t: G}\rho[\overline{\alpha := \_}]$ induces a
natural transformation
\[\begin{array}{ll}
& \setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t:
  G}\rho[\overline{\alpha := \_}]\\
 : & \setsem{\Gamma; \ol{\alpha} \vdash \Delta, x :
  F}\rho[\overline{\alpha := \_}] \to \setsem{\Gamma; \ol{\alpha}
  \vdash G}\rho[\overline{\alpha := \_}]\\   
 = & \setsem{\Gamma; \ol{\alpha} \vdash \Delta}\rho[\overline{\alpha
    := \_}] \times \setsem{\Gamma; \ol{\alpha} \vdash
  F}\rho[\overline{\alpha := \_}] \to \setsem{\Gamma; \ol{\alpha}
  \vdash G}\rho[\overline{\alpha := \_}]  
\end{array}\]
and thus a family of morphisms
\[\begin{array}{ll}
& \curry\, (\sem{\Gamma;\overline{\alpha} \,|\,
 \Delta, x : F \vdash t: G}\rho[\overline{\alpha := \_}])\\
: & \setsem{\Gamma; \ol{\alpha} \vdash \Delta}\rho[\overline{\alpha
     := \_}] \to (\setsem{\Gamma; \ol{\alpha} \vdash
   F}\rho[\overline{\alpha := \_}] \to \setsem{\Gamma; \ol{\alpha} 
   \vdash G}\rho[\overline{\alpha := \_}]) 
\end{array}\]
That is, for each $\ol{A : \set}$ and each $d :
\setsem{\Gamma;\emptyset \vdash \Delta}\rho = \setsem{\Gamma;
  \ol{\alpha} \vdash \Delta}\rho[\overline{\alpha := A}]$ by
weakening, we have
\[\begin{array}{ll}
  & (\setsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline{\alpha}}
  x.t : \Nat^{\overline{\alpha}} \,F \,G}\rho\,d)_{\ol{A}}\\
= & \curry\, (\setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F
  \vdash t: G}\rho[\overline{\alpha := A}])\,d\\
: & \setsem{\Gamma; \ol{\alpha} \vdash F}\rho[\overline{\alpha := A}]
\to \setsem{\Gamma; \ol{\alpha} \vdash G}\rho[\overline{\alpha := 
    A}]
\end{array}\]
\end{comment}
That these maps comprise a natural transformation $\eta :
\setsem{\Gamma; \ol{\alpha} \vdash F}\rho[\overline{\alpha := \_}] \to
\setsem{\Gamma; \ol{\alpha} \vdash G}\rho[\overline{\alpha := \_}]$ is
clear since $\eta_{\ol{A}} \, = \, \curry\,
(\setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t:
  G}\rho[\overline{\alpha := A}])\,d$ is the component at $\ol{A}$ of
the partial specialization to $d$ of the natural transformation
$\setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t:
  G}\rho[\overline{\alpha := \_}]$.  To see that the components of
$\eta$ also satisfy the additional condition needed for $\eta$ to
be in $\setsem{\Gamma;\emptyset \vdash \Nat^{\overline{\alpha}} \,F
  \,G}\rho$, let $\overline{R : \rel(A, B)}$ and suppose $(u, v) \in
\relsem{\Gamma;\overline{\alpha} \vdash F} \Eq_{\rho}[\overline{\alpha
    := R}] = (\setsem{\Gamma;\overline{\alpha} \vdash F}
\rho[\overline{\alpha := A}], \setsem{\Gamma;\overline{\alpha} \vdash
  F} \rho[\overline{\alpha := B}])$. Then the induction hypothesis and
$(d,d) \in \relsem{\Gamma;\emptyset \vdash \Delta} \Eq_\rho =
\relsem{\Gamma;\emptyset \vdash \Delta} \Eq_\rho[\ol{\alpha := R}]$
ensure that
\[\begin{array}{ll}
& (\eta_{\ol{A}}u,\eta_{\ol{B}}v)\\
= & (\curry\, (\setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F
  \vdash t: G}\rho[\overline{\alpha := A}])\,d\,u, \curry\,
(\setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t:
  G}\rho[\overline{\alpha := B}])\,d\,v)\\
= & \curry\, (\relsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F
  \vdash t: G}\Eq_\rho[\overline{\alpha := R}])\,(d,d)\,(u,v)\\
: & \relsem{\Gamma;\overline{\alpha} \vdash G}
\Eq_{\rho}[\overline{\alpha := R}]  
\end{array}\]
%The analogous results for $\relsem{\Gamma;\emptyset \,|\, \Delta
%  \vdash L_{\overline{\alpha}} x.t : \Nat^{\overline{\alpha}} \,F
%  \,G}$ are proved similarly.
\begin{comment}
Then the induction hypothesis on
the term $t$ ensures that
\[\begin{array}{ll}
  & \relsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t: G}
\Eq_{\rho}[\overline{\alpha := R}]\\
: & \relsem{\Gamma;\overline{\alpha} \vdash \Delta, x : F}
\Eq_{\rho}[\overline{\alpha := R}] \to
\relsem{\Gamma;\overline{\alpha} \vdash G} \Eq_{\rho}[\overline{\alpha
    := R}]
\end{array}\] and
\[\begin{array}{ll}
  &  \relsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t: G}
\Eq_{\rho}[\overline{\alpha := R}] \hfill(*)\\
= & (\setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t: G}
\rho[\overline{\alpha := A}], \setsem{\Gamma;\overline{\alpha} \,|\,
  \Delta, x : F \vdash t: G} \rho[\overline{\alpha := B}])
\end{array}\] Since $(d,d) \in \relsem{\Gamma;\emptyset \vdash \Delta}
\Eq_\rho =  \relsem{\Gamma;\emptyset \vdash \Delta}
\Eq_\rho[\ol{\alpha := R}]$ we therefore have that
\[\begin{array}{ll}
& (\eta_{\ol{A}}u,\eta_{\ol{B}}v)\\
= & (\curry\, (\setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F
  \vdash t: G}\rho[\overline{\alpha := A}])\,d\,u, \curry\,
(\setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t:
  G}\rho[\overline{\alpha := B}])\,d\,v)\\
= & \curry\, (\relsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F
  \vdash t: G}\Eq_\rho[\overline{\alpha := R}])\,(d,d)\,(u,v)\\
: & \relsem{\Gamma;\overline{\alpha} \vdash G}
\Eq_{\rho}[\overline{\alpha := R}]  
\end{array}\]
Here, the second equality is by $(*)$.  

The proofs that $\relsem{\Gamma;\emptyset \,|\, \Delta \vdash
  L_{\overline{\alpha}} x.t : \Nat^{\overline{\alpha}} \,F \,G}$ is a
  natural transformation from $\relsem{\Gamma;\emptyset \vdash
    \Delta}$ to $\relsem{\Gamma;\emptyset \vdash
    \Nat^{\overline{\alpha}} \,F \,G}$ and that, for all $\rho :
  \relenv$ and $d : \relsem{\Gamma;\emptyset \vdash \Delta}$,
  $\relsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline{\alpha}}
    x.t : \Nat^{\overline{\alpha}} \,F \,G}\,\rho\,d$ is a natural
  transformation from $\relsem{\Gamma;\ol{\alpha} \vdash
    F}\rho[\ol{\alpha := \_}]$ to $\relsem{\Gamma;\ol{\alpha} \vdash
    G}\rho[\ol{\alpha := \_}]$, are analogous.
\end{comment}
  %To see that
  %$\relsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline{\alpha}}
  %  x.t : \Nat^{\overline{\alpha}} \,F \,G}$ is a natural
  %transformation from $\relsem{\Gamma;\emptyset \vdash \Delta}$ to
  %$\relsem{\Gamma;\emptyset \vdash \Nat^{\overline{\alpha}} \,F \,G}$,
  %since the functorial part $\Phi$ of the type context is empty, we
  %need only show that, for every $\rho : \relenv$,
  %$\setsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline{\alpha}}
  %  x.t : \Nat^{\overline{\alpha}} \,F \,G}\rho$ is a morphism in
  %$\rel$ from $\setsem{\Gamma; \emptyset \vdash \Delta}\rho$ to
  %$\setsem{\Gamma; \emptyset \vdash \Nat^{\overline{\alpha}} \,F
  %  \,G}\rho$. The proof is similar to that in the previous bullet
  %point for the set semantics. The only difference is in the
  %additional condition on the components of the natural transformation
%\[ \eta \, = \, \curry\, (\relsem{\Gamma;\overline{\alpha}
%  \,|\, \Delta, x : F \vdash t: G}\rho[\overline{\alpha := \_}])\,d\]
%for $d : \relsem{\Gamma;\emptyset \vdash \Delta}\rho$ that must be
%verified to know that $\eta$ is in $\relsem{\Gamma;\emptyset \vdash
%  \Nat^{\overline{\alpha}} \,F \,G}\rho$. For that, let $\overline{R :
%  \rel(A,B)}$ and
%\[(u,v) \in \relsem{\Gamma;\overline{\alpha} \vdash
%  F} \rho[\overline{\alpha := R}] = (\setsem{\Gamma;\overline{\alpha}
%  \vdash F} (\pi_1\rho)[\overline{\alpha := A}],
%\setsem{\Gamma;\overline{\alpha} \vdash F}
%(\pi_2\rho)[\overline{\alpha := B}])\]
%Then the induction hypothesis on the term $t$ ensures that
%\[ \relsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t: G}
%\rho[\overline{\alpha := R}] \,: \, \relsem{\Gamma;\overline{\alpha}
%  \vdash \Delta, x : F} \rho[\overline{\alpha := R}] \to
%\relsem{\Gamma;\overline{\alpha} \vdash G} \rho[\overline{\alpha :=
%    R}]\]
%and
%\[\eta_{\ol{R}} = ((\pi_1\eta)_{\ol{A}}, (\pi_1\eta)_{\ol{B}})\]
%so that
%\[\begin{array}{ll}
%  & ((\pi_1\eta)_{\ol{A}} u,(\pi_2\eta)_{\ol{B}} v)\\
%= & \eta_{\ol{R}}(u,v)\\
%= & \curry\,\relsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F
%  \vdash t: G} \rho[\overline{\alpha := R}]\,d\,(u,v)\\
%: & \relsem{\Gamma;\overline{\alpha} \vdash G} \rho[\overline{\alpha
%    := R}]
%\end{array}\]
\begin{comment}
\item Finally, to see that $\pi_i(\relsem{\Gamma;\emptyset \,|\,
  \Delta \vdash L_{\overline \alpha} x.t : \Nat^{\overline\alpha} \,F
  \,G}\rho) = \setsem{\Gamma;\emptyset \,|\, \Delta \vdash
  L_{\overline \alpha} x.t : \Nat^{\overline\alpha} \,F
  \,G}(\pi_i\rho)$ we observe that $\pi_1$ and $\pi_2$ are surjective
  and compute
\[\begin{split}
&~\pi_i(\relsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline
    \alpha} x.t : \Nat^{\overline\alpha} \,F \,G}\rho) \\
=&~\pi_i(\curry (\relsem{\Gamma;\overline \alpha\,|\, \Delta, x : F
  \vdash t: G} \rho[\overline{\alpha := \_}])) \\
= &~\curry (\pi_i(\relsem{\Gamma;\overline \alpha\,|\, \Delta, x : F
  \vdash t: G} \rho[\overline{\alpha := \_}])) \\
= &~\curry (\setsem{\Gamma;\overline \alpha\,|\, \Delta, x : F \vdash
  t: G} (\pi_i(\rho[\overline{\alpha := \_}]))) \\
= &~\curry (\setsem{\Gamma;\overline \alpha\,|\, \Delta, x : F \vdash
  t: G} (\pi_i\rho)[\overline{\alpha := \_}]) \\
= &~\setsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline \alpha}
  x.t : \Nat^{\overline\alpha} \,F \,G}(\pi_i\rho)
\end{split}\]
\end{comment}
\item
$\underline{\Gamma;\Phi \,|\, \Delta \vdash t_{\overline
    \tau} s: G [\overline{\alpha := \tau}]}$\; To see that
$\setsem{\Gamma;\Phi \,|\, \Delta \vdash t_{\overline \tau} s: G
  [\overline{\alpha := \tau}]}$ is a natural transformation from
$\setsem{\Gamma; \Phi \vdash \Delta}$ to $\setsem{\Gamma;\Phi \vdash G
  [\overline{\alpha := \tau}]}$ we must show that, for every $\rho
: \setenv$, $\setsem{\Gamma;\Phi \,|\, \Delta \vdash t_{\overline
    \tau} s: G [\overline{\alpha := \tau}]}\rho$ is a morphism from
$\setsem{\Gamma; \Phi \vdash \Delta}\rho$ to $\setsem{\Gamma;\Phi
  \vdash G [\overline{\alpha := \tau}]}\rho$, and that this family of
morphisms is natural in $\rho$. Let $d : \setsem{\Gamma; \Phi \vdash
  \Delta}\rho$. Then
\[\begin{array}{ll}
  & \setsem{\Gamma;\Phi \,|\, \Delta \vdash t_{\overline \tau} s: G
  [\overline{\alpha := \tau}]}\,\rho\,d\\
= & (\eval \circ \langle (\setsem{\Gamma;\emptyset \,|\, \Delta \vdash
  t : \Nat^{\overline{\alpha}} \,F \,G}\rho\;
\_)_{\overline{\setsem{\Gamma;\Phi \vdash \tau}\rho}},\,
\setsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha :=
      \tau}]}\rho \rangle)\,d\\
= & \eval ((\setsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
  \Nat^{\overline{\alpha}} \,F \,G}\rho\;
\_)_{\overline{\setsem{\Gamma;\Phi \vdash \tau}\rho}} \,d,\,
\setsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha :=
      \tau}]}\rho\, d)\\
= & \eval ((\setsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
  \Nat^{\overline{\alpha}} \,F \,G}\rho\;
d)_{\overline{\setsem{\Gamma;\Phi \vdash \tau}\rho}},\,
\setsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha :=
      \tau}]}\rho\, d)\\
\end{array}\]
The induction hypothesis ensures that $(\setsem{\Gamma;\emptyset \,|\,
  \Delta \vdash t : \Nat^{\overline{\alpha}} \,F \,G}\rho\;
d)_{\overline{\setsem{\Gamma;\Phi \vdash \tau}\rho}}$ has type
$\setsem{\Gamma; \ol{\alpha} \vdash F}\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash \tau}\rho}] \to \setsem{\Gamma;
  \ol{\alpha} \vdash G}\rho[\ol{\alpha := \setsem{\Gamma;\Phi \vdash
      \tau}\rho}]$.  Since, in addition, $\setsem{\Gamma;\Phi \,|\,
  \Delta \vdash s: F [\overline{\alpha := \tau}]}\rho\, d :
\setsem{\Gamma; \Phi \vdash F[\ol{\alpha := \tau}]}\rho =
\setsem{\Gamma; \Phi, \ol{\alpha} \vdash F}\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash \tau}\rho}] = \setsem{\Gamma;
  \ol{\alpha} \vdash F}\rho[\ol{\alpha := \setsem{\Gamma;\Phi \vdash
      \tau}\rho}]$ by Equation~\ref{eq:subs-var},
%, and by weakening in the last step,
%since the type $\Gamma; \emptyset \vdash \Nat^{\ol{\alpha}} F\,G$ is
%only well-formed if $\Gamma; \ol{\alpha} \vdash F : \F$ and $\Gamma;
%\ol{\alpha} \vdash G : \F$. Thus,
we have that $\setsem{\Gamma;\Phi \,|\, \Delta
  \vdash t_{\overline \tau} s: G [\overline{\alpha :=
      \tau}]}\,\rho\,d : \setsem{\Gamma; \ol{\alpha} \vdash
  G}\rho[\ol{\alpha := \setsem{\Gamma;\Phi \vdash \tau}\rho}] =
\setsem{\Gamma; \Phi \vdash G[\ol{\alpha := \tau}]}\rho$, as desired.

\vspace*{0.1in}

To see that the family of maps comprising $\setsem{\Gamma;\Phi \,|\,
  \Delta \vdash t_{\overline \tau} s: G [\overline{\alpha := \tau}]}$
%form a natural transformation, i.e.,
is natural in $\rho$
%their set environment argument,
we need to show that, if $f : \rho \to \rho'$ in $\setenv$, then the
following diagram commutes, where $g = \setsem{\Gamma;\emptyset \,|\,
  \Delta \vdash t : \Nat^{\overline{\alpha}} \,F \,G}$ and $h =
\setsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha :=
      \tau}]}$:
{\footnotesize
\[\begin{tikzcd}
\setsem{\Gamma;\Phi \vdash \Delta}\rho \ar[r, "{\setsem{\Gamma;\Phi
      \vdash \Delta}f}"] \ar[d, "{\langle g \rho, h \rho\rangle}"']
& \setsem{\Gamma;\Phi \vdash 
  \Delta}\rho' \ar[d, "{\langle g \rho', h \rho' \rangle}"]\\
\setsem{\Gamma;\emptyset \vdash \Nat^{\overline{\alpha}} \,F \,G}\rho
\times \setsem{\Gamma;\Phi \vdash F [\overline{\alpha := \tau}]}\rho
\ar[d, "{\eval \circ ((-)_{\overline{\sem{\Gamma;\Phi\vdash \tau}\rho}} \times
    \id)}"']
\ar[r, bend left = 5, "{\setsem{\Gamma;\emptyset \vdash
      \Nat^{\overline{\alpha}} \,F \,G}f\, \times\, \setsem{\Gamma;\Phi
      \vdash F [\overline{\alpha := \tau}]}f}"] &
\setsem{\Gamma;\emptyset \vdash \Nat^{\overline{\alpha}} \,F \,G}\rho'
\times \setsem{\Gamma;\Phi \vdash F [\overline{\alpha := \tau}]}\rho'
\ar[d, "{\eval \circ ((-)_{\overline{\sem{\Gamma;\Phi\vdash
          \tau}\rho'}} \times \id)}"] \\
  %(\setsem{\Gamma;\overline{\alpha} \vdash F}\rho[\overline{\alpha :=
%    \setsem{\Gamma;\Phi\vdash\tau}\rho}] \to
%%\setsem{\Gamma;\overline{\alpha} \vdash G}\rho[\overline{\alpha :=
%    \setsem{\Gamma;\Phi\vdash\tau}\rho}]) \times \setsem{\Gamma;\Phi
%       \vdash F [\overline{\alpha := \tau}]}\rho \ar[d, equal] \\
%(\setsem{\Gamma;\Phi \vdash F [\overline{\alpha := \tau}]}\rho \to
%\setsem{\Gamma;\Phi \vdash G [\overline{\alpha := \tau}]}\rho) \times
%\setsem{\Gamma;\Phi \vdash F [\overline{\alpha := \tau}]}\rho \ar[d,
%  "{\eval}"]\\
%
\setsem{\Gamma;\Phi \vdash G [\overline{\alpha := \tau}]}\rho
\ar[r, "{\setsem{\Gamma;\Phi \vdash G [\overline{\alpha := \tau}]}f}"']
&
\setsem{\Gamma;\Phi \vdash G [\overline{\alpha := \tau}]}\rho'
\end{tikzcd}\]}
The top diagram commutes because $g$ and $h$ are natural in $\rho$ by
the induction hypothesis.
%$\setsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
%  \Nat^{\overline{\alpha}} \,F \,G}$ and $\setsem{\Gamma;\Phi \,|\,
%  \Delta \vdash s: F [\overline{\alpha := \tau}]}$ are natural in
To see that the bottom diagram commutes, we first note that
since $\rho|_\Gamma = \rho'|_\Gamma$, $\Gamma; \ol{\alpha} \vdash F :
\F$, and $\Gamma; \ol{\alpha} \vdash G : \F$, we can replace the
instance of $f$ in $\setsem{\Gamma;\emptyset \vdash
  \Nat^{\overline{\alpha}} \,F \,G}f$ with $\id$. Then, since
functoriality ensures that
%using the fact
%that $\setsem{\Gamma;\emptyset \vdash \Nat^{\overline{\alpha}} \,F
%  \,G}$ is a functor, we have that
$\setsem{\Gamma;\emptyset \vdash
  \Nat^{\overline{\alpha}} \,F \,G}\id = \id$, we need only show that,
%. To see that the bottom
%diagram commutes we must therefore prove that,
for all $\eta \in \setsem{\Gamma;\emptyset \vdash
  \Nat^{\overline{\alpha}} \,F \,G}\rho$ and $x \in
\setsem{\Gamma;\Phi \vdash F [\overline{\alpha := \tau}]}\rho$,
$\setsem{\Gamma;\Phi \vdash G [\overline{\alpha := \tau}]}f
(\eta_{\overline{\sem{\Gamma;\Phi\vdash \tau}\rho}} x) =
\eta_{\overline{\sem{\Gamma;\Phi\vdash \tau}\rho'}}
(\setsem{\Gamma;\Phi \vdash F [\overline{\alpha := \tau}]}f x)$ holds,
i.e., for all $\eta \in \setsem{\Gamma;\emptyset \vdash
  \Nat^{\overline{\alpha}} \,F \,G}\rho$, we have $\setsem{\Gamma;\Phi
  \vdash G [\overline{\alpha := \tau}]}f \circ
\eta_{\overline{\sem{\Gamma;\Phi\vdash \tau}\rho}} =
\eta_{\overline{\sem{\Gamma;\Phi\vdash \tau}\rho'}} \circ
\setsem{\Gamma;\Phi \vdash F [\overline{\alpha := \tau}]}f$. But this
follows from the naturality of $\eta$: the only variables in the
functorial contexts for $F$ and $G$ are $\ol \alpha$, so
$\setsem{\Gamma;\Phi \vdash F[\ol{\alpha := \tau}]}\rho =
\setsem{\Gamma; \ol{\alpha} \vdash F}\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash \tau}\rho}]$ and $\setsem{\Gamma;\Phi
  \vdash F[\ol{\alpha := \tau}]}f = \setsem{\Gamma; \ol{\alpha} \vdash
  F}\rho[\ol{\alpha := \setsem{\Gamma;\Phi \vdash \tau}f}]$, and
similarly for $G$, which ensures the commutativity of
{\footnotesize
\[\begin{tikzcd}
\setsem{\Gamma; \ol{\alpha} \vdash F}\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash \tau}\rho}] \ar[r,
  "{\;\;\;\eta_{\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho}}\;\;\; }"]
\ar[d, "{\setsem{\Gamma; \ol{\alpha} \vdash F}\id_\rho[\ol{\alpha := 
        \setsem{\Gamma;\Phi \vdash \tau}f}]}"']
& \setsem{\Gamma;
  \ol{\alpha} \vdash G}\rho[\ol{\alpha := \setsem{\Gamma;\Phi \vdash
      \tau}\rho}]
\ar[d, "{\setsem{\Gamma; \ol{\alpha} \vdash G}\id_\rho[\ol{\alpha := 
        \setsem{\Gamma;\Phi \vdash \tau}f}]}"]\\
\setsem{\Gamma; \ol{\alpha} \vdash F}\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash \tau}\rho'}] \ar[r,
  "{\eta_{\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho'}} }"]
& \setsem{\Gamma; \ol{\alpha} \vdash G}\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash \tau}\rho'}]
\end{tikzcd}\]}

\begin{comment}
Indeed, $\eta \in
\setsem{\Gamma;\emptyset \vdash \Nat^{\overline{\alpha}} \,F \,G}\rho$
implies that $\eta$ is a natural transformation from $\setsem{\Gamma;
  \overline{\alpha} \vdash F}\rho[\overline{\alpha := \_}]$ to
$\setsem{\Gamma; \overline{\alpha} \vdash G}\rho[\overline{\alpha :=
    \_}]$.  For each $\tau$, consider the morphism
$\setsem{\Gamma;\Phi \vdash \tau}f : \setsem{\Gamma;\Phi \vdash
  \tau}\rho \to \setsem{\Gamma;\Phi \vdash \tau}\rho'$. The following
diagram commutes by naturality of $\eta$:
\[\begin{tikzcd}
\setsem{\Gamma;\Phi \vdash F[\ol{\alpha := \tau}]}\rho \ar[d, equal] &
\setsem{\Gamma;\Phi \vdash G[\ol{\alpha := \tau}]}\rho \ar[d,
  equal]\\
\setsem{\Gamma; \ol{\alpha} \vdash F}\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash \tau}\rho}] \ar[r,
  "{\;\;\;\eta_{\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho}}\;\;\; }"]
\ar[d, "{\setsem{\Gamma; \ol{\alpha} \vdash F}\id_\rho[\ol{\alpha := 
        \setsem{\Gamma;\Phi \vdash \tau}f}]}"]
& \setsem{\Gamma;
  \ol{\alpha} \vdash G}\rho[\ol{\alpha := \setsem{\Gamma;\Phi \vdash
      \tau}\rho}]
\ar[d, "{\setsem{\Gamma; \ol{\alpha} \vdash G}\id_\rho[\ol{\alpha := 
        \setsem{\Gamma;\Phi \vdash \tau}f}]}"]\\
\setsem{\Gamma; \ol{\alpha} \vdash F}\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash \tau}\rho'}] \ar[r,
  "{\eta_{\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho'}} }"]
& \setsem{\Gamma; \ol{\alpha} \vdash G}\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash \tau}\rho'}]
\end{tikzcd}\]
That is,
\[\begin{array}{ll}
 & \setsem{\Gamma;\ol{\alpha} \vdash G}\id_\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi\vdash \tau}f}] \,\circ\,
\eta_{\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho}}\\
=& \eta_{\setsem{\Gamma;\Phi \vdash \tau}\rho'} \,\circ\,
\setsem{\Gamma;\ol{\alpha} \vdash F}\id_\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi\vdash \tau}f}]
\end{array}\]
But since the only variables in the functorial contexts for $F$ and
$G$ are $\ol{\alpha}$, we have that
\[\begin{array}{ll}
 & \setsem{\Gamma;\ol{\alpha} \vdash
  F}\id_\rho[\ol{\alpha := \setsem{\Gamma;\Phi\vdash \tau}f}]\\
=& \setsem{\Gamma;\ol{\alpha}\vdash F}f[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash \tau}f}]\\
=& \setsem{\Gamma;\Phi\vdash F[\ol{\alpha := \tau}]}f
\end{array}\]
and similarly for $G$.  Commutativity of this last diagram thus gives
that $\setsem{\Gamma;\Phi \vdash G[\ol{\alpha := \tau}]}f \,\circ\,
\eta_{\setsem{\Gamma;\Phi \vdash \tau}\rho} =
\eta_{\setsem{\Gamma;\Phi \vdash \tau}\rho'} \,\circ\,
\setsem{\Gamma;\Phi \vdash F[\ol{\alpha := \tau}]}f$, as desired.
\end{comment}
%\item The proof that $\relsem{\Gamma;\Phi \,|\, \Delta \vdash t_{\bf
%    \tau} s: G [\overline{\alpha := \tau}]}$ is a natural
%  transformation from $\relsem{\Gamma;\Phi \vdash \Delta}$ to
%  $\relsem{\Gamma;\Phi \vdash G [\overline{\alpha := \tau}]}$ is
%  analogous.
%\item Finally, to see that $\pi_i(\relsem{\Gamma;\Phi \,|\, \Delta
%  \vdash t_{\bf \tau} s: G [\overline{\alpha := \tau}]}\rho) =
%  \setsem{\Gamma;\Phi \,|\, \Delta \vdash t_{\bf \tau} s: G
%    [\overline{\alpha := \tau}]}(\pi_i\rho)$ we compute
%\[\begin{array}{ll}
%  & \pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash t_{\bf \tau} s: G
%  [\overline{\alpha := \tau}]}\rho)\\
%= & \pi_i( \eval \circ \langle (\relsem{\Gamma;\emptyset \,|\, \Delta
%  \vdash t : \Nat^{\overline{\alpha}} \,F \,G}\rho\;
%\_)_{\overline{\relsem{\Gamma;\Phi \vdash \tau}\rho}},
%\relsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha :=
%      \tau}]}\rho \rangle)\\
%= & \eval \circ \langle \pi_i((\relsem{\Gamma;\emptyset \,|\, \Delta
%  \vdash t : \Nat^{\overline{\alpha}} \,F \,G}\rho\;
%\_)_{\overline{\relsem{\Gamma;\Phi \vdash \tau}\rho}}),
%\pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha
%      := \tau}]}\rho) \rangle\\
%= & \eval \circ \langle \pi_i(\relsem{\Gamma;\emptyset \,|\, \Delta
%  \vdash t : \Nat^{\overline{\alpha}} \,F \,G}\rho\;
%\_)_{\overline{\pi_i(\relsem{\Gamma;\Phi \vdash \tau}\rho)}},
%\pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha
%      := \tau}]}\rho) \rangle\\
%= & \eval \circ \langle (\setsem{\Gamma;\emptyset \,|\, \Delta \vdash
%  t : \Nat^{\overline{\alpha}} \,F \,G}(\pi_i\rho)\;
%\_)_{\overline{\setsem{\Gamma;\Phi \vdash \tau}(\pi_i\rho)}},
%\setsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha :=
%      \tau}]}(\pi_i\rho) \rangle\\
%= & \setsem{\Gamma;\Phi \,|\, \Delta \vdash t_{\bf \tau} s: G
%  [\overline{\alpha := \tau}]}(\pi_i\rho)
%\end{array}\]

\item $\underline{\Gamma;\emptyset~|~\emptyset \vdash
  \map^{\ol{F},\ol{G}}_H :
  \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
      :=_{\ol{\beta}} G}])}$\; Since $\Phi$ is empty, to see that
  $\setsem{\Gamma; \emptyset~|~\emptyset \vdash \map^{\ol{F},\ol{G}}_H
  : \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
      :=_{\ol{\beta}} G}])}$ is a natural transformation from
  $\setsem{\Gamma;\emptyset \vdash \emptyset}$ to
  $\setsem{\Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
      :=_{\ol{\beta}} G}])}$ we need only show that, for all $\rho :
  \setenv$, the unique $d : \setsem{\Gamma;\emptyset \vdash
    \emptyset} \rho$,
%  we have that $\setsem{\Gamma;
%    \emptyset~|~\emptyset \vdash \map^{\ol{F},\ol{G}}_H :
%    \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
%    (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
%        :=_{\ol{\beta}} G}])}\,\rho\,d$ is a morphism from
%  $\ol{\setsem{\Gamma; \emptyset
%      \vdash\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G} \rho}$ to
%  $\setsem{\Gamma; \emptyset \vdash \Nat^{\ol{\gamma}}\,H[\ol{\phi
%        :=_{\ol{\beta}} F}]\,H[\ol{\phi :=_{\ol{\beta}} G}]} \rho$,
%  i.e.,
  and all $\ol{\eta : \setsem{\Gamma; \emptyset
      \vdash\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G} \rho}$, we have
  $\setsem{\Gamma; \emptyset~|~\emptyset \vdash \map^{\ol{F},\ol{G}}_H
    : \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
    (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
        :=_{\ol{\beta}} G}])}\,\rho\,d\, \ol{\eta}
  :$\\ $\setsem{\Gamma; \emptyset \vdash
    \Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
        :=_{\ol{\beta}} G}]} \rho$. For this, we first note that
  $\setsem{\Gamma ;\ol{\phi}, \ol{\gamma} \vdash H}$ is a functor from
  $\setenv$ to $\set$ and, for any $\ol B$, $\id_{\rho[\ol{\gamma :=
        B}]}[\ol{\phi := \lambda \ol{A}. \eta_{\ol{A}\,\ol{B}}}]$ is a
  morphism in $\setenv$ from \[\rho[\ol{\gamma := B}][\ol{\phi :=
      \lambda \ol{A}.\setsem{\Gamma; \ol{\gamma},\ol{\beta} \vdash
        F}\rho[\ol{\gamma := B}][\ol{\beta := A}]}]\] to
  \[\rho[\ol{\gamma := B}][\ol{\phi := \lambda \ol{A}.\setsem{\Gamma;
        \ol{\gamma},\ol{\beta} \vdash G}\rho[\ol{\gamma :=
          B}][\ol{\beta := A}]}]\] so that
$(\setsem{\Gamma; \emptyset~|~\emptyset \vdash
\map^{\ol{F},\ol{G}}_H :
\Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
(\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
    :=_{\ol{\beta}} G}])}\,\rho\,d\, \ol{\eta})_{\ol{B}}$
$=  \setsem{\Gamma; \ol{\phi},\ol{\gamma} \vdash H}\id_{\rho[\ol{\gamma
      := B}]}[\ol{\phi := \lambda \ol{A}. \eta_{\ol{A}\,\ol{B}}}]$
is indeed a morphism from
$\setsem{\Gamma ;\ol{\gamma} \vdash H[\ol{\phi := F}]}\rho[\ol{\gamma
      := B}]$
%= & \setsem{\Gamma ;\ol{\gamma},\ol{\phi} \vdash H}\rho[\ol{\gamma
%      := B}][\ol{\phi := \lambda \ol{A}.\setsem{\Gamma;
%        \ol{\gamma},\ol{\beta} \vdash F}\rho[\ol{\gamma :=
%          B}][\ol{\beta := A}]}]
to 
$ \setsem{\Gamma ;\ol{\gamma} \vdash H[\ol{\phi := G}]}\rho[\ol{\gamma
      := B}]$.
%= & \setsem{\Gamma ;\ol{\gamma},\ol{\phi} \vdash H}\rho[\ol{\gamma
%      := B}][\ol{\phi := \lambda \ol{A}.\setsem{\Gamma;
%        \ol{\gamma},\ol{\beta} \vdash G}\rho[\ol{\gamma :=
%          B}][\ol{\beta := A}]}]
This family of morphisms is natural in $\ol B$: if $\ol{f : B \to B'}$
then, writing $t$ for $\setsem{\Gamma; \emptyset~|~\emptyset \vdash
  \map^{\ol{F},\ol{G}}_H :
  \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
      :=_{\ol{\beta}} G}])}\,\rho\,d\, \ol{\eta}$, naturality of each
$\eta$, together with the fact that composition of environments is
computed componentwise, ensure that the following naturality diagram
for $t$ commutes:
{\footnotesize
\[\begin{tikzcd}
\setsem{\Gamma ;\ol{\gamma} \vdash H[\ol{\phi := F}]}\rho[\ol{\gamma
      := B}] \ar[r,
  "{\;\;\;t_{\ol{B}}\;\;\; }"]
\ar[d, "{\setsem{\Gamma ;\ol{\gamma} \vdash H[\ol{\phi :=
          F}]}\id_{\rho}[\ol{\gamma := f}]}"']
& \setsem{\Gamma ;\ol{\gamma} \vdash H[\ol{\phi := G}]}\rho[\ol{\gamma
      := B}]
\ar[d, "{\setsem{\Gamma ;\ol{\gamma} \vdash H[\ol{\phi :=
          G}]}\id_{\rho}[\ol{\gamma := f}]}"]\\
\setsem{\Gamma ;\ol{\gamma} \vdash H[\ol{\phi := F}]}\rho[\ol{\gamma
      := B'}] \ar[r,
  "{t_{\ol{B'}}}"]
& \setsem{\Gamma ;\ol{\gamma} \vdash H[\ol{\phi := G}]}\rho[\ol{\gamma
      := B'}] 
\end{tikzcd}\]}
That, for all $\rho : \setenv$ and $d :
  \setsem{\Gamma;\emptyset \vdash \emptyset}\rho$, and all $\ol{\eta :
    \setsem{\Gamma; \emptyset \vdash
      \Nat^{\ol{\beta},\ol{\gamma}}\,F\,G}\rho}$,
\[ \setsem{\Gamma; \emptyset~|~\emptyset \vdash
  \map^{\ol{F},\ol{G}}_H :
  \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
      :=_{\ol{\beta}} G}])}\,\rho\,d\, \ol{\eta}\] satisfies the
additional condition needed for it to be in $\setsem{\Gamma;
  \emptyset \vdash \Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}}
      F}]\,H[\ol{\phi :=_{\ol{\beta}} G}]}\rho$, follows from the fact
that each $\eta$ satisfies the extra condition needed for it to be
in its corresponding $\setsem{\Gamma; \emptyset \vdash
  \Nat^{\ol{\beta},\ol{\gamma}}\,F\,G}\rho$.

\begin{comment}  
\begin{itemize}
\item To see that $\setsem{\Gamma; \emptyset~|~\emptyset \vdash
  \map^{\ol{F},\ol{G}}_H :
  \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
      :=_{\ol{\beta}} G}])}$ is a natural transformation from
  $\setsem{\Gamma;\emptyset \vdash \emptyset}$ to
  $\setsem{\Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
      :=_{\ol{\beta}} G}])}$, since the functorial part $\Phi$ of the
  context is empty, we need only show that, for every $\rho :
  \setenv$,
  \[\setsem{\Gamma; \emptyset~|~\emptyset \vdash
  \map^{\ol{F},\ol{G}}_H :
  \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
      :=_{\ol{\beta}} G}])}\,\rho\]
is a morphism in $\set$
  from $\setsem{\Gamma;\emptyset \vdash \emptyset}\rho$ to
\[\setsem{\Gamma; \emptyset \vdash \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
      :=_{\ol{\beta}} G}])}\,\rho\] i.e., that, for the unique $d :
\setsem{\Gamma;\emptyset \vdash \emptyset} \rho$,
\[\setsem{\Gamma; \emptyset~|~\emptyset \vdash
\map^{\ol{F},\ol{G}}_H :
\Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
(\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
    :=_{\ol{\beta}} G}])}\,\rho\,d\] is a morphism from
$\ol{\setsem{\Gamma; \emptyset
    \vdash\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G} \rho}$ to
$\setsem{\Gamma; \emptyset \vdash \Nat^{\ol{\gamma}}\,H[\ol{\phi
      :=_{\ol{\beta}} F}]\,H[\ol{\phi :=_{\ol{\beta}} G}]} \rho$.
For this we show that for all $\ol{\eta : \setsem{\Gamma; \emptyset
    \vdash\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G} \rho}$ we have
\[\begin{array}{ll}
  & \setsem{\Gamma; \emptyset~|~\emptyset \vdash
\map^{\ol{F},\ol{G}}_H :
\Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
(\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
    :=_{\ol{\beta}} G}])}\,\rho\,d\, \ol{\eta}\\
: & \setsem{\Gamma; \emptyset \vdash \Nat^{\ol{\gamma}}\,H[\ol{\phi
      :=_{\ol{\beta}} F}]\,H[\ol{\phi :=_{\ol{\beta}} G}]} \rho
\end{array}\]
To this end, we note that, for any $\ol{B}$, 
\[\begin{array}{ll}
  & (\setsem{\Gamma; \emptyset~|~\emptyset \vdash
\map^{\ol{F},\ol{G}}_H :
\Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
(\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
    :=_{\ol{\beta}} G}])}\,\rho\,d\, \ol{\eta})_{\ol{B}}\\
= & \setsem{\Gamma; \ol{\phi},\ol{\gamma} \vdash H}\id_{\rho[\ol{\gamma
      := B}]}[\ol{\phi := \lambda \ol{A}. \eta_{\ol{A}\,\ol{B}}}]
\end{array}\]
is indeed a morphism from
\[\begin{array}{ll}
  & \setsem{\Gamma ;\ol{\gamma} \vdash H[\ol{\phi := F}]}\rho[\ol{\gamma
      := B}]\\
= & \setsem{\Gamma ;\ol{\gamma},\ol{\phi} \vdash H}\rho[\ol{\gamma
      := B}][\ol{\phi := \lambda \ol{A}.\setsem{\Gamma;
        \ol{\gamma},\ol{\beta} \vdash F}\rho[\ol{\gamma :=
          B}][\ol{\beta := A}]}]
\end{array}\]
to 
\[\begin{array}{ll}
  & \setsem{\Gamma ;\ol{\gamma} \vdash H[\ol{\phi := G}]}\rho[\ol{\gamma
      := B}]\\
= & \setsem{\Gamma ;\ol{\gamma},\ol{\phi} \vdash H}\rho[\ol{\gamma
      := B}][\ol{\phi := \lambda \ol{A}.\setsem{\Gamma;
        \ol{\gamma},\ol{\beta} \vdash G}\rho[\ol{\gamma :=
          B}][\ol{\beta := A}]}]
\end{array}\]
since $\setsem{\Gamma ;\ol{\phi}, \ol{\gamma} \vdash H}$ is a functor
from $\setenv$ to $\set$ and $\id_{\rho[\ol{\gamma := B}]}[\ol{\phi :=
    \lambda \ol{A}. \eta_{\ol{A}\,\ol{B}}}]$ is a morphism in
$\setenv$ from \[\rho[\ol{\gamma := B}][\ol{\phi := \lambda
    \ol{A}.\setsem{\Gamma; \ol{\gamma},\ol{\beta} \vdash
      F}\rho[\ol{\gamma := B}][\ol{\beta := A}]}]\] to \[\rho[\ol{\gamma
    := B}][\ol{\phi := \lambda \ol{A}.\setsem{\Gamma;
      \ol{\gamma},\ol{\beta} \vdash G}\rho[\ol{\gamma := B}][\ol{\beta
        := A}]}]\]

\vspace*{0.1in}

To see that this family of morphisms is natural in $\ol{B}$ we first
observe that if $\ol{f : B \to B'}$ then, writing $t$ for
$\setsem{\Gamma; \emptyset~|~\emptyset \vdash \map^{\ol{F},\ol{G}}_H :
  \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
      :=_{\ol{\beta}} G}])}\,\rho\,d\, \ol{\eta}$, we have
\[\begin{tikzcd}
\setsem{\Gamma ;\ol{\gamma} \vdash H[\ol{\phi := F}]}\rho[\ol{\gamma
      := B}] \ar[r,
  "{\;\;\;t_{\ol{B}}\;\;\; }"]
\ar[d, "{\setsem{\Gamma ;\ol{\gamma} \vdash H[\ol{\phi :=
          F}]}\id_{\rho}[\ol{\gamma := f}]}"']
& \setsem{\Gamma ;\ol{\gamma} \vdash H[\ol{\phi := G}]}\rho[\ol{\gamma
      := B}]
\ar[d, "{\setsem{\Gamma ;\ol{\gamma} \vdash H[\ol{\phi :=
          G}]}\id_{\rho}[\ol{\gamma := f}]}"]\\
\setsem{\Gamma ;\ol{\gamma} \vdash H[\ol{\phi := F}]}\rho[\ol{\gamma
      := B'}] \ar[r,
  "{t_{\ol{B'}}}"]
& \setsem{\Gamma ;\ol{\gamma} \vdash H[\ol{\phi := G}]}\rho[\ol{\gamma
      := B'}] 
\end{tikzcd}\]
This diagram commutes because $\setsem{\Gamma; \ol{\phi},\ol{\gamma}
  \vdash H}$ is a functor from $\setenv$ to $\set$ and because,
letting
\[ E_{F,B} = \rho[\ol{\gamma := B}][\ol{\phi := \lambda \ol{A}.\, \setsem{\Gamma;
      \ol{\gamma},\ol{\beta} \vdash F}\rho[\ol{\gamma := B}][\ol{\beta
        := A}]}]\] and
\[ e_{F,f} = \id_\rho[\ol{\gamma := f}][\ol{\phi := \lambda \ol{A}.\, \setsem{\Gamma;
      \ol{\gamma},\ol{\beta} \vdash F}\rho[\ol{\gamma := f}][\ol{\beta
        := \id_A}]}]\] for all $F$ and $B$ and $\ol{f : B \to B'}$,
the following diagram commutes by the fact that composition of
environments is componentwise together with the naturality of $\eta$:
\[\begin{tikzcd}[column sep=2in, row sep=0.75in]
E_{F,B}
\ar[r,  "{\hspace*{0.5in}\id_\rho[{\gamma :=
        \id_B}][\ol{\phi := \lambda 
        \ol{A}.\,\eta_{\ol{A}\,\ol{B}}}]\hspace*{0.5in}}"] 
\ar[d, "{e_{F,f}}"'] 
& E_{G,B}
\ar[d, "{e_{G,f}}"]\\
E_{F,B'} \ar[r, "{\hspace*{0.5in}\id_\rho[{\gamma :=
        \id_{B'}}][\ol{\phi := \lambda 
        \ol{A}.\,\eta_{\ol{A}\,\ol{B'}}}]\hspace*{0.5in}}"']
& E_{G,B'}
\end{tikzcd}\]
We therefore have that
\[\lambda \ol{B}.\, \setsem{\Gamma; \emptyset~|~\emptyset \vdash
  \map^{\ol{F},\ol{G}}_H :
  \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\; 
  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
      :=_{\ol{\beta}} G}])}\,\rho\,d\, \ol{\eta})_{\ol{B}}\]
  is natural in $\ol{B}$ as desired.
\item
  To see that, for every $\rho : \setenv$ and $d :
  \setsem{\Gamma;\emptyset \vdash \emptyset}\rho$, and all $\ol{\eta :
    \setsem{\Gamma; \emptyset \vdash
      \Nat^{\ol{\beta},\ol{\gamma}}\,F\,G}\rho}$,
\[ \setsem{\Gamma; \emptyset~|~\emptyset \vdash
  \map^{\ol{F},\ol{G}}_H :
  \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
      :=_{\ol{\beta}} G}])}\,\rho\,d\, \ol{\eta}\] satisfies the
additional condition needed for it to be in $\setsem{\Gamma;
  \emptyset \vdash \Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}}
      F}]\,H[\ol{\phi :=_{\ol{\beta}} G}]}\rho$, let $\ol{R :
  \rel(B,B')}$ and $\ol{S : \rel(C,C')}$. Since each map in
$\ol{\eta}$ satisfies the extra condition needed for it to be in
its corresponding $\setsem{\Gamma; \emptyset \vdash
  \Nat^{\ol{\beta},\ol{\gamma}}\,F\,G}\rho$ --- i.e., since
\[(\eta_{\ol{B}\,\ol{C}},\eta_{\ol{B'}\,\ol{C'}}) \in \relsem{\Gamma;
  \ol{\beta},\ol{\gamma} \vdash F}\Eq_\rho[\ol{\beta := R}][\ol{\gamma
    :=S}] \to \relsem{\Gamma; \ol{\beta},\ol{\gamma} \vdash
  G}\Eq_\rho[\ol{\beta := R}][\ol{\gamma :=S}]\]
--- we have that
\[\begin{array}{ll}
  & (\, (\lambda e\,\nu\,\ol{Z}.\,\setsem{\Gamma;\ol{\phi},\ol{\gamma}
  \vdash H}\id_{\rho[\ol{\gamma := Z}]}[\ol{\phi := \lambda
    \ol{A}.\nu_{\ol{A}\,\ol{Z}}}])\,d\,\ol{\eta}\,\ol{B},\\ 
 & \hspace*{0.5in}(\lambda e\,\nu\,\ol{Z}.\,\setsem{\Gamma;\ol{\phi},\ol{\gamma}
  \vdash H}\id_{\rho[\ol{\gamma := Z}]}[\ol{\phi := \lambda
    \ol{A}.\nu_{\ol{A}\,\ol{Z}}}])\,d\,\ol{\eta}\,\ol{B'}\;)\\
= & (\, \setsem{\Gamma;\ol{\phi},\ol{\gamma}
  \vdash H}\id_{\rho[\ol{\gamma := B}]}[\ol{\phi := \lambda
    \ol{A}.\eta_{\ol{A}\,\ol{B}}}]),\; \setsem{\Gamma;\ol{\phi},\ol{\gamma}
  \vdash H}\id_{\rho[\ol{\gamma := B'}]}[\ol{\phi := \lambda
    \ol{A}.\eta_{\ol{A}\,\ol{B'}}}])\,)
\end{array}\]
has type
\[\begin{array}{ll}
  & (\setsem{\Gamma;\ol{\gamma} \vdash H[\ol{\phi := F}]}\rho[\ol{\gamma
    := B}] \to \setsem{\Gamma;\ol{\gamma} \vdash H[\ol{\phi :=
      G}]}\rho[\ol{\gamma := B}],\\
  & \hspace*{0.5in}\setsem{\Gamma;\ol{\gamma} \vdash H[\ol{\phi := 
      F}]}\rho[\ol{\gamma := B'}] \to \setsem{\Gamma;\ol{\gamma} \vdash
  H[\ol{\phi := G}]}\rho[\ol{\gamma := B'}])\\
= & \relsem{\Gamma;\ol{\gamma} \vdash H[\ol{\phi := F}]}\Eq_\rho[\ol{\gamma
    := R}] \to \relsem{\Gamma;\ol{\gamma} \vdash H[\ol{\phi :=
      G}]}\Eq_\rho[\ol{\gamma := R}]
\end{array}\]
as desired.
\end{comment}


%\item The proofs that 
%\[\relsem{\Gamma; \emptyset~|~\emptyset \vdash
%  \map^{\ol{F},\ol{G}}_H :
%  \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
%  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
%      :=_{\ol{\beta}} G}])}\]
%is a natural transformation from $\relsem{\Gamma;\emptyset \vdash
%  \emptyset}$ to 
%\[\relsem{\Gamma; \emptyset \vdash
%  \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
%  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
%      :=_{\ol{\beta}} G}])}\]
%and that, for every $\rho : \relenv$ and the unique $d :
%\relsem{\Gamma;\emptyset \vdash \emptyset}\rho$,
%\[\relsem{\Gamma; \emptyset~|~\emptyset \vdash
%  \map^{\ol{F},\ol{G}}_H :
%  \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
%  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
%      :=_{\ol{\beta}} G}])}\,\rho\,d\] is a morphism from
%$\ol{\relsem{\Gamma; \emptyset \vdash
%    \Nat^{\ol{\beta},\ol{\gamma}}\,F\,G}}\,\rho$ to $\relsem{\Gamma;
%  \emptyset \vdash \Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}}
%      F}]\,H[\ol{\phi :=_{\ol{\beta}} G}]}\,\rho$, are analogous.
%\item Finally, to see that 
%  \[\begin{array}{ll}
%  & \pi_i (\relsem{\Gamma; \emptyset~|~\emptyset \vdash
%    \map_H^{\ol{F}\,\ol{G}} : 
%  \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
%  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
%      :=_{\ol{\beta}} G}])}\,\rho)\\
%= & \setsem{\Gamma; \emptyset~|~\emptyset \vdash
%    \map_H^{\ol{F}\,\ol{G}} : 
%  \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
%  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
%      :=_{\ol{\beta}} G}])}\,(\pi_i \rho)
%\end{array}\]
%we compute
%  \[\begin{array}{ll}
%  & \pi_i (\relsem{\Gamma; \emptyset~|~\emptyset \vdash
%    \map_H^{\ol{F}\,\ol{G}} : 
%  \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
%  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
%      :=_{\ol{\beta}} G}])}\,\rho)\\
%  = & \pi_i \, (\lambda e\, \ol{\nu}\,\ol{R}.\, \relsem{
%    \Gamma; \ol{\phi},\ol{\gamma} \vdash H} \id_{\rho[\ol{\gamma :=
%        R}]}[\ol{\phi := \lambda \ol{S}.\nu_{\ol{S}\,\ol{R}}}])\\
%  = & \lambda e\, \ol{\nu}\,\ol{R}.\, \setsem{
%    \Gamma; \ol{\phi},\ol{\gamma} \vdash H} \id_{(\pi_i \rho)[\ol{\gamma :=
%        \pi_i R}]}[\ol{\phi := \lambda \ol{S}.(\pi_i \nu)_{\ol{\pi_i
%          S}\,\ol{\pi_i R}}}]\\
%  = & \lambda d\, \ol{\eta}\,\ol{B}.\, \setsem{
%    \Gamma; \ol{\phi},\ol{\gamma} \vdash H} \id_{(\pi_i \rho)[\ol{\gamma :=
%        B}]}[\ol{\phi := \lambda \ol{A}.\eta_{\ol{A}\,\ol{B}}}]\\
%  = & \setsem{\Gamma; \emptyset~|~\emptyset \vdash
%    \map_H^{\ol{F}\,\ol{G}} : 
%  \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
%  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
%      :=_{\ol{\beta}} G}])}\,(\pi_i \rho)
%  \end{array}\]
%\end{itemize}

\item
$\underline{\Gamma;\emptyset \,|\, \emptyset \vdash \tin_H :
  Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
    {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
  \;(\mu \phi.\lambda {\overline \alpha}.H){\overline \beta}}$\; To
  see that if $d : \setsem{\Gamma;\emptyset \vdash \emptyset} \rho$
  then $\setsem{\Gamma;\emptyset \,|\, \emptyset \vdash \tin_H :
    Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
      {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
    \;(\mu \phi.\lambda {\overline \alpha}.H){\overline \beta}}\,
  \rho\,d$ is in\\ $\setsem{\Gamma;\emptyset \vdash
    Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
      {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
    \;(\mu \phi.\lambda {\overline \alpha}.H){\overline \beta}}\,
  \rho$, we first note that, for all $\ol{B}$ and $\ol{C}$,
  $(\setsem{\Gamma;\emptyset \,|\, \emptyset \vdash \tin_H :
    Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
      {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
    \;(\mu \phi.\lambda {\overline \alpha}.H){\overline \beta}}\,
  \rho\,d)_{\ol{B}\,\ol{C}}\, =\,
  (\mathit{in}_{T^\set_{H,\rho[\ol{\gamma := C}]}})_{\ol{B}}$ maps
  $\setsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash H[\phi := (\mu
      \phi.\lambda {\overline \alpha}.H){\overline \beta}][\ol{\alpha
        := \beta}]}\rho[\ol{\beta := B}][\ol{\gamma := C}] =
  T^\set_{H,\rho[\ol{\gamma := C}]}\, (\mu T^\set_{H,\rho[\ol{\gamma
        := C}]}) \, \ol{B}$ to $\setsem{\Gamma;\ol{\beta},\ol{\gamma}
    \vdash (\mu \phi.\lambda {\overline \alpha}.H){\overline \beta}}
  \rho[\ol{\beta := B}][\ol{\gamma := C}] = (\mu
  T^\set_{H,\rho[\ol{\gamma := C}]}) \, \ol{B}$. Secondly, we observe
  that\\ $\setsem{\Gamma;\emptyset \,|\, \emptyset \vdash \tin_H :
    Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
      {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
    \;(\mu \phi.\lambda {\overline \alpha}.H){\overline
      \beta}}\,\rho\,d = \lambda
  \ol{B}\,\ol{C}.\,(\mathit{in}_{T^\set_{H,\rho[\ol{\gamma :=
          C}]}})_{\ol{B}}$ is natural in $\ol{B}$ and $\ol{C}$, since
  naturality of $\mathit{in}$ with respect to its functor argument and
  naturality of $\mathit{in}_{T^\set_{H,\rho[\ol{\gamma := C'}]}}$ ensure
  that the following diagram commutes for all $\ol{f : B \to B'}$ and
  $\ol{g : C \to C'}$:
{\tiny
  \[\begin{tikzcd}[column sep=2.5in, row sep=0.75in]
T^\set_{H,\rho[\ol{\gamma := C}]}\, (\mu T^\set_{H,\rho[\ol{\gamma := C}]})\, \ol{B}
\ar[d, "{T^\set_{H,\id_\rho[\ol{\gamma := g}]}\,(\mu
    T^\set_{H,\id_\rho[\ol{\gamma := g}]}) \, \ol{B}}"] \ar[r,
  "{(\mathit{in}_{T^\set_{H,\rho[\ol{\gamma := C}]}})_{\ol{B}}}" ]
& (\mu T^\set_{H,\rho[\ol{\gamma := C}]})\, \ol{B} \ar[d, "{(\mu
    T^\set_{H,\id_\rho[\ol{\gamma := g}]}) \, \ol{B}}"]\\
T^\set_{H,\rho[\ol{\gamma := C'}]}\, (\mu
T^\set_{H,\rho[\ol{\gamma := C'}]})\, \ol{B} \ar[d, "{T^\set_{H,\rho[\ol{\gamma :=
          C'}]}\, (\mu T^\set_{H,\rho[\ol{\gamma := C'}]})\, \ol{f}}"]
\ar[r,"{(\mathit{in}_{T^\set_{H,\rho[\ol{\gamma := C'}]}})_{\ol{B}}}" ] & 
  (\mu T^\set_{H,\rho[\ol{\gamma := C'}]})\, \ol{B}
\ar[d,"{(\mathit{in}_{T^\set_{H,\rho[\ol{\gamma := C'}]}})_{\ol{B}}}" ] 
\\
T^\set_{H,\rho[\ol{\gamma := C'}]}\, (\mu T^\set_{H,\rho[\ol{\gamma := C'}]})\,
\ol{B'} \ar[r, "{(\mathit{in}_{T^\set_{H,\rho[\ol{\gamma :=
            C'}]}})_{\ol{B'}}}"] & (\mu T^\set_{H,\rho[\ol{\gamma := C'}]})\,
\ol{B'}
\end{tikzcd}\]
}
  That, for all $\rho : \setenv$ and $d :
\setsem{\Gamma;\emptyset \vdash \emptyset}\rho$,
\[\setsem{\Gamma;\emptyset \,|\, \emptyset \vdash
  \tin_H : Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
    {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
  \;(\mu \phi.\lambda {\overline \alpha}.H){\overline
    \beta}}\,\rho\,d\] satisfies the additional property needed for
it to be in \[\setsem{\Gamma;\emptyset \vdash
  Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
    {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
  \;(\mu \phi.\lambda {\overline \alpha}.H){\overline \beta}}\,\rho\]
  let $\ol{R : \rel(B,B')}$ and $\ol{S : \rel(C,C')}$ follows from the
  fact that 
\[\begin{array}{ll}
 & (\,(\setsem{\Gamma;\emptyset \,|\, \emptyset \vdash
  \tin_H : Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
    {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
  \;(\mu \phi.\lambda {\overline \alpha}.H){\overline
    \beta}}\,\rho\,d)_{\ol{B},\ol{C}},\,\\
 & \hspace*{0.5in}(\setsem{\Gamma;\emptyset \,|\, \emptyset \vdash
  \tin_H : Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
    {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
  \;(\mu \phi.\lambda {\overline \alpha}.H){\overline
    \beta}}\,\rho\,d)_{\ol{B'},\ol{C'}}\,)\\
=& (\, (\mathit{in}_{T^\set_{H,\rho[\ol{\gamma := C}]}})_{\ol{B}},
(\mathit{in}_{T^\set_{H,\rho[\ol{\gamma := C'}]}})_{\ol{B'}}\,)
\end{array}\]
has type
\[\begin{array}{ll}
%& (\, \setsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash H[\phi := (\mu
%    \phi.\lambda {\overline \alpha}.H){\overline \beta}][\ol{\alpha :=
%      \beta}]}\rho[\ol{\beta := B}][\ol{\gamma := C}] \to\\ 
%& \hspace*{0.5in}\setsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash (\mu \phi.\lambda
%  {\overline \alpha}.H){\overline \beta}} \rho[\ol{\beta :=
%    B}][\ol{\gamma := C}],\\
%& \hspace*{0.05in}\setsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash H[\phi := (\mu
%    \phi.\lambda {\overline \alpha}.H){\overline \beta}][\ol{\alpha :=
%      \beta}]}\rho[\ol{\beta := B'}][\ol{\gamma := C'}] \to\\ 
%& \hspace*{0.5in}\setsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash (\mu \phi.\lambda
%  {\overline \alpha}.H){\overline \beta}} \rho[\ol{\beta :=
%    B'}][\ol{\gamma := C'}]\,)\\
& (\, T^\set_{H,\rho[\ol{\gamma := C}]}\, (\mu
T^\set_{H,\rho[\ol{\gamma := C}]}) \, 
\ol{B} \to (\mu T^\set_{H,\rho[\ol{\gamma := C}]}) \, \ol{B}, \, \\
& \hspace*{0.5in}T^\set_{H,\rho[\ol{\gamma := C'}]}\, (\mu
T^\set_{H,\rho[\ol{\gamma := C'}]}) \, 
\ol{B'} \to (\mu T^\set_{H,\rho[\ol{\gamma := C'}]}) \,\ol{B'} \, )\\
= &
 \relsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash H[\phi := (\mu
    \phi.\lambda {\overline \alpha}.H){\overline \beta}][\ol{\alpha :=
      \beta}]}\Eq_\rho[\ol{\beta := R}][\ol{\gamma := S}] \to\\
 & \hspace*{0.5in} \relsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash (\mu
  \phi.\lambda \ol{\alpha}.H)\ol{\beta}} \Eq_\rho[\ol{\beta:=
    R}][\ol{\gamma :=S}]
\end{array}\]

\begin{comment}  
\begin{itemize}
\item To see that if $d : \setsem{\Gamma;\emptyset \vdash \emptyset}
  \rho$ then \[\setsem{\Gamma;\emptyset \,|\, \emptyset \vdash \tin_H :
    Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
      {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
    \;(\mu \phi.\lambda {\overline \alpha}.H){\overline \beta}}\,
  \rho\,d\] is in $\setsem{\Gamma;\emptyset \vdash
    Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
      {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
    \;(\mu \phi.\lambda {\overline \alpha}.H){\overline \beta}}\,
  \rho$, we first note that, for all $\ol{B}$ and $\ol{C}$,
  \[\begin{array}{ll}
   &(\setsem{\Gamma;\emptyset \,|\, \emptyset \vdash \tin_H :
    Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
      {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
    \;(\mu \phi.\lambda {\overline \alpha}.H){\overline \beta}}\,
  \rho\,d)_{\ol{B}\,\ol{C}}\\
  =& (\mathit{in}_{T_{\rho[\ol{\gamma := C}]}})_{\ol{B}}
\end{array}\] does indeed map
\[\begin{array}{ll}
  & \setsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash H[\phi := (\mu
    \phi.\lambda {\overline \alpha}.H){\overline \beta}][\ol{\alpha :=
      \beta}]}\rho[\ol{\beta := B}][\ol{\gamma := C}]\\
\hspace{0.2in} = & \setsem{\Gamma;\ol{\beta},\ol{\gamma},\ol{\alpha} \vdash H[\phi :=
    (\mu \phi.\lambda {\overline \alpha}.H){\overline
      \beta}]}\rho[\ol{\beta := B}][\ol{\gamma := C}][\ol{\alpha :=
    B}]\\
\hspace{0.2in} = & \setsem{\Gamma;\phi,\ol{\beta},\ol{\gamma},\ol{\alpha} \vdash H}
\rho[\ol{\beta := B}][\ol{\gamma := C}][\ol{\alpha :=
    B}]\\ & \hspace{0.5in} [\phi := \lambda
  \ol{D}.\,\setsem{\Gamma; \ol{\beta},\ol{\gamma},\ol{\alpha}
    \vdash (\mu \phi.\lambda {\overline \alpha}.H){\overline
      \beta}}\rho[\ol{\beta := B}][\ol{\gamma := C}][\ol{\alpha :=
    B}][\ol{\beta := D}]]\\
\hspace{0.2in} = & \setsem{\Gamma;\phi,\ol{\gamma},\ol{\alpha} \vdash H}
\rho[\ol{\gamma := C}][\ol{\alpha := B}]\\
  & \hspace*{0.5in}[\phi := \lambda \ol{D}.\,
  \setsem{\Gamma; \ol{\beta},\ol{\gamma}\vdash (\mu 
    \phi.\lambda {\overline \alpha}.H){\overline \beta}}\rho[\ol{\beta
      := D}][\ol{\gamma := C}]]\\
\hspace{0.2in} = & T_{\rho[\ol{\gamma := C}]}\, (\lambda \ol{D}.\,\setsem{\Gamma;
  \ol{\beta},\ol{\gamma}\vdash (\mu 
  \phi.\lambda {\overline \alpha}.H){\overline \beta}}\rho[\ol{\beta
    := D}][\ol{\gamma := C}])\, \ol{B}\\
\hspace{0.2in} = & T_{\rho[\ol{\gamma := C}]}\, (\mu T_{\rho[\ol{\gamma := C}]}) \, \ol{B}
\end{array}\] to
\[\begin{array}{ll}
 & \setsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash (\mu \phi.\lambda
  {\overline \alpha}.H){\overline \beta}} \rho[\ol{\beta :=
    B}][\ol{\gamma := C}]\\
= & (\lambda \ol{D}.\, \setsem{\Gamma;
  \ol{\beta},\ol{\gamma}\vdash (\mu \phi.\lambda {\overline
    \alpha}.H){\overline \beta}}\rho[\ol{\beta := D}][\ol{\gamma :=
    C}]) \ol{B}\\
= & (\mu T_{\rho[\ol{\gamma := C}]}) \, \ol{B}
\end{array}\]

\vspace*{0.1in}

To see that
\[\begin{array}{ll}
 & \setsem{\Gamma;\emptyset \,|\, \emptyset \vdash \tin_H :
  Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
    {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
  \;(\mu \phi.\lambda {\overline \alpha}.H){\overline
    \beta}}\,\rho\,d\\
=& \lambda \ol{B}\,\ol{C}.\,(\mathit{in}_{T_{\rho[\ol{\gamma :=
        C}]}})_{\ol{B}}
\end{array}\]
is natural in $\ol{B}$ and $\ol{C}$, we observe that the following
diagram commutes for all $\ol{f : B \to B'}$ and $\ol{g : C \to C'}$:
\[\begin{tikzcd}[column sep=2.5in, row sep=0.75in]
T_{\rho[\ol{\gamma := C}]}\, (\mu T_{\rho[\ol{\gamma := C}]})\, \ol{B}
\ar[d, "{\sigma_{\id_\rho[\ol{\gamma := g}]}\,(\mu
    \sigma_{\id_\rho[\ol{\gamma := g}]}) \, \ol{B}}"] \ar[r,
  "{(\mathit{in}_{T_{\rho[\ol{\gamma := C}]}})_{\ol{B}}}" ]
& (\mu T_{\rho[\ol{\gamma := C}]})\, \ol{B} \ar[d, "{(\mu
    \sigma_{\id_\rho[\ol{\gamma := g}]}) \, \ol{B}}"]\\
T_{\rho[\ol{\gamma := C'}]}\, (\mu
T_{\rho[\ol{\gamma := C'}]})\, \ol{B} \ar[d, "{T_{\rho[\ol{\gamma :=
          C'}]}\, (\mu T_{\rho[\ol{\gamma := C'}]})\, \ol{f}}"]
\ar[r,"{(\mathit{in}_{T_{\rho[\ol{\gamma := C'}]}})_{\ol{B}}}" ] & 
  (\mu T_{\rho[\ol{\gamma := C'}]})\, \ol{B}
\ar[d,"{(\mathit{in}_{T_{\rho[\ol{\gamma := C'}]}})_{\ol{B}}}" ] 
\\
T_{\rho[\ol{\gamma := C'}]}\, (\mu T_{\rho[\ol{\gamma := C'}]})\,
\ol{B'} \ar[r, "{(\mathit{in}_{T_{\rho[\ol{\gamma :=
            C'}]}})_{\ol{B'}}}"] & (\mu T_{\rho[\ol{\gamma := C'}]})\,
\ol{B'}
%\ar[d, "{(\mathit{in}_{T_{\rho[\ol{\gamma := C}]}})_{\ol{B}}}"']
%\ar[r, "{T_{\rho[\ol{\gamma := C'}]}\, (\mu T_{\rho[\ol{\gamma :=
%          C'}]})\, \ol{f} \; \circ \; \sigma_{\id_\rho[\ol{\gamma :=
%          g}]}\,(\mu \sigma_{\id_\rho[\ol{\gamma := g}]}) \, \ol{B}}"] 
%& T_{\rho[\ol{\gamma := C'}]}\, (\mu T_{\rho[\ol{\gamma := C'}]})\,
%\ol{B'} \ar[d, "({\mathit{in}_{T_{\rho[\ol{\gamma := C'}]}}})_{\ol{B'}}"]\\
%(\mu T_{\rho[\ol{\gamma := C}]})\, \ol{B}  \ar[r, "{(\mu
%    T_{\rho[\ol{\gamma := C'}]})\, \ol{f} \; \circ \; \mu
%    \sigma_{\id_\rho[\ol{\gamma := g}]} \ol{B}}"] 
%    & (\mu T_{\rho[\ol{\gamma := C'}]})\, \ol{B'} 
\end{tikzcd}\]
Indeed, naturality of $\mathit{in}$ with respect to its functor
argument ensures that the top diagram commutes, and naturality of
$\mathit{in}_{T_{\rho[\ol{\gamma := C'}]}}$ ensures that the bottom
one commutes. 
\item To see that $\setsem{\Gamma;\emptyset \,|\, \emptyset \vdash
  \tin_H : Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
    {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
  \;(\mu \phi.\lambda {\overline \alpha}.H){\overline
    \beta}}\,\rho\,d$ satisfies the additional property needed for
  it to be in \[\setsem{\Gamma;\emptyset \vdash
    Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
      {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
    \;(\mu \phi.\lambda {\overline \alpha}.H){\overline
      \beta}}\,\rho\]
  let $\ol{R : \rel(B,B')}$ and $\ol{S : \rel(C,C')}$. Then
\[\begin{array}{ll}
 & (\,(\setsem{\Gamma;\emptyset \,|\, \emptyset \vdash
  \tin_H : Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
    {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
  \;(\mu \phi.\lambda {\overline \alpha}.H){\overline
    \beta}}\,\rho\,d)_{\ol{B},\ol{C}},\,\\
 & \hspace*{0.5in}(\setsem{\Gamma;\emptyset \,|\, \emptyset \vdash
  \tin_H : Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
    {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
  \;(\mu \phi.\lambda {\overline \alpha}.H){\overline
    \beta}}\,\rho\,d)_{\ol{B'},\ol{C'}}\,)\\
=& (\, (\mathit{in}_{T_{\rho[\ol{\gamma := C}]}})_{\ol{B}},
(\mathit{in}_{T_{\rho[\ol{\gamma := C'}]}})_{\ol{B'}}\,)
\end{array}\]
has type
\[\begin{array}{ll}
& (\, \setsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash H[\phi := (\mu
    \phi.\lambda {\overline \alpha}.H){\overline \beta}][\ol{\alpha :=
      \beta}]}\rho[\ol{\beta := B}][\ol{\gamma := C}] \to\\ 
& \hspace*{0.5in}\setsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash (\mu \phi.\lambda
  {\overline \alpha}.H){\overline \beta}} \rho[\ol{\beta :=
    B}][\ol{\gamma := C}],\\
& \hspace*{0.05in}\setsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash H[\phi := (\mu
    \phi.\lambda {\overline \alpha}.H){\overline \beta}][\ol{\alpha :=
      \beta}]}\rho[\ol{\beta := B'}][\ol{\gamma := C'}] \to\\ 
& \hspace*{0.5in}\setsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash (\mu \phi.\lambda
  {\overline \alpha}.H){\overline \beta}} \rho[\ol{\beta :=
    B'}][\ol{\gamma := C'}]\,)\\
= & (\, T_{\rho[\ol{\gamma := C}]}\, (\mu T_{\rho[\ol{\gamma := C}]}) \,
\ol{B} \to (\mu T_{\rho[\ol{\gamma := C}]}) \, \ol{B}, \, 
T_{\rho[\ol{\gamma := C'}]}\, (\mu T_{\rho[\ol{\gamma := C'}]}) \,
\ol{B'} \to (\mu T_{\rho[\ol{\gamma := C'}]}) \,\ol{B'} \, )\\
= & \relsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash H[\phi := (\mu
    \phi.\lambda {\overline \alpha}.H){\overline \beta}][\ol{\alpha :=
      \beta}]}\Eq_\rho[\ol{\beta := R}][\ol{\gamma := S}] \to \\
& \hspace*{0.5in} \relsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash (\mu
  \phi.\lambda \ol{\alpha}.H)\ol{\beta}} \Eq_\rho[\ol{\beta:=
    R}][\ol{\gamma :=S}] 
\end{array}\]
\end{comment}

\begin{comment}
\item The proofs that $\relsem{\Gamma;\emptyset \,|\,
    \emptyset \vdash \tin_H : Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi
      := (\mu \phi.\lambda {\overline \alpha}.H){\overline
        \beta}][\ol{\alpha := \beta}] \;(\mu \phi.\lambda {\overline
      \alpha}.H){\overline \beta}}$ is a natural transformation from
  $\relsem{\Gamma;\emptyset \vdash \emptyset}$ to
  $\relsem{\Gamma;\emptyset \vdash Nat^{\ol{\beta},\ol{\gamma}} \,
    H[\phi := (\mu \phi.\lambda {\overline \alpha}.H){\overline
        \beta}][\ol{\alpha := \beta}] \;(\mu \phi.\lambda {\overline
      \alpha}.H){\overline \beta}}$ and that, for all $\rho : \relenv$
  and $d : \relsem{\Gamma;\emptyset \vdash \emptyset}$,
  \[\relsem{\Gamma;\emptyset \,|\, \emptyset \vdash \tin_H :
    Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
      {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
    \;(\mu \phi.\lambda {\overline \alpha}.H){\overline
      \beta}}\,\rho\,d\] is a natural transformation from $\lambda
  \ol{R}\,\ol{S}.\,\relsem{\Gamma; \ol{\beta},\ol{\gamma} \vdash
    H[\phi := (\mu \phi.\lambda {\overline \alpha}.H){\overline
        \beta}][\ol{\alpha := \beta}]}\rho[\ol{\beta := R}][\ol{\gamma
      := S}]$ to $\lambda \ol{R}\,\ol{S}.\,\relsem{\Gamma;
    \ol{\beta},\ol{\gamma} \vdash (\mu \phi.\lambda {\overline
      \alpha}.H){\overline \beta}}\rho[\ol{\beta := R}][\ol{\gamma :=
      S}]$, are analogous.
\item Finally, to see that $\pi_i(\relsem{\Gamma;\emptyset \,|\,
  \emptyset \vdash \tin_H : Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi :=
    (\mu \phi.\lambda {\overline \alpha}.H){\overline
      \beta}][\ol{\alpha := \beta}] \;(\mu \phi.\lambda {\overline
    \alpha}.H){\overline \beta}}\,\rho\,d) = \setsem{\Gamma;\emptyset
  \,|\, \emptyset \vdash \tin_H : Nat^{\ol{\beta},\ol{\gamma}} \,
  H[\phi := (\mu \phi.\lambda {\overline \alpha}.H){\overline
      \beta}][\ol{\alpha := \beta}] \;(\mu \phi.\lambda {\overline
    \alpha}.H){\overline \beta}}\,(\pi_i \rho)\,(\pi_i d)$ we first
  note that $d : \relsem{\Gamma; \emptyset \vdash \emptyset}\rho$ and
  $\pi_i d : \setsem{\Gamma; \emptyset \vdash \emptyset} (\pi_i \rho)$
  are uniquely determined. Further, the definition of natural
  transformations in $\rel$ ensures that, for any $\ol{R}$ and
  $\ol{S}$,
\[\begin{split}
 &~(\mathit{in}_{T_{\rho[\ol{\gamma := S}]}})_{\ol{R}}\\
=&~((\mathit{in}_{\pi_1 (T_{\rho[\ol{\gamma := S}]})})_{\ol{\pi_1 R}}, \,
(\mathit{in}_{\pi_2 (T_{\rho[\ol{\gamma := S}]})})_{\ol{\pi_2 R}})\\ 
=&~((\mathit{in}_{T^\set_{(\pi_1 \rho)[\ol{\gamma := \pi_1
        S}]}})_{\ol{\pi_1 R}}, \, (\mathit{in}_{T^\set_{(\pi_2
    \rho)[\ol{\gamma := \pi_2 S}]}})_{\ol{\pi_2 R}})\\
\end{split}\]
Observing that $\pi_1$ and $\pi_2$ are surjective, we therefore have
that
\[\begin{split}
 &~\pi_i(\relsem{\Gamma;\emptyset \,|\,
  \emptyset \vdash \tin_H : Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi :=
    (\mu \phi.\lambda {\overline \alpha}.H){\overline
      \beta}][\ol{\alpha := \beta}] \;(\mu \phi.\lambda {\overline
    \alpha}.H){\overline \beta}}\,\rho\,d)\\
=&~\pi_i (\lambda \ol{R}\,\ol{S}.\, (\mathit{in}_{T_{\rho[\ol{\gamma :=
        S}]}})_{\ol{R}}) \\ 
=&~\lambda \ol{B}\,\ol{C}.\, (\mathit{in}_{T^\set_{(\pi_i
      \rho)[\ol{\gamma := C}]}})_{\ol{B}} \\
=&~\setsem{\Gamma;\emptyset \,|\,
  \emptyset \vdash \tin_H : Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi :=
    (\mu \phi.\lambda {\overline \alpha}.H){\overline
      \beta}][\ol{\alpha := \beta}] \;(\mu \phi.\lambda {\overline
    \alpha}.H){\overline \beta}}\,(\pi_i \rho)\,(\pi_i d)
\end{split}\]
\end{itemize}
\end{comment}
\item
$\underline{\Gamma; \emptyset~|~\emptyset \vdash \fold^F_H :
  \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta \;F)}$ \; Since $\Phi$ is empty, to see
  that $\setsem{ \Gamma; \emptyset~|~\emptyset \vdash \fold^F_H :
    \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
      :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
    (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
    \alpha.H)\overline \beta \;F)}$ is a natural transformation
  $\setsem{\Gamma;\emptyset \vdash \emptyset}$ to \[\setsem{\Gamma;
    \emptyset \vdash \Nat^\emptyset\;(\Nat^{\ol{\beta},
      \ol{\gamma}}\,H[\phi :=_{\ol{\beta}} F][\ol{\alpha :=
        \beta}]\,F)\; (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu
    \phi.\lambda \overline \alpha.H)\overline \beta\,F}\] we need only
  show that, for all $\rho : \setenv$, the unique $d :
  \setsem{\Gamma;\emptyset \vdash \emptyset} \rho$, and all $\eta :
  \setsem{\Gamma; \emptyset \vdash \Nat^{\ol{\beta},
      \ol{\gamma}}\,H[\phi :=_{\ol{\beta}} F][\ol{\alpha :=
        \beta}]\,F} \rho$,
\[ \setsem{\Gamma; \emptyset~|~\emptyset \vdash \fold^F_H :
  \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta\,F}\,\rho\,d\,\eta\] has type
$\setsem{\Gamma; \emptyset \vdash \Nat^{{\ol{\beta},\ol{\gamma}}
  }\,(\mu \phi.\lambda \overline \alpha.H)\overline \beta\,F}\,\rho$
i.e., for any $\ol{B}$ and $\ol{C}$,
\[(\setsem{\Gamma; \emptyset~|~\emptyset \vdash \fold^F_H :
  \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta\,F}\,\rho\,d\,\eta)_{\ol{B}\,\ol{C}}\] is a
morphism from $\setsem{\Gamma; \ol{\beta},\ol{\gamma} \vdash (\mu
  \phi.\lambda \overline \alpha.H)\overline \beta}\rho[\ol{\beta :=
    B}][\ol{\gamma := C}] \,=\,(\mu T^\set_{H,\rho[\ol{\gamma := C}]})
\ol{B}$\\ to $\setsem{\Gamma; \ol{\beta},\ol{\gamma} \vdash
  F}\rho[\ol{\beta := B}][\ol{\gamma := C}]$.  To see this, note
%use Equations~\ref{eq:subs-var} and~\ref{eq:subs-const} to verify
that $\eta$ is a natural transformation from
\[\begin{array}{ll}
 & \lambda \ol{B}\,\ol{C}.\,\setsem{\Gamma; \ol{\beta},\ol{\gamma}
  \vdash H[\phi := F][\ol{\alpha := \beta}]}\rho[\ol{\beta :=
    B}][\ol{\gamma := C}]\\
%= & \lambda
%\ol{B}\,\ol{C}.\,\setsem{\Gamma;\ol{\beta},\ol{\gamma},\ol{\alpha}  
%  \vdash H[\phi := F]}\rho[\ol{\beta := B}][\ol{\gamma :=
%    C}][\ol{\alpha := B}]\\ 
%= & \lambda \ol{B}\,\ol{C}.\,\setsem{\Gamma;
%  \ol{\beta},\ol{\gamma},\ol{\alpha},\phi \vdash H}\rho
%[\ol{\beta := B}][\ol{\gamma := C}][\ol{\alpha := B}]\\
% & \hspace*{0.5in}[\phi := \lambda \ol{A}.\, \setsem{\Gamma;\ol{\beta},
%    \ol{\gamma},\ol{\alpha} \vdash F}\rho[\ol{\beta := B}][\ol{\gamma
%      := C}][\ol{\alpha := B}][\ol{\beta := A}]]\\ 
%= & \lambda \ol{B}\,\ol{C}.\, \setsem{\Gamma;
%  \ol{\gamma},\ol{\alpha},\phi \vdash H}\rho[\ol{\gamma :=
%    C}][\ol{\alpha := B}][\phi := \lambda \ol{A}.\,
%  \setsem{\Gamma;\ol{\beta}, 
%    \ol{\gamma}\vdash F}\rho[\ol{\gamma := C}][\ol{\beta := A}]]\\ 
= & \lambda \ol{B}\,\ol{C}.\,T^\set_{H,\rho[\ol{\gamma:=
     C}]}\,(\lambda \ol{A}. \, \setsem{\Gamma;\ol{\beta},\ol{\gamma} 
  \vdash F}\rho[\ol{\beta := A}][\ol{\gamma := C}]) \, \ol{B}
\end{array}\]
to
\[\begin{array}{ll}
 & \lambda \ol{B}\,\ol{C}.\,(\lambda
\ol{A}.\,\setsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash F}\rho[\ol{\beta
    := A}][\ol{\gamma := C}]) \ol{B}\\
= & \lambda
\ol{B}\,\ol{C}.\,\setsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash
  F}\rho[\ol{\beta := B}][\ol{\gamma := C}]
\end{array}\]
and thus
%if $x :
%\setsem{\Gamma; \ol{\beta},\ol{\gamma} \vdash (\mu \phi.\lambda
%  \overline \alpha.H)\overline \beta}\rho[\ol{\beta := B}][\ol{\gamma
%    := C}]\;=\;(\mu T^\set_{\rho[\ol{\gamma := C}]}) \ol{B}$, then
%\[\begin{array}{ll}
%  & (\setsem{\Gamma; \emptyset~|~\emptyset \vdash \fold^F_H :
%  \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
%    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
%  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
%  \alpha.H)\overline \beta\,F}\,\rho\,d\,\eta)_{\ol{B}\,\ol{C}}\,x\\
%= & (\mathit{fold}_{T^\set_{\rho[{\gamma := C}]}}\,(\lambda
%\ol{A}.\,\eta_{\ol{A}\,\ol{C}}))_{\ol{B}}\,x\\  
%:& (\lambda \ol{A}.\,\setsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash
%  F}\rho[\ol{\beta := A}][\ol{\gamma := C}])\ol{B}
%\end{array}\]
%i.e.,
for each $\ol{B}$ and $\ol{C}$,
\[(\setsem{\Gamma; \emptyset~|~\emptyset \vdash \fold^F_H :
  \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta\,F}\,\rho\,d\,\eta)_{\ol{B}\,\ol{C}}\] is a
morphism from
$\setsem{\Gamma; \ol{\beta},\ol{\gamma} \vdash (\mu
  \phi.\lambda \overline \alpha.H)\overline \beta}\rho[\ol{\beta :=
    B}][\ol{\gamma := C}]\,=\, (\mu T^\set_{H,\rho[\ol{\gamma := C}]})
\ol{B}$ to\\ $\setsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash
  F}\rho[\ol{\beta := B}][\ol{\gamma := C}]$.
\begin{comment}  
\begin{itemize}
\item
  To see that $\setsem{\Gamma; \emptyset~|~\emptyset \vdash
  \fold^F_H : \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta\,F}$ is a natural transformation from
  $\setsem{\Gamma;\emptyset \vdash \emptyset}$ to
  \[\setsem{\Gamma; \emptyset \vdash
    \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi 
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
    (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
    \alpha.H)\overline \beta\,F}\] since the functorial part $\Phi$ of
  the context is empty, we need only show that, for every $\rho :
  \setenv$,
\[\setsem{\Gamma; \emptyset~|~\emptyset \vdash
  \fold^F_H : \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta\,F}\,\rho\]
is a morphism in $\set$
  from $\setsem{\Gamma;\emptyset \vdash \emptyset}\rho$ to
\[\setsem{\Gamma; \emptyset \vdash \Nat^\emptyset\;(\Nat^{\ol{\beta},
    \ol{\gamma}} \,H[\phi :=_{\ol{\beta}} F][\ol{\alpha :=
      \beta}]\,F)\; (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu
  \phi.\lambda \overline \alpha.H)\overline \beta\,F}\,\rho\] i.e.,
that, for the unique $d : \setsem{\Gamma;\emptyset \vdash \emptyset}
\rho$,
\[\setsem{\Gamma; \emptyset~|~\emptyset \vdash
  \fold^F_H : \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta\,F}\,\rho\,d\] is a morphism from
$\setsem{\Gamma; \emptyset \vdash \Nat^{\ol{\beta},
    \ol{\gamma}}\,H[\phi :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F}
\rho$ to $\setsem{\Gamma; \emptyset \vdash
  \Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta\,F}\rho$. For this we show that for every
$\eta : \setsem{\Gamma; \emptyset \vdash \Nat^{\ol{\beta},
    \ol{\gamma}}\,H[\phi :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F}
\rho$ we have
\[\begin{array}{ll}
  & \setsem{\Gamma; \emptyset~|~\emptyset \vdash \fold^F_H :
  \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta\,F}\,\rho\,d\,\eta\\ : & \setsem{\Gamma;
  \emptyset \vdash \Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda
  \overline \alpha.H)\overline \beta\,F}\,\rho
\end{array}\]



To this end we show that, for any $\ol{B}$ and $\ol{C}$,
\[(\setsem{\Gamma; \emptyset~|~\emptyset \vdash \fold^F_H :
  \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta\,F}\,\rho\,d\,\eta)_{\ol{B}\,\ol{C}}\]
is a morphism from 
\[\setsem{\Gamma; \ol{\beta},\ol{\gamma} \vdash (\mu
    \phi.\lambda \overline \alpha.H)\overline \beta}\rho[\ol{\beta :=
    B}][\ol{\gamma := C}]\,=\,(\mu T^\set_{\rho[\ol{\gamma := C}]})
\ol{B}\] to \[\setsem{\Gamma; \ol{\beta},\ol{\gamma} \vdash
  F}\rho[\ol{\beta := B}][\ol{\gamma := C}]
%= (\lambda \ol{A}.\,
%\setsem{\Gamma; \ol{\beta},\ol{\gamma} \vdash
%  F}\rho[\ol{\beta := A}][\ol{\gamma := C}])\,\ol{B}
\] To see this, we use
Equations~\ref{eq:subs-var} and~\ref{eq:subs-const} for the first and
second equalities below, together with weakening, to see that $\eta$
is itself a natural transformation from 
\[\begin{array}{ll}
 & \lambda \ol{B}\,\ol{C}.\,\setsem{\Gamma; \ol{\beta},\ol{\gamma}
  \vdash H[\phi := F][\ol{\alpha := \beta}]}\rho[\ol{\beta :=
    B}][\ol{\gamma := C}]\\ 
= & \lambda
\ol{B}\,\ol{C}.\,\setsem{\Gamma;\ol{\beta},\ol{\gamma},\ol{\alpha}  
  \vdash H[\phi := F]}\rho[\ol{\beta := B}][\ol{\gamma :=
    C}][\ol{\alpha := B}]\\ 
= & \lambda \ol{B}\,\ol{C}.\,\setsem{\Gamma;
  \ol{\beta},\ol{\gamma},\ol{\alpha},\phi \vdash H}\rho
[\ol{\beta := B}][\ol{\gamma := C}][\ol{\alpha := B}]\\
 & \hspace*{0.5in}[\phi := \lambda \ol{A}.\, \setsem{\Gamma;\ol{\beta},
    \ol{\gamma},\ol{\alpha} \vdash F}\rho[\ol{\beta := B}][\ol{\gamma
      := C}][\ol{\alpha := B}][\ol{\beta := A}]]\\ 
= & \lambda \ol{B}\,\ol{C}.\, \setsem{\Gamma;
  \ol{\gamma},\ol{\alpha},\phi \vdash H}\rho[\ol{\gamma :=
    C}][\ol{\alpha := B}][\phi := \lambda \ol{A}.\,
  \setsem{\Gamma;\ol{\beta}, 
    \ol{\gamma}\vdash F}\rho[\ol{\gamma := C}][\ol{\beta := A}]]\\ 
=& \lambda \ol{B}\,\ol{C}.\,T^\set_{\rho[\ol{\gamma:=
      C}]}\,(\lambda \ol{A}. \, \setsem{\Gamma;\ol{\beta},\ol{\gamma} 
  \vdash F}\rho[\ol{\beta := A}][\ol{\gamma := C}]) \, \ol{B}\\
\end{array}\]
to 
\[\lambda \ol{B}\,\ol{C}.\,(\lambda
\ol{A}.\,\setsem{\Gamma;\ol{\beta},\ol{\gamma} 
  \vdash F}\rho[\ol{\beta := A}][\ol{\gamma := C}]) \ol{B}\;\;= \;\;
\lambda \ol{B}\,\ol{C}.\,\setsem{\Gamma;\ol{\beta},\ol{\gamma}
  \vdash F}\rho[\ol{\beta := B}][\ol{\gamma := C}]\] Thus, if $x :
\setsem{\Gamma; \ol{\beta},\ol{\gamma} \vdash (\mu \phi.\lambda
  \overline \alpha.H)\overline \beta}\rho[\ol{\beta := B}][\ol{\gamma
    := C}]\;=\;(\mu T^\set_{\rho[\ol{\gamma := C}]}) \ol{B}$, then
\[\begin{array}{ll}
  & (\setsem{\Gamma; \emptyset~|~\emptyset \vdash \fold^F_H :
  \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta\,F}\,\rho\,d\,\eta)_{\ol{B}\,\ol{C}}\,x\\
= & (\mathit{fold}_{T^\set_{\rho[{\gamma := C}]}}\,(\lambda
\ol{A}.\,\eta_{\ol{A}\,\ol{C}}))_{\ol{B}}\,x\\  
:& (\lambda \ol{A}.\,\setsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash
  F}\rho[\ol{\beta := A}][\ol{\gamma := C}])\ol{B}
\end{array}\]
i.e., for each $\ol{B}$ and $\ol{C}$
\[(\setsem{\Gamma; \emptyset~|~\emptyset \vdash \fold^F_H :
  \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta\,F}\,\rho\,d\,\eta)_{\ol{B}\,\ol{C}}\] is a
morphism from $(\mu T^\set_{\rho[\ol{\gamma := C}]}) \ol{B}$ to
$\setsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash F}\rho[\ol{\beta :=
    B}][\ol{\gamma := C}]$.
\vspace*{0.1in}
\end{comment}
To see that this family of morphisms is natural in $\ol{B}$ and
$\ol{C}$, we observe that the following diagram commutes for all
$\ol{f : B \to B'}$ and $\ol{g : C \to C'}$:
{\tiny
\[\begin{tikzcd}[column sep=2.5in, row sep=0.75in]
(\mu T^\set_{H,\rho[\ol{\gamma := C}]})\, \ol{B}
\ar[d, "{(\mu T^\set_{H,\id_\rho[\ol{\gamma := g}]}) \, \ol{B}}"'] \ar[r, 
  "{(\mathit{fold}_{T^\set_{H,\rho[\ol{\gamma := C}]}}\,(\lambda
    \ol{A}.\,\eta_{\ol{A}\,\ol{C}}))_{\ol{B}}}"] 
& \setsem{\Gamma; \ol{\beta},\ol{\gamma} \vdash F}\rho[\ol{\gamma :=
    C}][\ol{\beta := B}]\ar[d, "{\setsem{\Gamma;
      \ol{\beta},\ol{\gamma} \vdash F}\id_\rho[\ol{\gamma := 
    g}][\ol{\beta := \id_B}]}"]\\
(\mu T^\set_{H,\rho[\ol{\gamma := C'}]})\, \ol{B} 
\ar[r,"{(\mathit{fold}_{T^\set_{H,\rho[\ol{\gamma :=
            C'}]}}\,(\lambda \ol{A}.\,\eta_{\ol{A}\,\ol{C'}}))_{\ol{B}}\,}" ] 
\ar[d, "{(\mu T^\set_{H,\rho[\ol{\gamma := C'}]}) \, \ol{f}}"'] & 
 \setsem{\Gamma; \ol{\beta},\ol{\gamma} \vdash F}\rho[\ol{\gamma :=
    C'}][\ol{\beta := B}]\ar[d, "{\setsem{\Gamma;
      \ol{\beta},\ol{\gamma} \vdash F}\id_\rho[\ol{\gamma := 
    \id_{C'}}][\ol{\beta := f}]}"]\\
 (\mu T^\set_{H,\rho[\ol{\gamma := C'}]})\, \ol{B'} 
\ar[r,"{(\mathit{fold}_{T^\set_{H,\rho[\ol{\gamma :=
            C'}]}}\,(\lambda \ol{A}.\,\eta_{\ol{A}\,\ol{C'}}))_{\ol{B'}}\,}"
] &  
 \setsem{\Gamma; \ol{\beta},\ol{\gamma} \vdash F}\rho[\ol{\gamma :=
    C'}][\ol{\beta := B'}]
\end{tikzcd}\]}
Indeed, naturality of $\mathit{fold}_{T^\set_{H,\rho[\ol{\gamma :=
        C'}]}}\,(\lambda \ol{A}.\,\eta_{\ol{A}\,\ol{C'}})$ ensures that
the bottom diagram commutes. To see that the top one commutes
%is considerably more delicate.
%\vspace*{0.1in}
% To see that the top diagram commutes
we first observe that, given a natural transformation $\Theta : H \to
K : [\set^k, \set] \to [\set^k, \set]$, the fixpoint natural
transformation $\mu \Theta : \mu H \to \mu K : \set^k \to \set$ is
defined to be $\textit{fold}_{H}(\Theta\,(\mu K) \circ
\textit{in}_{K})$, i.e., the unique morphism making the following
diagram commute:\label{page:dia1}
{\footnotesize
\[\begin{tikzcd}[column sep = large]
H(\mu H)
	\ar[dd, "{\textit{in}_H}"']
	\ar[r, "{H(\mu \Theta)}"]
& H(\mu K)
	\ar[d, "{\Theta (\mu K)}"] \\
& K(\mu K)
	\ar[d, "{\textit{in}_K}"] \\
\mu H
	\ar[r, "{\mu \Theta}"']
& \mu K
\end{tikzcd}\]}
Taking $\Theta = T^{\set}_{H,f}: T^{\set}_{H,\rho} \to
T^{\set}_{H,\rho'}$ thus gives that, for any $f : \rho \to \rho'$ in
$\setenv$,
\begin{equation}\label{eq:mu-sigma-def}
\mathit{in}_{T^{\set}_{H,\rho'}} \circ 
T^{\set}_{H,f} (\mu T^{\set}_{H,\rho'}) \circ 
T^{\set}_{H,\rho}(\mu T^{\set}_{H,f}) \,=\, 
\mu T^{\set}_{H,f} \circ \mathit{in}_{T^{\set}_{H,\rho}}
\end{equation}
%the following diagram commutes for any
%morphism of set environments $f : \rho \to \rho'$:
%\begin{equation}\label{eq:mu-sigma-def}
%\begin{tikzcd}[column sep = large]
%T^{\set}_{\rho}(\mu T^{\set}_{\rho})
%	\ar[dd, "{\mathit{in}_{T^{\set}_{\rho}}}"']
%	\ar[r, "{T^{\set}_{\rho}(\mu \sigma^{\set}_{f})}"]
%& T^{\set}_{\rho}(\mu T^{\set}_{\rho'})
%	\ar[d, "{\sigma^{\set}_{f} (\mu T^{\set}_{\rho'})}"] \\
%& T^{\set}_{\rho'}(\mu T^{\set}_{\rho'})
%	\ar[d, "{\mathit{in}_{T^{\set}_{\rho'}}}"] \\
%\mu T^{\set}_{\rho}
%	\ar[r, "{\mu \sigma^{\set}_{f}}"']
%& \mu T^{\set}_{\rho'}
%\end{tikzcd}
%\end{equation}
Next, note that the action of the functor
%\begin{equation*}
$\lambda \ol{B}. \lambda \ol{C}. \setsem{\Gamma; \ol{\beta},
  \ol{\gamma} \vdash H[\phi := F][\ol{\alpha := \beta}]}\rho
        [\ol{\beta := B}] [\ol{\gamma := C}]
$ %\end{equation*}
on the morphisms $\ol{f : B \to B'}, \ol{g : C \to C'}$ is given by
\[\begin{array}{ll}
 & \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash H[\phi :=
      F][\ol{\alpha := \beta}]} \id_{\rho} [\ol{\beta := f}]
           [\ol{\gamma := g}]\\
%= & \setsem{\Gamma; \ol{\alpha}, \ol{\gamma} \vdash H[\phi :=
%      F]} \id_{\rho} [\ol{\alpha := f}][\ol{\gamma := g}]\\
= & \setsem{\Gamma; \phi, \ol{\alpha}, \ol{\gamma} \vdash H}
\id_{\rho}[\ol{\alpha := f}] [\ol{\gamma := g}][\phi := \lambda
  \ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \id_{\rho
    [\ol{\beta := A}]} [\ol{\gamma := g}]] \\ 
%=& \setsem{\Gamma; \phi, \ol{\alpha}, \ol{\gamma} \vdash H} (\id_{\rho
%  [\ol{\gamma := C'}] [\phi := \lambda \ol{A}. \setsem{\Gamma;
%      \ol{\beta}, \ol{\gamma} \vdash F} \rho [\ol{\beta := A}]
%    [\ol{\gamma := C'}]]} [\ol{\alpha := f}] \\
%&\hspace{3em} \circ \id_{\rho [\ol{\alpha := B}] [\phi := \lambda
%    \ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho
%       [\ol{\beta := A}] [\ol{\gamma := C'}]]} [\ol{\gamma := g}] \\
%&\hspace{3em} \circ \id_{\rho [\ol{\alpha := B}] [\ol{\gamma := C}]}
%[\phi := \lambda \ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma}
%    \vdash F} \id_{\rho [\ol{\beta := A}]}[\ol{\gamma := g}]] ) \\
=& \setsem{\Gamma; \phi, \ol{\alpha}, \ol{\gamma} \vdash H} \id_{\rho
  [\ol{\gamma := C'}][\phi := \lambda \ol{A}. \setsem{\Gamma;
      \ol{\beta}, \ol{\gamma} \vdash F} \rho [\ol{\beta := A}]
    [\ol{\gamma := C'}]]} [\ol{\alpha := f}] \\
&\hspace{3em} \circ \setsem{\Gamma; \phi, \ol{\alpha}, \ol{\gamma}
  \vdash H} \id_{\rho [\ol{\alpha := B}][\phi := \lambda
    \ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho
       [\ol{\beta := A}] [\ol{\gamma := C'}]]} [\ol{\gamma := g}] \\
&\hspace{3em} \circ \setsem{\Gamma; \phi, \ol{\alpha}, \ol{\gamma}
  \vdash H} \id_{\rho [\ol{\alpha := B}] [\ol{\gamma := C}]} [\phi :=
  \lambda \ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F}
  \id_{\rho [\ol{\beta := A}]} [\ol{\gamma := g}]] \\
= & T^{\set}_{H,\rho [\ol{\gamma := C'}]} (\lambda
\ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho
   [\ol{\beta := A}] [\ol{\gamma := C'}]) \ol{f} \\
&\hspace{3em} \circ \big( T^{\set}_{H,\id_{\rho}[\ol{\gamma := g}]}
   (\lambda \ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F}
   \rho [\ol{\beta := A}] [\ol{\gamma := C'}]) \big)_{\ol{B}} \\
&\hspace{3em} \circ \big( T^{\set}_{H,\rho [\ol{\gamma := C}]} (\lambda
   \ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \id_{\rho
     [\ol{\beta := A}]} [\ol{\gamma := g}]) \big)_{\ol{B}}
\end{array}\]
So if $\eta$ is a natural transformation such that $\eta_{\ol B, \ol
  C}$ has type
\[
%\lambda \ol{B}\,\ol{C}.
\setsem{\Gamma; \ol{\alpha},
  \ol{\gamma} \vdash H[\phi := F][\ol{\alpha := \beta}]}\rho
[\ol{\beta := B}] [\ol{\gamma := C}]
%\]          to \[
\to
%\lambda \ol{B}\, \ol{C}.
\setsem{\Gamma; \ol{\beta},
   \ol{\gamma} \vdash F}\rho [\ol{\beta := B}] [\ol{\gamma := C}]\]
then, by naturality,
\[\begin{array}{ll}
 & \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \id_{\rho}
       [\ol{\beta := f}] [\ol{\gamma := g}] \circ \eta_{\ol{B},
         \ol{C}} \\ 
%= & \eta_{\ol{B'}, \ol{C'}} \circ \setsem{\Gamma; \ol{\alpha},
%  \ol{\gamma} \vdash H[\phi := F][\ol{\alpha := \beta}]} \id_{\rho}
%[\ol{\beta := f}] [\ol{\gamma := g}] \\ 
= & \eta_{\ol{B'}, \ol{C'}} \circ T^{\set}_{\rho [\ol{\gamma := C'}]}
(\lambda \ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F}
\rho [\ol{\beta := A}] [\ol{\gamma := C'}]) \ol{f} \\
& \circ \big( T^{\set}_{H,\id_{\rho}[\ol{\gamma := g}]} (\lambda
\ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho
   [\ol{\beta := A}] [\ol{\gamma := C'}]) \big)_{\ol{B}} \\
& \circ \big( T^{\set}_{\rho [\ol{\gamma := C}]} (\lambda
   \ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \id_{\rho
     [\ol{\beta := A}]} [\ol{\gamma := g}]) \big)_{\ol{B}}
\end{array}\]
As a special case when $\ol{f = \id_B}$ we have
%\[\begin{array}{ll}
% & \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \id_{\rho [\ol{\beta
%      := B}]} [\ol{\gamma := g}] \circ \eta_{\ol{B}, \ol{C}}\\
%& = \eta_{\ol{B}, \ol{C'}} \circ \big(
%T^{\set}_{H,\id_{\rho}[\ol{\gamma := g}]} (\lambda
%\ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho
%   [\ol{\beta := A}] [\ol{\gamma := C'}]) \big)_{\ol{B}} \\
%& \hspace*{0.32in} \circ \big(
%   T^{\set}_{\rho [\ol{\gamma := C}]} (\lambda \ol{A}. \setsem{\Gamma;
%     \ol{\beta}, \ol{\gamma} \vdash F} \id_{\rho [\ol{\beta := A}]}
%   [\ol{\gamma := g}]) \big)_{\ol{B}}
%\end{array}\]
%i.e., 
\begin{equation}\label{eq:T-sigma-functor}
\begin{split}
  & \lambda \ol{B}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F}
\id_{\rho [\ol{\beta := B}]} [\ol{\gamma := g}] \circ \lambda
\ol{B}.\eta_{\ol{B}, \ol{C}} \\  
=\;\;\; & \lambda \ol{B}.\eta_{\ol{B}, \ol{C'}} \circ
\sigma^{\set}_{\id_{\rho}[\ol{\gamma := g}]} (\lambda
\ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho
   [\ol{\beta := A}] [\ol{\gamma := C'}]) \\
 & \hspace*{0.5in} \circ
   T^{\set}_{\rho [\ol{\gamma := C}]} (\lambda \ol{A}. \setsem{\Gamma;
     \ol{\beta}, \ol{\gamma} \vdash F} \id_{\rho [\ol{\beta := A}]}
   [\ol{\gamma := g}]) 
\end{split}
\end{equation}
Finally, to see that the top diagram in the diagram on
page~\pageref{page:dia1} commutes we first note that functoriality of
$T^{\set}_{H,\rho [\ol{\gamma := C}]}$, naturality of
$T^{\set}_{H,\id_{\rho}[\ol{\gamma := g}]}$, the universal property of
$\fold_{T^{\set}_{H,\rho [\ol{\gamma := C'}]}} (\lambda
\ol{A}. \eta_{\ol{A}, \ol{C'}})$ and Equation~\ref{eq:mu-sigma-def}
ensure that the following diagram commutes: {\footnotesize
\begin{equation}\label{eq:one-side}
  \begin{tikzcd}[column sep = huge, row sep = huge]
T^{\set}_{H,\rho [\ol{\gamma := C}]} (\mu T^{\set}_{H,\rho [\ol{\gamma :=
      C}]}) \ar[rr, "{T^{\set}_{H,\rho [\ol{\gamma := C}]} (
    \fold_{T^{\set}_{H,\rho [\ol{\gamma := C'}]}} (\lambda
    \ol{A}. \eta_{\ol{A}, \ol{C'}}) \circ \mu
    T^{\set}_{H,\id_{\rho}[\ol{\gamma := g}]} )}"] \ar[dd,
  "{\tin_{T^{\set}_{H,\rho [\ol{\gamma := C}]}}}"']
&& T^{\set}_{H,\rho [\ol{\gamma := C}]} (\lambda \ol{B}. \setsem{\Gamma;
  \ol{\beta}, \ol{\gamma} \vdash F} \rho [\ol{\beta := B}] [\ol{\gamma
    := C'}]) \ar[d, "{ T^{\set}_{H,\id_{\rho}[\ol{\gamma := g}]}
    (\lambda \ol{B}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F}
    \rho [\ol{\beta := B}] [\ol{\gamma := C'}]) }" description] \\
&& T^{\set}_{H,\rho [\ol{\gamma := C'}]} (\lambda
\ol{B}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho
   [\ol{\beta := B}][\ol{\gamma := C'}]) \ar[d, "{ \lambda \ol{A}. \eta_{\ol{A}, \ol{C'}}
     }" description] \\
\mu T^{\set}_{H,\rho [\ol{\gamma := C}]}\ar[r, "{\mu
    T^{\set}_{H,\id_{\rho}[\ol{\gamma := g}]}}"'] 
&\mu T^{\set}_{H,\rho [\ol{\gamma := C'}]} \ar[r,
  "{\fold_{T^{\set}_{H,\rho [\ol{\gamma := C'}]}} (\lambda
    \ol{A}. \eta_{\ol{A}, \ol{C'}})}"']
& \lambda \ol{B}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F}
\rho [\ol{\beta := B}] [\ol{\gamma := C'}]
  \end{tikzcd}
  \end{equation}}
%commutes
\begin{comment}
because
\[\begin{array}{ll}
& \lambda \ol{A}. \eta_{\ol{A}, \ol{C'}} \circ
\sigma^{\set}_{\id_{\rho}[\ol{\gamma := g}]} (\lambda
\ol{B}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho
   [\ol{\beta := B}] [\ol{\gamma := C'}])\\
& \hspace{3.6em}   \circ T^{\set}_{\rho
     [\ol{\gamma := C}]} ( \fold_{T^{\set}_{\rho [\ol{\gamma := C'}]}}
   (\lambda \ol{A}. \eta_{\ol{A}, \ol{C'}}) \circ \mu
   \sigma^{\set}_{\id_{\rho}[\ol{\gamma := g}]} ) \\
= & \lambda \ol{A}. \eta_{\ol{A}, \ol{C'}} \circ
\sigma^{\set}_{\id_{\rho}[\ol{\gamma := g}]} (\lambda
\ol{B}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho
   [\ol{\beta := B}] [\ol{\gamma := C'}]) \\
&\hspace{3.6em} \circ T^{\set}_{\rho [\ol{\gamma := C}]} (
   \fold_{T^{\set}_{\rho [\ol{\gamma := C'}]}} (\lambda
   \ol{A}. \eta_{\ol{A}, \ol{C'}}) ) \circ T^{\set}_{\rho [\ol{\gamma
         := C}]} ( \mu \sigma^{\set}_{\id_{\rho}[\ol{\gamma := g}]} )  \\
= & \lambda \ol{A}. \eta_{\ol{A}, \ol{C'}} \circ T^{\set}_{\rho
     [\ol{\gamma := C'}]} ( \fold_{T^{\set}_{\rho [\ol{\gamma :=
           C'}]}} (\lambda \ol{A}. \eta_{\ol{A}, \ol{C'}}) ) \circ
   \sigma^{\set}_{\id_{\rho}[\ol{\gamma := g}]} (\mu T^{\set}_{\rho
     [\ol{\gamma := C'}]}) \circ T^{\set}_{\rho [\ol{\gamma := C}]} (
   \mu \sigma^{\set}_{\id_{\rho}[\ol{\gamma := g}]} ) \\
= & \fold_{T^{\set}_{\rho [\ol{\gamma := C'}]}} (\lambda
\ol{A}. \eta_{\ol{A}, \ol{C'}}) \circ \tin_{T^{\set}_{\rho [\ol{\gamma
        := C'}]}} \circ \sigma^{\set}_{\id_{\rho}[\ol{\gamma := g}]}
(\mu T^{\set}_{\rho [\ol{\gamma := C'}]}) \circ T^{\set}_{\rho
  [\ol{\gamma := C}]} ( \mu \sigma^{\set}_{\id_{\rho}[\ol{\gamma :=
      g}]} ) \\
= &\fold_{T^{\set}_{\rho [\ol{\gamma := C'}]}} (\lambda
\ol{A}. \eta_{\ol{A}, \ol{C'}}) \circ \mu
\sigma^{\set}_{\id_{\rho}[\ol{\gamma := g}]} \circ
\tin_{T^{\set}_{\rho [\ol{\gamma := C}]}}
\end{array}\]
Here, the first equality is by functoriality of $T^{\set}_{\rho
  [\ol{\gamma := C}]}$, the second equality is by naturality of
$\sigma^{\set}_{\id_{\rho}[\ol{\gamma := g}]}$, the third equality by
the universal property of $\fold_{T^{\set}_{\rho [\ol{\gamma := C'}]}}
(\lambda \ol{A}. \eta_{\ol{A}, \ol{C'}})$ and the last equality by
Equation~\ref{eq:mu-sigma-def}.
\end{comment}
%That is, we have
%\begin{equation}\label{eq:one-side}
%\begin{split}
% & \fold_{T^{\set}_{\rho [\ol{\gamma := C'}]}} (\lambda
%\ol{A}. \eta_{\ol{A}, \ol{C'}}) \circ \mu
%\sigma^{\set}_{\id_{\rho}[\ol{\gamma := g}]}\\
%=\;\;\; & \fold_{T^{\set}_{\rho [\ol{\gamma := C}]}} ( \lambda
%\ol{A}. \eta_{\ol{A}, \ol{C'}} \circ
%\sigma^{\set}_{\id_{\rho}[\ol{\gamma := g}]} (\lambda
%\ol{B}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho
%   [\ol{\beta := B}] [\ol{\gamma := C'}]) )
%\end{split}
%\end{equation}
Next, we note that functoriality of $T^{\set}_{H,\rho [\ol{\gamma :=
      C}]}$, Equation~\ref{eq:T-sigma-functor}, and the universal
property of $\fold_{T^{\set}_{H,\rho [\ol{\gamma := C}]}} (\lambda
\ol{A}. \eta_{\ol{A}, \ol{C}})$ ensure that the following diagram
commutes: {\footnotesize
\begin{equation}\label{eq:other-side}
\begin{tikzcd}[row sep = huge]
T^{\set}_{\rho [\ol{\gamma := C}]} (\mu T^{\set}_{\rho [\ol{\gamma :=
      C}]}) \ar[rr, "{T^{\set}_{\rho [\ol{\gamma := C}]} (
    \lambda \ol{B}.\setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \id_{\rho
      [\ol{\beta := B}]} [\ol{\gamma := g}] \circ
    \fold_{T^{\set}_{\rho [\ol{\gamma := C}]}} (\lambda
    \ol{A}. \eta_{\ol{A}, \ol{C}}) )}"] \ar[dd, "{\tin_{T^{\set}_{\rho
        [\ol{\gamma := C}]}}}"']
&& T^{\set}_{\rho [\ol{\gamma := C}]} (\lambda \ol{B}.\setsem{\Gamma; \ol{\beta},
  \ol{\gamma} \vdash F} \rho [\ol{\beta := B}] [\ol{\gamma := C'}])
\ar[d, "{ \sigma^{\set}_{\id_{\rho}[\ol{\gamma := g}]}
    (\lambda \ol{B}.\setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho [\ol{\beta
        := B}] [\ol{\gamma := C'}]) }" description]\\
&& T^{\set}_{\rho [\ol{\gamma := C'}]} (\lambda \ol{B}.\setsem{\Gamma; \ol{\beta},
  \ol{\gamma} \vdash F} \rho [\ol{\beta := B}][\ol{\gamma := C'}]) \ar[d, "{ \lambda
    \ol{A}. \eta_{\ol{A}, \ol{C'}} }" description] \\
\mu T^{\set}_{\rho [\ol{\gamma := C}]} \ar[r, bend right = 10,
  "{\fold_{T^{\set}_{\rho [\ol{\gamma := C}]}} (\lambda
    \ol{A}. \eta_{\ol{A}, \ol{C}})}"'] & \lambda \ol{B}.\setsem{\Gamma; \ol{\beta},
  \ol{\gamma} \vdash F} \rho [\ol{\beta := B}] [\ol{\gamma := C}]
\ar[r, bend right = 10, "{\lambda \ol{B}.\setsem{\Gamma; \ol{\beta}, \ol{\gamma}
      \vdash F} \id_{\rho [\ol{\beta := B}]} [\ol{\gamma := g}]}"'] &
\lambda \ol{B}.\setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho [\ol{\beta :=
    B}] [\ol{\gamma := C'}]
\end{tikzcd}
\end{equation}}
%commutes because
%\begin{align*}
%& \lambda \ol{A}. \eta_{\ol{A}, \ol{C'}} \circ
%  \sigma^{\set}_{\id_{\rho}[\ol{\gamma := g}]} (\lambda
%  \ol{B}.\setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho
%     [\ol{\beta := B}] [\ol{\gamma := C'}]) \\
%&\hspace{3em} \circ T^{\set}_{\rho [\ol{\gamma := C}]} ( \lambda
%     \ol{B}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F}
%     \id_{\rho [\ol{\beta := B}]} [\ol{\gamma := g}] \circ
%     \fold_{T^{\set}_{\rho [\ol{\gamma := C}]}} (\lambda
%     \ol{A}. \eta_{\ol{A}, \ol{C}}) ) \\
%&= \lambda \ol{A}. \eta_{\ol{A}, \ol{C'}} \circ
%     \sigma^{\set}_{\id_{\rho}[\ol{\gamma := g}]} (\lambda
%     \ol{B}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho
%        [\ol{\beta := B}] [\ol{\gamma := C'}]) \\
%&\hspace{3em} \circ T^{\set}_{\rho [\ol{\gamma := C}]} ( \lambda
%        \ol{B}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F}
%        \id_{\rho [\ol{\beta := B}]} [\ol{\gamma := g}] ) \circ
%        T^{\set}_{\rho [\ol{\gamma := C}]} ( \fold_{T^{\set}_{\rho
%            [\ol{\gamma := C}]}} (\lambda \ol{A}. \eta_{\ol{A},
%          \ol{C}}) ) \\
% &= \lambda \ol{B}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F}
%        \id_{\rho [\ol{\beta := B}]} [\ol{\gamma := g}] \circ \lambda
%        \ol{A}. \eta_{\ol{A}, \ol{C}} \circ T^{\set}_{\rho [\ol{\gamma
%              := C}]} ( \fold_{T^{\set}_{\rho [\ol{\gamma := C}]}}
%        (\lambda \ol{A}. \eta_{\ol{A}, \ol{C}}) ) \\
%&= \lambda \ol{B}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F}
%        \id_{\rho [\ol{\beta := B}]} [\ol{\gamma := g}] \circ
%        \fold_{T^{\set}_{\rho [\ol{\gamma := C}]}} (\lambda
%        \ol{A}. \eta_{\ol{A}, \ol{C}}) \circ \tin_{T^{\set}_{\rho
%            [\ol{\gamma := C}]}}
%\end{align*}
%Here, the first equality is by functoriality of $T^{\set}_{\rho
%  [\ol{\gamma := C}]}$, the second equality is by
%Equation~\ref{eq:T-sigma-functor}, and the last equality is by the
%universal property of $\fold_{T^{\set}_{\rho [\ol{\gamma := C}]}}
%(\lambda \ol{A}. \eta_{\ol{A}, \ol{C}})$. That is, we have
%\begin{equation}\label{eq:other-side}
%\begin{split}
%  & \lambda \ol{B}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F}
%\id_{\rho [\ol{\beta := B}]} [\ol{\gamma := g}] \circ
%\fold_{T^{\set}_{\rho [\ol{\gamma := C}]}} (\lambda
%\ol{A}. \eta_{\ol{A}, \ol{C}}) \\ 
%= \;\;\;& \fold_{T^{\set}_{\rho [\ol{\gamma := C}]}} (\lambda
%\ol{A}. \eta_{\ol{A}, \ol{C'}} \circ
%\sigma^{\set}_{\id_{\rho}[\ol{\gamma := g}]} (\lambda
%\ol{B}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho
%   [\ol{\beta := B}] [\ol{\gamma := C'}]) ) 
%\end{split}
%\end{equation}
Combining the equations entailed by~\ref{eq:one-side}
and~\ref{eq:other-side}, we get that
%\[\fold_{T^{\set}_{\rho [\ol{\gamma := C'}]}} (\lambda \ol{A}. \eta_{\ol{A}, \ol{C'}})
%  \circ \mu \sigma^{\set}_{\id_{\rho}[\ol{\gamma := g}]} = \lambda
%  \ol{B}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \id_{\rho
%    [\ol{\beta := B}]} [\ol{\gamma := g}] \circ \fold_{T^{\set}_{\rho
%      [\ol{\gamma := C}]}} (\lambda \ol{A}. \eta_{\ol{A}, \ol{C}})\]
%  i.e., that
the top diagram in the diagram on
  page~\pageref{page:dia1} commutes, as desired.
%We therefore have that
%\[(\setsem{\Gamma; \emptyset~|~\emptyset
%  \vdash \fold^F_H : \Nat^\emptyset\;(\Nat^{\ol{\beta},
%    \ol{\gamma}}\,H[\phi :=_{\ol{\beta}} F][\ol{\alpha :=
%      \beta}]\,F)\; (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu
%  \phi.\lambda \overline \alpha.H)\overline
%  \beta\,F}\,\rho\,d\,\eta)_{\ol{B}\,\ol{C}}\] is natural in $\ol{B}$
%and $\ol{C}$ as desired.
To see that, for all $\rho : \setenv$, $d \in
\setsem{\Gamma; \emptyset \vdash \emptyset}\rho$, and $\eta :
\setsem{\Gamma; \emptyset \vdash \Nat^{\ol{\beta},
    \ol{\gamma}}\,H[\phi :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F}
\rho$,
\[\setsem{\Gamma; \emptyset~|~\emptyset
  \vdash \fold^F_H : \Nat^\emptyset\;(\Nat^{\ol{\beta},
    \ol{\gamma}}\,H[\phi :=_{\ol{\beta}} F][\ol{\alpha :=
      \beta}]\,F)\; (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu
  \phi.\lambda \overline \alpha.H)\overline \beta\,F}\,\rho\,d\,\eta\]
%\[\setsem{\Gamma;\emptyset \,|\, \Delta \vdash \fold^F_H\, t :
%    \Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
%    \alpha.H)\overline \beta\;F}\,\rho\,d\]
satisfies the additional condition needed for it to be in
$\setsem{\Gamma;\emptyset \vdash \Nat^{{\ol{\beta},\ol{\gamma}}
  }\,(\mu \phi.\lambda \overline \alpha.H)\overline \beta\;F}\,\rho$,
let $\ol{R : \rel(B,B')}$ and $\ol{S : \rel(C,C')}$.  Since $\eta$
satisfies the additional condition needed for it to be in
$\setsem{\Gamma; \emptyset \vdash \Nat^{\ol{\beta},
    \ol{\gamma}}\,(H[\phi := F][\ol{\alpha := \beta}])\,F} \rho$,
%--- i.e., since 
%\[\begin{array}{lll}
% (\eta_{\ol{B}\,\ol{C}}\,,
%\eta_{\ol{B'}\,\ol{C'}}) & \in & 
%\relsem{\Gamma;\ol{\gamma},\ol{\beta} \vdash H[\phi := F][\ol{\alpha
%      := \beta}]}\Eq_\rho[\ol{\gamma := S}][\ol{\beta := R}] \to\\
% &  & \hspace*{1in}
%\relsem{\Gamma;\ol{\gamma},\ol{\beta} \vdash F}\Eq_\rho[\ol{\gamma
%    := S}][\ol{\beta := R}]\\
%& = & T_{\Eq_\rho[\ol{\gamma := S}]}\;
%(\relsem{\Gamma;\ol{\gamma},\ol{\beta} \vdash F}\Eq_\rho[\ol{\gamma :=
%    S}][\ol{\beta := R}]) \to\\ 
%&  & \hspace*{1in}
%\relsem{\Gamma;\ol{\gamma},\ol{\beta} \vdash F}\Eq_\rho[\ol{\gamma
%    := S}][\ol{\beta := R}]
%\end{array}\]
%---
\[\begin{array}{ll}
 & (\,(\mathit{fold}_{T^\set_{H,\rho[\ol{\gamma :=
        C}]}}\,(\lambda \ol{A}.\,\eta_{\ol{A}\,\ol{C}}))_{\ol{B}},\,
(\mathit{fold}_{T^\set_{H,\rho[\ol{\gamma :=
        C'}]}}\,(\lambda \ol{A}.\eta_{\ol{A}\,\ol{C'}}))_{\ol{B'}}\,) 
\end{array}\]
has type
\[\begin{array}{ll}
  & (\mu T_{H,\Eq_\rho[\ol{\gamma := S}]}) \,\ol{R} \to
\relsem{\Gamma;\ol{\gamma},\ol{\beta} \vdash F}\Eq_\rho[\ol{\gamma := 
    S}][\ol{\beta:= R}]\\ 
= & (\mu T_{H,\Eq_\rho[\ol{\gamma :=
      S}]})\,\ol{\relsem{\Gamma;\ol{\gamma},\ol{\beta} 
  \vdash \beta}\Eq_\rho[\ol{\gamma := S}][\ol{\beta := R}]} \to
\relsem{\Gamma;\ol{\gamma},\ol{\beta} \vdash F}\Eq_\rho[\ol{\gamma := 
    S}][\ol{\beta:= R}]\\ 
= & \relsem{\Gamma; \ol{\gamma},\ol{\beta} \vdash (\mu \phi. \lambda
  \ol{\alpha}. H)\ol{\beta}}\Eq_\rho[\ol{\gamma := S}][\ol{\beta := R}] \to
\relsem{\Gamma;\ol{\gamma},\ol{\beta} \vdash F}\Eq_\rho[\ol{\gamma := 
    S}][\ol{\beta:= R}]
\end{array}\]
\begin{comment}
\item The proofs that
\[\relsem{\Gamma; \emptyset~|~\emptyset \vdash
  \fold^F_H : \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta\,F)}\] is a natural transformation from
  $\relsem{\Gamma;\emptyset \vdash \emptyset}$ to
  \[\relsem{\Gamma ; \emptyset \vdash
    \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi 
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
    (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
    \alpha.H)\overline \beta\,F)}\] and that, for all $\rho : \relenv$
  and the unique $d : \relsem{\Gamma;\emptyset \vdash \emptyset}\rho$,
\[\relsem{\Gamma; \emptyset~|~\emptyset \vdash
  \fold^F_H : \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta\,F)}\,\rho\,d\] is a morphism from
$\relsem{\Gamma; \emptyset \vdash \Nat^{\ol{\beta},
    \ol{\gamma}}\,H[\phi :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)}
\rho$ to $\relsem{\Gamma; \emptyset \vdash
  \Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta\,F}\rho$, are analogous.
\item Finally, to see that
\[\begin{array}{ll}
& \pi_i(\relsem{\Gamma; \emptyset~|~\emptyset \vdash
  \fold^F_H : \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta\,F)} \rho)\\
= & \setsem{\Gamma; \emptyset~|~\emptyset \vdash
  \fold^F_H : \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta\,F)}(\pi_i\rho)
\end{array}\]
we compute
\[\begin{array}{ll}
 & \pi_i(\relsem{\Gamma; \emptyset~|~\emptyset \vdash
  \fold^F_H : \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta\,F)})\\
=& \pi_i (\lambda
e\,\eta\,\ol{R}\,\ol{S}.\,(\mathit{fold}_{T_{\rho[\ol{\gamma 
        := S}]}}\,(\lambda \ol{Z}.\,\eta_{\ol{Z}\,\ol{S}}))_{\ol{R}})\\
=& \lambda
e\,\eta\,\ol{R}\,\ol{S}.\,(\mathit{fold}_{T_{(\pi_i\rho)[\ol{\gamma 
        := \pi_i S}]}}\,(\lambda \ol{Z}.\, (\pi_i
\eta)_{\ol{\pi_iZ}\,\ol{\pi_iS}}))_{\ol{\pi_i R}}\\ 
=& \lambda
d\,\eta\,\ol{B}\,\ol{C}.\,(\mathit{fold}_{T_{(\pi_i\rho)[\ol{\gamma 
        := C}]}} \,(\lambda \ol{A}.\eta_{\ol{A}\,\ol{C}}))_{\ol{B}}\\
=& \relsem{\Gamma; \emptyset~|~\emptyset \vdash
  \fold^F_H : \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta\,F)}(\pi_i \rho)\\

\end{array}\]
Here, we are again using the fact that $\pi_1$ and $\pi_2$ are
surjective. 
\end{comment}
%\end{itemize}  
\end{itemize}
\end{proof}

The following theorem is an immediate consequence of
Theorem~\ref{thm:at-gen}:
\begin{thm}\label{thm:at-gen-rel}
If \,$\Gamma; \Phi \,|\, \Delta \vdash t : \tau$ and \,$\rho \in \relenv$,
  and if \,$(a, b) \in \relsem{\Gamma; \Phi \vdash \Delta} \rho$,
  then \\
  $(\setsem{\Gamma; \Phi \,|\, \Delta \vdash t : \tau} (\pi_1 \rho) \,a \, ,
      \setsem{\Gamma; \Phi \,|\, \Delta \vdash t : \tau } (\pi_2 \rho) \,b) \in 
    \relsem{\Gamma; \Phi \vdash \tau} \rho$
\end{thm}
\noindent
Finally, the Abstraction Theorem is the instantiation of
Theorem~\ref{thm:at-gen-rel} to closed terms of closed type:
\begin{thm}\label{thm:abstraction}
If $\vdash t : \tau$, then $(\setsem{\vdash t : \tau},\setsem{\vdash t
  : \tau}) \in \relsem{\vdash \tau}$.
\end{thm}

\section{Free Theorems for Nested Types}\label{sec:ftnt}

\subsection{Free Theorem for Type of Polymorphic
  Bottom}\label{sec:bottom} 

Suppose $ \vdash g : \Nat^\alpha \,\onet\,\alpha$, let $G^\set =
\setsem{\vdash g : \Nat^\alpha \,\onet\,\alpha}$, and let $G^\rel =
\relsem{\vdash g : \Nat^\alpha \,\onet\,\alpha}$.  By
Theorem~\ref{thm:abstraction}, $(G^\set(\pi_1\rho),G^\set(\pi_2\rho))
= G^\rel\rho$. Thus, for all $\rho \in \relenv$ and any $(a, b) \in
\relsem{\vdash \emptyset}\rho = 1$, eliding the only possible
instantiations of $a$ and $b$ gives that
%\[\begin{array}{lll}
$(G^\set,G^\set) \;= \; (G^\set(\pi_1 \rho), G^\set (\pi_2 \rho))$
$ \in  \relsem{\vdash \Nat^\alpha \,\onet\,\alpha}\rho$
$ =  \{\eta : K_1 \Rightarrow \id\}$
$ =  \{(\eta_1 : K_1 \Rightarrow \id, \eta_2 : K_1 \Rightarrow
\id)\}$ 
%\end{array}\]
That is, $G^\set$ is a natural transformation from the constantly
$1$-valued functor to the identity functor in $\set$. In particular,
for every $S : \set$, $G^\set_S : 1 \to S$. Note, however, that if $S
= \emptyset$, then there can be no such morphism, so no such natural
transformation can exist,
%in $\set$,
and thus no term $\vdash g : \Nat^\alpha \onet \,\alpha$ can exist.
%in our calculus.
That is, our calculus does not admit any terms with the closed type
$\Nat^\alpha \onet \,\alpha$ of the polymorphic bottom.

\subsection{Free Theorem for Type of Polymorphic
  Identity}\label{sec:identity} 

Suppose $ \vdash g : \Nat^\alpha \,\alpha\,\alpha$, let $G^\set =
\setsem{\vdash g : \Nat^\alpha \,\alpha\,\alpha}$, and let $G^\rel =
\relsem{\vdash g : \Nat^\alpha \,\alpha\,\alpha}$.  By
Theorem~\ref{thm:abstraction}, $(G^\set(\pi_1\rho),G^\set(\pi_2\rho))
= G^\rel\rho$. Thus, for all $\rho \in \relenv$ and any $(a, b) \in
\relsem{\vdash \emptyset}\rho = 1$, eliding the only possible
instantiations of $a$ and $b$ gives that
%\[\begin{array}{lll}
$(G^\set, G^\set) \; = \; (G^\set(\pi_1 \rho), G^\set (\pi_2 \rho))$
$ \in \relsem{\vdash \Nat^\alpha \,\alpha\,\alpha}\rho$
$ =  \{\eta : \id \Rightarrow \id\}$
$ =  \{(\eta_1 : \id \Rightarrow \id, \eta_2 : \id \Rightarrow
\id)\}$
%\end{array}\]
That is, $G^\set$ is a natural transformation from the identity
functor on $\set$ to itself. Now let $S$ be any set.  If $S =
\emptyset$, then there is exactly one morphism $\id_S: S \to S$, so
$G^\set_S : S \to S$ must be $\id_S$. If $S \not = \emptyset$, then if
$a$ is any element of $S$ and $K_a :S \to S$ is the constantly
$a$-valued morphism on $S$, then instantiating the naturality square
implied by the above equality gives that $G^\set_S \circ K_a = K_a
\circ G^\set_S$, i.e., $G^\set_S \, a = a$, i.e., $G^\set_S = \id_S$.
Putting these two cases together we have that for every $S : \set$,
$G^\set_S = \id_S$, i.e., $G^\set$ is the identity natural
transformation for the identity functor on $\set$. So every closed
term $g$ of closed type $\Nat^\alpha\alpha\,\alpha$ always denotes the
identity natural transformation for the identity functor on $\set$,
i.e., every closed term $g$ of type $\Nat^\alpha\alpha\,\alpha$
denotes the polymorphic identity function.

\subsection{Standard Free Theorems for ADTs and Their Analogues for
  Nested types}\label{sec:ft-adt}

We can derive in our system even those free theorems for polymorphic
functions over ADTs that are not consequences of naturality.  We can,
e.g., prove the free theorem for $\mathit{filter}$'s type as follows:

%\begin{lemma}\label{lem:list-graph}
%If $g : A \to B$, $\rho : \relenv$, and $\rho\alpha = (A, B,
%\graph{g})$, then $\relsem{\alpha; \emptyset \vdash List \, \alpha}
%\rho = \graph{map_{\mathit{List}} \, g}$.
%\end{lemma}
%\begin{proof}
%The result follows by straightforward calculation using
%Definition~\ref{def:rel-sem} and Equation~\ref{eq:mu}, together with
%the facts that $\mathit{List} \,(A, B, \graph{g}) =
%\graph{\mathit{map}_{\mathit{List}} \,g}$ and, if $H = \onet + \beta
%\times\phi \beta$ {\color{blue} Why not $H = \onet + \alpha \times
%  \beta$? Does it matter?}, then $(T_{H,\rho}^n K_0)^* R =
%\Sigma_{i=0}^n R^i$ for all $n \in \nat$ and $R \in \rel$ by induction
%on $n$.
%\end{proof}

\begin{thm} 
If $g : A \to B$, $\rho : \relenv$, $\rho \alpha = (A, B, \graph{g})$,
$(a, b) \in \relsem{\alpha ;\emptyset \vdash \Delta} \rho$, $(s \circ
g, s) \in \relsem{\alpha; \emptyset \vdash \Nat^\emptyset \alpha \,
  \mathit{Bool}} \rho$, and % for $s : A \to \mathit{Bool}$, and
%$\alpha; \emptyset \,|\, \Delta \vdash t :
%\filtype$, if
$\mathit{filter} = \setsem{\alpha; \emptyset \,|\, \Delta \vdash t :
  \filtype}$ for some $t$, then
\[  \mathit{map}_{\mathit{List}} \,g \circ \mathit{filter} \, (\pi_1
\rho) \, a \, (s \circ g) = \mathit{filter}\, (\pi_2\rho) \, b \, s
\circ \mathit{map}_{\mathit{List}} \,g\]
\end{thm}
\begin{proof}
By Theorem~\ref{thm:at-gen-rel}, \[(\mathit{filter}\, (\pi_1 \rho)\, a,
\mathit{filter}\, (\pi_2 \rho)\, b) \in \relsem{\alpha; \emptyset
  \vdash \filtype} \rho\] so if $(s, s') \in \relsem{\alpha; \emptyset
  \vdash \Nat^\emptyset \alpha \, \mathit{Bool}} \rho = \rho\alpha \to
\Eq_{\mathit{Bool}}$ and $(xs, xs') \in \relsem{\alpha; \emptyset
  \vdash List \, \alpha} \rho$ then
% then
%  \begin{align*}
%    (t (\pi_1 \rho) \,a \,s, t (\pi_2 \rho) \,b \,s') &\in \relsem{\alpha; \emptys%et \vdash \Nat^\emptyset (List \, \alpha) \, (List \, \alpha)} \rho \\
%   &= \relsem{\alpha; \emptyset \vdash List \, \alpha} \rho \to \relsem{\alpha; \e%mptyset \vdash List \, \alpha} \rho \\
%  \end{align*}
%  So if $(xs, xs') \in \relsem{\alpha; \emptyset \vdash List \, \alpha} \rho$ then,
\begin{equation}\label{eq:filter-thm-list}
  (\mathit{filter}\, (\pi_1\rho) \,a \,s \,xs, \mathit{filter} \,
  (\pi_2\rho) \,b \,s' \,xs') \in \relsem{\alpha; \emptyset \vdash
    \mathit{List} \, \alpha} \rho
\end{equation}
If $\rho\alpha = (A, B, \graph{g})$, then $\relsem{\alpha; \emptyset
  \vdash \mathit{List} \, \alpha} \rho =
\graph{\mathit{map}_{\mathit{List}} \, g}$ by Lemma~\ref{lem:graph}
and Equation~\ref{thm:demotion-objects}.  Moreover, $xs' =
\mathit{map}_{\mathit{List}} \,g \,xs$ and $(s', s) \in \graph{g} \to
\Eq_{\mathit{Bool}}$, so $s' = s \circ g$. Instantiating
Equation~\ref{eq:filter-thm-list} thus gives the desired result.
% \begin{align*}
%    &(t (\pi_1\rho) \,a \,(s' \circ g) \,xs, t (\pi_2\rho) \,b \,s' \,(\mathit{map%}_{\mathit{List}} \,g \,xs)) \in \graph{\mathit{map}_{\mathit{List}} \,g}, \\ 
%    & i.e., \\ 
%    &\mathit{map}_{\mathit{List}} \,g \, (t (\pi_1\rho) \,a \,(s' \circ g) \,xs) =% t (\pi_2\rho) \,b \,s' \,(\mathit{map}_{\mathit{List}} \,g \,xs), \\ 
%    & i.e., \\
%    &\mathit{map}_{\mathit{List}} \,g \circ t (\pi_1 \rho) \, a \, (s' \circ g) = %t (\pi_2\rho) \, b \, s' \circ \mathit{map}_{\mathit{List}} \,g
%  \end{align*}
%  as desired.
\end{proof}

\begin{comment}
\begin{thm}\label{thm:at-gen-rel}
If \,$\Gamma; \Phi \,|\, \Delta \vdash t : \tau$ and \,$\rho \in \relenv$,
  and if \,$(a, b) \in \relsem{\Gamma; \Phi \vdash \Delta} \rho$,
  then \\
  $(\setsem{\Gamma; \Phi \,|\, \Delta \vdash t : \tau} (\pi_1 \rho) \,a \, ,
      \setsem{\Gamma; \Phi \,|\, \Delta \vdash t : \tau } (\pi_2 \rho) \,b) \in 
    \relsem{\Gamma; \Phi \vdash \tau} \rho$
\end{thm}
\begin{proof}
 Immediate from Theorem~\ref{thm:at-gen}.
\end{proof}
\end{comment}

\begin{comment}
\begin{thm} 
  If $g : A \to B$, 
  $\rho : \relenv$, 
  $\rho \alpha = (A, B, \graph{g})$,
  $(a, b) \in \relsem{\alpha ;\emptyset \vdash \Delta} \rho$, 
  $(s \circ g, s) \in \relsem{\alpha; \emptyset \vdash \Nat^\emptyset \alpha \, \mathit{Bool}} \rho$,
  and, for some well-formed term $\mathit{filter}$, \\
  $$t = \setsem{\alpha; \emptyset \,|\, \Delta \vdash \mathit{filter} : \filtype} \emph{, then }$$
  \begin{align*}
  \mathit{map}_{\mathit{List}} \,g \circ t (\pi_1 \rho) \, a \, (s \circ g) = t (\pi_2\rho) \, b \, s \circ \mathit{map}_{\mathit{List}} \,g
  \end{align*}
\end{thm}
\begin{proof}
  By Theorem~\ref{thm:at-gen-rel},
  $(t (\pi_1 \rho) a, t (\pi_2 \rho) b) \in \relsem{\alpha; \emptyset \vdash \filtype} \rho$.
  Thus if 
  $(s, s') \in \relsem{\alpha; \emptyset \vdash \Nat^\emptyset \alpha \, \mathit{Bool}} \rho = \rho\alpha \to \Eq_{\mathit{Bool}}$,
  then 
  \begin{align*}
    (t (\pi_1 \rho) \,a \,s, t (\pi_2 \rho) \,b \,s') &\in \relsem{\alpha; \emptyset \vdash \Nat^\emptyset (List \, \alpha) \, (List \, \alpha)} \rho \\
   &= \relsem{\alpha; \emptyset \vdash List \, \alpha} \rho \to \relsem{\alpha; \emptyset \vdash List \, \alpha} \rho \\
  \end{align*}
  So if $(xs, xs') \in \relsem{\alpha; \emptyset \vdash List \, \alpha} \rho$ then,
  \begin{equation}\label{eq:filter-thm}
  (t (\pi_1\rho) \,a \,s \,xs, t (\pi_2\rho) \,b \,s' \,xs') \in \relsem{\alpha; \emptyset \vdash List \, \alpha} \rho
  \end{equation}

  Consider the case in which $\rho\alpha = (A, B, \graph{g})$. Then $\relsem{\alpha; \emptyset \vdash List \, \alpha} \rho
  = \graph{\mathit{map}_{\mathit{List}} \, g}$, by Lemma~\ref{lem:list-graph}, and $(xs, xs') \in \graph{\mathit{map}_{\mathit{List}} \,g}$ 
  implies $xs' = \mathit{map}_{\mathit{List}} \,g \,xs$. We also have that 
  $(s, s') \in \graph{g} \to \Eq_{\mathit{Bool}}$ implies 
  $\forall (x, g x) \in \graph{g}. \,\, s x = s' (g x)$ and thus
  $s = s' \circ g$ due to the definition of morphisms between relations.
  %% TODO show (s, s') \in <g> -> \mathit{Bool} implies s = s' \circ g %% 
  With these instantiations, Equation~\ref{eq:filter-thm} becomes
  \begin{align*}
    &(t (\pi_1\rho) \,a \,(s' \circ g) \,xs, t (\pi_2\rho) \,b \,s' \,(\mathit{map}_{\mathit{List}} \,g \,xs)) \in \graph{\mathit{map}_{\mathit{List}} \,g}, \\ 
    & i.e., \\ 
    &\mathit{map}_{\mathit{List}} \,g \, (t (\pi_1\rho) \,a \,(s' \circ g) \,xs) = t (\pi_2\rho) \,b \,s' \,(\mathit{map}_{\mathit{List}} \,g \,xs), \\ 
    & i.e., \\
    &\mathit{map}_{\mathit{List}} \,g \circ t (\pi_1 \rho) \, a \, (s' \circ g) = t (\pi_2\rho) \, b \, s' \circ \mathit{map}_{\mathit{List}} \,g
  \end{align*}
  as desired.
\end{proof}
\end{comment}

%\subsection{Free Theorem for Type of $\mathit{filter}$ for
%  $\GRose$}\label{sec:filter-grose} 

{\color{blue} But rose trees are essentially first-order. Not for
  perfect trees or bushes... Say more?}

A similar proof establishes the analogous result for, say, generalized
rose trees:
\begin{thm} 
  If $g : A \to B$,
$F, G : \set \to \set$,
  $\eta : F \to G$ in $\set$, $\rho : \relenv$, $\rho \alpha =
 (A, B, \graph{g})$, $\rho \psi = (F, G, \graph{\eta})$, $(a, b) \in
 \relsem{\alpha, \psi ;\emptyset \vdash \Delta} \rho$, $(s \circ
 g, s) \in \relsem{\alpha; \emptyset \vdash \Nat^\emptyset \alpha \,
   \mathit{Bool}} \rho$, and
 \[ \mathit{filter} = \setsem{\alpha, \psi; \emptyset \,|\, \Delta
      \vdash t : \filtypeGRose}  \]
for some $t$, then
\[ \semmap_{\mathit{GRose}}\, \eta\, (g + 1) \circ \mathit{filter} \,
(\pi_1 \rho) \, a \, (s \circ g) = \mathit{filter} \, (\pi_2\rho) \, b
\, s \circ 
\semmap_{\mathit{GRose}}\, \eta\, g\]
\end{thm}

\subsection{Short Cut Fusion for Lists}\label{sec:short-cut}

We can recover standard short cut fusion for lists~\cite{glp93} in our
system: 
\begin{thm}
If $\vdash \tau : \F$, $\vdash \tau' : \F$, and 
%$\beta; \emptyset \,|\, \emptyset \vdash g : \Nat^{\emptyset}
%(\Nat^{\emptyset} (\onet + \tau \times \beta)\, \beta)\, \beta$. 
%If
$G \, = \, \setsem{\beta; \emptyset \,|\, \emptyset \vdash g :
  \Nat^{\emptyset} (\Nat^{\emptyset} (\onet + \tau \times \beta)\,
  \beta)\, \beta}$ for some $g$, then
\[\textit{fold}_{1 + \tau \times \_}\, n\, c\; (G\; (\mathit{List}\,
\setsem{\vdash \tau})\,\mathit{nil} \,\mathit{cons}) = G \,\setsem{\vdash
  \tau'}\, n\, c \]
\end{thm}
\begin{proof}
%Let $\vdash \tau : \F$ and $\vdash \tau' : \F$, let
%\[\beta; \emptyset \,|\, \emptyset \vdash g : \Nat^{\emptyset}
%(\Nat^{\emptyset} (\onet + \tau \times \beta)\, \beta)\, \beta\]
%and let
%\[G = \setsem{\beta; \emptyset \,|\, \emptyset
%  \vdash g : \Nat^{\emptyset} (\Nat^{\emptyset} (\onet + \tau \times
  %  \beta)\, \beta)\, \beta}\] Then
Theorem~\ref{thm:abstraction} gives
that, for any $\rho : \relenv$,
%and any $(a, b) \in
%\relsem{\beta; \emptyset \vdash \emptyset}\rho = 1$, then (eliding the
%only possible instantiations of $a$ and $b$) we have
\[\begin{array}{lll}
(G \,(\pi_1 \rho), G\, (\pi_2 \rho))
 & \in & \relsem{\beta; \emptyset \vdash \Nat^{\emptyset} (\Nat^{\emptyset}
  (\onet + \tau \times \beta)\, \beta)\, \beta} \rho\\
& \cong& (((\relsem{\vdash \tau} \rho \times
\rho\beta) \to \rho\beta) \times \rho\beta) \to \rho\beta 
\end{array}\]
%Since
%\[\begin{array}{rl}
% & \relsem{\beta; \emptyset \vdash \Nat^{\emptyset}
%  (\Nat^{\emptyset} (\onet + \tau \times \beta)\, \beta)\, \beta} \rho\\  
%=& \relsem{\beta; \emptyset \vdash \Nat^{\emptyset} (\onet +
%  \tau \times \beta)\, \beta} \rho \to \rho\beta \\ 
%=& (\relsem{\beta; \emptyset \vdash \onet + \tau \times \beta}
%\rho \to \rho\beta) \to \rho\beta \\ 
%=& ((\onet + \relsem{\vdash \tau} \rho \times
%\rho\beta) \to \rho\beta) \to \rho\beta \\ 
%\cong& (((\relsem{\vdash \tau} \rho \times
%\rho\beta) \to \rho\beta) \times \rho\beta) \to \rho\beta 
%\end{array}\]
%we have that
so if $(c', c) \in \relsem{\vdash \tau} \rho \times
\rho\beta \to \rho\beta$ and $(n', n) \in \rho\beta$ then
$(G \,(\pi_1 \rho)\, n'\, c', G\, (\pi_2 \rho)\, n\, c)
\in \rho \beta$.
In addition,
\[\setsem{\vdash \fold_{\onet + \tau
    \times \beta}^{\tau'} : \Nat^{\emptyset} (\Nat^{\emptyset} (\onet
  + \tau \times \tau')\, \tau')\, (\Nat^{\emptyset} (\mu \alpha. \onet
  + \tau \times \alpha)\, \tau')} =
\textit{fold}_{1 + \tau \times \_}\] so that if $c \in
\setsem{\vdash \tau} \,\times\, \setsem{\vdash \tau'} \to
\setsem{\vdash \tau'}$ and $n \in \setsem{\vdash \tau'}$, then
$(n, c) \in \setsem{\vdash \Nat^{\emptyset} (\onet + \tau \times \tau')\,
  \tau'}$. The instantiation
$\pi_1 \rho \beta = \setsem{\vdash \mu \alpha. \onet + \tau \times
  \alpha}=\mathit{List}\,\setsem{\vdash \tau}$,\, 
$\pi_2 \rho \beta = \setsem{\vdash \tau'}$,\,
$\rho \beta = \graph{\textit{fold}_{1 + \tau \times \_}\, n\, c} :
\rel(\pi_1 \rho \beta, \pi_2 \rho \beta)$,\,
$c' = \mathit{cons}$,\, and 
$n' = \mathit{nil}$
%Consider the instantiation:
%\[\begin{array}{rcl}
%\pi_1 \rho \beta &=& \setsem{\vdash \mu \alpha. \onet + \tau \times
%  \alpha} \;=\;\List\,\setsem{\vdash \tau}\\   
%\pi_2 \rho \beta &=& \setsem{\vdash \tau'}\\
%\rho \beta &=& \graph{\textit{fold}_{1 + \tau \times \_}\, n\, c} :
%\rel(\pi_1 \rho \beta, \pi_2 \rho \beta) \\ 
%c' &=& \mathit{cons}\\
%n' &=& \mathit{nil}
%\end{array}\]
%Clearly, $(\mathit{nil}, n) \in \rho\beta =
%\graph{\textit{fold}_{1 + \tau \times \_}\, n\, c}$ because $
%\textit{fold}_{1 + \tau \times \_}\, n\, c \,\mathit{nil} = n$.  Moreover,
%$(\mathit{cons}, c) \in \relsem{\vdash \tau} \,\times\, \rho\beta \to
%\rho\beta$ since if $(x, x') \in \relsem{\vdash \tau}$, i.e., $x =
%x'$, and if $(y, y') \in \rho\beta =
%\graph{\textit{fold}_{1 + \tau \times \_} n\, c}$, i.e., $y' =
%\textit{fold}_{1 + \tau \times \_} n\, c\, y$, then
%\[(\mathit{cons}\, x\, y, c\, x\, (\textit{fold}_{1 + \tau \times \_}\, n\,
%c\, y)) \in \graph{\textit{fold}_{1 + \tau \times \_}\, n\, c}\]
%i.e.,
%\[c\, x\, (\textit{fold}_{1 + \tau \times \_}\, n\, c\, y)
%= \textit{fold}_{1 + \tau \times \_}\, n\, c\, (\mathit{cons} \,x\, y)\]
%holds by definition of $\textit{fold}_{1 + \tau \times \_}$.  We
%therefore conclude that
thus gives that $(G \;(\mathit{List}\,\setsem{\vdash
  \tau})\,\mathit{nil} \,\mathit{cons}, G \,\setsem{\vdash \tau'} \,
n\, c) \in \graph{\textit{fold}_{1 + \tau \times \_}\, n\, c}$, i.e.,
that $\textit{fold}_{1 + \tau \times \_}\, n\, c\; (G\;
(\mathit{List}\,\setsem{\vdash \tau})\, \mathit{nil}\, \mathit{cons})
= G \,\setsem{\vdash \tau'}\, n\, c$.
\end{proof}

Using Equation~\ref{thm:demotion-objects} we can extend short
cut fusion results to arbitrary ADTs, as in~\cite{joh02}.

\begin{comment}
\subsection{Short Cut Fusion for Arbitrary ADTs}\label{sec:short-cut-adt}

\begin{thm}
Let $\ol{\vdash \tau : \F}$, let $\vdash \tau' : \F$, let $\ol{\alpha}; \beta
\vdash F : \F$, and let $\beta; \emptyset  \,|\,
\emptyset \vdash g : \Nat^{\emptyset} (\Nat^{\emptyset} F[\ol{\alpha
    := \tau}]\, \beta)\, \beta$.  If we regard
\[\begin{array}{lll}
H & = & \setsem{\emptyset;\beta \vdash F[\ol{\alpha :=
      \tau}]}\\
G & = & \setsem{\beta; \emptyset \,|\, \emptyset \vdash g :
  \Nat^{\emptyset} (\Nat^{\emptyset}\, F[\ol{\alpha := \tau}]\,
  \beta)\, \beta}
\end{array}\]
as functors in $\beta$, then for every $B \in H \setsem{\vdash \tau'}
\rightarrow \setsem{\vdash \tau'}$ we have
\[\textit{fold}_H\, B \; (G\; \mu H \; in_H) = G \,\setsem{\vdash \tau'}\, B\]
\end{thm}

\vspace*{0.2in}

\begin{proof}
  We first note that the type of $g$ is well-formed, since
  $\emptyset;\beta \vdash F[\ol{\alpha := \tau}] : \F$ so our
  promotion theorem gives that $\beta;\emptyset\vdash F[\ol{\alpha :=
      \tau}] : \F$, and $\emptyset;\beta\vdash\beta : \F$ so that our
  promotion theorem gives $\beta;\emptyset\vdash\beta : \F$. From
  these facts we deduce that $\beta;\emptyset \vdash
  \Nat^\emptyset\,F[\ol{\alpha := \tau}]\,\beta : \T$, and thus that
  $\beta; \emptyset \vdash \Nat^{\emptyset} (\Nat^{\emptyset}
  F[\ol{\alpha := \tau}]\, \beta)\, \beta : \T$.

  Theorem~\ref{thm:abstraction} gives that, for any $\rho : \relenv$
  and any $(a, b) \in \relsem{\beta; \emptyset \vdash \emptyset}\rho =
  1$, eliding the only possible instantiations of $a$ and $b$ gives
  that
\[(G \,(\pi_1 \rho), G\, (\pi_2 \rho))
\in \relsem{\beta; \emptyset \vdash \Nat^{\emptyset} (\Nat^{\emptyset}
  F[\ol{\alpha := \tau}]\, \beta)\, \beta} \rho\]
Since
\[\begin{array}{rl}
 & \relsem{\beta; \emptyset \vdash \Nat^{\emptyset}
  (\Nat^{\emptyset} F[\ol{\alpha := \tau}]\, \beta)\, \beta} \rho\\  
=& \relsem{\beta; \emptyset \vdash \Nat^{\emptyset} F[\ol{\alpha :=
      \tau}] \, \beta} \rho \to \rho\beta \\ 
\end{array}\]
we have that if $(A, B) \in \relsem{\beta; \emptyset \vdash
  \Nat^{\emptyset} F[\ol{\alpha := \tau}] \, \beta} \rho$
then
\[(G \,(\pi_1 \rho)\, A, G\, (\pi_2 \rho)\, B)
\in \rho \beta\]
Now note that
\[\setsem{\vdash \fold_{F[\ol{\alpha := \tau}]}^{\tau'} :
  \Nat^{\emptyset}\, (\Nat^{\emptyset}\, F[\ol{\alpha := \tau}][\beta
    := \tau'] \, \tau')\, (\Nat^{\emptyset} \,(\mu
  \beta. F[\ol{\alpha := \tau}] \, \tau')} =
\textit{fold}_H\]
and consider the instantiation
\[\begin{array}{lll}
A &=& \mathit{in}_H :  H (\mu H) \to \mu H\\
B & : & H\setsem{\vdash \tau'} \to \setsem{\vdash \tau'}\\
\rho \beta &=& \graph{\textit{fold}_H\, B}
\end{array}\]
(Note that all the types here are well-formed.)  This gives
\[\begin{array}{lll}
\pi_1 \rho \beta &=& \setsem{\vdash \mu \beta. F[\ol{\alpha := \tau}]}
\; = \; \mu H\\
\pi_2 \rho \beta &=& \setsem{\vdash \tau'}\\
\rho \beta &:& \rel(\pi_1 \rho \beta, \pi_2 \rho \beta)\\
A & : & \setsem{\beta; \emptyset \vdash \Nat^{\emptyset}
  F[\ol{\alpha := \tau}] \, \beta} (\pi_1 \rho)\\
B & : & \setsem{\beta; \emptyset \vdash \Nat^{\emptyset} F[\ol{\alpha
      := \tau}] \, \beta}(\pi_2 \rho)\\
\end{array}\]
since
\[\begin{array}{lll}
A \; = \; \mathit{in}_H & : & H(\mu H) \to \mu H\\
 & = & \setsem{\emptyset;\beta \vdash F[\ol{\alpha := \tau}]}(\mu
\setsem{\emptyset;\beta \vdash F[\ol{\alpha := \tau}]}) \to \mu
\setsem{\emptyset;\beta \vdash F[\ol{\alpha := \tau}]}\\
& = & \setsem{\emptyset;\beta \vdash F[\ol{\alpha :=
      \tau}]}(\pi_1\rho) \to \setsem{\emptyset;\beta \vdash
  \beta}(\pi_1 \rho)\\
& = & \setsem{\beta;\emptyset \vdash F[\ol{\alpha :=
      \tau}]}(\pi_1\rho) \to \setsem{\beta; \emptyset \vdash
  \beta}(\pi_1 \rho) \hspace*{0.25in} {\color{red} \mbox{Daniel's
    trick; now a theorem}} \\ 
& = & \setsem{\beta;\emptyset \vdash \Nat^\emptyset F[\ol{\alpha :=
      \tau}]\,\beta}(\pi_1 \rho) 
\end{array}\]
{\color{red} where ``Daniel's trick'' is the observation that a
  functor can be seen as non-functorial when we only care about its
  action on objects. This is now a theorem.}  We also have
\[\begin{array}{lll}
(A,B) \,=\, (\mathit{in}_H,B) & \in & \relsem{\beta; \emptyset \vdash
  \Nat^{\emptyset} F[\ol{\alpha := \tau}] \, \beta} \rho \\
 & = & \relsem{\beta; \emptyset \vdash F[\ol{\alpha :=
      \tau}]}\rho[\beta := \graph{\textit{fold}_H\, B}] \to
\graph{\textit{fold}_H\, B}\\
 & = & \relsem{\beta; \emptyset \vdash F[\ol{\alpha :=
      \tau}]}\graph{\textit{fold}_H\, B} \to
\graph{\textit{fold}_H\, B}\\
 & = & \relsem{\emptyset; \beta\vdash F[\ol{\alpha :=
      \tau}]}\graph{\textit{fold}_H\, B} \to
\graph{\textit{fold}_H\, B} \hspace*{0.35in} {\color{red}
  \mbox{Daniel's trick; now a theorem}}\\  
& = & \graph{\setsem{\emptyset; \beta \vdash F[\ol{\alpha :=
      \tau}]}\,(\textit{fold}_H\, B)} \to
\graph{\textit{fold}_H\, B} \hspace*{0.25in} {\color{red} \mbox{by the
    graph lemma}}\\ 
& = & \graph{\mathit{map}_H \,(\mathit{fold}_H\,B)} \to
\graph{\textit{fold}_H\, B}\\
\end{array}\]
since if $(x,y) \in \graph{\mathit{map}_H \,(\mathit{fold}_H\,B)}$,
i.e., if $\mathit{map}_H \,(\mathit{fold}_H\,B) \, x = y$, then
$\textit{fold}_H\, B\, (\mathit{in}_H\,x) = B\,y = B\, (\mathit{map}_H
\,(\mathit{fold}_H\,B) \, x)$ by the definition of $\mathit{fold}_H$
as a (indeed, the unique) morphism from $\mathit{in}_H$ to $B$. Thus,
\[(G \,(\pi_1 \rho)\, A, G\, (\pi_2 \rho)\, B) \in
\graph{\textit{fold}_H\, B}\]
i.e.,
\[\textit{fold}_H \, B \, (G\, (\pi_1 \rho) \, \mathit{in}_H) =
G\,(\pi_2 \rho)\,B\] 

\vspace*{0.1in}

\noindent
Since $\beta$ is the only free variable in $G$, this simplifies to
\[\textit{fold}_H\, B \, (G\, \mu H\, \mathit{in}_H) =
G\,\setsem{\vdash \tau'}\,B\]  
\end{proof}
\end{comment}

\subsection{Short Cut Fusion for Arbitrary Nested
  Types}\label{sec:short-cut-nested} 

%fold/build rule shows that Church encodings for nested types are iso
%(have the same interp) as the nested types themselves. Just like Ex
%2.8 in parpoe, but categorical rather than operational semantics. But
%built-in data types are more versatile in implementations. They can be
%inducted on, e.g. And they are stored in the heap, not the run-time
%stack, and are therefore more efficient.
%``Most higher order type languages meant for human programmers eschew
%fully impredicative polymorphism'' says Andy on p322.

Using our system we can, finally, formally prove correctness of the
categorically inspired short cut fusion for nested types
from~\cite{jg10}. Indeed, we have:
\begin{thm}\label{thm:short-cut-nested}
If $\emptyset;\phi,\alpha \vdash F : \F$, \,$\emptyset; \alpha
\vdash K : \F$, \,
%let $\phi ;\emptyset\,|\,\emptyset\vdash g :
%\Nat^\emptyset\,(\Nat^\alpha\,F\,(\phi\alpha)) \,
%(\Nat^\alpha\,\onet \, (\phi\alpha))$. If we let
$H : [\set,\set] \to [\set,\set]$ is defined by
\[\begin{array}{lll}
H\,f\,x & = & \setsem{\emptyset; \phi, \alpha \vdash F}[\phi :=
  f][\alpha := x]\\
\end{array}\]
and 
\[G = \setsem{\phi;\emptyset\,|\,\emptyset \vdash g :
\Nat^\emptyset\,(\Nat^\alpha\,F\,(\phi\alpha))\,(\Nat^\alpha\,\onet \,
(\phi\alpha))}\] for some $g$, then, for every $B \in H
\setsem{\emptyset;\alpha \vdash K} \rightarrow \setsem{\emptyset;
  \alpha \vdash K}$,
$\textit{fold}_{H}\, B \, (G\; \mu H \; in_{H}) = G
\,\setsem{\emptyset;\alpha \vdash K}\, B$.
\end{thm}

\begin{proof}
%We first note that the type of $g$ is well-formed since
%$\emptyset;\phi,\alpha \vdash F : \F$ so our promotion theorem gives
%that $\phi;\alpha \vdash F : \F$, and $\phi;\alpha \vdash \phi\alpha :
%\F$, so that $\phi;\emptyset \vdash \Nat^\alpha F\,(\phi\alpha) : \T$
%and $\phi;\emptyset \vdash \Nat^\alpha \onet \,(\phi\alpha) : \T$.
%Then $\phi;\emptyset \vdash \Nat^\alpha F\,(\phi\alpha) : \F$ and
%$\phi;\emptyset \vdash \Nat^\alpha \onet \,(\phi\alpha) : \F$ also
%%%hold, and, finally, 
%$\phi ;\emptyset\vdash 
%\Nat^\emptyset\,(\Nat^\alpha\,F\,(\phi\alpha)) \,
%(\Nat^\alpha\,\onet \, (\phi\alpha)) : \T$
%  
Theorem~\ref{thm:abstraction} gives that, for any 
$\rho : \relenv$,
%and any $(a, b) \in \relsem{\phi,\alpha;\emptyset \vdash
%  \emptyset}\rho = 1$, eliding the only possible instantiations
%of $a$ and $b$ gives that
\[\begin{array}{lll}
(G \,(\pi_1 \rho), G\, (\pi_2 \rho))
& \in & \relsem{\phi;\emptyset\vdash \Nat^{\emptyset} (\Nat^\alpha
  F\, (\phi\alpha))\, (\Nat^\alpha\,\onet \, (\phi\alpha))}
\rho\\ 
& = & \relsem{\phi;\emptyset\vdash \Nat^\alpha F\,
  (\phi\alpha)}\rho \to \relsem{\phi;\emptyset\vdash
  \Nat^\alpha\,\onet \, (\phi\alpha)}\rho\\ 
%& = & \relsem{\phi;\emptyset\vdash \Nat^\alpha F\,
%  (\phi\alpha)}\rho \to (\,\lambda A. 1 \Rightarrow \lambda A.\,(\rho
%\phi) A\,)\\   
%& = & \relsem{\phi;\emptyset\vdash \Nat^\alpha F\,
%  (\phi\alpha)}\rho \to (1 \Rightarrow \rho \phi)\\ 
& = & \relsem{\phi;\emptyset\vdash \Nat^\alpha F\,
  (\phi\alpha)}\rho \to \rho \phi
\end{array}\]
\noindent
so if $(A, B) \in \relsem{\phi;\emptyset\vdash \Nat^\alpha F\,
  (\phi\alpha)}\rho$ then $(G \,(\pi_1 \rho)\, A, G\, (\pi_2 \rho)\,
B) \in \rho \phi$.
In addition,
\[\setsem{\vdash \fold_F^K :
  \Nat^{\emptyset}\, (\Nat^\alpha F[\phi := K]\,K)\, (\Nat^\alpha
  ((\mu \phi.\lambda\alpha.F)\alpha)\,K)} = \textit{fold}_H\] Consider
the instantiation $A = \mathit{in}_H : H (\mu H) \Rightarrow \mu H$,\,
$B : H\setsem{\emptyset;\alpha\vdash K} \Rightarrow
\setsem{\emptyset;\alpha \vdash K}$,\, $\rho \phi =
\graph{\mathit{fold}_H\, B}$,\, $\pi_1 \rho \phi = \mu H$,\, $\pi_2
\rho \phi = \setsem{\emptyset;\alpha\vdash K}$,\, $\rho \phi :
\rel(\pi_1 \rho \phi, \pi_2 \rho \phi)$,\, $A : \setsem{\phi;
  \emptyset \vdash \Nat^\alpha F \, (\phi \alpha)} (\pi_1 \rho)$,\,
and $B : \setsem{\phi; \emptyset \vdash \Nat^\alpha F \, (\phi
  \alpha)} (\pi_2 \rho)$.
%\[\begin{array}{lll}
%A &=& \mathit{in}_H :  H (\mu H) \Rightarrow \mu H\\
%B & : & H\setsem{\emptyset;\alpha\vdash K} \Rightarrow
%\setsem{\emptyset;\alpha \vdash K}\\
%\rho \phi &=& \graph{\textit{fold}_H\, B} \hspace*{0.2in} {
%  \color{red} \mbox{a graph of a natural transformation, defined in
%    Enrico's notes}} 
%\end{array}\]
%(Note that all the types here are well-formed.) This gives
%\[\begin{array}{lll}
%\pi_1 \rho \phi &=& \mu H\\
%\pi_2 \rho \phi &=& \setsem{\emptyset;\alpha\vdash K}\\
%\rho \phi &:& \rel(\pi_1 \rho \phi, \pi_2 \rho \phi)\\
%A & : & \setsem{\phi; \emptyset \vdash \Nat^\alpha
%  F \, (\phi \alpha)} (\pi_1 \rho)\\
%B & : & \setsem{\phi; \emptyset \vdash \Nat^\alpha
%  F \, (\phi \alpha)} (\pi_2 \rho)\\
%\end{array}\]
%since
Equation~\ref{thm:demotion-objects} ensures that $A = \mathit{in}_H :
H(\mu H) \Rightarrow \mu H = \setsem{\phi;\emptyset \vdash \Nat^\alpha
  F \,(\phi\alpha)}(\pi_1\rho)$,
%\[\begin{array}{lll}
%A \; = \; \mathit{in}_H & : & H(\mu H) \Rightarrow \mu H\\
%& = & \setsem{\emptyset; \phi, \alpha \vdash F}[\phi := \mu
%  \setsem{\emptyset; \phi, \alpha \vdash F}] \Rightarrow \mu
%  \setsem{\emptyset; \phi, \alpha \vdash F}\\  
%& = & \setsem{\emptyset; \phi, \alpha \vdash F}(\pi_1\rho)
%  \Rightarrow \setsem{\emptyset; \phi,\alpha \vdash \phi\alpha}(\pi_1 \rho)\\
%& = & \setsem{\phi; \alpha \vdash F}(\pi_1\rho)
%  \Rightarrow \setsem{\phi;\alpha \vdash \phi\alpha}(\pi_1
%  \rho) \hspace*{0.25in} {\color{red} \mbox{Daniel's trick; now a theorem}}\\
%& = & \setsem{\phi;\emptyset \vdash \Nat^\alpha F
%    \,(\phi\alpha)}(\pi_1\rho) 
%\end{array}\]
and Equation~\ref{thm:demotion-objects} and Lemma~\ref{lem:graph}
together give that
\[\begin{array}{lll}
(A,B) \,=\, (\mathit{in}_H,B) & \in & \relsem{\phi;\emptyset\vdash
  \Nat^\alpha F\, (\phi\alpha)}\rho\\
% & = & \lambda A. \relsem{\phi;\alpha\vdash F}\rho[\alpha := A]
%\Rightarrow \lambda A. (\rho\phi) A\\
& = & \lambda A. \relsem{\phi;\alpha\vdash F}[\phi :=
  \graph{\textit{fold}_H\, B}][\alpha := A] \Rightarrow 
 \graph{\textit{fold}_H\, B} \\ 
%& = & \lambda A. \relsem{\emptyset;\phi,\alpha\vdash F}[\phi :=
%  \graph{\textit{fold}_H\, B}][\alpha := A] \Rightarrow 
%\graph{\textit{fold}_H\, B}  \hspace*{0.25in} {\color{red}
%  \mbox{Daniel's trick; now a theorem}}\\  
& = & \relsem{\emptyset;\phi,\alpha\vdash F}
  \graph{\textit{fold}_H\, B} \Rightarrow \graph{\textit{fold}_H\,
    B}\\
  & = & \graph{\setsem{\emptyset;\phi,\alpha\vdash F}
    \,(\mathit{fold}_H\,B)} \Rightarrow \graph{\textit{fold}_H\, B}\\
%\hspace*{0.25in} {\color{red} \mbox{Graph Lemma}}\\
  & = & \graph{\mathit{map}_H \,(\mathit{fold}_H\,B)} \Rightarrow
\graph{\textit{fold}_H\, B}\\
\end{array}\]
since if $(x,y) \in \graph{\mathit{map}_H \,(\mathit{fold}_H\,B)}$,
%i.e., if $\mathit{map}_H \,(\mathit{fold}_H\,B) \, x = y$,
then $\textit{fold}_H\, B\, (\mathit{in}_H\,x) = B\,y = B\,
(\mathit{map}_H \,(\mathit{fold}_H\,B) \, x)$ by the definition of
$\mathit{fold}_H$ as a (indeed, the unique) morphism from
$\mathit{in}_H$ to $B$.  Thus, $(G \,(\pi_1 \rho)\, A, G\, (\pi_2
\rho)\, B) \in \graph{\textit{fold}_H\, B}$, i.e., $\textit{fold}_H \,
B \, (G\, (\pi_1 \rho) \, \mathit{in}_H) = G\,(\pi_2 \rho)\,B$.  But
since $\phi$ is the only free variable in $G$, this simplifies to
$\textit{fold}_H\, B \, (G\, \mu H\, \mathit{in}_H) =
G\,\setsem{\emptyset;\alpha\vdash K}\,B$. 
\end{proof}

As in~\cite{jg10}, replacing $\onet$ with any term $\emptyset;\alpha
\vdash c$ generalizes
%with $\setsem{\emptyset;\alpha \vdash c}\rho = C$
Theorem~\ref{thm:short-cut-nested} to deliver more general a free
theorem whose conclusion is $\textit{fold}_{H}\, B \; \circ \; G\; \mu
H \; in_{H} = G \,\setsem{\emptyset;\alpha \vdash K}\, B$.

\section{Conclusion and Directions for Future Work}\label{sec:conclusion}

Term-level fixpoints from Daniel: In order to interpret term-level
fixpoints, we would need to add some sort of domain structure to the
sets and relations which are currently being used to interpret types.
With this added structure, we should be able to interpret recursive
function definitions in the usual way (as least fixed points with
respect to the domain structure).  An obvious way to add this
structure might be to replace Set with the category of omega-CPOs in
our model, but this category is not locally finitely presentable as is
required.


We don't need to verify exuistence of initial algebras (as is usual)
since this is built into our system.

We have forall-types but not all.

Can do everything in abstract locally presentable cartesian closed
category. 

Give definitions for arb lpccc, but compute free theorems in Set/Rel.

Future Work (in progress): extend calculus to GADTs

Add more polymorphisms (all foralls), even though most free theorems
only use one level (or maybe two, like short cut).

Couldn't do this before~\cite{jp19} because we didn't know before that
nested types (and then some) always have well-defined interpretations
in locally finitely presentable categories like $\set$ and $\rel$. In
fact, could extend results here to ``locally presentable fibrations'',
where these are yet to be defined, but would at least have locally
presentable base and total categories with the locally presentable
structure preserved by the fibration and appropriate reflection of the
total category in the base (as in Alex's effects paper?).


fixed points at term level ala Pitts:

I'm not sure if we actually want to do this or not (because not all fixed
points will necessarily exist, and this will have consequences, and because
of the restriction to strict functions it will entail and the fact that I
haven't yet thought about how those will thread through our calculus), but
another idea we might consider is adding fixed points at the term level. This
is done for System F in Wadler's section 7. [It is also done in Pitts'
Parametric Polymorphism and Operational Equivalence paper, where the term
introduction rule is SEE SOURCE

%Gamma \vdash F : \tau \to \tau
%-------------------------------
%Gamma \vdash fix (F) : tau

But of course the model there is entirely operational rather than
categorical.]

On the other hand, check out the last paragraph of Wadler's paper, which
suggests that (at least in 1989) there was some interest in calculi like
ours:

"The desire to derive theorems from types therefore suggests that it would be
valuable to explore programming languages that prohibit recursion or only
allow its restricted use. In theory, this is well understood; we have already
noted that any computable function that is provably total in second-order
Peano arithmetic can be defined in the pure polymorphic lambda calculus,
without using the fixpoint as a primitive. However, practical languages based
on this notion remain terra incognita."

Of course we are not working in System F, but perhaps the same desire applies
here, and we do get the same kinds of theorems as Wadler, many just as a
consequence of our interpretation, without invoking parametricity.

In any case, I guess Wadler could be cited as justifying restricting our
attention to our calculus since it could be seen as a way to have a practical
language that ensures that all programs are terminating.




\bibliography{references}

\end{document}


  
